<?php
/**                                          
 * Minder
 *
 * PHP \
 * \
 *  5.2.5
 *
 * @category  Minder
 * @package   Minder
 * @author    Rich Buggy <rich@zoombug.com.au>
 * @copyright 2007 Barcoding & Data Collection Systems
 * @license   http://www.barcoding.com.au/licence.html B&DCS Licence
 * @version   SVN: <svn_id>
 * @link      http://www.barcoding.com.au/
 *
 */

/**
 * Minder
 *
 * All access to the Minder database is through the Minder class.
 *
 * @category  Minder
 * @package   Minder
 * @author    Rich Buggy <rich@zoombug.com.au>
 * @copyright 2007 Barcoding & Data Collection Systems
 * @license   http://www.barcoding.com.au/licence.html B&DCS Licence
 * @link      http://www.barcoding.com.au/
 */
class Minder
{
    /**
     * A string containing the version
     *
     * @var string
     */
    public $version;

    /**
     * The database connection
     *
     * @var resource
     */
    private $db;

    /**
     * The username of the user that is currently connected to Minder
     *
     * @var string
     */
    public $userId;

    /**
     * The user type
     *
     * @var string
     */
    public $userType = null;

    /**
     * The IP address of the user that is current connected to Minder
     *
     * @var string
     */
    public $ip;

    /**
     * The device the user is currently logged in from
     *
     * @var string
     */
    public $deviceId;

    /**
     * @var string
     */
    public $deviceType = null;

    /**
     * The company to limit
     */
    public $limitCompany;

    /**
     * The selected Printer device
     *
     * @var string
     */
    public $limitPrinter;
    /**
     * Description of the last error which occurred during work with a database.
     *
     * @var string
     */
    public $lastError;

    protected $_lastQuery = '';

    /**
     * code of last error
     *
     * @var integer
     */
    public $lastErrorCode;

    /**
     * The warehouse to limit
     */
    public $limitWarehouse;

    /**
     * Is the user an admin?
     */
    public $isAdmin;

    /**
     * Is the user and inventory operator?
     */
    public $isInventoryOperator;

    /**
     * Is the user allowed to stock adjustment?
     *
     * @var boolean
     */
    public $isStockAdjust;
   
     
    public $isAdjustIssn;
    
    public $isAdjustPickOrder;

    /**
     * Is the user allowed to edit
     *
     * @var boolean
     */
    public $isEditable;

    public $silent = true;
    
    public $whId;

    /**
     * A singleton instance of the Minder class. This is used so only one
     * instance of Minder is ever created.
     *
     * @var Minder
     */
    static private $minder = null;

    /**
     * The DSN for the live database
     *
     * @var string
     */
    /* remove hard coded database location - use db alias */
    /* static public $dbLiveDsn = 'localhost:/data/asset.rf/wh.v39.gdb'; */
    static public $dbLiveDsn = 'localhost:async';

    /**
     * The DB name
     *
     * @var string
     */
    static public $dbName = 'minder';

    /**
     * The DSN for the training database
     *
     * @var string
     */
    static public $dbTrainingDsn = '';    

    /**                                                 
     * The username to use when connecting to the database
     *
     * @var string
     */
    static public $dbUser = 'SYSDBA';

    /**
     * The password to user when connecting to the database
     *
     * @var string
     */
    static public $dbPass = 'masterkey';

    /**
     *  Values from the CONTROL table 
     *  
     */
    public $defaultControlValues = array();

    protected $_selectQueryCache = array();

    protected $_sysScreenTableCache = array();

    private static $_dbAdapter;
    
    /**
     * Initialise an instance of the Minder object. This method should only be
     * called by getInstance() so that only a single instance is ever created.
     *
     * @return void
     */
    
    private function __construct() {

        $this->version  = Minder_Version::getFull();

        $this->userId   = null;
        $this->ip       = null;
        $this->deviceId = null;

        $this->db       = ibase_connect(self::$dbLiveDsn,
                                        self::$dbUser,
                                        self::$dbPass);
        Minder_DAO::$_db      = $this->db;
        $this->limitCompany   = 'all';
        $this->limitWarehouse = 'all';
        $this->limitPrinter   = key($this->getPrinterList(true));
        
        $this->defaultControlValues = $this->getValuesFromControl();
    }

    public function connect() {
        
        $this->db = ibase_connect(self::$dbLiveDsn, self::$dbUser, self::$dbPass);
    }

    /**
     * Reconnect user to another selected DSN
     *
     * @return void
     */
    private function connectToTraining() {
        
        $this->db       = ibase_connect(self::$dbTrainingDsn,
                                        self::$dbUser,
                                        self::$dbPass);
        self::$dbName         = 'test database';
        Minder_DAO::$_db      = $this->db;
        $this->limitCompany   = 'all';
        $this->limitWarehouse = 'all';
        $this->limitPrinter   = key($this->getPrinterList(true));
    }

    public static function getDefaultDbAdapter() {
        if (empty(self::$_dbAdapter)) {
            $dsn = self::$dbLiveDsn;
            $dsnArray = explode(':', $dsn);
            $name = isset($dsnArray[1]) ? $dsnArray[1] : $dsnArray[0];
            $host = isset($dsnArray[1]) ? $dsnArray[0] : 'localhost';
            self::$_dbAdapter = Zend_Db::factory('Firebird', array('adapterNamespace' => 'ZendX_Db_Adapter', 'host' => $host, 'username' => self::$dbUser, 'password' => self::$dbPass, 'dbname' => $name));
        }

        return self::$_dbAdapter;
    }

    /**
     * Begin a transaction. All subsequent SQL statements will be part of the
     * transaction until rollbackTransaction() or commitTransaction() is called.
     *
     * @return void
     */
    public function beginTransaction() {
        
        $this->dbTrans = ibase_trans(IBASE_DEFAULT, $this->db);
        if ($this->dbTrans === false) {
            throw new Exception('Unable to begin transaction');
        }
    }

    /**
     * Commits a previously started transaction.
     *
     * @return void
     */
    //protected function commitTransaction( ) {
    public function commitTransaction( $commitDefault = False) {
        
        if (isset($this->dbTrans )) {
            if ($this->dbTrans != null) {
                if (ibase_commit($this->dbTrans) === false) {
                    throw new Exception('Unable to commit transaction');
                }
                $this->dbTrans = null;
            } 
        } 
        if ($commitDefault) {
            if (ibase_commit() === false) {
                throw new Exception('Unable to commit Default Transaction');
            }
        }
    }

    /**
     * Cancels a transaction rolling back any commands that were run
     *
     * @return boolean True if successfull otherwise false
     */
    public function rollbackTransaction() {
        
        if ($this->dbTrans != null) {
            if (ibase_rollback($this->dbTrans) === false) {
                throw new Exception('Unable to rollback transaction');
            }
            $this->dbTrans = null;
        }
        return true;
    }

/**
  *
  ********* APCD constraint cheking *********
  *
  **/
   public function apcdConstraintChecking() {
	$tableName='rdb$relation_constraints';
	$constraintType='rdb$constraint_type';
	$constraintName='rdb$constraint_name';
	$foreignKey='FOREIGN KEY';
	$ssnSubType='SSN_FK_SSN_SUB_TYPE';
	$sql = " select * from $tableName where $constraintType = ? and $constraintName = ?";
	$result =  $this->fetchAssoc($sql, $foreignKey, $ssnSubType);
	return $result;
}



/************************************************/

    // function to update checked quantity after product scanning

    public function updatePickItemCheckQty($prodid,$pickorder) {
	if(!empty($pickorder)) {
	$query = "SELECT CHECKIN_QTY,PICKED_QTY from PICK_ITEM where PROD_ID=? AND PICK_ORDER=?";
	$result =  $this->fetchAssoc($query, $prodid, $pickorder);
	$checkinqty = $result['CHECKIN_QTY'];
	$pickedqty = $result['PICKED_QTY'];

	if(!empty($checkinqty)) {
		if($checkinqty<$pickedqty) {
			$sql = "UPDATE PICK_ITEM SET CHECKIN_QTY=($checkinqty+1) WHERE PROD_ID=$prodid AND PICK_ORDER='$pickorder'";
			$result = ibase_query($this->db, $sql);
			}	
		}
		
	else {
		$sql = "UPDATE PICK_ITEM SET CHECKIN_QTY=(COALESCE(CHECKIN_QTY,0)+1) WHERE PROD_ID=$prodid AND PICK_ORDER='$pickorder'";
        	$result = ibase_query($this->db, $sql);
		}
	}
	}

     // function to select checked quantity from table

    public function selectPickItemCheckinQty($prodid,$pickorder) {
	if(!empty($pickorder)) {
		$query = "SELECT CHECKIN_QTY from PICK_ITEM where PROD_ID=? AND PICK_ORDER=?";
		$result =  $this->fetchAssoc($query, $prodid, $pickorder);
		return $result['CHECKIN_QTY'];
		} 
	else {
		return false;
		}	
	}


/************************************************/    

    public function setDefaultCompanyId(){
        
        if($this->defaultControlValues['LIMIT_COMPANY_ID'] == 'T' && !empty($this->userId)){
           $sysUserData    =   $this->getSysUserData();
            
            if(!is_null($sysUserData['COMPANY_ID']) && !empty($sysUserData['COMPANY_ID'])){
                $this->limitCompany = $sysUserData['COMPANY_ID'];
            } elseif(!is_null($this->defaultControlValues['COMPANY_ID']) && !empty($this->defaultControlValues['COMPANY_ID'])) {
                $this->limitCompany = $this->defaultControlValues['COMPANY_ID'];
            } else {
                $this->limitCompany =   'all';    
            }    
        }
            
    }
    
    public function setDefaultWhId(){
        
        if($this->defaultControlValues['LIMIT_WH_ID'] == 'T' && !empty($this->userId)){
            $sysUserData    =   $this->getSysUserData();
            
            if(!is_null($sysUserData['DEFAULT_WH_ID']) && !empty($sysUserData['DEFAULT_WH_ID'])){
                $this->limitWarehouse = $sysUserData['DEFAULT_WH_ID'];   
            } elseif(!is_null($this->defaultControlValues['DEFAULT_WH_ID']) && !empty($this->defaultControlValues['DEFAULT_WH_ID'])) {
                $this->limitWarehouse = $this->defaultControlValues['DEFAULT_WH_ID'];   
            } else {
                $this->limitWarehouse =   'all';    
            }    
        }
            
    }

    /**
     * Performs a SQL query returning an array where the key is the first
     * column returned and the value is the second column returned.
     *
     * @param string $sql A SQL query string
     * @return array This function always returns an array
     * @throws Exception
     */
    public function findList($sql) {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $args = func_get_args();
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));

        $d = null;
        $query = ibase_prepare($this->db, $sql);
        if ($query !== false) {

            // Replace the SQL statement with the query
            $args = func_get_args();
            $args[0] = $query;

            // check args length and truncate to prevent error if param is longer then field
            // usualy this error occurs for LIKE clause and field length 1-2 char
            $cnt     = count($args);
            for ($i = 1; $i < $cnt; $i++) {
                $plist = ibase_param_info($query, $i-1);
                if (is_array($plist)) {
                    $args[$i] = substr($args[$i], 0, $plist['length']);
                }
            }
            
            $result = call_user_func_array('ibase_execute', $args);
            if ($result !== false) {
                $d = array();
                while (false !== ($row = ibase_fetch_row($result, IBASE_FETCH_BLOBS))) {
                    $d[(string)$row[0]] = (string)$row[1];
                }
                ibase_free_result($result);

            } else {
                $errcode    = ibase_errcode();
                $errmsg     = ibase_errmsg();
                ibase_free_query($query);
                $log->error('Unable to run query ' . $errcode . ', ' . $errmsg . '.' . $queryMsg);
                throw new Exception('Unable to run query ' . $errcode . ', ' . $errmsg . '. Query text: ' . $sql);
            }

            ibase_free_query($query);
        }

        if ($d === null) {
            $log->error($queryMsg);
            throw new Exception('Unable to retrieve list');
        }
        else {
            $log->info($queryMsg);
            return $d;
        }

    }

    protected function findAll($sql) {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $args = func_get_args();
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));

        $d = null;

        $query = ibase_prepare($this->db, $sql);
        if ($query !== false) {
            $args = func_get_args();
            // Replace the SQL statement with the query
            $args[0] = $query;
            $result = call_user_func_array('ibase_execute', $args);
            if (false !== $result) {
               $d = array();
                while (false !== ($row = ibase_fetch_row($result))) {
                    $d[] = $row;
                }
                ibase_free_result($result);
            }

            ibase_free_query($query);
        }

        if ($d === null) {
            $log->error($queryMsg);
            throw new Exception('Unable to retrieve list');
        }
        else {
            $log->info($queryMsg);
            return $d;
        }
    }

    protected function findAllAssoc($sql) {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $args = func_get_args();
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));

        $d = null;
       
        //$this->logMinder('/tmp/findallassoc.log', $sql) ;
        $query = ibase_prepare($this->db, $sql);

        if ($query !== false) {
            $args = func_get_args();
            // Replace the SQL statement with the query
            $args[0] = $query;
            $result = call_user_func_array('ibase_execute', $args);
            if (false !== $result) {
                $d = array();
                while (false !== ($row = ibase_fetch_assoc($result))) {
                    $d[] = $row;
                }
                ibase_free_result($result);
            }
            ibase_free_query($query);
        }

        if ($d === null) {
            $log->error($queryMsg);
            throw new Exception('Unable to retrieve list');
        }
        else {
            $log->info($queryMsg);
            return $d;
        }
    }

    protected function findOne($sql) {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $args = func_get_args();
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));

        $d = null;

        $query = ibase_prepare($this->db, $sql);
        if ($query !== false) {
            $args = func_get_args();
            // Replace the SQL statement with the query
            $args[0] = $query;
            $result = call_user_func_array('ibase_execute', $args);
            if (false !== $result) {
                if (false !== ($row = ibase_fetch_row($result))) {
                    $d = $row;
                }
                ibase_free_result($result);
            }
            ibase_free_query($query);
        }

        if ($d === null) {
            $log->error($queryMsg);
            throw new Exception('Unable to retrieve list');
        }
        else {
            $log->info($queryMsg);
            return $d;
        }
    }

    protected function findOneAssoc($sql) {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $args = func_get_args();
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));

        $d = null;
        
        $query = ibase_prepare($this->db, $sql);
        
        if ($query !== false) {
            $args = func_get_args();   
            // Replace the SQL statement with the query
            
            $args[0] = $query;
            
            $result = call_user_func_array('ibase_execute', $args);
            if (false !== $result) {
                $row = ibase_fetch_assoc($result);
                if ($row !== false) {
                    $d = $row;
                    if ($d === null) {
                        $errmsg = ibase_errmsg();
                        ibase_free_result($result);
                        ibase_free_query($query);
                        $log->error($errmsg . '. '. $queryMsg);
                        throw new Exception('Unable to retrieve list:'. $errmsg . '. Query text: ' . $sql);
                    }
                } else {
                    $tmpErrorMsg = ibase_errmsg();
                    if (false !== $tmpErrorMsg) {
                        unset($args[0]);
                        $this->lastError = $tmpErrorMsg . '. Query text: ' . $sql . '. Params: ("' . implode('", "', $args) . '")';
                        $log->error($tmpErrorMsg . '. '. $queryMsg);
                    }
                        
                }
                ibase_free_result($result);
                $log->info($queryMsg);
            } else {
                unset($args[0]);
                $this->lastError = ibase_errmsg() . '. Query text: ' . $sql . '. Params: ("' . implode('", "', $args) . '")';
                $log->error($queryMsg);
            }
            ibase_free_query($query);
        } else {
            $this->lastError = ibase_errmsg() . '. Query text: ' . $sql;
            $log->error($queryMsg);
        }

	foreach($d as $strKey => $strValue){
            if($this->isValidDate($strValue)){
                $d[$strKey] = $this->getFormatedDate($strValue);
            }
        }

        return $d;
    }
    
    protected function findOneAssocExt($sql) {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $args = func_get_args();
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));

        $d = null;
        
        $query = ibase_prepare($this->db, $sql);
        
        if ($query !== false) {
            $args = func_get_args();
            // Replace the SQL statement with the query
            $args[0] = $query;
            $result = call_user_func_array('ibase_execute', $args);
            if (false !== $result) {
                $row = ibase_fetch_assoc($result);
                if ($row !== false) {
                    $d = $row;
                    if ($d === null) {
                        $errmsg = ibase_errmsg();
                        ibase_free_query($query);
                        $log->error($queryMsg);
                        throw new Exception('Unable to retrieve list:'. $errmsg . '. Query text: ' . $sql);
                    }
                }
                ibase_free_query($query);
            }
        }

        $data   =   array();
        $count  =   ibase_num_fields($result);
        
        for ($i = 0; $i < $count; $i++) {
            $colInfo = ibase_field_info($result, $i);
            $tmpName = '';
            if (empty($colInfo['name'])) {
                $tmpName = $colInfo['alias'];
            } else {
                $tmpName = $colInfo['name'];
            }
            
            $collName = $tmpName;
            
            if (!empty($colInfo['relation'])) {
                $tmpName = $colInfo['relation'] . '.' . $tmpName;
            }
            
            $data[strtoupper($tmpName)] = (is_array($row) && isset($row[$collName])) ? $row[$collName] : '';
        }

//        foreach($row as $key    =>  $value){
//            $colInfo = ibase_field_info($result, $count);
//            $data[$colInfo['relation'] . '.' .$colInfo['name']]  =   $value;
//            $count++; 
//        }

        if ($result !== false)
            ibase_free_result($result);

        $log->info($queryMsg);
        return $data;
    }

    public function findValue($sql) {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $args = func_get_args();
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));
        $val = null;
        $query = null;
        $params = array();
        $query = ibase_prepare($this->db, $sql);
        if ($query !== false) {
            // Replace the SQL statement with the query
            $args[0] = $query;
            foreach ($args as $key => $item) {
                if ($item == null) {
                    unset($args[$key]);
                } elseif (is_array($item)) {
                    foreach ($item as $value) {
                        $params[] = $value;
                    }
                } else {
                    $params[] = $item;
                }
            }
            $result = call_user_func_array('ibase_execute', $params);
            if (false !== $result) {
                if (false !== ($row = ibase_fetch_row($result))) {
                    $val = $row[0];
                }
                ibase_free_result($result);
            }
            ibase_free_query($query);
        } else {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg();
            $log->error($this->lastError . '. ' . $queryMsg);
            throw new Exception('Unable to retrieve list: '.$this->lastError . $sql . print_r($params, True));
        }

        $log->info($queryMsg);

        return $val;
    }

    /**
     * Modified findAllAssoc
     *
     * Now params can be in array
     *
     * Prefered to use in such way:
     *      1st param - query string with placeholder '?'
     *      2nd param - array of values
     *
     * @return array
     */
    public function findAllAssocMod($sql) {

        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $log->info("before Prepare: " .$sql);
        $d = null;
        $query = ibase_prepare($this->db, $sql);
        if (func_num_args() > 1) {
            $args = func_get_arg(1);
            if (is_array($args)) {
                $params = array($query);
                $params = array_merge($params, $args);
            } else {
                // if comes non array params
                // get all params
                $params = func_get_args();
                // Replace the SQL statement with the query
                $params[0] = $query;
            }
        } else {
            // single query without params
            $params = array($query);
        }

        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($params, 1));

        if ($query !== false) {
            $result = call_user_func_array('ibase_execute', $params);
            if (false !== $result) {
                $d = array();
                while (false !== ($row = ibase_fetch_assoc($result, IBASE_TEXT))) {

                    foreach($row as $strKey => $strValue){
                        if($this->isValidDate($strValue)) {
                            $row[$strKey] = $this->getFormatedDate($strValue);
                        }
                    }

                    $d[] = $row;
                }
                ibase_free_result($result);

            } else {
                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                ibase_free_query($query);
                $log->error($this->lastError . '. ' . $queryMsg);
                throw new Exception('Error while request: ' . $this->lastError);
            }
            ibase_free_query($query);
        }

        if ($d === null) {
            $log->error($queryMsg);
            throw new Exception('Unable to retrieve list');
        }
        else {
            $log->info($queryMsg);
            return $d;
        }
    }

    /**
     * Return one row from result set.
     * Example: $this->fetchAssoc($sql, $arg1, $arg2, ...);
     *
     * @param string $sql  SQL query string.
     *
     * @return array|false Returns an associative array that corresponds to the fetched row
     *                     or false if there are no more rows.
     */
    public function fetchAssoc($sql) {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $args = func_get_args();
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));

        $query = @ibase_prepare($this->db, $sql);
        if (false === $query) {
            $log->error($queryMsg);
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        $args = func_get_args();
        $args[0] = $query;
        $result = @call_user_func_array('ibase_execute', $args);
        if (false === $result) {
            $errcode = ibase_errcode();
            $errmsg = ibase_errmsg();

            unset($args[0]);
            ibase_free_query($query);
            $log->error($queryMsg);
            throw new Minder_Exception($errcode . ': ' . $errmsg . '. Query text: ' . $sql . '. Args: ("' . implode('", "', $args) . '")');
        }
        $row = ibase_fetch_assoc($result, IBASE_TEXT);

        ibase_free_result($result);
        ibase_free_query($query);
        $log->info($queryMsg);
        
        foreach($row as $strKey => $strValue){
            if($this->isValidDate($strValue)) {
                $row[$strKey] = $this->getFormatedDate($strValue);
            }
        }

        return $row;
    }

    /**
     * Return all rows from result set.
     * Example 1: $this->fetchAllAssoc($sql, $arg1, $arg2, ...),
     * where $arg1, $arg2 query arguments (which will replaced instead ? in SQL query).
     * $args = array($sql, $arg1, $arg2);
     * Example 2: call_user_func_array(array($this, 'fetchAllAssoc'), $args);
     *
     * @param  string $sql SQL query string.
     *
     * @return array       Returns an associative array that corresponds to the fetched rows.
     */
     public function fetchAllAssoc($sql) {

        $args = func_get_args();
        $intKey = array_search('|FETCH_MODE=SPLIT_ARRAY|', $args);

        if($intKey > -1){
            unset($args[$intKey]);
            $strTempQuery = $sql;
            $arrTempParm = $args;
            $strTempQuery = preg_replace('/\s+/', ' ', $strTempQuery);
            $strTempQuery = str_ireplace("in (", "in(", $strTempQuery);

            $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        

            $args[0] = $query;
            $arrQueryAndParm = array();

            $intSplitBy = 1000;
            $intMaxLoopCount = 0;
            $intStartingOffset = 0;
            $intQueryIndex = 0;
            $intParmOffset = 1;
            $intParmCount = 0;
            $strSearchFore = "in(";
            $strTempQuery;
            while (($intStartingPosition = stripos($strTempQuery, $strSearchFore, $intStartingOffset))!== false){
                $arrQueryAndParm[$intQueryIndex]["query"] = substr($strTempQuery, $intStartingOffset, ($intStartingPosition - $intStartingOffset));
                $arrQueryAndParm[$intQueryIndex]["paremCount"] = count(explode("?", $arrQueryAndParm[$intQueryIndex]["query"]))-1;
                $arrQueryAndParm[$intQueryIndex]["parems"] = array_slice($arrTempParm, $intParmOffset, $arrQueryAndParm[$intQueryIndex]["paremCount"]);
                $arrQueryAndParm[$intQueryIndex]["type"] = "normal";
                $intParmOffset += $arrQueryAndParm[$intQueryIndex]["paremCount"];
                $intStartingOffset += strlen($arrQueryAndParm[$intQueryIndex]["query"]);
                ++$intQueryIndex;

                $arrQueryAndParm[$intQueryIndex]["query"] = substr($strTempQuery, $intStartingPosition, (strpos(substr($strTempQuery, $intStartingPosition),")"))+1);
                $arrQueryAndParm[$intQueryIndex]["paremCount"] = count(explode("?", $arrQueryAndParm[$intQueryIndex]["query"]))-1;
                $arrQueryAndParm[$intQueryIndex]["parems"] = array_slice($arrTempParm, $intParmOffset, $arrQueryAndParm[$intQueryIndex]["paremCount"]);

                $intTempMaxLoopCount = ceil($arrQueryAndParm[$intQueryIndex]["paremCount"]/$intSplitBy);
                //echo " {$arrQueryAndParm[$intQueryIndex]["paremCount"]} ($intTempMaxLoopCount) ";
                if($intTempMaxLoopCount > $intMaxLoopCount){
                    $intMaxLoopCount = $intTempMaxLoopCount;
                }

                $intParmOffset += $arrQueryAndParm[$intQueryIndex]["paremCount"];
                $intStartingOffset += strlen($arrQueryAndParm[$intQueryIndex]["query"]);
                if($arrQueryAndParm[$intQueryIndex]["paremCount"] != 0){
                    $arrQueryAndParm[$intQueryIndex]["type"] = "in";
                    $arrQueryAndParm[$intQueryIndex]["query"] = "in(<*-|ToChange|-*>)";
                }
                else{
                    $arrQueryAndParm[$intQueryIndex]["type"] = "normal";
                }
                ++$intQueryIndex;
            }
            if(strlen($strTempQuery) != $intStartingOffset){
                $arrQueryAndParm[$intQueryIndex]["query"] = substr($strTempQuery, $intStartingOffset);
                $arrQueryAndParm[$intQueryIndex]["paremCount"] = count(explode("?", $arrQueryAndParm[$intQueryIndex]["query"]))-1;
                $arrQueryAndParm[$intQueryIndex]["parems"] = array_slice($arrTempParm, $intParmOffset, $arrQueryAndParm[$intQueryIndex]["paremCount"]);
                $arrQueryAndParm[$intQueryIndex]["type"] = "normal";
                $intParmOffset += $arrQueryAndParm[$intQueryIndex]["paremCount"];
                $intStartingOffset = $intStartingOffset + strlen($arrQueryAndParm[$intQueryIndex]["query"]);
            }

            //echo "<pre> $strTempQuery <br> "; die(print_r($arrQueryAndParm));


            foreach($arrQueryAndParm as $intKey => $arrValue){
                if($arrValue["type"] == "in"){
                    $arrInParems = array_chunk($arrValue["parems"], $intSplitBy);
                    $intTempInParemCount = count($arrInParems);
                    $intTempInParemIndex = $intTempInParemCount - 1;
                    $arrQueryAndParm[$intKey]["inparems"] = $arrInParems;
                    while(count($arrQueryAndParm[$intKey]["inparems"]) != $intMaxLoopCount){
                        $arrQueryAndParm[$intKey]["inparems"][] = $arrInParems[$intTempInParemIndex];
                    }
                }
            }

            //echo "<pre> $strTempQuery <br> "; die(print_r($arrQueryAndParm));

            $intTempIndex = 0;
            $arrResult = array();
            while($intTempIndex != $intMaxLoopCount){
                $strQuery = "";
                $arrParm = array();
                $arrParm[0] = "";
                foreach($arrQueryAndParm as $intKey => $arrValue){
                    if($arrValue["type"] == "in"){
                        $arrValue["query"] = str_replace("<*-|ToChange|-*>", trim(str_repeat("?,", count($arrValue["inparems"][$intTempIndex])) ,","), $arrValue["query"]);
                        $arrParm = array_merge($arrParm, $arrValue["inparems"][$intTempIndex]);
                    }
                    else{
                        $arrParm = array_merge($arrParm, $arrValue["parems"]);
                    }
                    $strQuery .= " ".$arrValue["query"];
                }

                //echo "<pre> $strTempQuery <br> "; die(print_r($arrParm));

                $query = ibase_prepare($this->db, $strQuery);
                $arrParm[0] = $query;
                $result = call_user_func_array('ibase_execute', $arrParm);
                if (false === $result) {
                    $errcode = ibase_errcode();
                    $errmsg = ibase_errmsg();
                    ibase_free_query($query);
                    $msg = $errcode . ': ' . $errmsg . '. ' . $queryMsg;
                    $log->error($msg);
                    throw new Minder_Exception($msg);
                }

                while($arrLine = ibase_fetch_assoc($result, IBASE_TEXT)){
                    $arrResult[] = $arrLine;
                }

                //echo "<pre> $strTempQuery <br> "; die(print_r($arrResult));

                $log->info($queryMsg);
                ibase_free_result($result);
                ibase_free_query($query);

                ++$intTempIndex;
            }

            //echo "<pre> $strTempQuery <br> "; die(print_r($arrQueryAndParm));
            //echo "<pre> $strTempQuery <br> "; die(print_r($arrResult));
            return $arrResult;

        }
        else{

            $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
            $query = ibase_prepare($this->db, $sql);

            $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));
            if (false === $query) {
                $msg = ibase_errcode() . ': ' . ibase_errmsg() . '. ' . $queryMsg;
                $log->error($msg);
                throw new Minder_Exception($msg);
            }
            $args[0] = $query;

            $result = call_user_func_array('ibase_execute', $args);
            if (false === $result) {
                $errcode = ibase_errcode();
                $errmsg = ibase_errmsg();
                ibase_free_query($query);
                $msg = $errcode . ': ' . $errmsg . '. ' . $queryMsg;
                $log->error($msg);
                throw new Minder_Exception($msg);
            }
            for ($lines = array(); $line = ibase_fetch_assoc($result, IBASE_TEXT); $lines[] = $line);

            $log->info($queryMsg);
            ibase_free_result($result);
            ibase_free_query($query);

            return $lines;

        }

    }

    /*public function fetchAllAssoc($sql) {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $query = ibase_prepare($this->db, $sql);
        $args = func_get_args();
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));
        if (false === $query) {
            $msg = ibase_errcode() . ': ' . ibase_errmsg() . '. ' . $queryMsg;
            $log->error($msg);
            throw new Minder_Exception($msg);
        }
        $args[0] = $query;
        $result = call_user_func_array('ibase_execute', $args);
        if (false === $result) {
            $errcode = ibase_errcode();
            $errmsg = ibase_errmsg();
            ibase_free_query($query);
            $msg = $errcode . ': ' . $errmsg . '. ' . $queryMsg;
            $log->error($msg);
            throw new Minder_Exception($msg);
        }
        for ($lines = array(); $line = ibase_fetch_assoc($result, IBASE_TEXT); $lines[] = $line);

        $log->info($queryMsg);
        ibase_free_result($result);
        ibase_free_query($query);

        return $lines;
    }*/
    
    public function fetchColumn($column, $sql) {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $args = func_get_args();
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));

        $query = ibase_prepare($this->db, $sql);
        if (false === $query) {
            $log->error($queryMsg);
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        $args = func_get_args();
        array_shift($args);
        $args[0] = $query;
        $result = call_user_func_array('ibase_execute', $args);
        if (false === $result) {
            $errcode = ibase_errcode();
            $errmsg = ibase_errmsg();
            ibase_free_query($query);
            $log->error($queryMsg);
            throw new Minder_Exception($errcode . ': ' . $errmsg . '. Query text: ' . $sql);
        }
        for ($lines = array(); $line = ibase_fetch_assoc($result, IBASE_TEXT); $lines[] = isset($line[$column]) ? $line[$column] : null);

        ibase_free_result($result);
        ibase_free_query($query);
        $log->info($queryMsg);
        return $lines;
    }

    public function fetchAllAssocExt($sql) {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $args = func_get_args();
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($args, 1));

        $query = ibase_prepare($this->db, $sql);
        if (false === $query) {
            $errcode = ibase_errcode();
            $errmsg = ibase_errmsg();
            $log->error($queryMsg);
            throw new Minder_Exception($errcode . ': ' . $errmsg . '. Query text: ' . $sql);
        }
        $args = func_get_args();
        $args[0] = $query;
        $result = call_user_func_array('ibase_execute', $args);
        if (false === $result) {
            $errcode = ibase_errcode();
            $errmsg = ibase_errmsg();
            ibase_free_query($query);
            $log->error($queryMsg);
            throw new Minder_Exception($errcode . ': ' . $errmsg . '. Query text: ' . $sql);
        }
        for ($lines = array(); $line = ibase_fetch_assoc($result, IBASE_TEXT); ) {
            $row = array();
            $fieldNo = 0;
            foreach ($line as $key => $val) {
                $colInfo = ibase_field_info($result, $fieldNo);
                $row[$colInfo['relation'] . '.' .$colInfo['name']]  =   $val;
                $fieldNo++; 
            }
            $lines[] = $row;
        }

        ibase_free_result($result);
        ibase_free_query($query);
        $log->info($queryMsg);
        return $lines;
    }

    /**
     * Return first column from first row in result set.
     *
     * @return string|null|false Returns false if record could not be found, null or string otherwise.
     */
    public function fetchOne(){
        
        $args = func_get_args();
        $result = call_user_func_array(array($this, 'fetchAssoc'), $args);
        if ($result === false) {
            return false;
        }
        return array_shift($result);
    }

    /**
     * Prepare arguments, truncated its to length basing on database information.
     *
     * @param  string|array|resource $sql  SQL query string. If array, then $sql must be in following
     * format: $sql = array($sql, $arg1, $arg2, ..., $argn);
     * @param  array                 $args Arguments (which will replaced instead ? in SQL query).
     *
     * @return array                       Array of prepared arguments. If SQL query is array, then
     * the first value of the array (SQL query) included in returned arguments list.
     *
     * @throws Minder_Exception            When invalid invalid SQL query or arguments.
     */
    public function prepareArgs($sql, $args = null) {

        $unshift = false;
        if (is_array($sql)) {
            $unshift = true;
            $args = $sql;
            $sql = array_shift($args);
        }
        if (is_resource($sql)) {
            $query = $sql;
        } else {
            if (false === ($query = ibase_prepare($this->db, $sql))) {
                $this->lastError    =   ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql;
            }
        }
        $i = 0;
        foreach ($args as $key => $arg) {
            $info = ibase_param_info($query, $i++);
            switch ($info['type']) {
                case 'VARCHAR':
                    //$delta = $info['length'] - strlen($arg);
                    $args[$key] = substr($arg, 0, $info['length']);
                    break;
            }
        }
        if ($unshift) {
            array_unshift($args, $sql);
        }

        ibase_free_query($query);

        return $args;
    }

    /**
     * Use this function to create an instance of the Minder class. This
     * makes sure only a single instance is created.
     *
     * @return Minder
     */
    static public function getInstance() {
        
        if (self::$minder === null) {
            self::$minder = new Minder();
        }

        // To reset clint time zone from db in case of session out
        if(isset(self::$minder->deviceId) and self::$minder->deviceId != ""){
            $objSession = new Zend_Session_Namespace();
            $strClientTimeZone = $objSession->BrowserTimeZone;

            if(!isset($objSession->TimeZoneFromBrowser)){
                $txtDateLog = date("d-m-Y H:i:s")." -> TimeZone from browser : $strClientTimeZone \n";
                //file_put_contents("/tmp/DateConversionLog.txt", $txtDateLog, FILE_APPEND);
                file_put_contents("/data/tmp/DateConversionLog.log", $txtDateLog, FILE_APPEND);
                $objSession->TimeZoneFromBrowser = $strClientTimeZone;
            }
            
            
            if($strClientTimeZone == ""){
                $arrSessionTableData = self::$minder->getSessionTableData("CLIENT_TIME_ZONE");
                if(isset($arrSessionTableData["DESCRIPTION"])){
                    $objSession->BrowserTimeZone = $arrSessionTableData["DESCRIPTION"];

                    $txtDateLog = date("d-m-Y H:i:s")." -> TimeZone from session table loaded to session : ".$objSession->BrowserTimeZone." \n";
                    //file_put_contents("/tmp/DateConversionLog.txt", $txtDateLog, FILE_APPEND);
                    file_put_contents("/data/tmp/DateConversionLog.log", $txtDateLog, FILE_APPEND);
                }
            }
        }

        return self::$minder;
    }

    /**
     * Log a message to a file
     *
     * @return none
     */
    public function logMinder($filename, $message) {
        
        $fileid = fopen($filename, 'a');
        fwrite($fileid, $message . "\n");
        fclose($fileid);
    }

    /**
     * @return array|null
     */
    public function getAddress($recordId) {
        
        $addr = null;

        $recordId = intval($recordId);
        if ($recordId > 0) {
            $row = $this->fetchAssoc('SELECT * FROM PERSON_ADDRESS WHERE RECORD_ID = ?', $recordId);
            if (is_array($row)) {
                $addr = new Address();
                $addr->recordId = $row['RECORD_ID'];
                $addr->personId = $row['PERSON_ID'];
                $addr->firstName = $row['ADDR_FIRST_NAME'];
                $addr->lastName = $row['ADDR_LAST_NAME'];
                $addr->type = $row['ADDR_TYPE'];
                $addr->line1 = $row['ADDR_LINE1'];
                $addr->line2 = $row['ADDR_LINE2'];
                $addr->suburb = $row['ADDR_SUBURB'];
                $addr->city = $row['ADDR_CITY'];
                $addr->state = $row['ADDR_STATE'];
                $addr->postcode = $row['ADDR_POST_CODE'];
                $addr->country = $row['ADDR_COUNTRY'];
                $addr->phone = $row['ADDR_PHONE_NO'];
            }
        }

        return $addr;
    }

    /**
     * Return a list of people
     *
     * @return array
     */
    public function getAddresses($type = null, $personId = null) {
        
        $result = array();

        if ($type == null) {
            if ($personId == null) {
                $rows = $this->findAllAssoc('SELECT * FROM PERSON_ADDRESS ORDER BY PERSON_ID');
            } else {
                $rows = $this->findAllAssoc('SELECT * FROM PERSON_ADDRESS WHERE PERSON_ID = ? ORDER BY PERSON_ID', $personId);
            }
        } else {
            if ($personId == null) {
                $rows = $this->findAllAssoc('SELECT * FROM PERSON_ADDRESS WHERE ADDR_TYPE = ? ORDER BY PERSON_ID', $type);
            } else {
                $sql = 'SELECT * FROM PERSON_ADDRESS WHERE ADDR_TYPE = ? AND PERSON_ID = ? ORDER BY PERSON_ID';
                $rows = call_user_func_array(array($this, 'fetchAllAssoc'), $this->prepareArgs(array($sql, $type, $personId)));
            }
        }
        
        foreach ($rows as $row) {
            $addr = new Address();
            $addr->recordId = $row['RECORD_ID'];
            $addr->personId = $row['PERSON_ID'];
            $addr->firstName = $row['ADDR_FIRST_NAME'];
            $addr->lastName = $row['ADDR_LAST_NAME'];
            $addr->type = $row['ADDR_TYPE'];
            $addr->line1 = $row['ADDR_LINE1'];
            $addr->line2 = $row['ADDR_LINE2'];
            $addr->suburb = $row['ADDR_SUBURB'];
            $addr->city = $row['ADDR_CITY'];
            $addr->state = $row['ADDR_STATE'];
            $addr->postcode = $row['ADDR_POST_CODE'];
            $addr->country = $row['ADDR_COUNTRY'];
            $addr->phone = $row['ADDR_PHONE_NO'];
            $addr->title = $row['ADDR_TITLE'];
            $result[$row['RECORD_ID']] = $addr;
        }

        return $result;
    }

    public function getCompany($companyId) {
        
        $company = null;

        $sql = "SELECT * FROM COMPANY WHERE COMPANY_ID = ?";
        $row = $this->findOneAssoc($sql, $companyId);
        if ($row != null) {
            $company = new Company();
            $company->companyId = $row['COMPANY_ID'];
            $company->address = $row['ADDRESS1'];
            if ($row['ADDRESS2'] != '') {
                $company->address = $company->address . ', ' . $row['ADDRESS2'];
            }
            if ($row['ADDRESS3'] != '') {
                $company->address = $company->address . ', ' . $row['ADDRESS3'];
            }
            $company->acn = $row['ACN'];
            $company->abn = $row['ABN'];
            $company->url = $row['URL'];
            $company->email = $row['EMAIL'];
            $company->fax = $row['FAX_NO'];
            $company->phone = $row['PHONE_NO'];
            $company->name = $row['NAME'];
            $company->defaultCarrierId = $row['DEFAULT_CARRIER_ID'];
        }

        return $company;
    }

    /**
     * Return a list of companies
     *
     * @return array
     */
     public function getCompanyList($q = null) {
        
        if ($this->isAdmin || $this->isInventoryOperator) {
            $sql = "SELECT COMPANY_ID, COMPANY_ID FROM COMPANY ";
            if ($q !== null) {
                $sql = $sql . "WHERE UPPER(COMPANY_ID) LIKE ? ORDER BY 1 ASC ";
                return $this->findList($sql, '%'. strtoupper($q) . '%');
            }
            $sql .= 'ORDER BY 1 ASC';
            
            return $this->findList($sql);
        } else {
            //$sql = "SELECT COMPANY_ID, COMPANY_ID FROM ACCESS_COMPANY WHERE USER_ID = ?";
            $sql = "SELECT ACCESS_COMPANY.COMPANY_ID, COMPANY.COMPANY_ID FROM ACCESS_COMPANY JOIN COMPANY ON ACCESS_COMPANY.COMPANY_ID = COMPANY.COMPANY_ID WHERE ACCESS_COMPANY.USER_ID = ? ";
            if ($q !== null) {
                //$sql = $sql . " AND UPPER(COMPANY_ID) LIKE ?";
                $sql = $sql . "AND UPPER(ACCESS_COMPANY.COMPANY_ID) LIKE ? ORDER BY 1 ASC ";
                return $this->findList($sql, $this->userId, '%'. strtoupper($q) . '%');
            }
            //$sql .= 'ORDER BY COMPANY_ID ASC';
            $sql .= 'ORDER BY COMPANY.COMPANY_ID ASC';
            return $this->findList($sql, $this->userId);
        }
    }

    /**
     * Return an array of all the container types ordered by DESCRIPTION. The
     * key will be the CODE and value will be the DESCRIPTION.
     *
     * @return array return empty array if query is empty or fail
     */
    public function getContainerTypeList() {

        return $this->getExtOptionsList('SHIP_CONTR');
    }
    /**
    * @desc return data from OPTIONS, where GROUP_CODE = 'PA|PB|PC, etc _FORMAT'
    * @return array 
    */
    public function getPrnFile($groupCode) {
        
        return $this->getOptionsList($groupCode);
    }
    /**
    * @desc return data from OPTIONS, where GROUP_CODE = 'LOAN_DAYS'
    * @return array 
    */
    public function getLoanDaysList() {
        
        return $this->getOptionsList('LOAN_DAYS');
    }
    /**
     * Return a list of cost centres
     *
     * @return array
     */
    public function getCostCentreList() {
        
        $sql = "SELECT CODE, DESCRIPTION
                FROM COST_CENTRE
                ORDER BY DESCRIPTION";

        return $this->findList($sql);
    }
    
    public function getCostCentre($code = null) {
        
        if ($code == null) {
            throw new Exception('invalid input');
        }
        
        $sql = "SELECT * FROM COST_CENTRE WHERE CODE = ? ";
        
        $result = $this->fetchAssoc($sql, $code);
        
        return $result['DESCRIPTION'];
    }

        public function checkCostCentreExist($code = null, $wh_id = null, $company_id=null) {
        
        if ($code == null) {
            throw new Exception('invalid input');
        }
        
        $sql = "SELECT * FROM COST_CENTRE WHERE CODE = ? AND WH_ID = ? AND COMPANY_ID = ?";
        
        $result = $this->fetchAssoc($sql, $code, $wh_id, $company_id);
        
        return $result['DESCRIPTION'];
    }

    public function getDespatchLocationList($whId = null) {
        
        $sql = "SELECT WH_ID || LOCN_ID, LOCN_NAME FROM LOCATION WHERE STORE_AREA = 'DS'";
        if ($whId !== null) {
            $sql = $sql . " AND WH_ID = '$whId'";
        }
        $sql = $sql . " ORDER BY LOCN_NAME";

        return $this->findList($sql);
    }

    public function getExportCategoryList($q = null) {
 
        return array_merge(array('' => ''), $this->getExtOptionsList('PRODEXPCAT'));
    }

    public function getWarrantyList() {
        
        $sql = 'SELECT WARRANTY_CODE, WARRANTY_CODE AS WARRANTY_CODE1 FROM WARRANTY';
        return $this->findList($sql);
    }

    /**
     * Return the last line number for the provided GRN number
     *
     * @param string $grnNo GRN number
     *
     * @return integer return 0 if query is empty or fail
     */
    public function getLastLineNo($grnNo) {
        
        $sql = "SELECT LAST_LINE_NO FROM GRN WHERE GRN = ?";
        return $this->findValue($sql, $grnNo);
    }


    /**
     * Lookup an order by the order number and return the order
     *
     * @return PickOrder
     */
    public function getPickOrder($orderNo, $orderType = 'SO') {
        
        $pickOrder = null;
        $sql = "SELECT *
                FROM PICK_ORDER 
                WHERE PICK_ORDER = ?";
        
        switch(strtoupper($orderType)) {
            case 'SO':
                        $sql  .=' AND PICK_ORDER_TYPE = \'SO\'';
                        
                        break;
            case 'TO':
                        $sql  .=' AND PICK_ORDER_TYPE = \'TO\'';
                        break;
            case '':
                        break;
        }
        try {
            
            $data = $this->findOneAssoc($sql, $orderNo);
            if ($data != null) {
                $pickOrder = new PickOrder();
                foreach ($data as $k => $v) {
                    $prop = strtolower($k);
                    $prop = str_replace('_', ' ', $prop);
                    $prop = ucwords($prop);
                    $prop = str_replace(' ', '', $prop);
                    $prop = strtolower($prop[0]) . substr($prop, 1);
                    $pickOrder->$prop = $v;
                }
                if ($pickOrder->pSameAsInvoiceTo == 'T') {
                    $pickOrder->dAddressLine1 = $pickOrder->pAddressLine1;
                    $pickOrder->dAddressLine2 = $pickOrder->pAddressLine2;
                    $pickOrder->dCity = $pickOrder->pCity;
                    $pickOrder->dState = $pickOrder->pState;
                    $pickOrder->dPostCode = $pickOrder->pPostCode;
                    $pickOrder->dCountry = $pickOrder->pCountry;
                }
            }
//            if (null != $pickOrder) {
//                list($pickOrder->subTotalAmount, $pickOrder->taxSubTotal) = $this->getPickOrderSubTotals($orderNo);
//            }
        } catch (Exception $e) {
            $this->lastError = $e->getCode() . ': ' . $e->getMessage();
            return false;
        }
        return $pickOrder;
    }
    
    /**
    * Fetches descriptions for ledgers codes by codes values or by codes labels
    * 
    * @param array   $codes        - array of codes, which keeps codes values or codes labels
    * @param string  $companyId    - company id to fetch codes descriptions
    * @param string  $screenName   - screen name to fetch default codes, if $defaultCodes == false, $screenName should always be null
    * @param boolean $defaultCodes - true - searches codes by codes value, false - searches codes by lables
    * @return array                - array of codes descriptions in form array('by_label' => array('code_label' => 'code_value'), 'by_code' => array('code_value' => 'code_description'))
    *                                if $defaultCodes == false, $result['by_labels'] will be NULL
    * 
    * @throws Exception - database query error
    */
    public function getLedgerCodesDescriptions(array $codes, $companyId, $screenName = null, $defaultCodes = false) {
        $result = array('by_label' => null, 'by_code' => array());
        
        $companyId  = strtoupper($companyId);
        $screenName = strtoupper($screenName);
        
        if ($defaultCodes) {
            $result['by_label'] = array();
            $defaulCodeSQL      = "SELECT DESCRIPTION FROM OPTIONS WHERE GROUP_CODE ='CMPLGRCODE' AND CODE = ?";
            
            foreach ($codes as $codeLabel) {
                $tmpOptionsCode                                     = $companyId.'|'.strtoupper($codeLabel).'|'.$screenName;
                $result['by_label'][$codeLabel]                     = $this->fetchOne($defaulCodeSQL, $tmpOptionsCode);
                $result['by_code'][$result['by_label'][$codeLabel]] = '';
            }
        } else {
            foreach ($codes as $codeValue) {
                $result['by_code'][$codeValue] = '';
            }
        }

        $codeDescriptionSQL = "SELECT DESCRIPTION FROM CHART_OF_ACCOUNTS WHERE (COMPANY_ID = ? OR COMPANY_ID IS NULL) AND CODE = ?";
        foreach ($result['by_code'] as $codeValue => $description) {
            $result['by_code'][$codeValue] = $this->fetchOne($codeDescriptionSQL, $companyId, $codeValue);
        }
        
        return $result;
        
    }

    public function getPickItem($pickOrder, $lineNo) {
        
        $sql = "SELECT * FROM PICK_ITEM WHERE PICK_ORDER = ? AND PICK_ORDER_LINE_NO = ?";
        $row = $this->findOneAssoc($sql, $pickOrder, $lineNo);
        $pickItem = new PickItem($row);
        $pickItem->id = $row['PICK_LABEL_NO'];
        return $pickItem;
    }

    public function getPickItemById($id) {
        
        $sql = 'SELECT * FROM PICK_ITEM WHERE PICK_LABEL_NO = ?';
        $row = $this->fetchAssoc($sql, $id);
        if (false === $row) {
            return false;
        }
        return new PickItem($row);
    }

    /**
     * @param  int $id
     * @return int|string
     */
    public function getPickItemTaxRate($id) {
        
        $prodId = $this->fetchOne('SELECT PROD_ID FROM PICK_ITEM WHERE PICK_LABEL_NO = ?', $id);
        if ($prodId === false) {
            return null;
        }
        $ok = false;
        if ($prodId) {
            $sql = "SELECT 1 FROM
                PROD_PROFILE AS pp INNER JOIN PICK_ITEM AS pi
                ON pp.PROD_ID = pi.PROD_ID WHERE pp.TAX_APPLICABLE = 'T' AND pi.PICK_LABEL_NO = ?";
            $ok = $this->fetchOne($sql, $id);
        } else {
            $ok = true;
        }
        if ($ok) {
            return $this->fetchOne('SELECT DEFAULT_GST_RATE FROM CONTROL');
        }
        return 0;
    }

    public function getDevicesForAllocating() {
        
        $devices = array();

        $sql = "SELECT DEVICE_ID, EQUIPMENT_DESCRIPTION_CODE, CURRENT_PERSON FROM SYS_EQUIP WHERE DEVICE_TYPE = 'HH' ORDER BY DEVICE_ID";
        foreach ($this->findAll($sql) as $data) {
            $deviceId = $data[0];
            $data[] = $this->findValue("SELECT COUNT(*) FROM PICK_ITEM WHERE DEVICE_ID = ?", $deviceId);
            $devices[$data[0]] = $data;
        }


        return $devices;
    }
    /**
    * @desc return array structures of PICK_ITEMS
    * @param string $pickOrder
    * @return array of structures - $pickItems
    */
    public function getPickItemList($pickOrder) {
        
        $pickItems = array();

        $sql = "SELECT *
                FROM PICK_ITEM
                WHERE PICK_ORDER = ?";

        $lines = $this->findAllAssocMod($sql, $pickOrder);
        foreach ($lines as $key => $line) {
            $pickItems[$line['PICK_LABEL_NO']] = $line;
        }

        return $pickItems;
    }

    /**
    * @desc return array objects of PICK_ITEMS
    * @param string $pickOrder
    * @return array of objects - $pickItems
    */
    public function getPickItems($pickOrder) {
        
        $pickItems = array();

        $sql = "SELECT *
                FROM PICK_ITEM
                WHERE PICK_ORDER = ?";

        $lines = $this->findAllAssoc($sql, $pickOrder);
        foreach ($lines as $key => $line) {
            $pickItem = new PickItem($line);
            $pickItem->id = $pickItem['PICK_LABEL_NO']; ;
            $pickItems[$key] = $pickItem;
        }

        return $pickItems;
    }
    
    public function searchdPickItem( $pickItem  )
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);

        list($sql, $sqlOrder) =  $this->getSelectQuery("F", "PICK_ITEM");
        
        $sql = preg_replace('/\s+/', ' ', $sql);
        $strSearchQuery = "when(PICK_ITEM.PROD_ID IS NULL OR PICK_ITEM.PROD_ID = '') then (select SSN.SSN_DESCRIPTION from SSN where SSN.ssn_id = PICK_ITEM.ssn_id)";
        $strReplaceQuery = "when(PICK_ITEM.PROD_ID IS NULL OR PICK_ITEM.PROD_ID = '')         
                            then 
                            (
                                case when ((select SSN.SSN_DESCRIPTION from SSN where SSN.ssn_id = PICK_ITEM.ssn_id) is not null)
                                THEN
                                (
                                    select SSN.SSN_DESCRIPTION from SSN where SSN.ssn_id = PICK_ITEM.ssn_id
                                )
                                else
                                (
                                    select description from options where group_code = 'RET_REASON' and code = PICK_ITEM.reason
                                )
                                end
                            )";
        if (stripos($sql, $strSearchQuery) !== false) {
            $sql = str_ireplace($strSearchQuery, $strReplaceQuery, $sql);
        }

        $sql .= " WHERE  PICK_ITEM.PICK_LABEL_NO = ? ";
        
        $values = array( $pickItem );
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $data   = $this->findAllAssocMod($sql, $values);
        
        return $data[0];
    }

    public function getPickItemsByPickOrders(array $pickOrders = array(), $clause = null, $pageNo, $resultsPerPage, $pickOrderTable = null) {
        
        $lines = array();

        if (!count($pickOrders)) {
            return $lines;
        }
        
        $where  =   'WHERE 1=1 AND ';
        if(!is_null($clause)) {
            foreach($clause as $key => $value) {
                $where .= $key;
            }
        }
        
        $args = array();
        $pickOrderClause = is_null($pickOrderTable) ? 'PICK_ORDER = ? OR ' : ($pickOrderTable . '.PICK_ORDER = ? OR ');
        foreach ($pickOrders as $pickOrder) {
            $args[] .= $pickOrder;
            $where  .= $pickOrderClause;
        }
        
        $where  =   substr($where, 0, -4);
        
        
        list($sql, $sqlOrder) =  $this->getSelectQuery("T", "PICK_ITEM");
        
        $sql .= ' ' . $where . ' ' . $sqlOrder;
        
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        
        $total  = $this->findValue($sqlCount, $args);
        $data   = $this->findAllAssocMod($sqlQuery, $args);
        
        $result['total'] = $total;
        
        if (count($data) > 0) {
            $pickItems = array();
            
            foreach($data as $row) {
                //$tmpPickItem = $this->searchdPickItem($row['PICK_LABEL_NO']);
                //$pickItem       = new PickItem($tmpPickItem);
                $pickItem       = new PickItem($this->searchdPickItem($row['PICK_LABEL_NO']));
                $pickItem->id   = $row['PICK_LABEL_NO'];
                
                $result['data'][$row['PICK_LABEL_NO']]  = $pickItem;
            }
            
       } else {
             $result['all'] = $result['data']  = array();
        }
        
        return $result;
    }

    public function getPickItemsForAllocating($clause, $pageNo = 0, $resultsPerPage = 15) {
        
        $cond = '';
        $args = array();

        if ($this->limitCompany != 'all') {
            $cond = $cond . 'AND PICK_ORDER.COMPANY_ID = ? ';
            $args[] = $this->limitCompany;
        }
        if ($this->limitWarehouse != 'all') {
            $cond = $cond . 'AND PICK_ORDER.WH_ID = ? ';
            $args[] = $this->limitWarehouse;
        }

        $items = array();
        $where = '';
        
        foreach($clause as $key => $value) {
            $where .= $key;
            if(!empty($value)) { 
                $args[] = $value;
            }  
        }
            $where = substr($where, 0, strlen($where)-5);
    
        $sql = "SELECT PICK_ITEM.PICK_LABEL_NO, 
                       CASE WHEN (PICK_ITEM.PROD_ID IS NULL) 
                            THEN ISSN.PROD_ID 
                            ELSE PICK_ITEM.PROD_ID 
                       END as PROD_ID, 
                       PROD_PROFILE.SHORT_DESC, 
                       PICK_ITEM.PICK_ORDER_QTY, 
                       PICK_ITEM.PICK_ORDER, 
                       PICK_ORDER.PICK_PRIORITY, 
                       PICK_ORDER.PICK_DUE_DATE, 
                       PICK_ORDER.WH_ID, 
                       PICK_ORDER.COMPANY_ID, 
                       PICK_ORDER.D_FIRST_NAME || PICK_ORDER.D_LAST_NAME as NAME 
                FROM PICK_ORDER  
                JOIN PICK_ITEM ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
                LEFT JOIN ISSN ON PICK_ITEM.SSN_ID = ISSN.SSN_ID
                LEFT JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID 
                LEFT JOIN PROD_PROFILE ON (PICK_ITEM.PROD_ID = PROD_PROFILE.PROD_ID OR ISSN.PROD_ID = PROD_PROFILE.PROD_ID) 
                WHERE PICK_ORDER.PICK_STATUS IN ('OP', 'DA') AND PICK_ITEM.PICK_LINE_STATUS IN ('OP', 'UP') AND " . $where . "  
                ORDER BY 2 ASC, PICK_ORDER.PICK_PRIORITY ASC, PICK_ORDER.PICK_DUE_DATE ASC, PICK_ITEM.PICK_ORDER ASC";
      
        if (false === ($values = $this->prepareArgs($sql, $args))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
       
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage); 
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);
       
        $result['total'] = $total;
        $result['data']  = $data;
        
        return $result; 
    
    }
   
    public function getPickItemsForAllocatingCount($pageNo = 0, $resultsPerPage = 15, $dueDate = '', $prodId = '') {
        
        $cond = '';
        $args = array();
        if ($this->limitCompany != 'all') {
            $cond = $cond . 'AND PICK_ORDER.COMPANY_ID = ? ';
            $args[] = $this->limitCompany;
        }
        if ($this->limitWarehouse != 'all') {
            $cond = $cond . 'AND PICK_ORDER.WH_ID = ? ';
            $args[] = $this->limitWarehouse;
        }
        if ($dueDate !== '') {
            $args[] = $dueDate;
            $dueDate = ' AND PICK_DUE_DATE = ?';
        }
        if ($prodId !== '') {
            $args[] = $prodId;
            $prodId = ' AND PICK_ITEM.PROD_ID = ?';
        }

        $sql = "SELECT COUNT(PICK_ITEM.PROD_ID) 
                FROM PICK_ITEM JOIN PICK_ORDER ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER JOIN PROD_PROFILE ON PROD_PROFILE.PROD_ID = PICK_ITEM.PROD_ID 
                WHERE PICK_LINE_STATUS IN ('OP', 'UP') AND PICK_ORDER.PICK_ORDER IN (SELECT DISTINCT PICK_ORDER FROM PICK_ORDER WHERE PICK_STATUS IN ('OP', 'DA')) $dueDate $prodId";
        array_unshift($args, $sql);
        return call_user_func_array(array($this, 'findValue'), $args);
    }


    /**
     * get searched for GrnLine object
     *
     * @param string $grnId - GRN's GRN to Get
     * @return  GrnLine
     */
    public function searchdPickOrder( $pickOrder  )
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);

        list($sql, $sqlOrder) =  $this->getSelectQuery( "F", "PICK_ORDER");
    $sql .= "
                        WHERE  PICK_ORDER.PICK_ORDER = ? 
                    ";
        // New code
        $values = array( $pickOrder );
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $data   = $this->findAllAssocMod($sql, $values);
  
        return $data[0];
    }

    protected function _formatPickOrderConditionsForSalesOrderScreen($criteria, &$args) {
        if ($criteria == null) {
            $criteria = array();
        }
        $cond = 'WHERE 1=1 AND ';
        $args = is_array($args)? $args : array();

        if (count($criteria) > 0) {
            foreach ($criteria as $key => $val) {
                if (($offs = strpos($key, '?')) !== false ) {
                    $args[] = $val;

                    while (($offs = strpos($key, '?', ++$offs)) !== false)
                        $args[] = $val;
                    $cond  .= $key;
                } elseif(!empty($key) && empty($value)){
                    $cond .= $key;
                }
            }
        }
        $cond = substr($cond, 0, -5);
        $cond .= " AND PICK_ORDER.PICK_STATUS <> 'CN'"
            . (($this->isAdmin || $this->isSalesManagerT() || $this->isCreditManagerT())  ? '' : " AND PICK_ORDER.PICK_STATUS <> 'DX'"); // fixed for sales and credit manager
        $cond .= $this->getWarehouseAndCompanyLimit( 0, false, "PICK_ORDER.", "PICK_ORDER.");
        return substr($cond, 0, -5);
    }

    /**
     * @return array Returns an array of
     */
    public function getPickOrders($criteria = null, $pageNo = '', $resultsPerPage = '', $dbFields = array()) {
        
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);

        list($sql, $sqlOrder) =  $this->getSelectQuery( "T", "PICK_ORDER");

        $args = array();
        $sql .= " " . $this->_formatPickOrderConditionsForSalesOrderScreen($criteria, $args). " " . $sqlOrder;
        
        $log->info($sql . ' : ' . implode(',', $args));
      
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);

        $total  = $this->findValue($sqlCount, $args);
        $data   = $this->findAllAssocMod($sqlQuery, $args);
        
        $result['total'] = $total;
        if (count($data) > 0) {
            foreach($data as $row) {
                $pickOrders = $this->searchdPickOrder( $row['PICK_ORDER']);
                $d = explode(' ', $pickOrders['PICK_DUE_DATE']);
                $pickOrders['PICK_DUE_DATE'] = $d[0];
                $result['data'][$pickOrders['PICK_ORDER']]  = $pickOrders; 
            }
        } else {
             $result['all'] = $result['data']  = array();
        }
        
        return $result;
    }

    /**
     * @param array|null $criteria
     * @return array
     */
    public function getPickOrderIds($criteria = null) {
        list($sql, $sqlOrder) =  $this->getSelectQuery( "T", "PICK_ORDER");

        $args = array();
        $sql .= " " . $this->_formatPickOrderConditionsForSalesOrderScreen($criteria, $args). " " . $sqlOrder;

        $data   = $this->findAllAssocMod($sql, $args);
        $result = array();

        if (count($data) < 1)
            return $result;

        foreach($data as $row)
            $result[$row['PICK_ORDER']] = $row['PICK_ORDER'];

        return $result;
    }

    /**
     * @deprecated
     * @return void
     */
    public function getPickOrdetTotalsForSalesOrderScreen($criteria) {
        $args = array();
        $sql = 'SELECT SUM(COALESCE(PICK_ORDER.DUE_AMOUNT, 0)) AS TOTAL_DUE_AMOUNT FROM ' . $this->_formatFromPart($this->_getScreenNameByScreenType('PICK_ORDER'));
        $sql .= ' ' . $this->_formatPickOrderConditionsForSalesOrderScreen($criteria, $args);
        array_unshift($args, $sql);

        $result = array('TOTAL_DUE_AMOUNT' => 0);

        if (false !== ($queryResult = call_user_func_array(array($this, 'fetchAssoc'), $args))) {
            $result = $queryResult;
        }

        return $result;
    }
    
    /**
     *
     * @return array Returns an array of
     */
    public function getDespatchedPickOrders($criteria = null, $pageNo = '', $resultsPerPage = '', $dbFields = array()) {
        
        if ($criteria == null) {
            $criteria = array();
        }

        $cond = '';
        $args = array();
        $pickLabelNo = null;
        if (count($criteria) > 0) {
              $cond = 'WHERE 1=1 AND ';
              foreach ($criteria as $key => $val) {
                   if (false !== strpos($key, '?')) {
                        $args[] = $val;
                        $cond  .= $key;
                   } elseif(!empty($key) && empty($value)){
                        $cond .= $key;
                   }
              }
        }
                $cond = substr($cond, 0, -5);
                
        // #270 and #313.
        if (!empty($cond)) {
            $cond .= " AND PICK_ORDER.PICK_STATUS <> 'CN'"
                . ($this->isAdmin ? '' : " AND PICK_ORDER.PICK_STATUS <> 'DX'");
        } else {
            $cond .= " WHERE PICK_ORDER.PICK_STATUS <> 'CN'"
                . ($this->isAdmin ? '' : " AND PICK_ORDER.PICK_STATUS <> 'DX'");
        }

        if ($this->limitCompany != 'all') {
            $cond .= " AND PICK_ORDER.COMPANY_ID = ?";
            $args[] = $this->limitCompany;
        } else {
            if (!$this->isAdmin && !$this->isInventoryOperator) {
                $companyList = $this->getCompanyList();
                if (count($companyList) > 0 ) {
                    $cond .= " AND PICK_ORDER.COMPANY_ID IN (";
                    foreach ($companyList as $key => $val) {
                        $cond .= '?, ';
                        $args[] = $val;
                    }
                    $cond = substr($cond, 0, -2) . ')';
                }
            }
        }

        if ($this->limitWarehouse != 'all') {
            $cond .= ' AND PICK_ORDER.WH_ID = ?';
            $args[] = $this->limitWarehouse;
        } else {
            $warehouseList = $this->getWarehouseList();
            if (count($warehouseList) > 0 ) {
                $cond .= ' AND PICK_ORDER.WH_ID IN (';
                foreach ($warehouseList as $key => $val) {
                    $cond .= '?, ';
                    $args[] = $key;
                }
                $cond = substr($cond, 0, -2) . ')';
            }
        }
        
        
        if ($this->isAdmin) {
            
            $filteredColumns    =   array('PICK_ORDER.PICK_ORDER');
            $select             =   '';
            $from               =   '';
            if(count($dbFields['db_fileds']) > 0){
                for($i=0; $i < count($dbFields['db_fileds']); $i++){
                    if(!in_array($dbFields['db_fileds'][$i], $filteredColumns)){
                       $select .= $dbFields['fileds'][$i] . ', '; 
                       $from   .= $dbFields['db_fileds'][$i] . ', '; 
                    }
                }
            }
            
            $sql = "SELECT DISTINCT
                        $select
                        PICK_ORDER
                        FROM (
                            SELECT
                            $from
                            PICK_ORDER.PICK_ORDER,
                            CASE WHEN PICK_ORDER.RETURN_DATE IS NOT NULL
                                THEN (DIFFDATE( PICK_ORDER.PICK_DUE_DATE, PICK_ORDER.RETURN_DATE,4) + 1)
                            END AS AGEDAYS,
                            
                            
                            CASE WHEN PICK_ITEM.PICK_LABEL_NO IS NULL
                                THEN PICK_ITEM_CANCEL.PICK_LABEL_NO
                            ELSE PICK_ITEM.PICK_LABEL_NO
                            END AS PICK_LABEL_NO
                            
                            
                            
                            FROM PICK_ORDER
                            LEFT OUTER JOIN PICK_ITEM ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER
                            LEFT OUTER JOIN PICK_ITEM_CANCEL ON PICK_ITEM_CANCEL.PICK_ORDER = PICK_ORDER.PICK_ORDER
                            LEFT OUTER JOIN PERSON ON PICK_ORDER.PERSON_ID = PERSON.PERSON_ID $cond)";
                
                if ($pickLabelNo) {
                    $sql .= ' WHERE PICK_LABEL_NO = ?';
                    $args[] = $pickLabelNo;
                }
                $sql .= ' ORDER BY PICK_ORDER DESC';

        } else {
            
            $filteredColumns    =   array('PICK_ORDER.PICK_ORDER');
            $select             =   '';
            $from               =   '';
            if(count($dbFields['db_fileds']) > 0){
                for($i=0; $i < count($dbFields['db_fileds']); $i++){
                    if(!in_array($dbFields['db_fileds'][$i], $filteredColumns)){
                       $select .= $dbFields['db_fileds'][$i] . ', '; 
                       $from   .= $dbFields['db_fileds'][$i] . ', '; 
                    }
                }
            }
            
            if ($pickLabelNo) {
                array_unshift($args, $pickLabelNo);
                $join = ' INNER JOIN PICK_ITEM ON (PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER AND PICK_ITEM.PICK_LABEL_NO = ?)';
            }  else {
                $join = '';
            }
            $sql = "SELECT  
                            $select
                            PICK_ORDER.PICK_ORDER,
                            CASE WHEN PICK_ORDER.RETURN_DATE IS NOT NULL
                                THEN (DIFFDATE( PICK_ORDER.PICK_DUE_DATE, PICK_ORDER.RETURN_DATE,4) + 1)
                            END AS AGEDAYS
                                          
                    FROM PICK_ORDER$join
                    LEFT OUTER JOIN PICK_ITEM ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER
                    LEFT OUTER JOIN PERSON ON PICK_ORDER.PERSON_ID = PERSON.PERSON_ID $cond
                    ORDER BY PICK_ORDER.PICK_ORDER DESC";
        }
        
        
        
        $log = Zend_Registry::get('logger');
        $log->info('getPickOrders()');
        $log->info($sql . ' : ' . implode(',', $args));
      
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
      
        $all    = $this->findAllAssocMod($sql, $args);
        $total  = $this->findValue($sqlCount, $args);
        $data   = $this->findAllAssocMod($sqlQuery, $args);
        $result['total'] = $total;
        if (count($data) > 0) {
            $pickOrders = array();
            foreach($data as $row) {
                $d = explode(' ', $row['PICK_DUE_DATE']);
                $row['PICK_DUE_DATE'] = $d[0];
                $result['data'][$row['PICK_ORDER']]  = $row; 
            }
            
            foreach($all as $row) {
                $d = explode(' ', $row['PICK_DUE_DATE']);
                $row['PICK_DUE_DATE'] = $d[0];
                $result['all'][$row['PICK_ORDER']]  = $row;    
            }
        } else {
             $result['all'] = $result['data']  = array();
        }
        
        return $result;
    }

    public function getPickOrdersForAllocating($clause, $pageNo = 0, $resultsPerPage = 15) {
        
        $cond = '';
        $args = array();
        if ($this->limitCompany != 'all') {
            $cond = $cond . 'AND PICK_ORDER.COMPANY_ID = ? ';
            $args[] = $this->limitCompany;
        }
        if ($this->limitWarehouse != 'all') {
            $cond = $cond . 'AND PICK_ORDER.WH_ID = ? ';
            $args[] = $this->limitWarehouse;
        }
        
        $where = '';
        
        foreach($clause as $key => $value) {
            $where .= $key;
            if(!empty($value)) { 
                $args[] = $value;
            }  
        }
            $where = substr($where, 0, strlen($where)-5);
        
        $pickOrders = array();
        $sql = "SELECT PICK_ORDER.PICK_ORDER, 
                       PICK_ORDER.PICK_STATUS, 
                       PICK_ORDER.PICK_PRIORITY, 
                       PICK_ORDER.PICK_DUE_DATE, 
                       PICK_ORDER.PERSON_ID, 
                       PICK_ORDER.D_FIRST_NAME, 
                       PICK_ORDER.CUSTOMER_PO_WO, 
                       PICK_ORDER.SHIP_VIA, 
                       PICK_ORDER.WH_ID, 
                       PICK_ORDER.COMPANY_ID 
                FROM PICK_ORDER 
                     LEFT OUTER JOIN PERSON ON PICK_ORDER.PERSON_ID = PERSON.PERSON_ID WHERE PICK_ORDER.PICK_ORDER IN (SELECT PICK_ORDER FROM PICK_ITEM WHERE PICK_LINE_STATUS IN ('OP', 'UP')) AND PICK_ORDER.PICK_STATUS IN ('OP', 'DA') AND " . $where . " 
                ORDER BY PICK_ORDER ASC";
        
        if (false === ($values = $this->prepareArgs($sql, $args))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage); 
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);
        
        $result['total'] = $total;
        $result['data']  = $data;
        
        return $result;
    }

    /**
     *
     * @return integer The total number of records matching the provided criteria
     */
    public function getPickOrdersCount($criteria = null) {
        
        if ($criteria == null) {
            $criteria = array();
        }
        if ($this->limitCompany != 'all') {
            $criteria['company_id'] = $this->limitCompany;
        }
        if ($this->limitWarehouse != 'all') {
            $criteria['wh_id'] = $this->limitWarehouse;
        }

        $cond = '';
        $args = array();
        if (count($criteria) > 0) {
            $cond = 'WHERE ';
            foreach ($criteria as $k => $v) {
                if ($k == 'from_create_date') {
                    $k = 'create_date >= ? ';
                } else if ($k == 'to_create_date') {
                    $k = 'create_date <= ? ';
                } else {
                    $k = $k . ' = ? ';
                }
                $cond = $cond . 'pick_order.' . $k . 'AND ';
                $args[] = $v;
            }
            $cond = substr($cond, 0, -4);
        }

        $sql = "SELECT COUNT(PICK_ORDER.PICK_ORDER) FROM PICK_ORDER LEFT OUTER JOIN PERSON ON PICK_ORDER.PERSON_ID = PERSON.PERSON_ID $cond";
        array_unshift($args, $sql);
        return call_user_func_array(array($this, 'findValue'), $args);
    }

    /**
     * Return the order number associated with the GRN number
     *
     * @param string $grnNo GRN number
     *
     * @return string return empty string if query is empty or fail
     */
    public function getOrderNoFromGrnNo($grnNo) {
        
        return $this->fetchValue("SELECT ORDER_NO FROM GRN WHERE GRN = ?", $grnNo);
    }
    /**
     * Returns an array indicating which note tabs should be shown on the
     * pick order screens.
     *
     * @return array List of Instructions, Other Notes, Remarks, Footer
     */
    public function getPickOrderNotesList() {
        
        return $this->getOptionsList('ORD_NOTES');
    }

    public function getPickOrderStatusList() {
        
        return $this->getExtOptionsList('PICK_STATU');
    }

    /**
     * Return an array of package bases
     *
     * @return array
     */
    public function getPackageBaseList() {
        
        return $this->getExtOptionsList('PICK_BASE');
    }

    /**
     * Return an array of all the packaging owners ordered by DESCRIPTION. The
     * CODE will be the key and the DESCRIPTION will be the value
     *
     * @return array return empty array if query is empty or fail
     */
    public function getPackagingOwnerList() {
        
        return $this->getExtOptionsList('PACK_OWNER');
    }

    /**
     * Return an array of all the packaging types ordered by DESCRIPTION. The
     * CODE will be the key and the DESCRIPTION will be the value
     *
     * @return array return empty array if query is empty or fail
     */
    public function getPackagingTypeList(){
   
        return $this->getExtOptionsList('PACK_TYPE');
    }

    /**
     * Return an array of all the pallet owners ordered by DESCRIPTION. The
     * CODE will be the key and the DESCRIPTION will be the value
     *
     * @return array return empty array if query is empty or fail
     */
    public function getPalletOwnerList() {
    
        return $this->getExtOptionsList('PALL_OWNER');
    }

    /**
     * Return an array of payment methods
     *
     * @return array
     */
    public function getPaymentMethodList() {
        
        $sql = "SELECT PAYMENT_METHOD, PAYMENT_METHOD FROM PAYMENT_METHODS ORDER BY 1";

        return $this->findList($sql);
    }

    /**
     * Return an array of payment terms
     *
     * @return array
     */
    public function getPaymentTermsList() {
        
        $sql = "SELECT TERM, TERM FROM TERMS ORDER BY 1";

        return $this->findList($sql);
    }
    
    /**
    * Return Person address list.
    * 
    * @param array | NULL $addrTypeFilter       - array of ADDR_TYPE values to filter by, if null no filter applyed
    * @param array | NULL $format               - array of fields to use as CAPTIONS for dropdown list, if null $keyFieldName is used
    * @param array | NULL $addrStatusFilter     - array of ADDR_STATUS values to filter by, if null no filter applyed
    * @param array | null $fieldsMapping        - describe which field of reference table correspond to which field of target table
    * @param array | NULL $additionalConditions - array of conditions tu filter resultset (for example array('PERSON_ID' => 'WELD001'))
    * @param string| NULL $action               - action type: get_list          - fetch list to populate dropdown input, method should return array($key => $value)
    *                                                          get_value         - get single value from list by $searchValue
    *                                                          get_default_value - get single value using $defultSQL and $additionalConditions
    *                                                          populate_fields   - populate target table fields using $searchValue
    * @param mixed        $searchValue          - value to search list by
    * @param string| NULL $defaultSQL           - SQL expression to get default value for list
    * @return mixed
    * 
    * @throws Exception
    */
    public function getPersonAddressList(array $addrTypeFilter = NULL, array $format = NULL, array $addrStatusFilter = NULL, array $fieldsMapping, array $additionalFilter = null, $action = 'get_list', $searchValue = null, $defaultSQL = null) {
        if (null === $format) {
            $format = array($keyFieldName);
        }
        
        if (false === ($allowedFields = $this->getFieldList('PERSON_ADDRESS'))) {
            throw new Exception($this->lastError);
        }
        
        $selectFields = array_intersect($format, $allowedFields);
        $orderBy      = null;
        
        if (count($selectFields)) {
            reset($selectFields);
            $orderBy = current($selectFields);
        }
        
        if (!in_array('RECORD_ID', $selectFields))
            $selectFields[] = 'RECORD_ID';
        
        $filter = array();
        $args   = array();
        
        if (null !== $addrTypeFilter) {
            $tmpFilter = array();
            foreach ($addrTypeFilter as $value) {
                $tmpFilter[] = '?';
                $args[]      = $value;
            }
            $filter[] = 'ADDR_TYPE IN (' . implode(', ', $tmpFilter) . ')';
        }
        
        if (null !== $addrStatusFilter) {
            $tmpFilter = array();
            foreach ($addrStatusFilter as $value) {
                $tmpFilter[] = '?';
                $args[]      = $value;
            }
            $filter[] = 'ADDR_STATUS IN (' . implode(', ', $tmpFilter) . ')';
        }
        
        $allowedFilters = array('PERSON_ID' => 'PERSON_ID');
            
        if ($additionalFilter === null)
            $additionalFilter = array();
            
        $tmpAdditionalFilter = array_intersect_key($additionalFilter, $allowedFilters);
        
        if (($action == 'get_default_value') && ($searchValue !== true)) {
            //use only additional filters for substituting into $defaultSQL
            $filter = array();
            $args   = array();
        }
        
        foreach ($tmpAdditionalFilter as $key => $value) {
            $filter[] = strtoupper($key) . ' = ?';
            $args[]   = $additionalFilter[$key];
        }
        
        switch ($action) {
            case 'get_list':
                $sql = 'SELECT DISTINCT ' . implode(', ', $selectFields) . ' FROM PERSON_ADDRESS';
        
                if (count($filter)) {
                    $sql .= ' WHERE ' . implode(' AND ', $filter);
                }
        
                if ($orderBy !== NULL) {
                    $sql .= ' ORDER BY ' . $orderBy . ' ASC';
                }

                array_unshift($args, $sql);
                $queryResult = call_user_func_array(array($this, 'fetchAllAssoc'), $args);
                $result      = array();
        
                foreach ($queryResult as $row) {
                    $tmpArr = array();
                    foreach ($format as $field) {
                        if (array_key_exists($field, $row)) {
                            $tmpArr[] = $row[$field];
                        } else {
                            $tmpArr[] = $field;
                        }
                    }
                    $result[$row['RECORD_ID']] = implode(' ', $tmpArr);
                }
                break;
            case 'get_default_value':
                $whereClause = '';
                if (count($filter)) {
                    $whereClause = implode(' AND ', $filter) . ' ';
                    
                    if (stripos($defaultSQL, ' where ') === false) {
                        $whereClause = ' WHERE ' . $whereClause;
                    } else {
                        $whereClause = ' AND ' . $whereClause;
                    }
                }
                
                $pattern = array('{WHERE_SECTION}');
                $replace = array($whereClause);
                
                $sql = str_ireplace($pattern, $replace, 'SELECT FIRST 1 RECORD_ID' . stristr($defaultSQL, ' FROM '));
                array_unshift($args, $sql);
                $result = call_user_func_array(array($this, 'findValue'), $args);
                break;
            case 'populate_fields':
                $result = array();
                
                $selectFields = array_intersect(array_keys($fieldsMapping), $allowedFields);
                
                if (count($selectFields)) {
                    $sql = 'SELECT FIRST 1 ' . implode(', ', $selectFields) . ' FROM PERSON_ADDRESS WHERE RECORD_ID = ?';
                    $sqlResult = $this->findOneAssoc($sql, $searchValue);
                    
                    foreach ($fieldsMapping as $refField => $targetField) {
                        $result[$targetField] = (isset($sqlResult[$refField])) ? $sqlResult[$refField] : '';
                    }
                }
                
                break;
            default:
                throw new Exception("Uncknown action name '$action'");
            
        }
        
        return $result;
    }

    public function getPerson($personId, $isUsedPersonAddressTable = false, $addressType = 'OF') {
        
        $person =   null;
        
        if($isUsedPersonAddressTable) {
                    
            $sql = 'SELECT * 
                    FROM PERSON_ADDRESS 
                    WHERE ADDR_TYPE = ? AND
                          PERSON_ID = ? ';
            $sql = 'SELECT PERSON_ADDRESS.* ,PERSON.STATUS
                    FROM PERSON
                    JOIN PERSON_ADDRESS ON PERSON.PERSON_ID = PERSON_ADDRESS.PERSON_ID
                    WHERE PERSON.PERSON_ID = ?
                    AND   PERSON_ADDRESS.ADDR_TYPE = ? '; 
            
            //$row =   $this->findOneAssoc($sql, $addressType, $personId);
            $row =   $this->findOneAssoc($sql, $personId,  $addressType );
            
            if(!empty($row)){
                
                $person = new Person();
                $person->personId           = $row['PERSON_ID'];
                $person->personType         = $row['PERSON_TYPE'];
                $person->firstName          = $row['ADDR_FIRST_NAME'];
                $person->lastName           = $row['ADDR_LAST_NAME'];
                $person->addressLine1       = $row['ADDR_LINE1'];
                $person->addressLine2       = $row['ADDR_LINE2'];
                $person->city               = $row['ADDR_CITY'];
                $person->state              = $row['ADDR_STATE'];
                $person->postcode           = $row['ADDR_POST_CODE'];
                $person->country            = $row['ADDR_COUNTRY'];
                $person->telephone          = $row['ADDR_PHONE_NO'];
                $person->status             = $row['STATUS'];
                    
                return $person;
            }
        }
        
        $sql    = "SELECT * 
                   FROM PERSON 
                   WHERE PERSON_ID = ?";
                   
        $row    = call_user_func_array(array($this, 'fetchAssoc'), $this->prepareArgs(array($sql, $personId)));
        
        if ($row) {
            $person = new Person();
            $person->personId           = $row['PERSON_ID'];
            $person->personType         = $row['PERSON_TYPE'];
            $person->firstName          = $row['CONTACT_FIRST_NAME'];
            $person->lastName           = $row['CONTACT_LAST_NAME'];
            $person->mailAddress1       = $row['MAIL_ADDRESS1'];
            $person->mailAddress2       = $row['MAIL_ADDRESS2'];
            $person->mailCity           = $row['MAIL_CITY'];
            $person->mailState          = $row['MAIL_STATE'];
            $person->mailPostcode       = $row['MAIL_POST_CODE'];
            $person->mailCountry        = $row['MAIL_COUNTRY'];
            $person->contactAddress1    = $row['CONTACT_ADDRESS1'];
            $person->contactAddress2    = $row['CONTACT_ADDRESS2'];
            $person->contactCity        = $row['CONTACT_CITY'];
            $person->contactState       = $row['CONTACT_STATE'];
            $person->contactPostcode    = $row['CONTACT_POST_CODE'];
            $person->contactCountry     = $row['CONTACT_COUNTRY'];
            $person->telephone1         = $row['MAIL_PHONE'];
            $person->addressLine1       = $row['ADDRESS_LINE1'];
            $person->addressLine2       = $row['ADDRESS_LINE2'];
            $person->addressLine3       = $row['ADDRESS_LINE3'];
            $person->addressLine4       = $row['ADDRESS_LINE4'];
            $person->addressLine5       = $row['ADDRESS_LINE5'];
            $person->city               = $row['CITY'];
            $person->state              = $row['STATE'];
            $person->postcode           = $row['POST_CODE'];
            $person->country            = $row['COUNTRY'];
            $person->telephone          = $row['PHONE_NO'];
            $person->status             = $row['STATUS'];
        
        }
        
        return $person;
    }

    /**
     * Return a list of people
     *
     * @param mixed $type
     * @param string $q search value
     * @param integer $orderBy
     *
     * @return array
     */
    public function getPersonList($type, $q = null, $orderBy = 0) {
        $sql = "SELECT P.PERSON_ID, COALESCE(P.FIRST_NAME,'') || ' ' || COALESCE(P.LAST_NAME,'') AS CON_NAME FROM PERSON P WHERE";
        $args = array();
        $flag = 0;
        if ($q != null) {
            $q = strtoupper($q);
            $sql = $sql . " (UPPER(PERSON_ID) LIKE ? OR UPPER(FIRST_NAME) LIKE ? OR UPPER(LAST_NAME) LIKE ?) AND";
            $args[] = $q;
            $args[] = $q;
            $args[] = $q;
            $flag = 1;
        }
        if (is_array($type)) {
            $sql = $sql . " (PERSON_TYPE = ?";
            $args[] = $type[0];
            $c = count($type);
            for ($i = 1; $i < $c; $i++) {
                $sql = $sql . " OR PERSON_TYPE = ?";
                $args[] = $type[$i];
            }
            $sql = $sql . ")";
        } else {
            $sql = $sql . " PERSON_TYPE = ?";
            $args[] = $type;
        }
        if ($this->limitCompany != 'all') {
            $sql = $sql . " AND COMPANY_ID = ?";
            $args[] = $this->limitCompany;
        }

        switch ($orderBy) {
            case 2:
                $sql = $sql . " ORDER BY PERSON_ID";
                break;
            case 1:
                $sql = $sql . " ORDER BY CON_NAME";
                break;
            case 0:
            default:
                $sql = $sql . " ORDER BY CON_NAME, PERSON_ID";
        }
        array_unshift($args, $sql);
     
        $d = null;
        
        $query = ibase_prepare($this->db, $args[0]);
        if ($query !== false) {
            // Replace the SQL statement with the query
            $args[0] = $query;

            if ($flag) {
                $info = ibase_param_info($query, 0);
                $delta = $info['length'] - strlen($args[1]);
                switch (true) {
                    case $delta == 1:
                        for ($i = 1; $i <= 3; $i++) {
                            $args[$i] = substr($args[$i], 0, $info['length']) . '%';
                        }
                        break;

                    case $delta <= 0:
                        for ($i = 1; $i <= 3; $i++) {
                            $args[$i] = substr($args[$i], 0, $info['length']);
                        }
                        break;

                    default:
                        for ($i = 1; $i <= 3; $i++) {
                            $args[$i] = '%' . substr($args[$i], 0, $info['length']) . '%';
                        }
                }
            }
            $result = call_user_func_array('ibase_execute', $args);
            
            if ($result !== false) {
                $d = array();
                while (false !== ($row = ibase_fetch_row($result))) {
                    $d[(string)$row[0]] = (string)$row[1];
                }
                ibase_free_result($result);

            } else {
                ibase_free_query($query);
                throw new Exception('Unable to run query');
            }
            ibase_free_query($query);
        }

        if ($d === null) {
            throw new Exception('Unable to retrieve list');
        }
        else {
            return $d;
        }
    }
    
    /**
     * Return a list of people by PERSON.STATUS
     *
     * @param mixed $status
     * @param integer $orderBy
     *
     * @return array
     */
    
    public function getPersonListByStatus($type, $status, $mode = 1, $orderBy = 0) {
        
        if($mode == 1) {
            //$sql = "SELECT P.PERSON_ID, (SELECT * FROM NONULLP(P.FIRST_NAME)) || ' ' || (SELECT * FROM NONULLP(P.LAST_NAME)) AS CON_NAME FROM PERSON P WHERE";
            $sql = "SELECT P.PERSON_ID, COALESCE(P.FIRST_NAME,'') || ' ' || COALESCE(P.LAST_NAME,'') AS CON_NAME FROM PERSON P WHERE";
        } else {
//            $sql = "SELECT P.PERSON_ID, (P.PERSON_ID || ' ' || (SELECT * FROM NONULLP(P.FIRST_NAME))) AS CON_NAME FROM PERSON P WHERE";
            $sql = "SELECT P.PERSON_ID, COALESCE(P.FIRST_NAME,'') || ' ' || COALESCE(P.LAST_NAME,'') AS CON_NAME FROM PERSON P WHERE";
        }
        $args = array();
        
        if (is_array($type)) {
            $sql = $sql . " PERSON_TYPE IN (" . substr(str_repeat('?, ', count($type)), 0, -2) . ")";
            $args = array_merge($args, array_values($type));
        } else {
            $sql = $sql . " PERSON_TYPE = ?";
            $args[] = $type;
        }
        
        if (is_array($status)) {
            $sql = $sql . " STATUS IN (" . substr(str_repeat('?, ', count($status)), 0, -2) . ")";
            $args = array_merge($args, array_values($status));
        } else {
            $sql = $sql . " AND STATUS = ?";
            $args[] = $status;
        }
        
        $sql = $sql . " AND " . $this->formatCompanyLimit('P');

        switch ($orderBy) {
            case 2:
                $sql = $sql . " ORDER BY PERSON_ID";
                break;
            case 1:
                $sql = $sql . " ORDER BY CON_NAME";
                break;
            case 0:
            default:
                $sql = $sql . " ORDER BY CON_NAME, PERSON_ID";
        }
        array_unshift($args, $sql);

        $d = null;
        
        $query = ibase_prepare($this->db, $args[0]);
        if ($query !== false) {
            // Replace the SQL statement with the query
            $args[0] = $query;

            $result = call_user_func_array('ibase_execute', $args);
            
            if ($result !== false) {
                $d = array();
                while (false !== ($row = ibase_fetch_row($result))) {
                    $d[(string)$row[0]] = (string)$row[1];
                }
                ibase_free_result($result);

            } else {
                ibase_free_query($query);
                throw new Exception('Unable to run query');
            }

            ibase_free_query($query);
        }

        if ($d === null) {
            throw new Exception('Unable to retrieve list');
        }
        else {
            return $d;
        }
    }

    /**
     * get Person status list
     * key will be the CODE and value will be the DESCRIPTION.
     *
     * @return array
     */
    public function getPersonStatusList() {
        
        return $this->getExtOptionsList('PER_STATUS');
    }

    /**
     * Return an array of printers ordered by the DEVICE_ID. The DEVICE_ID will
     * be used for both the key and value.
     *
     * @return array return empty array if query is empty or fail
     */
    public function getPrinterList($override = false) {

        //$sql = "SELECT DEVICE_ID, DEVICE_ID
        //        FROM (SELECT SYS_EQUIP.DEVICE_ID, SYS_EQUIP.COMPANY_ID FROM SYS_EQUIP";
        $sql = "
            SELECT
                DEVICE_ID,
                DEVICE_ID || ' - ' || COALESCE(EQUIPMENT_DESCRIPTION_CODE, '')
            FROM SYS_EQUIP";

    // do company restriction
        if (!$override) {
            //-- if not limited by company
            if ($this->limitCompany != 'all') {
                $sql .= " WHERE SYS_EQUIP.COMPANY_ID = '" . $this->limitCompany . "' AND ";
            } else {
                //-- else assume all Companies accessible to User.
                if ($this->isAdmin || $this->isInventoryOperator) {
                    $sql .= " WHERE ";
                } else {
                    $companyList = $this->getCompanyList();
                    if (count($companyList) > 0 ) {
                        $sql .= ' WHERE SYS_EQUIP.COMPANY_ID IN (';
                        foreach ($companyList as $key => $val) {
                            $sql .= "'" . $val . "', ";
                        }
                        $sql = substr($sql, 0, strlen($sql) - 2);
                        $sql .= ') AND ';
                    } else {
                        $sql .= ' WHERE ';
                    }
                }
            }

            $sql .= " SYS_EQUIP.DEVICE_TYPE IN ('PR', 'PL', 'LP') ";
            $sql .= "   ORDER BY 1";
            return $this->findList($sql);
        } else {
            return Minder_SysScreen_Legacy_SysEquipManager::getFullPrinterList();
        }
    }

    /**
     * getPrinterIp
     *
     * @param string $printerId
     * @return string|false
     */
    public function getPrinterIp ($printerId) {
        
        $sql = 'SELECT IP_ADDRESS FROM SYS_EQUIP WHERE DEVICE_TYPE = \'PR\' AND DEVICE_ID = ?';

        return $this->findValue($sql, $printerId);
    }


    /**
     * return Printer object
     *
     * @param string|null $tableName
     * @param string|null $printer
     * @return Minder_Printer_Abstract
     */
    public function getPrinter($tableName=null, $printer = null) {
        
        $sql = 'SELECT CONTROL.GENERATE_LABEL_TEXT FROM CONTROL';
        if (false != ($mode = $this->findValue($sql))) {
            switch ($mode) {
                case 'T':
                    if ($printer != null) {
                        return new Minder_Printer_BarTender($printer);
                    } else {
                        return new Minder_Printer_BarTender();
                    }
                break;
                case 'F':
                    if ($printer != null) {
                        $p = new Minder_Printer_Native($printer);
                        $p->setTableName($tableName);
                        return $p;
                    } else {
                        $p = new Minder_Printer_Native();
                        $p->setTableName($tableName);
                        return $p;
                    }
                case 'O':
                default:
                    throw new Exception('Unknown GENERATE LABEL method "' . $mode . '"');
                    return false;
                break;
            }

        }
    }

    /**
     * Get work dir for selected device
     *
     * @param string $deviceId
     * @return string|false
     */
    public function getPrinterDir ($deviceId) {
        
        $sql = 'SELECT SYS_EQUIP.WORKING_DIRECTORY FROM SYS_EQUIP WHERE DEVICE_ID = ?';

        $result = $this->findValue($sql, $deviceId);

        return $result;
    }


    /**
     * Return a list of products
     *
     * @return array
     */
    public function getProductList($q = null) {
       
        $sql = "SELECT PROD_ID, SHORT_DESC FROM PROD_PROFILE";
        if ($q != null) {
            $q = strtoupper($q);
            $sql = $sql . " WHERE UPPER(PROD_ID) LIKE ?";
            $sql = $sql . " OR UPPER(SHORT_DESC) LIKE ?";
            $sql = $sql . " OR UPPER(SHORT_DESC) LIKE ?";
            
            $sql = $sql . " OR UPPER(LONG_DESC) LIKE ?";

        }
        $sql = $sql . " ORDER BY SHORT_DESC";
        if ($q !== null) {
            return $this->findList($sql, "%$q%", "%$q%", "%$q%", "%$q%");
        }
        
        return $this->findList($sql);
    }
    
    /**
    * Returns list of products sorted by PROD_ID
    * 
    * @return array
    */
    public function getProductListSortedById() {
        return $this->findList('SELECT PROD_ID, SHORT_DESC FROM PROD_PROFILE ORDER BY PROD_ID');
    }

    /**
     * Return a list of products with long description
     *
     * @return array
     */
    public function getProductLongDescriptionList($q = null) {
        
        $sql = "SELECT LONG_DESC, PROD_ID FROM PROD_PROFILE";
        if ($q != null) {
            $q = strtoupper($q);
            $sql = $sql . " WHERE UPPER(PROD_ID) LIKE ?";
            $sql = $sql . " OR UPPER(LONG_DESC) LIKE ?";

        }
        $sql = $sql . " ORDER BY LONG_DESC";
        if ($q !== null) {
            return $this->findList($sql, "%$q%", "%$q%" );
        }
        return $this->findList($sql);
    }

    /**
     * Return a list of products with long description
     *
     * @return array
     */
    public function getProductShortDescriptionList($q = null)
    {
        $sql = "SELECT SHORT_DESC, PROD_ID FROM PROD_PROFILE";
        if ($q != null) {
            $q = strtoupper($q);
            $sql = $sql . " WHERE UPPER(PROD_ID) LIKE ?";
            $sql = $sql . " OR UPPER(SHORT_DESC) LIKE ?";

        }
        $sql = $sql . " ORDER BY SHORT_DESC";
        if ($q !== null) {
            return $this->findList($sql, "%$q%", "%$q%");
        }
        return $this->findList($sql);
    }

    public function getProductInfo($prodId)
    {
        if ($prodId != null) {
           $sql = "SELECT PROD_PROFILE.PROD_ID,
                       PROD_PROFILE.SHORT_DESC,
                       PROD_PROFILE.COMPANY_ID,
                       UOM.CODE,
                       UOM.DESCRIPTION,
                       PROD_PROFILE.TEMPERATURE_ZONE
                   FROM PROD_PROFILE, UOM
                   WHERE PROD_PROFILE.UOM = UOM.CODE AND PROD_PROFILE.PROD_ID = ?
                   ORDER BY PROD_ID";
            return $this->findAllAssoc($sql, $prodId);
        } else {
            return false;
        }
    }
    
    /**
    * get product list filtered by Order company id
    * 
    * @param string $orderNo
    * @return array $productList
    */
    public function getFilteredByCompnayProdList($orderNo){
        
        $sql    =   "SELECT PROD_ID,
                            PROD_ID,
                            PROD_ID AS PROD_ID3
                     FROM PROD_PROFILE
                     WHERE PROD_PROFILE.COMPANY_ID IS NULL OR 
                           PROD_PROFILE.COMPANY_ID = '' OR
                           PROD_PROFILE.COMPANY_ID = ? 
                     ORDER BY PROD_ID3 ";
     
        $productList = $this->findList($sql, $orderNo);
        
        return $productList;       
    }


    /**
     * Return a alternate list of products
     *
     * @return array
     */
    public function getAlternateProductList($q = null)
    {
        $sql = "SELECT ALTERNATE_ID, SHORT_DESC FROM PROD_PROFILE";
        if ($q != null) {
            $q = strtoupper($q);
            $sql = $sql . " WHERE UPPER(ALTERNATE_ID) LIKE ?";
            $sql = $sql . " OR UPPER(PROD_ID) LIKE ?";
            $sql = $sql . " OR UPPER(LONG_DESC) LIKE ?";

        }
        $sql = $sql . " ORDER BY SHORT_DESC";
        if ($q !== null) {
            return $this->findList($sql, "%$q%", "%$q%", "%$q%");
        }
        return $this->findList($sql);
    }


    /**
     * Return an array of all the product owners ordered by NAME. The COMPANY_ID
     * will be the key and the NAME will be the value.
     *
     * @return array return empty array if query is empty or fail
     */
    public function getProductOwnerList()
    {
        if ($this->limitCompany != 'all') {
            return array($this->limitCompany => $this->limitCompany);
        }

        if ($this->isAdmin || $this->isInventoryOperator) {
            $sql = "SELECT COMPANY_ID, COMPANY_ID FROM COMPANY ORDER BY 1";
            return $this->findList($sql);
        } else {
            $sql = "SELECT COMPANY_ID, COMPANY_ID FROM ACCESS_COMPANY WHERE USER_ID = ? ORDER BY 1";
            return $this->findList($sql, $this->userId);
        }
    }

    /**
     * Returns a product profile
     *
     * @return ProductProfile
     */
    public function getProduct($prodId, $companyId = '', $warehouseId = '')
    {
        if ($companyId == '' && $this->limitCompany != 'all') {
            $companyId = $this->limitCompany;
        }
        if ($warehouseId == '' && $this->limitWarehouse != 'all') {
            $warehouseId = $this->limitWarehouse;
        }

        $sql = "SELECT PROD_ID, SHORT_DESC, SALE_PRICE, TAX_APPLICABLE, ISSUE_UOM FROM PROD_PROFILE WHERE PROD_ID = ?";
        $row = $this->findOneAssoc($sql, $prodId);
        if ($row === null) {
            return null;
        }
        $p = new ProductProfile();
        $p->prodId = $row['PROD_ID'];
        $p->shortDesc = $row['SHORT_DESC'];
        $p->salePrice = is_null($row['SALE_PRICE']) ? '' : $row['SALE_PRICE'];
        $p->gst = 0;
        if ($row['TAX_APPLICABLE'] != 'F') {
            $p->gst = $this->findValue("SELECT DEFAULT_GST_RATE FROM CONTROL");
        }
        $p->uom = $row['ISSUE_UOM'];

        $sql = "
            SELECT
                AVAILABLE_QTY,
                AVAILABLE1_QTY,
                AVAILABLE2_QTY,
                AVAILABLE3_QTY
            FROM
                PRODUCT_CMP_WH_STOCK_STATUS_V(?, ?, ?, ?, 'AVAILABLE_QTY|AVAILABLE1_QTY|AVAILABLE2_QTY|AVAILABLE3_QTY')
        ";
        $row = $this->findOneAssoc($sql, $prodId, $companyId, $warehouseId, $this->userId);
        if ($row !== null) {
            $p->availableQty = $row['AVAILABLE_QTY'];
            $p->issnSizes[] = $row['AVAILABLE1_QTY'];
            $p->issnSizes[] = $row['AVAILABLE2_QTY'];
            $p->issnSizes[] = $row['AVAILABLE3_QTY'];
        } else {
            $p->availableQty = 'Err';
            $p->issnSizes[] = 'Err';
            $p->issnSizes[] = 'Err';
            $p->issnSizes[] = 'Err';
        }

        $p->warehouseTotals = array();
        if ($warehouseId == '') {
            $sql = "SELECT WH_ID FROM WAREHOUSE ORDER BY WH_ID";
            $whs = $this->findAll($sql);
            foreach($whs as $row) {
                $available = $this->findValue("SELECT AVAILABLE_QTY FROM PRODUCT_CMP_WH_STOCK_STATUS_V(?, ?, ?, ?,|AVAILABLE_QTY)", $prodId, $companyId, $row[0], $this->userId);
                $p->warehouseTotals[] = array('key' => $row[0], 'val' => $available);
            }
        } else {
            $available = $this->findValue("SELECT AVAILABLE_QTY FROM PRODUCT_CMP_WH_STOCK_STATUS_V(?, ?, ?, ?,|AVAILABLE_QTY)", $prodId, $companyId, $warehouseId, $this->userId);
            $p->warehouseTotals[] = array('key' => $warehouseId, 'val' => $available);
        }
        return $p;
    }

    /**
     * Returns a product profile
     *
     * @return ProductProfile
     */
    public function getProductByISSN($issn)
    {
        $sql = "SELECT SSN.PROD_ID, SSN.SSN_TAX_APPLICABLE, SSN.SSN_SALE_PRICE, SSN.SSN_SALE_UOM, SSN.SSN_DESCRIPTION, ISSN.CURRENT_QTY FROM SSN, ISSN WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN AND ISSN.SSN_ID = ?";
        $issnData = $this->findOneAssoc($sql, $issn);

        if ($issnData === null) {
            return null;
        }
        $p = new ProductProfile();
        $p->prodId = $issnData['PROD_ID'];
        $p->shortDesc = '';
        $p->ssnDescription = $issnData['SSN_DESCRIPTION'];
        $p->salePrice = is_null($issnData['SSN_SALE_PRICE']) ? '' : $issnData['SSN_SALE_PRICE'];
        $p->gst = 0;
        if ($issnData['SSN_TAX_APPLICABLE'] != 'F') {
            $p->gst = $this->findValue("SELECT DEFAULT_GST_RATE FROM CONTROL");
        }
        $p->uom = $issnData['SSN_SALE_UOM'];

        $p->availableQty = $issnData['CURRENT_QTY'];
        $p->issnSizes[] = 0;
        $p->issnSizes[] = 0;
        $p->issnSizes[] = 0;

        $p->warehouseTotals = array();
        return $p;
    }

    /**
     * Return an array of receive locations ordered by the location name. The
     * key will be the LOCN_ID and the value will be the LOCN_NAME.
     *
     * @return array return empty array if query is empty or fail
     */
    public function getReceiveLocationList()
    {
        $sql = "SELECT LOCATION.LOCN_ID, LOCATION.LOCN_NAME
                FROM LOCATION, SESSION
                WHERE STORE_AREA = 'RC'
                AND LOCATION.WH_ID = SESSION.DESCRIPTION
                AND SESSION.CODE = 'CURRENT_WH_ID'
                AND SESSION.DEVICE_ID = 'MQ'
                ORDER BY LOCN_NAME";

        return $this->findList($sql);
    }

    public function getWhReceiveLocationList()
    {
        $sql = 'SELECT DEFAULT_WH_ID 
                FROM SYS_USER 
                WHERE USER_ID = ? ';
        
        
        $sysUserWhId = $this->findValue($sql, $this->userId);
        
        $sql = 'SELECT DEFAULT_WH_ID
                FROM CONTROL';
        
        $controlWhId = $this->findValue($sql);
      
        $sql = 'SELECT WH_ID || LOCN_ID, WH_ID || LOCN_ID FROM LOCATION WHERE STORE_AREA = \'RC\'';
        $args = array();
        if ($this->limitWarehouse != 'all') {
            $sql .= ' AND WH_ID = ?';
            $args[] = $this->limitWarehouse;
        } else {
            if($sysUserWhId != null) {
                $sql .= ' AND WH_ID = ?';
                $args[] = $sysUserWhId;    
            } else {
                $sql .= ' AND WH_ID = ?';
                $args[] = $controlWhId;
            }    
        }
        $sql .= ' ORDER BY 1';
        
        array_unshift($args, $sql);
        return call_user_func_array(array($this, 'findList'), $args);
    }

    /**
     * Return a list of companies that can send products ordered by the NAME.
     * The PERSON_ID will be the key and the FIRST_NAME will be the value.
     *
     * @return array return empty array if query is empty or fail
     */
    public function getSentByList()
    {
        $sql = "SELECT PERSON_ID, FIRST_NAME
                FROM PERSON
                WHERE SUBSTRING(PERSON_TYPE FROM 1 FOR 2)
                IN ('CO', 'CS', 'CU')
                ORDER BY FIRST_NAME, PERSON_ID";

        return $this->findList($sql);
    }

    /**
     * Return a list of companies to ship via
     *
     * @return array
     */
    public function getShipViaList()
    {
        $sql = "SELECT CARRIER_ID, CARRIER_ID FROM CARRIER ORDER BY 1";

        return $this->findList($sql);
    }
    
    /**
     * Return a list of companies to ship via
     *
     * @return array
     */
    public function getTrnTypeShipViaList()
    {
        $sql = "SELECT CARRIER_ID, TRN_TYPE FROM CARRIER ORDER BY 1";

        return $this->findList($sql);
    }

    /**
     * Return a list of shipping services
     *
     * @return array
     */
    public function getShipServiceList($carrierId)
    {
        if ($carrierId == '') {
            return array();
        }

        $sql = "SELECT SERVICE_TYPE, DESCRIPTION
                FROM CARRIER_SERVICE
                WHERE CARRIER_ID = ?
                ORDER BY CARRIER_ID";

        return $this->findList($sql, $carrierId);
    }
    
    /**
     * Return a list of shipping services frpm PO
     *
     * @return array
     */
    public function getPoShipServiceList()
    {
        $sql = "SELECT DISTINCT
                       SHIP_SERVICE,
                       SHIP_SERVICE
                FROM PICK_ORDER ";

        return $this->findList($sql);
    }

    public function getSSNList($q = null)
    {
        $sql = 'SELECT SSN_ID, SSN_DESCRIPTION FROM SSN ';
        if ($q != null) {
            $arg  = '%' . strtoupper($q) . '%';
            $sql .= ' WHERE (UPPER(SSN_DESCRIPTION) LIKE ? OR SSN_ID LIKE ?)';
            $sql .= ' ORDER BY SSN_DESCRIPTION, SSN_ID';
            return $this->findList($sql, $arg, $arg);
        }
        $sql .=  ' ORDER BY SSN_DESCRIPTION, SSN_ID';
        return $this->findList($sql);
    }

    public function getGrnList($q = null)
    {
        $sql = 'SELECT GRN, \'\' FROM GRN ';
        if ($q != null) {
            $arg  = strtoupper($q) . '%';
            $sql .= ' WHERE GRN LIKE ? ';
            $sql .= ' ORDER BY 1';
            return $this->findList($sql, $arg);
        }
        return $this->findList($sql);
    }

    /**
     * Return a list of warehouses
     *
     * The key is the warehouse id and the value is the name
     *
     * @return array
     */
    public function getWarehouseList($overrideLimit = false)
    {
        if ($this->isAdmin || $this->isInventoryOperator) {
            if ($this->userId == 'Admin') {
                if ($this->limitWarehouse == 'all' || $overrideLimit) {
                    $sql = "SELECT WH_ID, DESCRIPTION FROM WAREHOUSE";
                    return $this->findList($sql);
                } else {
                    $sql = "SELECT WH_ID, DESCRIPTION FROM WAREHOUSE WHERE WH_ID = ?";
                    return $this->findList($sql, $this->limitWarehouse);
                }
            } else {
                if ($this->limitWarehouse == 'all' || $overrideLimit) {
                    $sql = "SELECT WH_ID, DESCRIPTION FROM WAREHOUSE WHERE NOT ((WH_ID  = 'XA') OR (WH_ID >= 'XC' AND WH_ID <= 'XX'))";
                    return $this->findList($sql);
                } else {
                    $sql = "SELECT WH_ID, DESCRIPTION FROM WAREHOUSE WHERE WH_ID = ? AND NOT ((WH_ID  = 'XA') OR (WH_ID >= 'XC' AND WH_ID <= 'XX'))";
                    return $this->findList($sql, $this->limitWarehouse);
                }
            }
        } else {
            if ($this->limitWarehouse == 'all' || $overrideLimit) {
                $sql = "SELECT WAREHOUSE.WH_ID, DESCRIPTION FROM WAREHOUSE JOIN ACCESS_USER ON WAREHOUSE.WH_ID = ACCESS_USER.WH_ID AND USER_ID = ?";
                return $this->findList($sql, $this->userId);
            } else {
                $sql = "SELECT WAREHOUSE.WH_ID, DESCRIPTION FROM WAREHOUSE JOIN ACCESS_USER ON WAREHOUSE.WH_ID = ACCESS_USER.WH_ID AND USER_ID = ? AND WAREHOUSE.WH_ID = ?";
                return $this->findList($sql, $this->userId, $this->limitWarehouse);
            }
        }
    }
    
    public function getWarehouseDescription($whId){
        
         $sql = "SELECT 
                    DESCRIPTION 
                 FROM WAREHOUSE 
                 WHERE WH_ID = ?";
         
         return $this->findOne($sql, $whId);
            
    }
    
    /**
     * Log the user into Minder
     *
     * If the user is validated then the connect should be called and true
     * return. On failure these are set to null and false is returned.
     *
     * @param string $userId user ID for login
     * @param string $pass   user pass for login
     * @param string $ip     user IP for login
     *
     * @return boolean
     */
    
    public function login($userId, $pass, $ip)
    {
        $tmpSysUser = SysUser::getSysUser($userId);
        $tmpCompanyAccessList = $tmpSysUser->getCompanyAccessList();
        $tmpWarehouseAccessList = $tmpSysUser->getWarehouseAccessList();
        
        if (empty($tmpCompanyAccessList) || empty($tmpWarehouseAccessList))
            throw new Minder_Exception('Error: User has empty Company or Warehouse access list. Check system setup.');
        
        $this->userId   = null;
        $this->ip       = null;
        $this->deviceId = null;
        $this->isAdmin  = false;
        $queryString    = "SELECT DEVICE_ID,
                                  LG_STATUS,
                                  LG_MESSAGE
                           FROM LOGIN_DEVICE(?, '',?)";
        $query = ibase_prepare($this->db, $queryString);

        if (false !== $query) {

            if (false !== ($result = ibase_execute($query, $ip, $userId))) {
                if (false !== ($row = ibase_fetch_row($result))) {
                    ibase_free_result($result);
                    ibase_free_query($query);
                    $deviceId  = $row[0];
                    $dbStatus  = $row[1];
                    $dbMessage = $row[2]; // error message from UDF LOGIN_DEVICE()
                                          // should I handle it?
                    if ($dbStatus > 0) {
                        $dbTran      = ibase_trans(IBASE_DEFAULT, $this->db);
                        $queryString = "SELECT PASS_WORD,
                                               USER_ID,
                                               USER_TYPE,
                                               DEFAULT_WH_ID,
                                               PICK_SEQUENCE,
                                               PICK_DIRECTION,
                                               SYS_ADMIN,
                                               INVENTORY_OPERATOR,
                                               EDITABLE,
                                               STOCK_ADJUST,
                                               STATUS_ADJUST_ISSN,
                                               STATUS_ADJUST_PICK_ORDER
                                        FROM SYS_USER
                                        WHERE USER_ID = ? ";

                        if (false !== ($query = ibase_prepare($queryString))) {
                            if (false !== ($result = ibase_execute($query, $userId))) {
                                if (false !== ($row = ibase_fetch_row($result))) {
                                    $dbUserPass          = $row[0];
                                    $dbLoginUser         = $row[1];
                                    $dbLoginType         = $row[2];
                                    $dbWH_ID             = $row[3];
                                    $dbPickSeq           = $row[4];
                                    $dbPickDir           = $row[5];
                                    $dbAdmin             = $row[6];
                                    $dbInventoryOperator = $row[7];
                                    $dbEditable          = $row[8];
                                    $dbStockAdjust       = $row[9];
                                    $dbAdjustIssn        = $row[10];
                                    $dbAdjustPickOrder   = $row[11];

                                    ibase_free_result($result);

                                    if ($dbLoginType == 'TR') {
                                        $this->connectToTraining();
                                    }
                                    $query = "SELECT 1
                                              FROM SESSION
                                              WHERE DEVICE_ID = '" . $deviceId . "'
                                                AND CODE = 'CURRENT_WH_ID'";

                                    if (false === ($result = ibase_query($this->db, $query))) {
                                        throw new Exception("Unable to Read Session!");
                                    } else {
                                        if (false !== ($row = ibase_fetch_row($result))) {
                                            $query = "UPDATE SESSION
                                                         SET DESCRIPTION = '" . $dbWH_ID . "',
                                                             CREATE_DATE = 'NOW'
                                                       WHERE DEVICE_ID   = '" . $deviceId . "'
                                                         AND CODE        = 'CURRENT_WH_ID'";
                                        } else {
                                            $query = "INSERT INTO
                                                      SESSION(DEVICE_ID,
                                                              CODE,
                                                              DESCRIPTION,
                                                              CREATE_DATE)
                                                      VALUES('" . $deviceId . "',
                                                             'CURRENT_WH_ID',
                                                             '" . $dbWH_ID . "',
                                                             'NOW')";

                                        }
                                        ibase_free_result($result);
                                        if (false === ($result = ibase_query($this->db, $query))) {
                                            throw new Exception("Unable to Update session! Query: " . $query);
                                        }
                                        ibase_free_result($result);
                                    }
                                    $query = "SELECT 1
                                              FROM SESSION
                                              WHERE DEVICE_ID = '" . $deviceId . "'
                                                AND CODE = 'CURRENT_PICK_SEQ'";
                                    $result = ibase_query($this->db, $query);
                                    if (false === $result) {
                                        throw new Exception("Unable to Read Session!");
                                    } else {
                                        if (false !== ($row = ibase_fetch_row($result))) {
                                            $query = "UPDATE SESSION
                                                         SET DESCRIPTION = '" . $dbPickSeq ."',
                                                             CREATE_DATE = 'NOW'
                                                       WHERE DEVICE_ID   = '" . $deviceId . "'
                                                         AND CODE        = 'CURRENT_PICK_SEQ'";
                                        } else {
                                            $query = "INSERT INTO
                                                      SESSION(DEVICE_ID,
                                                              CODE,
                                                              DESCRIPTION,
                                                              CREATE_DATE)
                                                      VALUES('" . $deviceId . "',
                                                             'CURRENT_PICK_SEQ',
                                                             '" . $dbPickSeq . "',
                                                             'NOW')";
                                        }
                                        ibase_free_result($result);
                                        $result = ibase_query($this->db, $query);
                                        if (false === $result) {
                                            throw new Exception("Unable to Update session! Query: " . $query);
                                        }
                                    }

                                    ibase_free_result($result);

                                    $query = "SELECT 1
                                              FROM SESSION
                                              WHERE DEVICE_ID = '" . $deviceId . "'
                                                AND CODE = 'CURRENT_PICK_DIR'";

                                    $result = ibase_query($this->db, $query);
                                    if (false === $result) {
                                        throw new Exception("Unable to Read Session!");
                                    } else {
                                        if (false !== ($row = ibase_fetch_row($result))) {
                                            $query = "UPDATE SESSION
                                                        SET DESCRIPTION = '" . $dbPickDir . "',
                                                            CREATE_DATE = 'NOW'
                                                      WHERE DEVICE_ID   = '" . $deviceId . "'
                                                        AND CODE        = 'CURRENT_PICK_DIR'";
                                        } else {
                                            $query = "INSERT INTO
                                                      SESSION(DEVICE_ID,
                                                              CODE,
                                                              DESCRIPTION,
                                                              CREATE_DATE)
                                                      VALUES('" . $deviceId . "',
                                                             'CURRENT_PICK_DIR',
                                                             '" . $dbPickDir . "',
                                                             'NOW')";
                                        }
                                        ibase_free_result($result);
                                        $result = ibase_query($this->db, $query);
                                        if (false === $result) {
                                            throw new Exception("Unable to Update session! Query: " . $query);
                                        }
                                        ibase_free_result($result);
                                    }
                                    $query = "SELECT 1
                                              FROM SESSION
                                              WHERE DEVICE_ID = '" . $deviceId . "'
                                                AND CODE = 'CURRENT_IP_ADDRESS'";

                                    $result = ibase_query($this->db, $query);
                                    if (false === $result) {
                                        throw new Exception("Unable to Read Session!");
                                    } else {
                                        if (false !== ($row = ibase_fetch_row($result))) {
                                            $query = "UPDATE SESSION
                                                        SET DESCRIPTION = '" . $ip . "',
                                                            CREATE_DATE = 'NOW'
                                                      WHERE DEVICE_ID   = '" . $deviceId . "'
                                                        AND CODE        = 'CURRENT_IP_ADDRESS'";
                                        } else {
                                            $query = "INSERT INTO
                                                      SESSION(DEVICE_ID,
                                                              CODE,
                                                              DESCRIPTION,
                                                              CREATE_DATE)
                                                      VALUES('" . $deviceId . "',
                                                             'CURRENT_IP_ADDRESS',
                                                             '" . $ip . "',
                                                             'NOW')";
                                        }
                                        ibase_free_result($result);
                                        $result = ibase_query($this->db, $query);
                                        if (false === $result) {
                                            throw new Exception("Unable to Update session! Query: " . $query);
                                        }
                                        ibase_free_result($result);
                                    }



                                    $objSession = new Zend_Session_Namespace();
                                    $strClientTimeZone = $objSession->BrowserTimeZone;

                                    $query = "SELECT 1
                                              FROM SESSION
                                              WHERE DEVICE_ID = '" . $deviceId . "'
                                                AND CODE = 'CLIENT_TIME_ZONE'";

                                    if (false === ($result = ibase_query($this->db, $query))) {
                                        throw new Exception("Unable to Read Session!");
                                    } else {
                                        if (false !== ($row = ibase_fetch_row($result))) {
                                            $query = "UPDATE SESSION
                                                         SET DESCRIPTION = '" . $strClientTimeZone . "',
                                                             CREATE_DATE = 'NOW'
                                                       WHERE DEVICE_ID   = '" . $deviceId . "'
                                                         AND CODE        = 'CLIENT_TIME_ZONE'";
                                        } else {
                                            $query = "INSERT INTO
                                                      SESSION(DEVICE_ID,
                                                              CODE,
                                                              DESCRIPTION,
                                                              CREATE_DATE)
                                                      VALUES('" . $deviceId . "',
                                                             'CLIENT_TIME_ZONE',
                                                             '" . $strClientTimeZone . "',
                                                             'NOW')";

                                        }
                                        ibase_free_result($result);
                                        if (false === ($result = ibase_query($this->db, $query))) {
                                            throw new Exception("Unable to Update session! Query: " . $query);
                                        }
                                        ibase_free_result($result);
                                    }

                            }
                            else {
                                $dbUserPass  = '';
                                $dbLoginUser = '';
                            }
                            if (($userId == $dbLoginUser) && ($pass == $dbUserPass)) {
                                $this->userId               = $userId;
                                $this->ip                   = $ip;
                                $this->deviceId             = $deviceId;
                    $LogFile = "/tmp/login.log";
                    $LogFile = "/data/tmp/login.log";
                    $wkMessage =  "LOGIN MDR Instance user:" . $this->userId ;
                    $wkMessage .= isset($_SERVER['HTTP_X_FORWARDED_FOR']) ?  " http_x_forwarded_for " . $_SERVER['HTTP_X_FORWARDED_FOR'] : "";
                    $wkMessage .=  " remote_addr: " . $this->ip  ;
                    //file_put_contents($LogFile, $wkMessage . "\n", FILE_APPEND );
                    $wkMessage .=  " device: " . $this->deviceId  ;
                    $wkMessage .= " " . date("M, d-M-Y H:i:s.u");
                    file_put_contents($LogFile, $wkMessage . "\n", FILE_APPEND );
                                $this->isAdmin              = ($dbAdmin == 'T')             ? true : false;
                                $this->isInventoryOperator  = ($dbInventoryOperator == 'T') ? true : false;
                                $this->isEditable           = ($dbEditable == 'T')          ? true : false;
                                $this->isStockAdjust        = ($dbStockAdjust == 'T')       ? true : false;
                                $this->isAdjustIssn         = ($dbAdjustIssn == 'T')        ? true : false;
                                $this->isAdjustPickOrder    = ($dbAdjustPickOrder == 'T')   ? true : false;
                                $this->whId                 = $dbWH_ID;
                                $this->limitPrinter   = key($this->getPrinterListLimited());
                                {
                                    $wk_buffer = "LOGIN:MDR Login Device " . $deviceId . " User " . $userId . " ";
                                    $query = "INSERT INTO
                                              LOG(DESCRIPTION )
                                              VALUES('" . $wk_buffer . "' || CAST(CAST('NOW' AS TIMESTAMP) AS CHAR(24)))";
                                    $result = ibase_query($this->db, $query);
                                    if (false === $result) {
                                        throw new Exception("Unable to Update log! Query: " . $query);
                                    }
                                    ibase_free_result($result);
                                }
                                Minder2_Environment::setCurrentUser(null);
                                $otcLog = new Minder_Log_Otc();
                                $otcLog->info('User "' . $this->userId . '" logged in.');
                                return true;
                            }
                            else {
                                throw new Exception('User Id or Password does not match.');
                            }
                        } else {
                            throw new Exception('User not found in database.');
                        }
                        ibase_commit($dbTran);
                    }
                  }
                    else {
                        throw new Exception($dbMessage);
                    }
                }
            } else {
                return false;
            }
        }
        else {
            throw new Exception(ibase_errcode() . ': ' . ibase_errmsg());
        }
        return false;
    }

    /**
     * Log out the currently logged in user
     *
     * @return boolean
     */
    public function logout()
    {
        $otcLog = new Minder_Log_Otc();
        $otcLog->info('User "' . $this->userId . '" go logout.');
        $sql = "SELECT LG_STATUS, LG_MESSAGE FROM LOGOUT_DEVICE(?)";
        $row = $this->findOne($sql, $this->deviceId);
        if ($row == null) {
            return false;
        }
    $LogFile = "/tmp/login.log";
    $LogFile = "/data/tmp/login.log";
    file_put_contents($LogFile, "LOGOUT minder user:" . $this->userId .  " remote_addr: " . $_SERVER['REMOTE_ADDR'] . " Device " . $this->deviceId .  date("M, d-M-Y H:i:s.u") . "\n", FILE_APPEND );
        return true;
    }

    /**
     * Log out all currently logged in users
     *
     * @return void
     */
    public function logoutAll()
    {
        $dbTran = ibase_trans(IBASE_DEFAULT, $this->db);
        $query  = "UPDATE SYS_USER
                      SET DEVICE_ID=NULL,
                          LOGIN_DATE=NULL";

        if (false === ($result = ibase_query($this->db, $query))) {
            throw new Exception("Unable to update sys_user!");
        }

        $query = "UPDATE SYS_EQUIP
                     SET CURRENT_PERSON = NULL,
                         CURRENT_LOGGED_ON = NULL";
        if (false === ($result = ibase_query($this->db, $query))) {
            throw new Exception("Unable to update sys_equip!");
        }
        {
            $wk_buffer = "LOGIN:MDR Logout All Devices " ;
            $query = "INSERT INTO
                      LOG(DESCRIPTION )
                      VALUES('" . $wk_buffer . "' || CAST(CAST('NOW' AS TIMESTAMP) AS CHAR(24)))"; 
            $result = ibase_query($this->db, $query);
            if (false === $result) {
                throw new Exception("Unable to Update log!");
            }
        }
        ibase_free_result($result);
    $LogFile = "/tmp/login.log";
    $LogFile = "/data/tmp/login.log";
    file_put_contents($LogFile, "LOGOUT minder All :" . $this->userId .  " remote_addr: " . $_SERVER['REMOTE_ADDR'] . " Device " . $this->deviceId .  date("M, d-M-Y H:i:s.u") . "\n", FILE_APPEND );
    }

    protected function _getLimitCompanyId() {
        if (!empty($this->limitCompany) && ($this->limitCompany != 'all'))
            return $this->limitCompany;

        $data = $this->getSysUserData();
        if (!empty($data) && isset($data['COMPANY_ID']) && !empty($data['COMPANY_ID']))
            return $data['COMPANY_ID'];

        return $this->defaultControlValues['COMPANY_ID'];
    }

    /**
     * Returns a new order with all the defaults set
     *
     * @todo The SQL query doesn't work so the defaults aren't being set
     *
     * @return PickOrder
     */
    public function newPickOrder()
    {
        $pickOrder = new PickOrder();

        $pickOrder->shipVia             = $this->defaultControlValues['DEFAULT_CARRIER_ID'];
        $pickOrder->taxRate             = $this->defaultControlValues['DEFAULT_GST_RATE'];
        $pickOrder->paymentMethod       = $this->defaultControlValues['DEFAULT_PAYMENT_METHOD'];
        $pickOrder->terms               = $this->defaultControlValues['DEFAULT_TERM'];
        $pickOrder->pickPriority        = $this->defaultControlValues['DEFAULT_PICK_PRIORITY'];
        $pickOrder->whId                = $this->defaultControlValues['DEFAULT_WH_ID'];
        $pickOrder->despatchLocation    = $this->defaultControlValues['DEFAULT_DESPATCH_LOCATION'];
        $pickOrder->pickStatus          = 'UC';
        $pickOrder->pickDueDate         = date('Y-m-d');
        $pickOrder->createDate          = date('Y-m-d H:i:s');
        //$pickOrder->pSameAsInvoiceTo    = 'T';
        $pickOrder->companyId           = $this->_getLimitCompanyId();

        $data = $this->getSysUserData();
        if ($data != null) {
            $pickOrder->personId    = $data['DEFAULT_ORDER_SOLD_TO'];
        }

        return $pickOrder;
    }

    public function isCreditManagerT()
    {
        try {
            $result = $this->findOne("SELECT 1 FROM sys_user WHERE CREDIT_MANAGER = 'T' AND USER_ID = ?", $this->userId);
            $result = true;
        } catch (Exception $e) {
            $result = false;
        }
        return $result;
    }
    
    public function isSalesManagerT() {
        try {
            $result = $this->fetchOne("SELECT SALE_MANAGER FROM sys_user WHERE USER_ID = ?", $this->userId);
            
            if ($result == 'T') {
                return true;
            }
        } catch (Exception $e) {
            return false;
        }
        return false;
    }

    public function isWhManagerT() {        
        try {            
            $result = $this->fetchOne("SELECT WH_MANAGER FROM sys_user WHERE USER_ID = ?", $this->userId);                        
            if ($result == 'T') {                
                return true;            
            }        
        } catch (Exception $e) {            
            return false;        
        }        
        return false;    
    }    
    
    public function isStatusAdjustPurchaseOrderT() {
        try {            
            $result = $this->fetchOne("SELECT STATUS_ADJUST_PURCHASE_ORDER FROM sys_user WHERE USER_ID = ?", $this->userId);                        
            Zend_Registry::get('logger')->debug(array('file' => __FILE__, 'line' => __LINE__, $result, $this->userId));
            if ($result == 'T') {                
                return true;            
            }        
        } catch (Exception $e) {            
            return false;        
        }        
        return false;    
    }
    
    public function isStatusAdjustPoLine() {
        try {            
            $result = $this->fetchOne("SELECT STATUS_ADJUST_PO_LINE FROM sys_user WHERE USER_ID = ?", $this->userId);                        
            if ($result == 'T') {                
                return true;            
            }        
        } catch (Exception $e) {            
            return false;        
        }        
        return false;    
    }
    
    public function isStatusAdjustPickItemT() {
        try {            
            $result = $this->fetchOne("SELECT STATUS_ADJUST_PICK_ITEM FROM sys_user WHERE USER_ID = ?", $this->userId);                        
            if ($result == 'T') {                
                return true;            
            }        
        } catch (Exception $e) {            
            return false;        
        }        
        return false;    
    }
    
    public function isSysAdmin() {
        return (strtolower($this->userId) == 'admin');
    }
    
    public function newPickItem()
    {
        $line = new PickItem();

        $sql = "SELECT DEFAULT_GST_RATE FROM CONTROL";
        $data = $this->findOneAssoc($sql);
        if ($data != null) {
            $line->gst = $data['DEFAULT_GST_RATE'];
        }
        return $line;
    }

    public function pickOrderApproveDespatch($pickOrder)
    {
        $sql = "SELECT VALID_SO FROM APPROVE_SALES_ORDER(?, 'RS', 'DA', ?)";

        if ($this->findValue($sql, $pickOrder, $this->userId) == 'T') {
            return true;
        }

        return false;
    }

    public function pickOrderApprovePick($pickOrder)
    {
        $sql = "SELECT VALID_SO FROM APPROVE_SALES_ORDER(?, 'RS', 'OP', ?)";

        if ($this->findValue($sql, $pickOrder, $this->userId) == 'T') {
            return true;
        }

        return false;
    }

    public function pickOrderCancel($pickOrder, $reason)
    {
	if (empty($reason)) {
		$reason = "None";
	}
        $sql = "EXECUTE PROCEDURE CANCEL_SALE_ORDER(?, ?)";

        $query = ibase_prepare($this->db, $sql);

        if (false !== $query) {
            if(($result = ibase_execute($query, $pickOrder, $reason)) !== false) {
                ibase_free_result($result);
                ibase_free_query($query);
                return true;
            }
            else {
                ibase_free_query($query);
                return false;
            }
        }
        else {
            throw new Exception(ibase_errcode() . ': ' . ibase_errmsg());
        }
   }

    public function pickOrderConfirm($pickOrder)
    {
        $sql = "SELECT PERSON_ID FROM PICK_ORDER WHERE PICK_ORDER = ?";
        if ($this->findValue($sql, $pickOrder) == 'ANONYMOUS') {
            return false;
        }

        $sql = "SELECT VALID_SO FROM UPDATE_SALE_ORDER_STATUS(?, 'RS', 'CF', ?)";
        if ($this->findValue($sql, $pickOrder, $this->userId) == 'T') {
            return true;
        }

        return false;
    }

    public function pickOrderHold($pickOrder)
    {
/*
        $sql = "SELECT VALID_SO FROM UPDATE_SALE_ORDER_STATUS(?, 'PA', 'HD', ?)";

        if ($this->findValue($sql, $pickOrder, $this->userId) == 'T') {
            return true;
        }
*/
        $sql = "SELECT PICK_STATUS FROM PICK_ORDER WHERE PICK_ORDER = ?";

        if ($this->findValue($sql, $pickOrder ) == 'HD') {
            $sql = "SELECT VALID_SO FROM UPDATE_SALE_ORDER_STATUS(?, 'HD', 'UC', ?)";
        }
        else {
            $sql = "SELECT VALID_SO FROM UPDATE_SALE_ORDER_STATUS(?, 'PA', 'HD', ?)";
        }
        if ($this->findValue($sql, $pickOrder, $this->userId) == 'T') {
            return true;
        }

        return false;
    }

    public function pickOrderUnHold($pickOrder)
    {
        $sql = "SELECT VALID_SO FROM UPDATE_SALE_ORDER_STATUS(?, 'HD', 'UC', ?)";

        if ($this->findValue($sql, $pickOrder, $this->userId) == 'T') {
            return true;
        }

        return false;
    }

    
    public function getPickOrderSubTotals($pickOrder) {
        
//        var_dump(__FILE__, __LINE__, $this->findOne('SELECT PICK_ORDER.due_amount, P_COUNTRY FROM PICK_ORDER WHERE pick_ORDER = ?', $pickOrder));
        
        $row = $this->findOne(
            "
                select 
                    SUM(COALESCE(PICK_ITEM.PICK_ORDER_QTY, 0) * COALESCE(PICK_ITEM.SALE_PRICE, 0) * (1 - COALESCE(PICK_ITEM.DISCOUNT, 0) / 100)) AS po_line_total,
                    SUM( case
                        /* first of all check for order country*/
                        WHEN
                            pick_order.P_COUNTRY IS NULL or pick_order.P_COUNTRY = '' or pick_order.P_COUNTRY = 'AU' or pick_order.P_COUNTRY = 'AUSTRALIA'
                        THEN
                            /*if no country or country is AU or AUSTRALIA, then find out tax amount*/
                            case 
                                WHEN
                                    /*check if this is product or issn*/
                                    CASE
                                        WHEN NOT (pick_item.PROD_ID IS NULL OR pick_item.prod_id = '') THEN
                                            /*if this is product, then check if tax applicable*/
                                            (SELECT COALESCE(prod_profile.tax_applicable, 'T') FROM PROD_PROFILE WHERE prod_profile.prod_id = pick_item.prod_id)
                                        WHEN NOT (pick_item.ssn_id IS NULL OR pick_item.ssn_id = '') THEN
                                            /*if issm, then check if issn is product or non-product*/
                                            case
                                                WHEN
                                                    (SELECT ISSN.prod_id FROM ISSN WHERE ISSN.ssn_id = pick_item.ssn_id) IS NULL
                                                    OR (SELECT ISSN.prod_id FROM ISSN WHERE ISSN.ssn_id = pick_item.ssn_id) = ''
                                                THEN
                                                    /*if this is non-product then tax is applicable*/
                                                    'T'
                                                ELSE
                                                    /*if this is product, check if tax applicable*/
                                                    (SELECT COALESCE(prod_profile.tax_applicable, 'T') FROM ISSN left JOIN PROD_PROFILE ON ISSN.PROD_ID = PROD_PROFILE.PROD_ID WHERE ISSN.ssn_id = pick_item.ssn_id)
                                            END
                                        ELSE
                                            'T'
                                    END = 'T'
                                then
                                    /*if tax is applicable then use pick_item.TAX_RATE or pick_order.tax_rate or control.default_gst_rate*/
                                    COALESCE(pick_item.TAX_RATE, (SELECT FIRST 1 control.default_gst_rate FROM control))
                                ELSE
                                    /*if tax is not applicable then use zero tax rate*/
                                    0
                            END
                        ELSE
                            /*if country is other then AUSTRALIA then don't use GST*/
                            0
                    end * COALESCE(PICK_ITEM.PICK_ORDER_QTY, 0) * COALESCE(PICK_ITEM.SALE_PRICE, 0) * (1 - COALESCE(PICK_ITEM.DISCOUNT, 0) / 100) / 100) AS PO_SUB_TAX_AMOUNT
                from
                    PICK_ITEM
                    LEFT JOIN pick_order ON PICK_ITEM.pick_order = pick_order.pick_order
                WHERE 
                    PICK_ITEM.pick_order = ?
            ", 
            $pickOrder
        );
        list($subTotalAmount, $subTotalTax) = $row;
//        var_dump(__FILE__, __LINE__, $row);
        
        return array($subTotalAmount, $subTotalTax, 'SUB_TOTAL_AMOUNT' => $subTotalAmount, 'SUB_TOTAL_TAX' => $subTotalTax);
    }
    
    
    /**
    * Use this method after PICK_ORDER.P_COUNTRY field have been updated to recalculate 
    * PICK_ITEMs and PICK_ORDER billing information.
    * 
    * There is set of triggers in DB: ADD_PICK_ITEM_TIME, ADD_PICK_ORDER_TIME, UPDATE_PICK_ITEM_TIME, UPDATE_PICK_ORDER_TIME,
    * which are used to calculate billing information. But these are not enough. 
    * Assume such situation:
    * 1. There is an Order in DB which has P_COUNTRY = 'AU'. And this Order has some PICK_ITEMS.
    * 2. User changes that order contry to P_COUNTRY = 'CHINA'. UPDATE_PICK_ORDER_TIME trigger will
    *    update that order billing information, but not PICK_ITEMS billing information.
    *    So these PICK_ITEMs.TAX_RATE still be 10% this will lead to incorrect PICK_ORDER.SUB_TOTAL_TAX
    *    and to completely incorrect billing information.
    * 
    * To avoid this we should:
    * - save each PICK_ITEM belong to that order, this will cause UPDATE_PICK_ITEM_TIME trigger
    *   to recalculate billing information for each PICK_ITEM;
    * - save PICK_ORDER again, this will cause UPDATE_PICK_ORDER_TIME trigger to recalculate PICK_ORDER
    *   information using correct PICK_ITEMS.
    * 
    * @param string $pickOrder - PICK_ORDER to recalculate
    * @return false on error
    */
    public function pickOrderRecalculate($pickOrder)
    {
        //just call dummy update for PICK_ITEM table to invoke UPDATE_PICK_ITEM_TIME trigger
        if (false !== ($result = $this->execSQL('UPDATE PICK_ITEM SET PICK_ORDER = ? WHERE PICK_ORDER = ?', array($pickOrder, $pickOrder)))) {
            //if PICK_ITEM updated successfuly, then make dummy update on PICK_ORDER table, to invoke UPDATE_PICK_ORDER_TIME trigger
            $result = $this->execSQL('UPDATE PICK_ORDER SET PICK_ORDER = ? WHERE PICK_ORDER = ?', array($pickOrder, $pickOrder));
        }
//        var_dump(__FILE__, __LINE__, __FUNCTION__);
        return $result;
//        $result = false;

//        list($subTotalAmount, $subTotalTax) = $this->getPickOrderSubTotals($pickOrder);
//        Zend_Registry::get('logger')->debug(array('file' => __FILE__, 'line' => __LINE__, $subTotalAmount, $subTotalTax));
//        if ($subTotalAmount == null) {
//            $subTotalAmount =  0;
//        }
//        if ($subTotalTax == null) {
//            $subTotalTax = 0;
//        }
//        $row = $this->findOneAssoc('SELECT FREIGHT, ADMIN_FEE_RATE, ADMIN_FEE_AMOUNT, OTHER_NUM1, OTHER_NUM2, AMOUNT_PAID, P_COUNTRY FROM PICK_ORDER WHERE PICK_ORDER = ?', $pickOrder);
//        $row['P_COUNTRY'] = (empty($row['P_COUNTRY'])) ? '' : $row['P_COUNTRY'];
//        $row['P_COUNTRY'] = strtoupper(trim($row['P_COUNTRY']));
//        if (empty($row['P_COUNTRY']) || $row['P_COUNTRY'] == 'AU' || $row['P_COUNTRY'] == 'AUSTRALIA')
//            $taxRate = $this->defaultControlValues['DEFAULT_GST_RATE'];
//        else 
//            $taxRate = 0;

//        $taxableAmount = ($row['FREIGHT'] + (($subTotalAmount + $row['FREIGHT']) * $row['ADMIN_FEE_RATE']/100) + $row['ADMIN_FEE_AMOUNT'] + $row['OTHER_NUM1'] + $row['OTHER_NUM2']);
//        $taxAmount = $subTotalTax + $taxableAmount * $taxRate / 100;
//        $total = $subTotalAmount + $taxableAmount + $taxAmount;
//        $dueAmount = $total - $row['AMOUNT_PAID'];
//        $freightTaxAmount = $row['FREIGHT'] * $taxRate / 100;
//        $sql = "UPDATE PICK_ORDER SET SUB_TOTAL_AMOUNT = ?, TAX_AMOUNT = ?, DUE_AMOUNT = ?, FREIGHT_TAX_AMOUNT = ?, TAX_RATE = ? WHERE PICK_ORDER = ?";
//        $query = ibase_prepare($this->db, $sql);
//        if ($query !== false) {
//            $result = ibase_execute($query, $subTotalAmount, $taxAmount, $dueAmount, $freightTaxAmount, $taxRate, $pickOrder);
//        }
//        return $result;
    }
    
    /**
    * Used to recalculate PICK_ITEMs billing information 
    * But now it's better to use pickOrderRecalculate() method.
    * 
    * @deprecated
    * 
    * @param array $clause
    * @return false on error
    */
    public function pickItemRecalculate($clause) {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info(print_r($clause, true));
        $result = true;
        //$log->info(print_r($params, true));

        $sql = "
            UPDATE PICK_ITEM SET 
                LINE_TOTAL = COALESCE(SALE_PRICE, 0) * (1 - COALESCE(DISCOUNT, 0) / 100) * COALESCE(PICK_ORDER_QTY, 0),
                TAX_AMOUNT = 
                    CASE
                        /*test for order country*/
                        WHEN
                            COALESCE((SELECT
                                CASE
                                    WHEN PICK_ORDER.P_COUNTRY IS NULL       THEN 'T'
                                    WHEN PICK_ORDER.P_COUNTRY = ''          THEN 'T'
                                    WHEN PICK_ORDER.P_COUNTRY = 'AU'        THEN 'T'
                                    WHEN PICK_ORDER.P_COUNTRY = 'AUSTRALIA' THEN 'T'
                                    ELSE
                                        'F'
                                END
                            FROM
                                PICK_ORDER
                            WHERE
                                PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER), 'T') = 'T'
                        THEN
                            /*if australia or unknown, then check if tax applicable for thap pick_item*/
                            CASE
                                WHEN (CASE
                                        /*chech if this is product or ISSN*/
                                        WHEN NOT (PICK_ITEM.PROD_ID IS NULL OR PICK_ITEM.PROD_ID = '') THEN
                                            /*if product, check that product prod_profile*/
                                            COALESCE((SELECT COALESCE(PROD_PROFILE.TAX_APPLICABLE, 'T') FROM PROD_PROFILE WHERE PICK_ITEM.PROD_ID = PROD_PROFILE.PROD_ID), 'T')
                                        WHEN NOT (PICK_ITEM.SSN_ID IS NULL OR PICK_ITEM.SSN_ID = '') THEN
                                            /*if this is ISSN, chech for this ISSN*/
                                            COALESCE((SELECT
                                                CASE
                                                    /*if this is non-product, tax always applicable*/
                                                    WHEN ISSN.PROD_ID IS NULL THEN 'T'
                                                    WHEN ISSN.PROD_ID = '' THEN 'T'
                                                    ELSE
                                                        /*if this is product, check that product PROD_PROFILE*/
                                                        COALESCE((SELECT COALESCE(PROD_PROFILE.TAX_APPLICABLE, 'T') FROM PROD_PROFILE WHERE ISSN.PROD_ID = PROD_PROFILE.PROD_ID), 'T')
                                                END
                                            FROM ISSN
                                            WHERE ISSN.SSN_ID = PICK_ITEM.SSN_ID ), 'T')
                                        ELSE
                                            'T'
                                END) = 'T' 
                                THEN 
                                    /*tax is applicable*/
                                    COALESCE(SALE_PRICE, 0) * (1 - COALESCE(DISCOUNT, 0) / 100) * COALESCE(PICK_ORDER_QTY, 0) * COALESCE(TAX_RATE, (SELECT FIRST 1 control.default_gst_rate FROM control)) / 100
                                ELSE
                                    /*tax is not applicable*/
                                    0
                            END
                        ELSE
                            /*if not australia, then tax is not apllicable*/
                            0
                    END,
                TAX_RATE   = COALESCE(TAX_RATE, (SELECT FIRST 1 control.default_gst_rate FROM control))
            WHERE 1=1 AND 
        ";
        foreach ($clause as $key => $val) {
            if (false !== strpos($key, '?')) {
                $params[] = $val;
            }
            $sql .= $key;
        }
        
        $sql = substr($sql, 0, -5);
        
        $log->info($sql . ' : ' . implode(',', $params));
        //$log->info(print_r($params, true));
        $result  = $this->execSQL($sql, $params);
   
        return $result;
        
    }

    /**
    * @deprecated Adding SSN.SSN_ID to PICK_ITEMs in 'case 3' is incorrect (see minder issue #3562#note-8).
    * 
    * @param mixed $collection
    * @return int
    */
    public function addPickIssnItem(array $collection)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $data = $collection;
        $log->info(print_r($data, true));
        if (empty($collection['pick_order'])) {
            return false;
        }
        $pickOrder = $collection['pick_order'];
        unset($data['pick_order']);
        $salePrice  =   $data['price'];
        unset($data['price']);

        $result = true;
   
        if (!isset($data['required_qty'])) {
            $log->info('no required qty ' );
        }
        if (!isset($data['case'])) {
            $log->info('no case ' );
        }
        
        if (isset($data['required_qty']) && isset($data['case'])) {
            // ----------------
            // --- Products ---
            // ----------------
            $requiredQty = $data['required_qty'];
            
            unset($data['required_qty']);
            $log->info('required qty :' . $requiredQty);

            $case = $data['case'];
            $log->info('case :' . $case);
            unset($data['case']);
            switch ((int) $case) {
                case 1:
                case 2:
                
                    $log->info('add product  ');
                    $sql = "EXECUTE PROCEDURE ADD_PICK_ITEMS(?, 'T', 'T', ?, '', '', ?, 'NOW', ?, ?)";
                    if (false !== ($query = ibase_prepare($this->db, $sql))) {
                        $wk_added = false;
                        foreach ($data as $item) {
                            
                            if(!empty($item['SALE_PRICE'])){
                                $salePrice = $item['SALE_PRICE'];
                            } elseif(empty($salePrice)) {
                                $salePrice = 0.00;
                            }
                            
                            $item['QTY'] = $requiredQty;
                            $log->info(print_r($item, true));
                            
                            if (!$wk_added) {
                               $log->info('did not add  prod :' );
                               $log->info($pickOrder . ', ' . $item['PROD_ID'] . ', ' . $requiredQty . ', ' . $this->userId);
                               if (false === ($result = ibase_execute($query, $pickOrder, $item['PROD_ID'], $requiredQty, $this->userId, $salePrice))) {
                                   $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql . '. Params: (' . $pickOrder . ', ' . $item['PROD_ID'] . ', '  . $requiredQty . ', '  . $this->userId . ', '  . $salePrice . ')';
                                   break;
                               }
                                ibase_free_result($result);
                            }

                        }
                        ibase_free_query($query);
                    } else {
                        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                    }
                    break;

                case 3:
                    //This is totaly incorrect we should newer add SSN.SSN_ID to PICK_ITEM
                    //but instead we should add ISSN.SSN_ID (see minder issue #3562#note-8).
                    $log->info('add issn  ');
                    $sql = "EXECUTE PROCEDURE ADD_PICK_SSN_ITEMS(?, 'T', 'T', ?, '', ?, 'NOW', ?, ?)";
                    
                    if (false !== ($query = ibase_prepare($this->db, $sql))) {
                
                        $sum  = 0;
                        $last = false;
                        
                        foreach ($data as $item) {
                            if(is_null($item['PROD_ID']) || empty($item['PROD_ID'])) {
                                
                                if(!empty($item['SSN_SALE_PRICE'])) {
                                    $salePrice  =   $item['SSN_SALE_PRICE'];
                                } elseif(empty($salePrice)) {
                                    $salePrice = 0.00;
                                }
                                
                            } else {
                                $prodProfile    =   $this->getProduct($item['PROD_ID']);
                        
                                if(!empty($prodProfile->salePrice)) {
                                    $salePrice  =   $prodProfile->salePrice;   
                                } elseif(empty($salePrice)){
                                    $salePrice = 0.00;
                                }
                            }
                            
                            $itemCurrentQty = $this->getFieldSum('SSN', 'SSN.CURRENT_QTY', array('SSN.SSN_ID = ?' => array($item['SSN_ID'])));
                            
                            if (empty($itemCurrentQty) || empty($item['SSN_ID'])) {
                                $this->lastError = 'Error: CURRENT_QTY = 0 or SSN_ID is empty for select record.';
                                $result = false;
                                continue;
                            }
                            if ($item['CURRENT_QTY'] + $sum > $requiredQty) {
                                $item['CURRENT_QTY'] = $requiredQty - $sum;
                                $last = true;
                            }
                            $sum += $item['CURRENT_QTY'];
                            
                            if (false === ($result = ibase_execute($query, $pickOrder, $item['SSN_ID'], $item['CURRENT_QTY'], $this->userId, $salePrice))) {
                                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql. '. Params: (' . $pickOrder . ', ' . $item['SSN_ID'] . ', ' . $item['CURRENT_QTY'] . ', ' . $this->userId . ', ' . $salePrice . ')';
                                break;
                            }
                            if ($last) {
                                ibase_free_result($result);
                                break;
                            }

                            ibase_free_result($result);
                        }
                        ibase_free_query($query);
                    } else {
                        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                    }
                    break;
            } // switch
        } else {
            // --------------------
            // --- Non-Products ---
            // --------------------
       
            $log->info('add non product ');
            $sql = 'SELECT SSN_ID, CURRENT_QTY FROM ISSN WHERE ISSN.ORIGINAL_SSN = ?';
            $query = ibase_prepare($this->db, $sql);
            $sql = "EXECUTE PROCEDURE ADD_PICK_SSN_ITEMS(?, 'T', 'T', ?, '', ?, 'NOW', ?)";
            $query1 = ibase_prepare($this->db, $sql);
           
            if ($query && $query1) {
                foreach ($data as $item) {
                    if (($result = ibase_execute($query, $item['SSN_ID']))) {
                        while (false !== ($line = ibase_fetch_assoc($result))) {
                            $log->info($query1 . ', ' . $pickOrder . ', ' . $line['SSN_ID'] . ', ' . $line['CURRENT_QTY'] . ', ' . $this->userId);
                            if (false === ($res1 = ibase_execute($query1, $pickOrder, $line['SSN_ID'], $line['CURRENT_QTY'], $this->userId))) {
                                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                                ibase_free_query($query1);
                                ibase_free_query($query);
                                $result = false;
                                break 2;
                            }
                            else {
                                ibase_free_result($res1);
                            }
                        }
                       
                        ibase_free_result($result);
                    }
                }
                ibase_free_query($query1);
                ibase_free_query($query);
            } else {
                $result = false;
                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
            }
        }
        
        $this->pickOrderRecalculate($pickOrder);
        
        if ($result === false) {
            throw new Exception('Unable add PICK_ITEM. ' . $this->lastError);
        }
        return $result;
    }

    /**
    * Used when User inserting new Product PICK_ITEM
    * 
    * @param string  $pickOrder   - PICK_ORDER to add items to
    * @param array   $items       - list of PROD_ID and SALES_PRICE to add
    * @param integer $requiredQty - qty required to add
    * 
    * @return boolean
    */
    protected function addProductPickItem($pickOrder = '', $items = array(), $requiredQty = 0, $salePrice = 0) {
        $sql = "EXECUTE PROCEDURE ADD_PICK_ITEMS(?, 'T', 'T', ?, '', '', ?, 'NOW', ?, ?)";

        if (false !== ($query = ibase_prepare($this->db, $sql))) {

            foreach ($items as $item) {

            
                if(!empty($item['SALE_PRICE'])){
                    $salePrice = $item['SALE_PRICE'];
                } elseif(empty($salePrice)) {
                    $salePrice = 0.00;
                }


                
                if (false === ($result = ibase_execute($query, $pickOrder, $items['product'], $requiredQty, $this->userId, $salePrice))) {
                    $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql . '. Params: (' . $pickOrder . ', ' . $items['product'] . ', '  . $requiredQty . ', '  . $this->userId . ', '  . $salePrice . ')';
                    ibase_free_query($query);
                    return false;
                }
                else {
                    ibase_free_result($result);
                }
            }
            ibase_free_query($query);
        } else {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
            return false;
        }
        
        return true;
    }
    
    /**
    * Used when User inserting new Non Product PICK_ITEM
    * 
    * @param string  $pickOrder   - PICK_ORDER to add items to
    * @param array   $items       - list of ISSN.SSN_ID, ISSN.PROD_ID, ISSN.CURRENT_QTY, PROD_PROFILE.SALE_PRICE and SSN.SSN_SALE_PRICE to add
    * @param integer $requiredQty - qty required to add
    * 
    * @return boolean
    */
    protected function addNonProductPickItem($pickOrder = '', $items = array(), &$requiredQty = 0, $salePrice = 0) {
        $sql = "EXECUTE PROCEDURE ADD_PICK_SSN_ITEMS(?, 'T', 'T', ?, '', ?, 'NOW', ?, ?)";
        if (false !== ($query = ibase_prepare($this->db, $sql))) {
        
            $sum  = 0;
            $last = false;
            
            foreach ($items as $item) {
                if(empty($item['PROD_ID'])) {
                    if(!empty($item['SSN_SALE_PRICE'])) {
                        $salePrice =   $item['SSN_SALE_PRICE'];
                    } elseif(empty($salePrice)) {
                        $salePrice =   0.00;
                    }
                } else {
                    //TODO: replace subquery call with using PROD_PROFILE.SALE_PRICE
                    $prodProfile   =   $this->getProduct($item['PROD_ID']);
            
                    if(!empty($prodProfile->salePrice)) {
                        $salePrice =   $prodProfile->salePrice;   
                    } elseif(empty($salePrice)){
                        $salePrice =   0.00;
                    }
                }
                
                if (empty($item['CURRENT_QTY'])) {
                    ibase_free_query($query);
                    $this->lastError = 'Error: CURRENT_QTY = 0 for select record.';
                    return false;
                }
                if ($item['CURRENT_QTY'] + $sum > $requiredQty) {
                    $item['CURRENT_QTY'] = $requiredQty - $sum;
                    $last = true;
                }
                $sum += $item['CURRENT_QTY'];
                
                if (false === ($result = ibase_execute($query, $pickOrder, $item['SSN_ID'], $item['CURRENT_QTY'], $this->userId, $salePrice))) {
                    $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql. '. Params: (' . $pickOrder . ', ' . $item['SSN_ID'] . ', ' . $item['CURRENT_QTY'] . ', ' . $this->userId . ', ' . $salePrice . ')';
                    ibase_free_query($query);
                    return false;
                }
                if ($last) {
                    ibase_free_result($result);
                    ibase_free_query($query);
                    break;
                }

                ibase_free_result($result);
            }

            ibase_free_query($query);
            $requiredQty -= $sum;
        } else {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
            return false;
        }
        return true;
    }
    
    /**
    * Use this to add new PICK_ITEM to PICK_ORDER
    * 
    * @param array $collection
    * 
    * @return boolean
    */
    public function addPickItem(array &$collection) {

        $data = $collection;
        if (empty($collection['pick_order'])) {
            return false;
        }
        $pickOrder = $collection['pick_order'];
        unset($data['pick_order']);

        $salePrice  =   $data['price'];
        unset($data['price']);

        $requiredQty = $data['required_qty'];
        unset($data['required_qty']);

        $case = $data['case'];
        unset($data['case']);
        
        $result = true;
        switch ((int)$case) {
            case 1:
            case 2:
                //----------------
                //Adding PRODUCT
                //----------------
                $result = $this->addProductPickItem($pickOrder, $data, $requiredQty, $salePrice);

		
                break;
            case 3:
                //----------------
                //Adding NON PRODUCT
                //----------------
                $result = $this->addNonProductPickItem($pickOrder, $data, $requiredQty, $salePrice);
                break;
            default:
                //----------------
                //Error this should not happen
                //----------------
                $result = false;
                $this->lastError = 'Minder::' . __FUNCTION__ . ' bad $case: ' . $case;
        }
        
        $collection['not_added_qty'] = $requiredQty;
        
        $this->pickOrderRecalculate($pickOrder);
        
        if ($result === false) {
            throw new Exception('Unable add PICK_ITEM. ' . $this->lastError);
        }
        return true;
    }

    public function pickItemAdd($pickOrder, $line, $extendedInfo = false)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info('pickOrder:' . print_r($pickOrder,true));
        $log->info('line:' . print_r($line,true));
        if ((int)$line->qty < 1) {
            return false;
        }

        $success = false;
        $lineNo = null;
        if ((isset($line->issn) && $line->issn == '') || !isset($line->issn)) {
            $viaIssn = false;
            if (strlen($line->productId) > 14) {
                $line->productId = trim(substr($line->productId, 0, 14));
            }
            $sql    = "EXECUTE PROCEDURE ADD_PICK_ITEMS(?, 'T', 'T', ?, '', ?, ?, 'NOW', ?)";
            $log->info("EXECUTE PROCEDURE ADD_PICK_ITEMS('{$pickOrder}', 'T', 'T', '{$line->productId}', '', '{$line->PICK_ORDER_LINE_NO}', {$line->qty}, 'NOW', '{$this->userId}')");
            $this->msg("EXECUTE PROCEDURE ADD_PICK_ITEMS('{$pickOrder}', 'T', 'T', '{$line->productId}', '', '{$line->PICK_ORDER_LINE_NO}', {$line->qty}, 'NOW', '{$this->userId}')" . PHP_EOL);
            $query = ibase_prepare($this->db, $sql);
            if ($query !== false) {
                if (false !== ($result = ibase_execute($query, $pickOrder, $line->productId, $line->PICK_ORDER_LINE_NO, $line->qty, $this->userId))) {
                    $success = true;
                    ibase_free_result($result);
                    ibase_free_query($query);
                }
                else
                    ibase_free_query($query);
            }
        } else {
            $viaIssn = true;
            //$log     = Zend_Registry::get('logger');
            //$log->info("EXECUTE PROCEDURE ADD_PICK_SSN_ITEMS('{$pickOrder}', 'T', 'T', '{$line->issn}', '', '', {$line->qty}, 'NOW', '{$this->userId}')");
            $log->info("EXECUTE PROCEDURE ADD_PICK_SSN_ITEMS('{$pickOrder}', 'T', 'T', '{$line->issn}', '{$line->PICK_ORDER_LINE_NO}', {$line->qty}, 'NOW', '{$this->userId}')");
            //$this->msg("EXECUTE PROCEDURE ADD_PICK_SSN_ITEMS('{$pickOrder}', 'T', 'T', '{$line->issn}', '', '', {$line->qty}, 'NOW', '{$this->userId}')" . PHP_EOL);
            $this->msg("EXECUTE PROCEDURE ADD_PICK_SSN_ITEMS('{$pickOrder}', 'T', 'T', '{$line->issn}', '{$line->PICK_ORDER_LINE_NO}', {$line->qty}, 'NOW', '{$this->userId}')" . PHP_EOL);

            //$sql     = "EXECUTE PROCEDURE ADD_PICK_SSN_ITEMS(?, 'T', 'T', ?, '', ?, 'NOW', ?)";
            $sql     = "EXECUTE PROCEDURE ADD_PICK_SSN_ITEMS(?, 'T', 'T', ?, ?, ?, 'NOW', ?)";
            $query   = ibase_prepare($this->db, $sql);
            if ($query !== false) {
                //ibase_execute($query, $pickOrder, $line->issn, $line->qty, $this->userId);
                if (false !== ($result = ibase_execute($query, $pickOrder, $line->issn, $line->PICK_ORDER_LINE_NO, $line->qty, $this->userId))) {
                    $success = true;
                    ibase_free_result($result);
                    ibase_free_query($query);
                }
                else {
                    ibase_free_query($query);
                }
            } else {
                $this->lastError = ibase_errcode() . ' : ' . ibase_errmsg() . '. Query text: ' . $sql;
            }
        }
        if ($success) {
            $sql = "SELECT MAX(PICK_LABEL_NO) FROM PICK_ITEM WHERE PICK_ORDER = ?";

            $query = ibase_prepare($this->db, $sql);
            if ($query !== false) {
                $result = ibase_execute($query, $pickOrder);
                if (false !== $result) {
                    while (false !== ($data = ibase_fetch_row($result))) {
                        $lineNo = $data[0];
                    }
                    ibase_free_result($result);
                }
                ibase_free_query($query);
            } else {
                $this->lastError = ibase_errcode() . ' : ' . ibase_errmsg() . '. Query text: ' . $sql;
            }
        }
        if ($success) {
            if ($extendedInfo) {
                $params = array();
                $sql = 'UPDATE PICK_ITEM SET   ';
                foreach ($line as $key => $val) {
                    if (!$viaIssn) {
                        if ($key != 'qty' && $key != 'productId') {
                            if ($val != false ) {
                                $sql .= $key . ' = ?, ';
                                $params[] = $val;
                            }
                        }
                    } else {
                        if ($key != 'qty' && $key != 'productId' && $key != 'issn') {
                            if ($val != false ) {
                                $sql .= $key . ' = ?, ';
                                $params[] = $val;
                            }
                        }
                    }
                }
                $sql  = substr($sql, 0, -2);
                $sql .= ' WHERE PICK_ORDER = ? AND PICK_LABEL_NO = ?';
                //$log  = Zend_Registry::get('logger');
                $log->info($sql . '; ' . implode(',',$params));
                $params[] = $pickOrder;
                $params[] = $lineNo;

                $query  = ibase_prepare($sql);
                if (false !== $query) {
                    array_unshift($params, $query);
                    $result = call_user_func_array('ibase_execute', $params);
                    if (false !== $result) {
                        ibase_free_result($result);
                        ibase_free_query($query);
                    }
                    else {
                        ibase_free_query($query);
                    }
                }

            } else {
                $sql = "UPDATE PICK_ITEM SET CONTACT_NAME = ?, ALLOW_SUBSTITUTE = ?, SPECIAL_INSTRUCTIONS1 = ?, SPECIAL_INSTRUCTIONS2 = ?, SALE_PRICE = ?, TAX_RATE = ?, DISCOUNT = ?, LINE_TOTAL = ? WHERE PICK_ORDER = ? AND PICK_ORDER_LINE_NO = ?";

                $query = ibase_prepare($this->db, $sql);
                if ($query !== false) {
                    $result = ibase_execute($query, $line->contact, $line->allowSubstitute, $line->externalNote, $line->internalNote, $line->price, $line->gst, $line->discountRate, $line->total, $pickOrder, $lineNo);
                    if (false !== $result) {
                        ibase_free_result($result);
                        ibase_free_query($query);
                    }
                    else {
                        ibase_free_query($query);
                    }
                }
            }
        }

        $this->pickOrderRecalculate($pickOrder);

        if (!$success) {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
            throw new Exception('Unable add PICK_ITEM.');
        }

        $log->info('end pickitemadd' );
        return $success;
    }

    public function pickItemDelete($pickOrder, $pickLabelNo)
    {
        $sql = "EXECUTE PROCEDURE DELETE_SALE_ORDER_LINE(?)";

        $query = ibase_prepare($this->db, $sql);
        if ($query !== false) {
            $result = ibase_execute($query, $pickLabelNo);
            if (false !== $result) {
                ibase_free_result($result);
                ibase_free_query($query);
            }
            else {
                ibase_free_query($query);
            }
        }

        $this->pickOrderRecalculate($pickOrder);

        return true;
    }

    public function getControlFields($fields)
    {
        if (!is_array($fields)) {
            if (!is_string($fields)) {
                throw new Minder_Exception('Invalid parameters (' . __METHOD__ . ').');
            }
            $fields = array($fields);
        }
        $fields = array_intersect($this->getFieldList('CONTROL'), $fields);
        if (!count($fields)) {
            throw new Minder_Exception('Invalid parameters (' . __METHOD__ . ').');
        }
        $sql = 'SELECT FIRST 1 ' . implode(', ', $fields) . ' FROM CONTROL';
        return $this->fetchAssoc($sql);
    }

    public function pickOrderInsert(&$pickOrder)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info('pickOrder:' . print_r($pickOrder,true));

        $result = false;
        $items = $pickOrder->items;

        unset($pickOrder->items);

        if (($oldPickOrder = $this->getPickOrder($pickOrder->pickOrder))) {
            if( $oldPickOrder->pickStatus == 'HD' ||
                $oldPickOrder->pickStatus == 'OP'||
                $oldPickOrder->pickStatus == 'DA' ||
                $oldPickOrder->pickStatus == 'CF' ||
                $oldPickOrder->pickStatus == 'UC' ||
                $oldPickOrder->pickStatus == '') {

        if ($oldPickOrder->pickStarted != '') {
                    $this->lastError = 'Order already Started Picking ' . $oldPickOrder->pickStarted . '  ' . $pickOrder->pickOrder;
                    $result = false;
                } else {
                    $this->updatePickOrder($pickOrder);
                    $this->lastError = 'Order already updated. ' . $pickOrder->pickOrder;
                    $result = true;
                }
            } else {
                $this->lastError = 'Status ' . $oldPickOrder->pickStatus . ' is incorrect (allowed - OP/HD/DA). ' . $pickOrder->pickOrder;
                $result = false;
            }
        } else {
            if ($this->pickOrderCreate($pickOrder, true)) {
                $result = true;
            }
        }
            if($result) {
                try {
                    $errorMsg = '';
                    $listPickItemsToUpdate = array();
                    $listPickItems = $this->getPickItems($pickOrder->pickOrder);
                    foreach ($items as $key => $pickItem) {
                        $line = new stdClass();
                        $line->productId = $pickItem->items['PROD_ID'];
                        $line->qty       = (int)$pickItem->items['PICK_ORDER_QTY'];
                        $line->issn      = $pickItem->items['SSN_ID'];
                        foreach ($pickItem->items as $key => $val) {
                            if ($key != 'PROD_ID' && $key != 'PICK_ORDER_QTY' && $key != 'SSN_ID') {
                                    $line->$key = $val;
                            }
                        }
                        //$log = Zend_Registry::get('logger');
                        $log->info('check if exists pick_item');
                        //check exists the line - change to use the ssn and product
                        //if(($oldLine = $this->ifExistsPickItem($line->PICK_ORDER, $line->PI_LEGACY_LINENO))) {
                        if(($oldLine = $this->ifExistsPickItem($line->PICK_ORDER, $line->PI_LEGACY_LINENO, $line->issn, $line->productId))) {
                            $log->info('Exists - ' . $pickItem->id);
                            // must use the status list from the control table here
                            if( $oldLine['PICK_LINE_STATUS'] == 'UC' ||
                                $oldLine['PICK_LINE_STATUS'] == 'CF' ||
                                $oldLine['PICK_LINE_STATUS'] == 'OP' ||
                                $oldLine['PICK_LINE_STATUS'] == 'UP' ||
                                $oldLine['PICK_LINE_STATUS'] == 'AS' ||
                                $oldLine['PICK_LINE_STATUS'] == 'HD' ||
                                $oldLine['PICK_LINE_STATUS'] == 'CN' ||
                                $oldLine['PICK_LINE_STATUS'] == 'WP' ||
                                $oldLine['PICK_LINE_STATUS'] == ''
                                ) {
                                $pickItem['PICK_LABEL_NO'] = $oldLine['PICK_LABEL_NO'];
                                $this->updatePickItem($pickItem);
                                $listPickItemsToUpdate[] = $oldLine['PICK_LABEL_NO'];
                            } else {
                                $errorMsg .= 'Status ' . $oldLine['PICK_LINE_STATUS'] . ' for PICK_ITEM ' . $oldLine['PICK_LABEL_NO'] . ' is incorrect (allowed - AS/OP/HD/UP). ' . PHP_EOL;
                                $this->lastError = $errorMsg;
                                $result = false;
                            }
                        } else {
                            $log->info('add new item - ' . $pickItem->id);
                            $lineResult = $this->pickItemAdd($pickItem->items['PICK_ORDER'], $line, true);
                            if (!$lineResult) {
                                $log->info($this->lastError);
                            }
                        }
                        unset($line);
                    }

                    foreach($listPickItems as $item) {
                        if(!in_array($item->id, $listPickItemsToUpdate)) {
                            // the delete - change to use the ssn and product
                            //if(!$this->deletePickOrderLine($pickOrder->pickOrder, $item->items['PI_LEGACY_LINENO'])) {
                            /* if(!$this->deletePickOrderLine($pickOrder->pickOrder, $item->items['PI_LEGACY_LINENO'], $items->items['SSN_ID'], $items->items['PROD_ID'])) {
                                $this->lastError = 'Impossible delete PICK_ITEM ' . $item->id;
                                $result = false;
                            } */
                        }
                    }

                } catch (Exception $e) {
                    $log->info('Exception caught ' . __FUNCTION__);
                    $log->info($e->getMessage());
                    $log->info($e->getTraceAsString());
                }
                $log->info('end pickOrderInsert:' );
                ibase_commit();
                return $result;
            } else {
                $log->info('end pickOrderInsert:' );
                return $result;
            }
    }
    /**
    * @desc  update Sales Order
    * @param $pickOrder
    * @return boolean
     *
     * @deprecated duplicate see Minder::pickOrderUpdate()
    */
    public function updatePickOrder($pickOrder, $mode = 'default' ) {

       $orderNo = $pickOrder->pickOrder;
       $oldOrder = $this->getPickOrder($orderNo);

       $sql = 'UPDATE PICK_ORDER SET ';
       $where = ' WHERE PICK_ORDER = ? ';
       $data = array();

       if($mode == 'default'){
            foreach($pickOrder as $key => $value) {
             if($value != $oldOrder->$key && $value !== false && $key !== 'taxSubTotal') {
                $key = strtoupper(preg_replace('/([A-Z])/', '_$1', $key));
                $sql .= $key . ' = ?, ';
                $data[$key] = $value;
             }
            }    
       } else {
            foreach($pickOrder as $key => $value) {
             if($key != 'pickOrder') {
                $key = strtoupper(preg_replace('/([A-Z])/', '_$1', $key));
                $sql .= $key . ' = ?, ';
                $data[$key] = $value;
             }
            }    
       }
       
            $data['PICK_ORDER'] = $orderNo;

        $sql = substr($sql, 0, -2);
        $sql .= $where;
        
        $log = Zend_Registry::get('logger');
        $log->info($sql . '; ' . implode(',',$data));
        $query = ibase_prepare($this->db, $sql);
        if ($query) {
            array_unshift($data, $query);
            $args   = $this->prepareArgs($data);
            $result = call_user_func_array('ibase_execute', $args);
            if (false === $result) {
                $errcode = ibase_errcode();
                $errmsg = ibase_errmsg();
                ibase_free_query($query);
                $this->lastError = $errcode . ': ' . $errmsg . '. Query text: ' . $sql;
                return false;
            }
            $this->pickOrderRecalculate($pickOrder->pickOrder);
            ibase_free_query($query);
            return $result;
        } else {
            return false;
        }
     }

    public function updatePickOrderPickPriority($pickOrder, $newPickPriority) {
        $sql = "
            UPDATE PICK_ORDER SET
                PICK_PRIORITY = ?
            WHERE
                PICK_ORDER = ?
        ";

        return $this->execSQL($sql, array($newPickPriority, $pickOrder));
    }

    /**
    * @desc check if PickItem exists
    * @param Order, OrderLineNo
    * @return boolean
    *
    */
    private function ifExistsPickItem($pickOrder, $pickOrderLinNo, $pickSsn, $pickProduct) {
        $sql = 'SELECT * FROM PICK_ITEM WHERE PICK_ORDER = ? AND PI_LEGACY_LINENO = ? ';
        $searchValues = array();
        $searchValues [] = $pickOrder;
        $searchValues [] = $pickOrderLinNo;
        if ($pickSsn != '') {
            $sql .= ' AND SSN_ID = ? ';
            $searchValues[] = $pickSsn;
        }
        if ($pickProduct != '') {
            $sql .= ' AND PROD_ID = ? ';
            $searchValues[] = $pickProduct;
        }
        //if (count($line = $this->findAllAssocMod($sql, array($pickOrder, $pickOrderLinNo))) > 0) {
        if (count($line = $this->findAllAssocMod($sql, $searchValues)) > 0) {
            return $line[0];
        }
        return false;
    }
    /**
    * @desc update exists SalesOrder
    * @param $pickItem
    * @return boolean
    */
     public function updatePickItem($pickItem)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info('pickItem:' . print_r($pickItem,true));
        $args = $pickItem->items;

        $pickOrder = $args['PICK_ORDER'];
        $pickOrderLinNo = $args['PICK_LABEL_NO'];
        unset($args['PI_LEGACY_LINENO']);
        unset($args['PICK_ORDER']);
        unset($args['PICK_LABEL_NO']);

        $sql = 'UPDATE PICK_ITEM SET ';
        $values = array();
        foreach ($args as $key => $arg) {
            if($arg != false) {
                $sql .= "$key = ?, ";
                $values[$key] = $arg;
            }
        }
        $sql = substr($sql, 0, -2);

        $sql .= ' WHERE PICK_ORDER = ? AND PICK_LABEL_NO = ?';
        $values['PICK_ORDER'] = $pickOrder;
        $values['PICK_LABEL_NO'] = $pickOrderLinNo;
        $query = ibase_prepare($this->db, $sql);
        if ($query !== false) {
            array_unshift($values, $query);

            $values = $this->prepareArgs($values);

            //$log    = Zend_Registry::get('logger');
            $log->info($sql . '; ' . implode(',' , $values));

            $result = @call_user_func_array('ibase_execute', $values);
            
            if ($result === false) {
                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                throw new Exception('Error occur during save PICK_ITEM.' . $this->lastError);
            } else {
                $this->pickOrderRecalculate($pickItem->items['PICK_ORDER']);
                ibase_free_query($query);
                $log->info('end updatepickItem');
                return $result;
            }
        } else {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
            throw new Exception($this->lastError);
        }
        return false;
    }

    /**
     * Insert or Create PickOrder
     *
     * @param PickOrder $pickOrder
     * @param boolean $onlonlyinsert
     * @return boolean
     */
    public function pickOrderCreate(PickOrder &$pickOrder, $onlyinsert = false)
    {
/*
        if (empty($pickOrder->despatchLocation)) {
            $this->lastError = 'Cannot create Sales Order with empty DESPATCH_LOCATION.';
            return false;
        }
*/
/*
        if the person exists
               if  person status is CU or OB then ok
               else cannot do this
        else an imported order so ok
*/
        $person = $this->getPerson($pickOrder->personId, false, 'OF');
        if ($person != null) {
            if ($person->status !== 'CU' and $person->status !== 'OB') {
                $this->lastError = 'Cannot create Sales Order with Non Current Person.';
                return false;
            }
        }

        if (empty($pickOrder->despatchLocation)) {
            if (empty($this->defaultControlValues['DEFAULT_DESPATCH_LOCATION'])) {
                $this->lastError = 'Cannot create Sales Order with empty Despatch Location.';
                return false;
            }

            $pickOrder->despatchLocation = $this->defaultControlValues['DEFAULT_DESPATCH_LOCATION'];
        }
        
        if (strtoupper(trim($pickOrder->pCountry)) == 'AU' || strtoupper(trim($pickOrder->pCountry)) == 'AUSTRALIA') {
            $pickOrder->taxRate = $this->defaultControlValues['DEFAULT_GST_RATE'];
        } else {
            $pickOrder->taxRate = 0;
        }
        if ($onlyinsert === false) {
            $pickOrder->pickOrder = '';
            $pickOrder->createDate = date('Y-m-d H:i:s');

        }
        $pickOrder->createdBy = $this->userId;
        $pickOrder->lastUpdateDate = $pickOrder->createDate;
        $pickOrder->updateId = $this->userId;

        if ($pickOrder->pSameAsInvoiceTo == 'T') {
            $pickOrder->dAddressLine1 = $pickOrder->pAddressLine1;
            $pickOrder->dAddressLine2 = $pickOrder->pAddressLine2;
            $pickOrder->dCity = $pickOrder->pCity;
            $pickOrder->dState = $pickOrder->pState;
            $pickOrder->dPostCode = $pickOrder->pPostCode;
            $pickOrder->dCountry = $pickOrder->pCountry;
        }

        if ($onlyinsert === false) {
            $orderPrefix = substr($pickOrder->pickOrderType, 0, 1);
            $orderPrefix = $orderPrefix ? $orderPrefix : 'S';
            $sql = "SELECT SALE_ORDER_ID FROM GET_SALE_ORDER_NO('" . $orderPrefix . "')";
            $result = ibase_query($this->db, $sql);
            if (false !== $result) {
                while (false !== ($data = ibase_fetch_assoc($result))) {
                    $pickOrder->pickOrder = $data['SALE_ORDER_ID'];
                }
                ibase_free_result($result);
            }
        }
        if ($pickOrder->pickOrder == '') {
            return false;
        }
        $sql = 'INSERT INTO PICK_ORDER (';
        $values = '';
        $data = array();
        foreach ($pickOrder as $k => $v) {
            if ($k !== 'taxSubTotal') {
                $col = strtoupper(preg_replace('/([A-Z])/', '_$1', $k));
                if ($col == 'P_AUST_POST4STATE_ID') {
                    $col = 'P_AUST_POST_4STATE_ID';
                }
                if ($col == 'D_PERSON_ID' && $v == '') {

                } else {
                    $sql .= "$col, ";
                    $values .= '?, ';
                    $data[$col] = $v;
                }
            }
        }
        $sql = substr($sql, 0, -2);
        $sql .= ') VALUES (' . substr($values, 0, -2) . ')';

        $log = Zend_Registry::get('logger');
        $log->info($sql . '; ' . implode(',' , $data));

        $query = ibase_prepare($this->db, $sql);
        if ($query) {
            array_unshift($data, $query);
            try {
                $tmpData = $this->prepareArgs($data);
                Zend_Registry::get('logger')->debug(array('file' => __FILE__, 'line' => __LINE__, $sql, implode(';' , $tmpData)));
                $result = call_user_func_array('ibase_execute', $tmpData);
                if (false === $result) {
                    $errcode = ibase_errcode();
                    $errmsg = ibase_errmsg();
                    ibase_free_query($query);
                    throw new Minder_Exception($errcode . ': ' . $errmsg . '. Query text: ' . $sql);
                }
                $this->pickOrderRecalculate($pickOrder->pickOrder);
                ibase_free_result($result);
                ibase_free_query($query);
            } catch (Minder_Exception $e) {
                $this->lastError = $e->getMessage();
                return false;
            }
        } else {
            $this->lastError = ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql;
            return false;
        }
        return true;
    }

    public function pickOrderUpdate(&$pickOrder)
    {
/*
        if the person exists
               if  person status is CU or OB then ok
               else cannot do this
        else an imported order so ok
*/
        $person = $this->getPerson($pickOrder->personId, false, 'OF');
        if ($person != null) {
            if ($person->status !== 'CU' and $person->status !== 'OB') {
                $this->lastError = 'Cannot create Sales Order with Non Current Person.';
                return false;
            }
        }

        if (empty($pickOrder->despatchLocation)) {
            if (empty($this->defaultControlValues['DEFAULT_DESPATCH_LOCATION'])) {
                $this->lastError = 'Despatch Location cannot be NULL.';
                return false;
            }
            $pickOrder->despatchLocation = $this->defaultControlValues['DEFAULT_DESPATCH_LOCATION'];
        }

        $pickOrder->lastUpdateDate = $pickOrder->createDate;
        $pickOrder->updateId = $this->userId;

        if ($pickOrder->pSameAsInvoiceTo == 'T') {
            $pickOrder->dAddressLine1 = $pickOrder->pAddressLine1;
            $pickOrder->dAddressLine2 = $pickOrder->pAddressLine2;
            $pickOrder->dCity = $pickOrder->pCity;
            $pickOrder->dState = $pickOrder->pState;
            $pickOrder->dPostCode = $pickOrder->pPostCode;
            $pickOrder->dCountry = $pickOrder->pCountry;
        }

        $sql = 'UPDATE PICK_ORDER SET ';
        $data = array();
        foreach($pickOrder as $k => $v) {
            if ($k !== 'pickOrder' && $k !== 'createdBy' && $k !== 'createDate' && $k !== 'taxSubTotal') {
                $col = strtoupper(preg_replace('/([A-Z])/', '_$1', $k));
                if ($col == 'P_AUST_POST4STATE_ID') {
                    $col = 'P_AUST_POST_4STATE_ID';
                }
                $sql = $sql . $col . ' = ?, ';
                $data[] = $v;
            }
        }
        $sql = substr($sql, 0, -2);
        $sql = $sql . ' WHERE PICK_ORDER = ?';
        $data[] = $pickOrder->pickOrder;
        $query = ibase_prepare($this->db, $sql);
        if ($query) {
            array_unshift($data, $query);
            $result = call_user_func_array('ibase_execute', $data);
            if ($result) {
                $this->pickOrderRecalculate($pickOrder->pickOrder);
                ibase_free_query($query);
                return $result;
            }

            ibase_free_query($query);
        }
        return false;
    }


    /**
     * get searched for GrnLine object
     *
     * @param string $grnId - GRN's GRN to Get
     * @return  GrnLine
     */
    public function searchdGrn( $grnId , $queryType )
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);

        list($sql, $sqlOrder) =  $this->getSelectQuery( "F", 'GRN', $queryType);
    
    $sql .= "
                        WHERE  GRN.GRN = ? 
                    ";
        // New code
        
        $values = array( $grnId );
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $data   = $this->findAllAssocMod($sql, $values);
        
        return $data[0];
    }


    /**
     * Get records from GRN
     *
     * each record stored in new GRNLine object
     *
     * @return array of GRNLine
     */
    public function getGrns($clause = null, $method = 'edit', $pageNo = null, $resultsPerPage = null, $dbFields = array())
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
         // for showing GRN table use selected headers
         if($method != 'edit'){
              $queryType = "SR";
              list($sql, $sqlOrder) =  $this->getSelectQuery( "T", 'GRN');
         } else {
              $queryType = "ER";
              list($sql, $sqlOrder) =  $this->getSelectQuery( "T", 'GRN', $queryType);
         }
         
         $grnLines['data']  =   array();
         $grnLines['total'] =   0;
        
        //-- if not limited by company
        if ($this->limitCompany != 'all') {
            $sql .= " WHERE GRN.OWNER_ID = '" . $this->limitCompany . "' AND ";
        } else {
            //-- else assume all Companies accessible to User.
            if ($this->isAdmin || $this->isInventoryOperator) {
                $sql .= " WHERE ";
            } else {
                $companyList = $this->getCompanyList();
                if (count($companyList) > 0 ) {
                    $sql .= ' WHERE GRN.OWNER_ID IN (';
                    foreach ($companyList as $key => $val) {
                        $sql .= "'" . $val . "', ";
                    }
                    $sql = substr($sql, 0, strlen($sql) - 2);
                    $sql .= ') AND ';
                } else {
                    $sql .= ' WHERE ';
                }
            }
        }
        $sql .= ' 1=1 AND ';

        $values =   array();
        
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                    $sql .= $key;
                    if (!empty($val) && false != strpos($key, '?')) {
                        $values[] = $val;
                    } elseif(true == strpos($key, '?') && empty($val)) {
                        $values[] = ''; 
                    }
                }
        }

        $sql = substr($sql, 0, strlen($sql) - 5);
        //$sql .= ' ORDER BY GRN_DATE DESC';
//        $sql .= $sqlOrder;
    
        try{
            //$data = $this->findAllAssocMod($sql, $values);
            
            //list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
            list($sqlCount, $sqlQuery)  = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage, False);
            $sqlQuery                  .= $sqlOrder;
            $log->info('sqlCount:' . $sqlCount);
            $log->info('sqlQuery:' . $sqlQuery);
      
            if (false === ($Query = $this->prepareArgs($sqlCount, $values))) {
                throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sqlCount);
            }
            $total  = $this->findValue($sqlCount, $Query);
            //$this->getDBLog('getgrn performed the totals count');

            if (false === ($Query = $this->prepareArgs($sqlQuery, $values))) {
                throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sqlQuery);
            }
            $data   = $this->findAllAssocMod($sqlQuery, $Query);
      
            //$total  = $this->findValue($sqlCount, $values);
            //$data   = $this->findAllAssocMod($sqlQuery, $values);
            
        } catch(Exception $ex){
            throw new Exception($ex);   
        }
        
        if ($data !== null) {
            foreach ($data as $line) {
                $grnData = $this->searchdGrn($line['GRN'], $queryType);
                $temp = new GrnLine($grnData);
           
                //$temp               = new GrnLine($line);
                $temp->id           = $line['GRN'];
                $result['data'][]   = $temp;
            }
            
            $result['total'] =   $total;
           
            return $result;
            
        } else {
            return $grnLines;
        }
    }

    /**
     * get GRN list from GRN table for /warehouse/grn/
     *
     * @param string $q
     * @return array
     */
    public function getGrnNoListFromGrn($q = null)
    {
        $sql = "SELECT GRN, GRN FROM GRN";

        if (null != $q) {
            $sql .= " WHERE GRN LIKE ? ";
            return $this->findList($sql, "$q%");
        } else {
            return $this->findList($sql);
        }
    }

    /**
     * get ORDER_NO list from GRN table for /warehouse/grn/
     *
     * @param string $q
     * @return array
     */
    public function getOrderNoListFromGrn($q = null)
    {
        $sql = "SELECT ORDER_NO, ORDER_NO FROM GRN";

        if (null != $q) {
            $sql .= " WHERE UPPER(ORDER_NO) LIKE ? ";
            return $this->findList($sql, strtoupper("$q%"));
        } else {
            return $this->findList($sql);
        }
    }

    /**
     * Get audit code
     *
     * Return array where CODE is key, DESCRIPTION is value
     *
     * @return array
     */
    public function getAuditCodeList()
    {
        $sql = 'SELECT CODE, DESCRIPTION FROM AUDIT_CODE ORDER BY 1';

        return $this->findList($sql);
    }

    /**
     * get list of grn types from OPTIONS table
     * GROUP_CODE = 'ORDER_TYPE'
     *
     * @return array
     */
    public function getGrnTypeList()
    {
        //return $this->getOptionsList('ORDER_TYPE', 'CODE');
        return $this->getExtOptionsList('GRN_TYPE', 'CODE');
    }

    /**
     * get CARRIER from GRN table
     *
     * @return array
     */
    public function getCarrierFromGrn()
    {
        $sql = "SELECT CARRIER, CARRIER FROM GRN ORDER BY 1";

        return $this->findList($sql);
    }

    public function getCarriersList()
    {
        $sql = 'SELECT carrier_id, carrier_id FROM carrier ORDER BY 1 DESC';

        return $this->findList($sql);
    }

    public function getCarriers() {
        return $this->fetchAllAssoc('SELECT * FROM CARRIER ORDER BY CARRIER_ID');
    }
    
    public function getCarrierUoms($carrierId) {
//will use one uom set for all carriers (see: http://binary-studio.office-on-the.net/issues/3616#note-25 and previous discussion)
//        $sql = "SELECT UOM_DT AS DT, UOM_WT AS WT FROM CARRIER WHERE CARRIER_ID = ?";
//        
//        $uoms = array();
//        
//        try {
//            $uoms = $this->findOneAssoc($sql, $carrierId);
//            
//        } catch (Exception $e) {
//            throw new Minder_Exception('Cannot find carrier UOMs: ' . $e->getMessage());
//        }

        $uoms = array();
        $sql = "SELECT GROUP_CODE, CODE FROM OPTIONS WHERE GROUP_CODE IN (?, ?, ?)";
        $result = $this->fetchAllAssoc($sql, 'PACK_ID_WT', 'PACK_ID_DT', 'PACK_ID_VT');
        Zend_Registry::get('logger')->debug(array('file' => __FILE__, 'line' => __LINE__, $result));
        foreach ($result as $row) {
            switch ($row['GROUP_CODE']) {
                case 'PACK_ID_WT':
                    $uoms['WT'] = $row['CODE'];
                    break;
                case 'PACK_ID_DT':
                    $uoms['DT'] = $row['CODE'];
                    break;
                case 'PACK_ID_VT':
                    $uoms['VT'] = $row['CODE'];
                    break;
            }
        }
        
        return $uoms;
    }
    
    public function getDsotUoms() {
        return array('WT' => 'KG', 'VT' => 'M3', 'DT_FOR_VT' => 'MT');
    }
    
    public function getPackIdTypes() {
        return $this->getOptionsList('PACKIDTYPE');
    }
    
    public function getDimensionDefaults() {
        $uomDefaultsCodes = array();
        
        foreach ($this->getPackIdTypes() as $typeCode => $typeDescription) {
            $uomDefaultsCodes[] = 'PACK_ID_D' . $typeCode;
            $uomDefaultsCodes[] = 'PACK_ID_W' . $typeCode;
        }
        
        if (count($uomDefaultsCodes) < 1) {
            throw new Minder_Exception('No PACKIDTYPE defined in OPTIONS table. Check system setup.');
        }
        
        $sql = 'SELECT GROUP_CODE, CODE FROM OPTIONS WHERE GROUP_CODE IN (' . substr(str_repeat('?, ', count($uomDefaultsCodes)), 0, -2) . ')';
        
        array_unshift($uomDefaultsCodes, $sql);
        
        $result = call_user_func_array(array($this, 'fetchAllAssoc'), $uomDefaultsCodes);
        
        $dimensionDefaults = array();
        
        foreach ($result as $resultRow) {
            $tmpUomType  = substr($resultRow['GROUP_CODE'], 0, 9);
            $tmpPackType = substr($resultRow['GROUP_CODE'], 9, 1);
            
            if ($tmpUomType == 'PACK_ID_D') {
                list($L, $W, $H) = explode('|', $resultRow['CODE']);
                $dimensionDefaults[strtoupper($tmpPackType)]['L'] = $L;
                $dimensionDefaults[strtoupper($tmpPackType)]['W'] = $W;
                $dimensionDefaults[strtoupper($tmpPackType)]['H'] = $H;
            } elseif ($tmpUomType == 'PACK_ID_W') {
                $dimensionDefaults[strtoupper($tmpPackType)]['WT'] = $resultRow['CODE'];
            }
        }
        
        return $dimensionDefaults;
    }

    /**
     * get OWNER_ID from GRN table
     *
     * @return array
     */
    public function getOwnerIdFromGrn()
    {
        $sql = "SELECT OWNER_ID, OWNER_ID FROM GRN ORDER BY 1";

        return $this->findList($sql);
    }

    /**
     * get RETURN_ID from GRN table
     *
     * @return array
     */
    public function getSupplierIdFromGrn()
    {
        $sql = "SELECT RETURN_ID, RETURN_ID FROM GRN ORDER BY 1";

        return $this->findList($sql);
    }

    /**
     * Return a list of issn
     *
     * @param $q filter for SSN_ID
     *
     * @return array
     */
    public function getIssnList($q = null, $orderBy = 'ISSN.SSN_ID')
    {
        if ($q ==! null) {
            $q = '%' . strtoupper($q) . '%';
            //$sql = "SELECT ISSN.SSN_ID, NONULL(SSN.SSN_DESCRIPTION) || '(' || NONULL(GRN.GRN_DATE) || ')'
            $sql = "SELECT ISSN.SSN_ID,
                    (CASE WHEN SSN.SSN_DESCRIPTION IS NOT NULL
                       THEN SSN.SSN_DESCRIPTION
                       ELSE ''
                     END ) || '(' ||
                    (CASE WHEN GRN.GRN_DATE IS NOT NULL
                       THEN GRN.GRN_DATE
                       ELSE ''
                     END ) || ')'
                    FROM ISSN
                    LEFT OUTER JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID
                    LEFT OUTER JOIN GRN ON GRN.GRN = SSN.GRN
                    WHERE UPPER(ISSN.SSN_ID) LIKE ?
                       OR UPPER(SSN.SSN_DESCRIPTION) LIKE ?
                    ORDER BY " . $orderBy;
            return $this->findList($sql, $q, $q);
        }
        $sql = "SELECT ISSN.SSN_ID, SSN_DESCRIPTION FROM ISSN LEFT JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID ORDER BY 1";
        return $this->findList($sql);
    }


    /**
     * get SSN_ID for ISSN
     *
     * @param string $ssnId - ISSN's SSN_ID to Get
     * @return  ORIGINAL_SSN
     */
    public function getOriginalSsn($ssnId)
    {
        $sql = 'SELECT ORIGINAL_SSN FROM ISSN WHERE SSN_ID = ?';
        return $this->fetchOne($sql, $ssnId);
    }

    
    /**
     * get Last SSN_ID for the Grn
     *
     * @param string $grnId - SSN's GRN to Get
     * @return  SSN_ID
     */
    public function getLastSsnforGrn($grnId)
    {
        $sql = 'SELECT FIRST 1 SSN_ID FROM SSN WHERE GRN = ? ORDER BY CREATE_DATE DESC';
        return $this->fetchOne($sql, $grnId);
    }

    
    /**
     * get searched for IssnLine object
     *
     * @param string $ssnId - ISSN's SSN_ID to Get
     * @return  IssnLine
     */
    public function searchdIssn( $ssnId, $queryType = 'SR')
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);



        list($sql, $sqlOrder) =  $this->getSelectQuery( "F", "ISSN", $queryType);
    $sql .= "
                        WHERE  ISSN.SSN_ID = ? 
                    ";
        // New code
        $values = array( $ssnId );
        
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $data   = $this->findAllAssocMod($sql, $values);
       
        return $data[0];
    }

    /**
     * @deprecated remove when possible
     * @param string $screenType
     * @return string
     */
    protected function _getScreenNameByScreenType($screenType) {
        return Minder_SysScreen_Legacy_OptionManager::getScreenNameByScreenType($screenType);
//        return Minder_SysScreen_TypeEnumerator::getName($screenType);
//        return $this->findValue("SELECT DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = ? AND CODE = ? ", 'SCN_FORMAT', $screenType );
    }

    /**
     * @deprecated remove when possible
     * @throws Exception|Minder_Exception
     * @param string $primaryId
     * @param string $screenName
     * @param string $queryType
     * @return string
     */
    protected function _formatSelectPart($primaryId, $screenName, $queryType) {
        $result = '';
        // get screen vars required
        $varData   = Minder_SysScreen_Legacy_VarManager::getVars($primaryId, $screenName, $queryType);

        //$log->info('varData:' . print_r( $varData,true));
        $wkHaveVar = False;
        $fieldsCount = 0;
        if ($varData !== null && is_array($varData)) {
            foreach( $varData as $varLine) {
                // get the user type check
                //if (($varLine['SSV_USER_TYPE'] == '')  || ($varLine['SSV_USER_TYPE'] == $myUserType)) {
                if (($varLine['SSV_USER_TYPE'] == '')  || in_array($this->_getCurrentUserType(), explode('|', $varLine['SSV_USER_TYPE']) )) {
                    $wk_isok = True;
                } else {
                    $wk_isok = False;
                }
                // and in the wh check
                if ($wk_isok) {
                    if (($varLine['WH_ID'] != '') && ($varLine['WH_ID'] != $this->whId)) {
                        $wk_isok = False;
                    }
                }
                // and in the device type check
                if ($wk_isok) {
                    if (($varLine['SSV_DEVICE_TYPE'] != '') && ($varLine['SSV_DEVICE_TYPE'] != $this->_getCurrentDeviceType())) {
                        $wk_isok = False;
                    }
                }

                if ($wk_isok) {
                    $fieldsCount++;
                    //$log->info('varLine:' . print_r( $varLine,true));
                    if ($varLine['SSV_ALIAS'] != '') {
                        $varLine['SSV_ALIAS'] = 'AS ' . $varLine['SSV_ALIAS'];
                    }
                    if ($wkHaveVar) {
                        $result .=  "," ;
                    } else {
                        $wkHaveVar = True;
                    }
                    $result .=  PHP_EOL ;
                    if ($varLine['SSV_EXPRESSION'] == '') {
                        if ($varLine['SSV_TABLE'] == '') {
                            $result .=  $varLine['SSV_NAME'] ;
                        } else {
                            $result .=  $varLine['SSV_TABLE'] . "." . $varLine['SSV_NAME'] ;
                        }
                    } else {
                        $result .=  $varLine['SSV_EXPRESSION'] ;
                    }
                    $result .= " " .  $varLine['SSV_ALIAS'] ;
                }
            }
        }
        if ($fieldsCount == 0 ) {
            if ($primaryId == 'T') {
                throw new Exception("Error: Cannot find any primary key for '$screenName'");
            } else {
                throw new Exception("Error: Cannot find any field for '$screenName'");
            }
        }

        //$log->info('sqlResult:' . $sqlResult);
        return $result;
    }

    /**
     * @deprecated remove when possible
     * @throws Exception|Minder_Exception
     * @param string $screenName
     * @return string
     */
    protected function _formatFromPart($screenName) {
        $result = '';
        $tableData = Minder_SysScreen_Legacy_TableManager::getTables($screenName);
        //$log->info('tableData:' . print_r( $tableData,true));
        if ($tableData !== null && is_array($tableData)) {
            $tablesCount = 0;
            foreach( $tableData as $tableLine) {
                // get the user type check
                if (($tableLine['SST_USER_TYPE'] == '')  || ($tableLine['SST_USER_TYPE'] == $this->_getCurrentUserType())) {
                    $wk_isok = True;
                } else {
                    $wk_isok = False;
                }
                // and in the wh check
                if ($wk_isok) {
                    if (($tableLine['WH_ID'] != '') && ($tableLine['WH_ID'] != $this->whId)) {
                            $wk_isok = False;
                    }
                }
                // and in the device type check
                if ($wk_isok) {
                    if (($tableLine['SST_DEVICE_TYPE'] != '') && ($tableLine['SST_DEVICE_TYPE'] != $this->_getCurrentDeviceType())) {
                        $wk_isok = False;
                    }
                }

                if ($wk_isok) {
                    $tablesCount++;
                    //$log->info('tableLine:' . print_r( $tableLine,true));
                    if ($tableLine['SST_ALIAS'] != '') {
                        $tableLine['SST_ALIAS'] = 'AS ' . $tableLine['SST_ALIAS'];
                    }

                    $result .=  PHP_EOL . $tableLine['SST_JOIN'] . " " . $tableLine['SST_TABLE'] .  " " . $tableLine['SST_ALIAS'] . " " . $tableLine['SST_VIA'];
                }
            }

            if ($tablesCount ==0 ){
                throw new Exception("Cannot find any table for '$screenName'");
            }
        }

        return $result;
    }

    /**
     * @deprecated remove when possible
     * @throws Minder_Exception
     * @param string $screenName
     * @return string
     */
    protected function _formatOrderByPart($screenName) {
        $result     = '';
        $orderData  = Minder_SysScreen_Legacy_OrderManager::getOrders($screenName);
        //$log->info('tableData:' . print_r( $tableData,true));
        if ($orderData !== null && is_array($orderData)) {
            foreach( $orderData as $orderLine) {
                // get the user type check
                if (($orderLine['SSO_USER_TYPE'] == '')  || ($orderLine['SSO_USER_TYPE'] == $this->_getCurrentUserType())) {
                    $wk_isok = True;
                } else {
                    $wk_isok = False;
                }
                // and in the wh check
                if ($wk_isok) {
                    if (($orderLine['WH_ID'] != '') && ($orderLine['WH_ID'] != $this->whId)) {
                        $wk_isok = False;
                    }
                }
                // and in the device type check
                if ($wk_isok) {
                    if (($orderLine['SSO_DEVICE_TYPE'] != '') && ($orderLine['SSO_DEVICE_TYPE'] != $this->_getCurrentDeviceType())) {
                        $wk_isok = False;
                    }
                }

                if ($wk_isok) {
                    //$log->info('orderLine:' . print_r( $orderLine,true));
                    // if sso_order starting 'order'
                    // else add a quote before the field
                    $wk_is_order = stripos( $orderLine['SSO_ORDER'],"ORDER BY ");
                    if ($wk_is_order === FALSE){
                        $result .= ",";
                    }
                    $result .=  PHP_EOL . $orderLine['SSO_ORDER']  ;
                }
            }
        }
        return $result;
    }

    protected function _getCurrentUserType() {
        if (is_null($this->userType)) {
            // what is my user type
            //      currently the sys_admin flag for this user
            //      added incentory operator and editable
            $this->userType = "|";
            $this->userType .= ($this->isAdmin) ? 'A' : ' ';
            $this->userType .= "|";
            $this->userType .= ($this->isInventoryOperator) ? 'I' : ' ';
            $this->userType .= "|";
            $this->userType .= ($this->isEditable) ? 'E' : ' ';
            $this->userType =  $this->getUserCategory() ;
            // want to add credit and sales manager
            $this->userType .= "|";
        }

        return $this->userType;
    }

    protected function _getCurrentDeviceType() {
        if (is_null($this->deviceType)) {
            $this->deviceType = $this->findValue("SELECT DEVICE_TYPE FROM SYS_EQUIP WHERE DEVICE_ID = ? ", $this->deviceId );
        }

        return $this->deviceType;
    }

    /**
     * get searched for Query
     *
     * @param string $primaryId - get primary Id only 
     * @param string $screenType - to get eg ISSN 
     * @param string $queryType - to get eg 'SR' for Search Result Set 'SE' for Search  'ER' for Edit Result Set 
     * @return  sqlResult and sqlOrder
     */
    public function GetSelectQuery( $primaryId, $screenType , $queryType = 'SR' )
    {
        $log = Minder_Registry::getLogger()->startDetailedLog();
        $cacheKey = implode('|', func_get_args());
        $log->starting(__METHOD__ . ': ' . $cacheKey);

        if (!isset($this->_selectQueryCache[$cacheKey])) {
            $screenName = $this->_getScreenNameByScreenType($screenType);

            $sqlResult  = "SELECT " . $this->_formatSelectPart($primaryId, $screenName, $queryType);
            $sqlResult .= ' FROM ' . $this->_formatFromPart($screenName);

            $sqlOrder   = PHP_EOL . $this->_formatOrderByPart($screenName);

            $this->_selectQueryCache[$cacheKey] = array($sqlResult, $sqlOrder);
        }

        $log->done();
        return $this->_selectQueryCache[$cacheKey];
    }
    
    /**
     * get searched for fields in the Query
     *
     * @param string $primaryId - get primary Id only 
     * @param string $screenType - to get eg ISSN 
     * @param string $queryType - to get eg 'SR' for Search Result 'SE' for Search 'ER' for Edit Result 
     * @return  array of fields that the Query Returns
     */
    public function GetSelectField(  $screenType , $queryType = 'SR' )
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
    $sqlResult = array();
    $varData = array();
    // get the screen name to use
    $screenName = $this->_getScreenNameByScreenType($screenType);
    // what is my user type
    $myUserType = "|";
    $myUserType .= ($this->isAdmin) ? 'A' : ' ';
    $myUserType .= "|";
    $myUserType .= ($this->isInventoryOperator) ? 'I' : ' ';
    $myUserType .= "|";
    $myUserType .= ($this->isEditable) ? 'E' : ' ';
        $myUserType =  $this->getUserCategory() ;
    // want to add credit manager and sales manager
    $myUserType .= "|";
    // what is my wh id
    $myWhId =   $this->whId;
    // what is my company
    // what is my device type
        $myDeviceType = $this->findValue("SELECT DEVICE_TYPE FROM SYS_EQUIP WHERE DEVICE_ID = ? ", $this->deviceId );

    // what about my user type -yes
    // what about my company
    // what about my wh id - yes
    // what about my device type - yes

    // get screen vars required
    $sql = "SELECT SSV_NAME,
                       SSV_EXPRESSION,
                       SSV_SEQUENCE,
                       SSV_ALIAS,
                       SSV_TABLE,
                       SSV_TITLE,
                       COMPANY_ID,
                       WH_ID,
                       SSV_USER_TYPE,
                       SSV_DEVICE_TYPE
                FROM SYS_SCREEN_VAR
                WHERE SS_NAME = ?
                AND   SSV_FIELD_STATUS = ?
                AND   SSV_FIELD_TYPE = ? 
                ORDER BY SSV_SEQUENCE ";

        //$values = array( $screenName, 'OK', 'SR' );
        $values = array( $screenName, 'OK', $queryType );
        
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $varData   = $this->findAllAssocMod($sql, $values);
        
        //$log->info('varData:' . print_r( $varData,true));
        if ($varData !== null && is_array($varData)) {
        foreach( $varData as $varLine) {
                // get the user type check
                //if (($varLine['SSV_USER_TYPE'] == '')  || ($varLine['SSV_USER_TYPE'] == $myUserType)) {
                if (($varLine['SSV_USER_TYPE'] == '')  || in_array($myUserType , explode('|', $varLine['SSV_USER_TYPE']) )) {
                    $wk_isok = True;
                } else {
                    $wk_isok = False;
                }
                // and in the wh check
                if ($wk_isok) {
                    if (($varLine['WH_ID'] != '') && ($varLine['WH_ID'] != $myWhId)) {
                        $wk_isok = False;
                    } 
                } 
                // and in the device type check
                if ($wk_isok) {
                    if (($varLine['SSV_DEVICE_TYPE'] != '') && ($varLine['SSV_DEVICE_TYPE'] != $myDeviceType)) {
                        $wk_isok = False;
                    } 
                } 

                if ($wk_isok) {
                    //$log->info('varLine:' . print_r( $varLine,true));
                    if ($varLine['SSV_ALIAS'] == '') {
                        if ($varLine['SSV_EXPRESSION'] == '') {
                        $sqlResult[ $varLine['SSV_NAME']] = $varLine['SSV_TITLE'] ;
                        } else {
                        $sqlResult[ 'EXPRESSION'] = $varLine['SSV_TITLE'] ;
                        }
                    } else {
                    $sqlResult[ $varLine['SSV_ALIAS']] = $varLine['SSV_TITLE'] ;
                    }
                }
        }
    }

        $log->info('sqlResult:' . print_r( $sqlResult, true));
        return $sqlResult;
    }
    
    /**
    * getSearchInputs
    * 
    * @param mixed $ssName
    * @param mixed $ssvFieldType
    * @deprecated use Minder_SysScreen class insted
    * @return mixed
    */
    public function getSearchInputs($ssName, $ssvFieldType = 'SE'){
        $sqlResult      =   Minder_SysScreen_Legacy_VarManager::getVars('F', $ssName, $ssvFieldType);
        $returnResult   =   array();
        $dropDownList1  =   array();
        $dropDownList2  =   array();
        $allowedList    =   array();
        
        foreach($sqlResult as $row){
            if($row['SSV_INPUT_METHOD'] != 'DL|1|' && $row['SSV_INPUT_METHOD'] != 'dl|1|' && 
               $row['SSV_INPUT_METHOD'] != 'DL|2|' && $row['SSV_INPUT_METHOD'] != 'dl|2|' ){
                
                $data                   =   array();
                $data['SSV_NAME']       =   $row['SSV_NAME'];       
                $data['SSV_TITLE']      =   $row['SSV_TITLE'];
                $data['TYPE']           =   $row['SSV_INPUT_METHOD'];
                $data['SEARCH_PARAM']   =   '';
                
                $returnResult[] =   $data;       
            }
            
            if($row['SSV_INPUT_METHOD'] == 'dl|1|'){
                $dropDownList1[$row['SSV_NAME']] =    $row['SSV_TITLE'];     
            }
            
            if($row['SSV_INPUT_METHOD'] == 'dl|2|'){
                $dropDownList2[$row['SSV_NAME']] =    $row['SSV_TITLE'];     
            }
            
            if($row['SSV_INPUT_METHOD'] == 'DL|1|'){
                $dropDownListNames[0]   =   $row['SSV_TITLE'];       
            }
            
            if($row['SSV_INPUT_METHOD'] == 'DL|2|'){
                $dropDownListNames[1]   =   $row['SSV_TITLE'];       
            }
            
            if(!empty($row['SSV_NAME'])){
                if($row['SSV_INPUT_METHOD'] == 'DP'){
                    $allowedList[$row['SSV_NAME']]  =   $row['SSV_TABLE'] . '.' . $row['SSV_NAME'] . ' = ? AND ';           
                } else if ($row['SSV_INPUT_METHOD'] == 'IN' || $row['SSV_INPUT_METHOD'] == 'dl'){
                    $allowedList[$row['SSV_NAME']]  =   $row['SSV_TABLE'] . '.' . $row['SSV_NAME'] . ' LIKE ? AND ';           
                } else{
                    $allowedList[$row['SSV_NAME']]  =   $row['SSV_TABLE'] . '.' . $row['SSV_NAME'] . ' = ? AND ';           
                }
            }
        }
        
        return array($returnResult, $dropDownList1, $dropDownList2, $dropDownListNames, $allowedList);
    
    }
    
    /**
    * Modified version of getSearchInputs - gets search inputs without any restrictions
    * 
    * @param string $ssName - name of system screen to get fields
    * @param string $ssvFieldType - search fields type
    */
    public function getSearchInputs2($ssName, $ssvFieldType = 'SE'){
        
        //lets find correct SS_NAME from option table
        $ssRealName = $this->_getScreenNameByScreenType($ssName);
        
        if (empty($ssRealName)) {
            //if didn't found assume that ssName is ssRealName
            $ssRealName = $ssName;
        }
        
        $sql = "SELECT *
                FROM SYS_SCREEN_VAR
                WHERE SS_NAME = ? AND 
                      SSV_FIELD_TYPE = ? AND
                      SSV_FIELD_STATUS =  'OK'
                ORDER BY SSV_SEQUENCE";
        
        $values =   array($ssRealName, $ssvFieldType);
        
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $sqlResult      =   $this->findAllAssocMod($sql, $values);
        $returnResult   =   array();
        
        $dlRepository   =   array();
        
        foreach($sqlResult as $row){
            $inputParser = new Minder_Page_FormBuilder_InputMethodParcer();
            $parseResult = $inputParser->parse($row['SSV_INPUT_METHOD']);

            switch ($parseResult->inputMethod){
                case Minder_Page_FormBuilder_InputMethod::INPUT:
                case Minder_Page_FormBuilder_InputMethod::DATE_PICKER:
                case Minder_Page_FormBuilder_InputMethod::COMPLEX_DROPDOWN_NAME:
                    $data                   =   array();
                    $data['SSV_NAME']       =   $row['SSV_NAME'];       
                    $data['SSV_TABLE']      =   $row['SSV_TABLE'];       
                    $data['SSV_TITLE']      =   $row['SSV_TITLE'];
                    $data['TYPE']           =   $row['SSV_INPUT_METHOD'];
                    $data['SSV_EXPRESSION'] =   $row['SSV_EXPRESSION'];
                    $data['SEARCH_PARAM']   =   '';
                
                    if ($parseResult->inputMethod == Minder_Page_FormBuilder_InputMethod::COMPLEX_DROPDOWN_NAME) {
                        if ((!isset($parseResult->groupNo)) || (!is_numeric($parseResult->groupNo))) {
                            throw new Exception("Unrecognised input method '". $row['SSV_INPUT_METHOD']."' for '".$row['SSV_NAME']."' in '$ssName'");
                        }
                        
                        $data['SEARCH_PARAM1'] =   '';
                        $dlRepository['DL|'.$parseResult->groupNo]['SSV_SEQUENCE'] = $row['SSV_SEQUENCE'];
                        if (!isset($dlRepository['DL|'.$parseResult->groupNo]['VALUES'])) {
                            $dlRepository['DL|'.$parseResult->groupNo]['VALUES']       = array();
                        }
                        $dlRepository['DL|'.$parseResult->groupNo]['DESCRIPTION']  = $data;
                    }
                    
                    if (array_key_exists($row['SSV_SEQUENCE'], $returnResult)) {
                        throw new Exception("Duplicate SSV_SEQUENS=".$row['SSV_SEQUENCE']." for '".$data['SSV_NAME']."' and '".$returnResult[$row['SSV_SEQUENCE']]['SSV_NAME']."' in '$ssName'.");
                    }
                    
                    $returnResult[$row['SSV_SEQUENCE']] =   $data;       
                    break;
                case Minder_Page_FormBuilder_InputMethod::DROP_DOWN:
                    //here we should get avalable values for dropdown list using SSV_DROPDOWN_SQL
                    //assuming for now there would be two collumns in query: the first is key, the second is value
                    //find whether it's true!!!
                    
                    try {
                        switch (strtoupper(trim($row['SSV_DROPDOWN_DATA_FROM']))) {
                            case 'FUN':
                                $methodName = substr($row['SSV_DROPDOWN_SQL'], 0, strpos($row['SSV_DROPDOWN_SQL'], '('));
                                
                                if (!is_callable(array($this, $methodName))) {
                                    throw new Exception("Unsupported method '$methodName' in 'SSV_DROPDOWN_DATA_FROM' = '" . $row['SSV_DROPDOWN_DATA_FROM'] . "' for #" . $row['RECORD_ID'] . " in $ssName.");
                                }
                                
                                eval('$args = array' . strstr($row['SSV_DROPDOWN_SQL'], '(') . ';');
                                $list = call_user_func_array(array($this, $methodName), $args);
                                break;
                            case 'SQL':
                                $list = $this->findList($row['SSV_DROPDOWN_SQL']);
                                break;
                            default:
                                throw new Exception("Unsupported 'SSV_DROPDOWN_DATA_FROM' = '" . $row['SSV_DROPDOWN_DATA_FROM'] . "' for #" . $row['RECORD_ID'] . " in $ssName.");
                        }
                    } catch (Exception $e) {
                        throw new Exception("Error building options list for dropdown search field #".$row['RECORD_ID']." in '$ssName'. Reason: " . $e->getMessage());
                    }
                    
                    $data                   =   array();
                    $data['SSV_NAME']       =   $row['SSV_NAME'];       
                    $data['SSV_TABLE']      =   $row['SSV_TABLE'];       
                    $data['SSV_TITLE']      =   $row['SSV_TITLE'];
                    $data['TYPE']           =   $row['SSV_INPUT_METHOD'];
                    $data['SSV_EXPRESSION'] =   $row['SSV_EXPRESSION'];
                    $data['SEARCH_PARAM']   =   '';
                    $data['VALUES']         =   array_merge(array('' => ''), $list);
                    
                    $returnResult[$row['SSV_SEQUENCE']] =   $data;       
                    break;
                case Minder_Page_FormBuilder_InputMethod::COMPLEX_DROPDOWN_VALUESLIST:
                    if ((!isset($parseResult->groupNo)) || (!is_numeric($parseResult->groupNo))) {
                        throw new Exception("Unrecognised input method '". $row['SSV_INPUT_METHOD']."' for '".$row['SSV_NAME']."' in '$ssName'.");
                    }
                    
                    $dlRepository['DL|'.$parseResult->groupNo]['VALUES'][$row['SSV_NAME']] = $row['SSV_TITLE'];
                    break;
                default:
                    throw new Exception("Unrecognised input method '". $row['SSV_INPUT_METHOD']."' for '".$row['SSV_NAME']."' in '$ssName'.");
                
            }
            
            if((!empty($row['SSV_NAME'])) && ($parseResult->inputMethod != Minder_Page_FormBuilder_InputMethod::COMPLEX_DROPDOWN_NAME)) {
                $tmpCond = '';
                if ($parseResult->inputMethod == Minder_Page_FormBuilder_InputMethod::DATE_PICKER) {
                    if (empty($row['SSV_EXPRESSION'])) {
                        $tmpCond = $row['SSV_TABLE'] . '.' . $row['SSV_NAME'] . " BETWEEN ZEROTIME(CAST(? AS TIMESTAMP)) AND MAXTIME(CAST(? AS TIMESTAMP)) AND ";
                    } else {
                        $tmpCond = $row['SSV_EXPRESSION'] . " BETWEEN ZEROTIME(CAST(? AS TIMESTAMP)) AND MAXTIME(CAST(? AS TIMESTAMP)) AND ";
                    }
                } else if ($parseResult->inputMethod == Minder_Page_FormBuilder_InputMethod::INPUT ||
                           $parseResult->inputMethod == Minder_Page_FormBuilder_InputMethod::COMPLEX_DROPDOWN_VALUESLIST){
                    if (empty($row['SSV_EXPRESSION'])) {
                        $tmpCond = $row['SSV_TABLE'] . '.' . $row['SSV_NAME'] . " LIKE ? AND ";
                    } else {
                        $tmpCond = $row['SSV_EXPRESSION'] . " LIKE ? AND ";
                    }
                } else {
                    if (empty($row['SSV_EXPRESSION'])) {
                        $tmpCond = $row['SSV_TABLE'] . '.' . $row['SSV_NAME'] . " = ? AND ";
                    } else {
                        $tmpCond = $row['SSV_EXPRESSION'] . " = ? AND ";
                    }
                }
                $allowedList[$row['SSV_NAME']] = $tmpCond;
            }
        }
//        var_dump(array('file' => __FILE__, 'line' => __LINE__, '$dlRepository' => $dlRepository));
        
        foreach ($dlRepository as $dlKey => $dlElement) {
            if (!count($dlElement['VALUES'])) {
                throw new Exception("Dropdown search field '".$dlElement['DESCRIPTION']['SSV_TITLE']."' with input method ".$dlKey."| was declared for '$ssName' but no element with input method ".strtolower($dlKey)."| found in it.");
            }
            
            if (!isset($dlElement['SSV_SEQUENCE'])) {
                throw new Exception("Dropdown search elements (".implode(', ', array_keys($dlElement['VALUES'])).") with input method ".strtolower($dlKey)."| were declared for '$ssName' but no search fields with input method $dlKey| found.");
            }
            
            $returnResult[$dlElement['SSV_SEQUENCE']]['VALUES'] = array_merge(array('' => ''), $dlElement['VALUES']);
        }
        
//        var_dump(array('file' => __FILE__, 'line' => __LINE__, '$returnResult' => $returnResult, '$allowedList' => $allowedList));
        
        return array($returnResult, $allowedList);
    }
    
    /**
    * Return realname for screen from OPTIONS table, 
    * if no records found assume that given name is real
    * 
    * @param string $ssName - screen alias
    * @return screen name
    */
    public function getScreenRealName($ssName) {
        $ssRealName = $this->_getScreenNameByScreenType($ssName);
        
        if ($ssRealName == '')
            $ssRealName = $ssName;
            
        return $ssRealName;
    }
    
    /**
    * Gets SYS_SCREEN_COLOURS for selected screen
    * 
    * @param string $ssName - screen name
    * @return array - color description
    * 
    * @throws Exception
    */
    public function getScreenColors($ssName) {
        $ssName = $this->getScreenRealName($ssName);
        
        $screenColors = array();
        $sql = 'SELECT * FROM SYS_SCREEN_COLOUR WHERE SS_NAME = ? AND SSC_STATUS = ? ORDER BY SSC_SEQUENCE';
        $queryResults = $this->fetchAllAssoc($sql, $ssName, 'OK');
        
        foreach ($queryResults as $ssColor) {
            if (!isset($screenColors[$ssColor['SSC_COLOUR_TEST_NAME']]))
                $screenColors[$ssColor['SSC_COLOUR_TEST_NAME']] = array();
                
            $screenColors[$ssColor['SSC_COLOUR_TEST_NAME']][] = $ssColor;
        }
        
        return $screenColors;
    }
    
    /**
    * Parses raw value for SYS_SCREEN_COLOURs
    * 
    * @param mixed  $rawValue - raw value of the first or second compare-to values from SYS_SCREEN_COLOUR
    * @param string $operator - operator name from SYS_SCREEN_COLOUR
    * @return mixed - parsed value
    */
    private function _parseTestValue($rawValue, $operator) {
        //get some variables for tests
        $_NOW             = time();
        $tmpArr           = getdate($_NOW);
        $_TODAY_BEGINS    = mktime(0, 0, 0, $tmpArr['mon'], $tmpArr['mday'], $tmpArr['year']);
        $_TOMORROW_BEGINS = strtotime('+1 day', $_TODAY_BEGINS);
        
        $dateFormat       = 'Y-m-d H:i:s';
        
        $operator         = strtoupper(trim($operator));
        $tmpRawValue      = trim($rawValue);

        switch (true) {
            case strtoupper($tmpRawValue) == 'TODAY':
                return date($dateFormat, $_TODAY_BEGINS);
                
            case strtoupper($tmpRawValue) == "MAXTIME('TODAY')":
                if (in_array($operator, array('BETWEEN', 'LESS')))
                    //if operator 'BETWEEN' or 'LESS' use $_TOMORROW_BEGINS as border for strict compare
                    return date($dateFormat, $_TOMORROW_BEGINS);
                else
                    //in other cases use the last second of TODAY
                    return date($dateFormat, $_TOMORROW_BEGINS - 1);
            case strtoupper($tmpRawValue) == "TRUE":
                return true;
            default:
                return $rawValue;
        }
    }
    
    /**
    * Change input fields color according to SYS_SCREEN_COLOR and currend row data
    * 
    * @param mixed $editInputs   - edit input fileds description from SYS_SCREEN_VAR table
    * @param mixed $rowData      - current row data
    * @param mixed $screenColors - color tests description from SYS_SCREEN_COLOUR table
    */
    public function highlightEditInputs($editInputs, $rowData, $screenColors) {
        //get some info about screen
        $primaryIds  = array();
        $tables      = array();
        $primaryArgs = array();
        $primaryCond = array();
        foreach ($editInputs as $tabId => $tab) {
            foreach ($tab as $fieldName => $fieldDescription) {
                if ($fieldDescription['SSV_PRIMARY_ID'] == 'T') {
                    $fullFieldName = trim($fieldDescription['SSV_TABLE']) . '.' . trim($fieldDescription['SSV_NAME']);
                    $primaryIds[$fullFieldName] = $fullFieldName;
                    $tables[$fieldDescription['SSV_TABLE']] = $fieldDescription['SSV_TABLE'];
                    $primaryCond[] = $fullFieldName . ' = ?';
                    $primaryArgs[] = $rowData[trim($fieldDescription['SSV_NAME'])];
                }
            }
        }
        
        foreach ($editInputs as $tabId => &$tab) {
            foreach ($tab as $fieldName => &$fieldDescription) {
                
                if (!isset($screenColors[$fieldDescription['SSV_COLOUR_TEST_NAME']])) {
                    //no tests for this input
                    continue;
                }
                    
                if (!isset($rowData[$fieldDescription['SSV_COLOUR_TEST_FIELD']])) {
                    //no value for testing in $rowData
                    continue;
                }
                $testingValue               = $rowData[$fieldDescription['SSV_COLOUR_TEST_FIELD']];
                $fieldDescription['COLOR']  = '';
                
                foreach ($screenColors[$fieldDescription['SSV_COLOUR_TEST_NAME']] as $colorTestName => $colorTestDescription) {
//                    $testResult  = false;
                    $operator    = $colorTestDescription['SSC_OPERATOR'];
//                    $firstValue  = $this->_parseTestValue($colorTestDescription['SSC_VALUE1'], $operator);
//                    $secondValue = $this->_parseTestValue($colorTestDescription['SSC_VALUE2'], $operator);;
                    
                    if (strtoupper(trim($operator)) == 'TRUE') {
                        $fieldDescription['COLOR'] = $colorTestDescription['SSC_COLOUR_NAME'];
                        break;
                    }
                    
                    $testCondition = $primaryCond;
                    $args          = $primaryArgs;
                    
                    switch (strtoupper(trim($operator))) {
                        case 'EQUAL': 
                            $testCondition[] = $fieldDescription['SSV_COLOUR_TEST_FIELD'] . ' = ?';
                            $args[]          = $colorTestDescription['SSC_VALUE1'];
                            break;
                        case 'START': 
                            $testCondition[] = $fieldDescription['SSV_COLOUR_TEST_FIELD'] . ' STARTING ?';
                            $args[]          = $colorTestDescription['SSC_VALUE1'];
                            break;
                        case 'END': 
                            $testCondition[] = $fieldDescription['SSV_COLOUR_TEST_FIELD'] . ' LIKE ?';
                            $args[]          = '%' . trim($colorTestDescription['SSC_VALUE1'], "'");
                            break;
                        case 'ANY': 
                            $testCondition[] = $fieldDescription['SSV_COLOUR_TEST_FIELD'] . ' LIKE ?';
                            $args[]          = '%' . trim($colorTestDescription['SSC_VALUE1'], "'") . '%';
                            break;
                        case 'BETWEEN': 
                            $tmpStr      = $fieldDescription['SSV_COLOUR_TEST_FIELD'] . ' BETWEEN ';
                            if (strtoupper($colorTestDescription['SSC_VALUE1']) == "MAXTIME('TODAY')") {
                                $tmpStr .= "MAXTIME('TODAY') AND ";
                            } else {
                                $tmpStr .= "? AND ";
                                $args[]  = $colorTestDescription['SSC_VALUE1'];
                            }
                        
                            if (strtoupper($colorTestDescription['SSC_VALUE2']) == "MAXTIME('TODAY')") {
                                $tmpStr .= "MAXTIME('TODAY')";
                            } else {
                                $tmpStr .= "?";
                                $args[]  = $colorTestDescription['SSC_VALUE2'];
                            }
                            $testCondition[] = $tmpStr;
                            
                            break;
                        case 'LESS': 
                            if (strtoupper($colorTestDescription['SSC_VALUE1']) == "MAXTIME('TODAY')") {
                                $testCondition[] = $fieldDescription['SSV_COLOUR_TEST_FIELD'] . " < MAXTIME('TODAY')";
                            } else {
                                $testCondition[] = $fieldDescription['SSV_COLOUR_TEST_FIELD'] . ' < ?';
                                $args[]          = $colorTestDescription['SSC_VALUE1'];
                            }
                            break;
                        case 'GREATER': 
                            if (strtoupper($colorTestDescription['SSC_VALUE1']) == "MAXTIME('TODAY')") {
                                $testCondition[] = $fieldDescription['SSV_COLOUR_TEST_FIELD'] . " > MAXTIME('TODAY')";
                            } else {
                                $testCondition[] = $fieldDescription['SSV_COLOUR_TEST_FIELD'] . ' > ?';
                                $args[]          = $colorTestDescription['SSC_VALUE1'];
                            }
                            break;
                        default: 
                            if (strtoupper($colorTestDescription['SSC_VALUE1']) == "MAXTIME('TODAY')") {
                                $testCondition[] = $fieldDescription['SSV_COLOUR_TEST_FIELD'] . ' ' . $operator . " MAXTIME('TODAY')";
                            } else {
                                $testCondition[] = $fieldDescription['SSV_COLOUR_TEST_FIELD'] . ' ' . $operator . " ?";
                                $args[]          = $colorTestDescription['SSC_VALUE1'];
                            }
                    }
                    
                    $testSQL = "SELECT '" . $colorTestDescription['SSC_COLOUR_NAME'] . "' FROM " . implode(', ', $tables) . ' WHERE ' . implode(' AND ', $testCondition);
                    array_unshift($args, $testSQL);
                    $fieldDescription['COLOR'] = call_user_func_array(array($this, 'findValue'), $args);

                    if ($fieldDescription['COLOR'] == $colorTestDescription['SSC_COLOUR_NAME']) {
                        break;
                    }
                }
            }
        }
        
        return $editInputs;
    }
    
    /**
    * Fill information about drop-doun edit input list
    * 
    * @param array        $editInput    - initial info for edit input
    * @param array | null $conditions   - additional filter for drop-down values in form array(<field_name> => <field_value>)
    * @param booblean     $mapDefault   - fill mapped fields with values using SSV_DROPDOWN_DEFAULT
    * @param mixed        $mapWithValue - fill mapped fields with values using specified value, if null do not fill
    * 
    * @return array - extended info for edit input with dropdown information
    * 
    * @throws Exception 
    */
    public function getDropDownExInfo($editInput, $conditions = null, $mapDefault = false, $mapWithValue = null) {
        if (empty($editInput['SSV_DROPDOWN_SQL'])) {
            throw new Exception('#' . $editInput['RECORD_ID'] . ' in ' . $editInput['SS_NAME'] . ' has SSV_INPUT_METHOD = \'DD\' or SSV_INPUT_METHOD_NEW = \'DD\' but empty SSV_DROPDOWN_SQL.');
        }
        
        $editInput['SSV_DROPDOWN_DATA_FROM'] = trim($editInput['SSV_DROPDOWN_DATA_FROM']);
        $methodName = null;
        $defaultArgs = array();
        
        //init ext fields with empty values
        $editInput['DD_VALUES']       = array();
        $editInput['MAPPED_DEFAULTS'] = array();
        $editInput['MAPPED_FIELDS']   = array();
        if (isset($editInput['DEFAULT_VALUE']))
            unset($editInput['DEFAULT_VALUE']);
        
        if ($editInput['SSV_DROPDOWN_DATA_FROM'] != 'FUN') {

            $editInput['SSV_INPUT_METHOD'] = '_EXT_DD';
            $editInput['DD_VALUES'] = $this->fetchAllAssoc($editInput['SSV_DROPDOWN_SQL']);
            
            if(!empty($editInput['SSV_DROPDOWN_DEFAULT'])){
                $editInput['DEFAULT_VALUE']   =   $this->findValue($editInput['SSV_DROPDOWN_DEFAULT']);   
            }
        } elseif ($editInput['SSV_DROPDOWN_DATA_FROM'] == 'FUN' && !empty($editInput['SSV_DROPDOWN_SQL'])) {
            
            $list = array();
            
            $methodName = substr($editInput['SSV_DROPDOWN_SQL'], 0, strpos($editInput['SSV_DROPDOWN_SQL'], '('));
            eval('$defaultArgs = $args = array' . strstr($editInput['SSV_DROPDOWN_SQL'], '(') . ';');
            if (is_callable(array($this, $methodName))) {
                /**
                * @todo: 
                * use the same interface for List (getPersonAddressList, getPersonListByStatus, etc.) functions. For example:
                * <method_name>(<static_parametrs>[,$additionalConditions, $actionName,  $searchValue, $defaultSQL])
                * <static_parametrs> - defined in SSV_DROPDOWN_SQL field
                * $additionalConditions - array of conditions tu filter resultset (for example array('PERSON_ID' => 'WELD001'))
                * $action - action type: get_list - fetch list to populate dropdown input, method should return array($key => $value)
                *                        get_value - get single value from list by $searchValue
                *                        get_default_value - get single value using $defultSQL and $additionalConditions
                * $searchValue - value to search list by
                * $defaultSQL - SQL expression to get default value for list
                */
                if ($methodName == 'getPersonAddressList') {
                    array_push($args, $conditions, 'get_list');
                }
                $list = call_user_func_array(array($this, $methodName), $args);
            } else {
                throw new Exception("Udefined method $methodName");
            }
            $editInput['DD_VALUES']  =   $list;
            
            if(!empty($editInput['SSV_DROPDOWN_DEFAULT'])){
                if ($methodName == 'getPersonAddressList') {
                    $args = $defaultArgs;
                    array_push($args, $conditions, 'get_default_value', true, $editInput['SSV_DROPDOWN_DEFAULT']);
                    $editInput['DEFAULT_VALUE']   =   call_user_func_array(array($this, $methodName), $args);
                } else {
                    $editInput['DEFAULT_VALUE']   =   $this->findValue($editInput['SSV_DROPDOWN_DEFAULT']);   
                }
            }    
        } else {
            if(!empty($editInput['SSV_DROPDOWN_DEFAULT'])){
                $editInput['DEFAULT_VALUE']   =   $this->findValue($editInput['SSV_DROPDOWN_DEFAULT']);   
            }    
        }
        
        $valueToMap = $editInput['DEFAULT_VALUE'];

        if (($methodName == 'getPersonAddressList') && ($valueToMap !== 0) && empty($valueToMap)) {
            $args = $defaultArgs;
            array_push($args, $conditions, 'get_default_value', false, $editInput['SSV_DROPDOWN_DEFAULT']);
            $valueToMap =   call_user_func_array(array($this, $methodName), $args);
        }


        if (($valueToMap !== 0) && empty($valueToMap) && reset($editInput['DD_VALUES'])){
            $valueToMap = each($editInput['DD_VALUES']);
            $valueToMap = $valueToMap['key'];
        }
        

        if ($mapDefault && !empty($valueToMap)) {
            if ($editInput['SSV_DROPDOWN_DATA_FROM'] == 'FUN' && !empty($editInput['SSV_DROPDOWN_SQL'])) {
                $methodName = substr($editInput['SSV_DROPDOWN_SQL'], 0, strpos($editInput['SSV_DROPDOWN_SQL'], '('));
                eval('$args = array' . strstr($editInput['SSV_DROPDOWN_SQL'], '(') . ';');
                
                if (is_callable(array($this, $methodName))) {
                    if ($methodName == 'getPersonAddressList') {
                        //other methods doesnt support this for now
                        array_push($args, $conditions, 'populate_fields', $valueToMap);       
                        $editInput['MAPPED_DEFAULTS'] = call_user_func_array(array($this, $methodName), $args);
                    }
                } else {
                    throw new Exception("Udefined method $methodName");
                }
            }
        }
        if (($mapWithValue !== null) && array_key_exists($mapWithValue, $editInput['DD_VALUES'])) {
            if ($editInput['SSV_DROPDOWN_DATA_FROM'] == 'FUN' && !empty($editInput['SSV_DROPDOWN_SQL'])) {
                $methodName = substr($editInput['SSV_DROPDOWN_SQL'], 0, strpos($editInput['SSV_DROPDOWN_SQL'], '('));
                eval('$args = array' . strstr($editInput['SSV_DROPDOWN_SQL'], '(') . ';');
                
                if (is_callable(array($this, $methodName)) && $methodName == 'getPersonAddressList') {
                    if ($methodName == 'getPersonAddressList') {
                        //other methods doesnt support this for now
                        array_push($args, $conditions, 'populate_fields', $mapWithValue);
                        $editInput['MAPPED_FIELDS'] = call_user_func_array(array($this, $methodName), $args);
                    }
                } else {
                    throw new Exception("Udefined method $methodName");
                }
            }
        }
        
        return $editInput;
    }
    
    /**
    * Gets single Edit input from SYS_SCREEN_VAR by RECORD_ID
    * 
    * @param string       $recordId     - RECORD_ID to get
    * @param string       $method       - list | new - wich input metod to use SSV_INPUT_METHOD or SSV_INPUT_METHOD_NEW
    * @param array | NULL $conditions   - additional conditions to pass into SSV_DROPDOUN_SQL method
    * @param boolean      $getDDExInfo  - get or not drop down extended info - dropdown values, default value, mapped fields etc.
    * 
    * @return array - description of searched filed
    */
    public function getSingleEditInput($recordId, $method = 'list', $conditions = null, $getDDExInfo = true) {
        
        $sql = "SELECT FIRST 1 *
                FROM SYS_SCREEN_VAR
                LEFT JOIN SYS_SCREEN_ACTION ON SYS_SCREEN_ACTION.SSV_NAME  = SYS_SCREEN_VAR.SSV_ACTION
                WHERE 
                    SYS_SCREEN_VAR.RECORD_ID = ? 
                    AND SYS_SCREEN_VAR.SSV_FIELD_STATUS = 'OK' 
        ";
        $args = array($recordId);
        
        array_unshift($args, $sql);
        
        $result = call_user_func_array(array($this, 'findOneAssoc'), $args);
        
        if(empty($result['SSV_ALIAS'])) {
            $result['SSV_ALIAS'] =   strtoupper($result['SSV_NAME']);
        }
        
        if(!empty($result['SSV_FIELD_WIDTH'])){
            $result['SSV_SIZE'] =   $result['SSV_FIELD_WIDTH'];
        } else {
            $result['SSV_SIZE'] =   100;    
        }

        if ($method == 'new' && !empty($result['SSV_INPUT_METHOD_NEW']))
            $result['SSV_INPUT_METHOD'] = $result['SSV_INPUT_METHOD_NEW'];
            
        if (($result['SSV_INPUT_METHOD'] == 'DD') && $getDDExInfo) {
            $result = $this->getDropDownExInfo($result, $conditions);
        }
        
        return $result;
    }
    
    /**
    * get inputs for tables PICK_ORDER, GRN, etc 
    * 
    * @deprecated use getEditInputs2. Fields must be obtaned by SS_NAME but not by SSV_TABLE.
    * 
    * @param mixed $ssName
    * @param mixed $ssvFieldType
    * @param array $tabsList
    * @param array $conditions
    * @param boolean      $getDDExInfo  - get or not drop down extended info - dropdown values, default value, mapped fields etc.
    */
    public function getEditInputs($ssName, $ssvFieldType = 'SR', $method = 'list', $conditions = null, $getDDExInfo = true){
        $sql = "SELECT *
                FROM SYS_SCREEN_VAR
                LEFT JOIN SYS_SCREEN_ACTION ON SYS_SCREEN_ACTION.SSV_NAME  = SYS_SCREEN_VAR.SSV_ACTION
                WHERE SSV_TABLE = ? AND SSV_FIELD_STATUS = 'OK' AND 
                      SSV_FIELD_TYPE = ?
                ORDER BY SSV_SEQUENCE";
        
        $values =   array($ssName, $ssvFieldType);
        
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $sqlResult         =   $this->findAllAssocMod($sql, $values);
        $editInputsList    =   array();
        $generalFields     =   array();
        $populatedDefaults =   array();
        foreach($sqlResult as $input){
            $data                       =   array();
            
            if(!empty($input['SSV_EXPRESSION'])) {
                $input['SSV_NAME']           =   strtoupper($input['SSV_ALIAS']);    
            } else {
                if(!empty($input['SSV_ALIAS'])) {
                    $input['SSV_NAME']           =   strtoupper($input['SSV_ALIAS']);
                } else {
                    $input['SSV_NAME']           =   strtoupper($input['SSV_NAME']);
                }
            }
            
            if(!empty($input['SSV_FIELD_WIDTH'])){
                $input['SSV_SIZE']       =   $input['SSV_FIELD_WIDTH'];
            } else {
                $input['SSV_SIZE']       =   100;    
            }
            
            if ($method == 'new' && !empty($input['SSV_INPUT_METHOD_NEW'])) {
                $input['SSV_INPUT_METHOD'] = $input['SSV_INPUT_METHOD_NEW'];
            }
            
            if(!empty($input['SSV_DROPDOWN_DEFAULT'])){
                $pattern                   =   array('%USER_ID%');
                $replacement               =   array($this->userId);
                $input['SSV_DROPDOWN_DEFAULT'] =   preg_replace($pattern, $replacement, $input['SSV_DROPDOWN_DEFAULT']);
            }   
            
            if ($input['SSV_INPUT_METHOD'] == 'DD' && $getDDExInfo) {
                $input                    = $this->getDropDownExInfo($input, $conditions, true);
                
                if (is_array($input['MAPPED_FIELDS']))
                    $populatedDefaults    = array_merge($populatedDefaults, $input['MAPPED_FIELDS']);
            }

            if(empty($input['SSV_TAB'])){
                 $generalFields[]   =   $input;
            } else {
                $editInputsList[$input['SSV_TAB']][$input['SSV_NAME']]  =   $input;
            }
        }
        
        //added general fields to all tabs
        foreach($editInputsList as $key => &$value1){
            foreach($generalFields as $value2){
                $value2['SSV_TAB']   =   $key;
                $value1[$value2['SSV_NAME']] = $value2;    
            }
            
            foreach($value1 as $key => &$input) {
                if (isset($populatedDefaults[$key]))
                    $input['POPULATED_VALUE'] = $populatedDefaults[$key];
            }
        }
        
        return $editInputsList;     
    }

    /**
     * @deprecated method added only to support legacy code used with PICKORDER sys screen
     * @param array $fieldDescriptions
     * @param array $rowValues
     * @return array
     */
    public function fillEditInputsDefaults($fieldDescriptions, $rowValues) {
        foreach ($fieldDescriptions as &$description) {
            if (empty($description['SSV_DROPDOWN_DEFAULT'])) continue;
            if (stristr($description['SSV_DROPDOWN_DEFAULT'], 'select') === false) continue;

            if (trim($description['SSV_DROPDOWN_DATA_FROM']) == 'FUN') {
                $methodName = substr($description['SSV_DROPDOWN_SQL'], 0, strpos($description['SSV_DROPDOWN_SQL'], '('));
                if ($methodName == 'getPersonAddressList') continue; //this will be served somewere else
            }

            $foundMatches = array();
            $replacements = array();
            if (preg_match_all('/%(\w+)%/', $description['SSV_DROPDOWN_DEFAULT'], $foundMatches)) {
                foreach ($foundMatches[1] as $sqlParam) {
                    $replacements['/%' . $sqlParam. '%/'] = isset($rowValues[$sqlParam]) ? $rowValues[$sqlParam] : '';
                }
            }
            $defaultSql = preg_replace(array_keys($replacements), array_values($replacements), $description['SSV_DROPDOWN_DEFAULT']);

            $description['DEFAULT_VALUE'] = $this->findValue($defaultSql);
        }

        return $fieldDescriptions;
    }

    protected function _getNumberFormat($row) {
        $ssvOther = isset($row['SSV_FORMAT']) ? $row['SSV_FORMAT'] : null;

        if (empty($ssvOther))
            return null;

        $pattern = '/^(NUMBERFORMAT)\((.*)\)$/i';

        $matches = array();

        if (!preg_match($pattern, $ssvOther, $matches))
            return null; //no number format

        return $matches[2];
    }

    /**
    * get inputs for tables PICK_ORDER, GRN, etc 
    * 
    * @param mixed   $ssName
    * @param mixed   $ssvFieldType
    * @param array   $tabsList
    * @param array   $conditions
    * @param boolean $getDDExInfo  - get or not drop down extended info - dropdown values, default value, mapped fields etc.
    * 
    * @todo add company, warehouse and others limits, if needed
    */
    public function getEditInputs2($ssName, $ssvFieldType = 'SR', $method = 'list', $conditions = null, $getDDExInfo = true){
        $sqlResult         =   Minder_SysScreen_Legacy_VarManager::getVars('F', $ssName, $ssvFieldType);
        $editInputsList    =   $this->getTabList($ssName);
        
        if (count($editInputsList) < 1) {
            throw new Exception("No tabs defined for '$ssName' in SYS_SCREEN_TAB.");
        }
        foreach($editInputsList as $key => &$value1){
            if (!is_array($value1))
                $value1 = array();
        }
        
        $generalFields     =   array();
        $populatedDefaults =   array();
        foreach($sqlResult as $input){
            $data                       =   array();
            
            if(empty($input['SSV_ALIAS'])) {
                $input['SSV_ALIAS']           =   strtoupper($input['SSV_NAME']);
            }
            
            if(!empty($input['SSV_FIELD_WIDTH'])){
                $input['SSV_SIZE']       =   $input['SSV_FIELD_WIDTH'];
            } else {
                $input['SSV_SIZE']       =   100;    
            }
            
            if ($method == 'new' && !empty($input['SSV_INPUT_METHOD_NEW'])) {
                $input['SSV_INPUT_METHOD'] = $input['SSV_INPUT_METHOD_NEW'];
            }
            
            if(!empty($input['SSV_DROPDOWN_DEFAULT'])){
                $pattern                   =   array('%USER_ID%');
                $replacement               =   array($this->userId);
                $input['SSV_DROPDOWN_DEFAULT'] =   preg_replace($pattern, $replacement, $input['SSV_DROPDOWN_DEFAULT']);
            }   
            
            if ($input['SSV_INPUT_METHOD'] == 'DD' && $getDDExInfo) {
                $input                    = $this->getDropDownExInfo($input, $conditions, true);
                
                if (is_array($input['MAPPED_FIELDS']))
                    $populatedDefaults    = array_merge($populatedDefaults, $input['MAPPED_FIELDS']);
            }

            $input['NUMBER_FORMAT'] = $this->_getNumberFormat($input);

            if(empty($input['SSV_TAB'])){
                 $generalFields[]   =   $input;
            } else {
                $editInputsList[$input['SSV_TAB']][$input['SSV_ALIAS']]  =   $input;
            }
        }
        
        //added general fields to all tabs
        foreach($editInputsList as $key => &$value1){
            foreach($generalFields as $value2){
                $value2['SSV_TAB']   =   $key;
                $value1[$value2['SSV_ALIAS']] = $value2;    
            }
            
            foreach($value1 as $key => &$input) {
                if (isset($populatedDefaults[$key]))
                    $input['POPULATED_VALUE'] = $populatedDefaults[$key];
            }
        }
        
        return $editInputsList;     
    }

    /**
    * Get tab list for SYS_SCREEN
    * 
    * @param string $ssName - screen alias
    * @return array
    * 
    * @todo add company, warehouse and others limits, if needed
    */
    public function getTabList($ssName) {
        return Minder_SysScreen_Legacy_TabManager::getTabs($ssName);
    }
    /**
    * Get table headers information for each tab in SYS_SCREEN
    * 
    * @param string $tableName
    * @param array $tabList
    * @return array
    * 
    * @todo add company, warehouse and others limits, if needed
    */

    public function getHeadersForTabList($tableName, $tabList){
        $companyList = array();

        if (!$this->isAdmin) {
            $query = "SELECT COMPANY_ID FROM ACCESS_COMPANY WHERE USER_ID = '" .  $this->userId . "'";
            $availableCompanies = $this->fetchAllAssoc($query);

            foreach($availableCompanies as $item) {
                array_push($companyList, "'" .$item['COMPANY_ID']. "'");
            }

            if($this->limitCompany == 'all') {
                $companies = implode(",", $companyList);
                $partQuery =  " AND (COMPANY_ID IS NULL OR COMPANY_ID IN (" . $companies . ")) ";
            }
            else {
                $partQuery = " AND (COMPANY_ID IS NULL OR COMPANY_ID = '".$this->limitCompany."') ";
            }
        }
        else {
            if($this->limitCompany == 'all') {
                $partQuery = "";
            }
            else {
                $partQuery = " AND (COMPANY_ID IS NULL OR COMPANY_ID = '".$this->limitCompany."') ";
            }
        }

        $sql = "SELECT
                    CASE WHEN SSV_ALIAS IS NULL OR SSV_ALIAS = ''
                        THEN UPPER(SSV_NAME)
                        ELSE UPPER(SSV_ALIAS)
                    END AS SSV_NAME,
                    SSV_TITLE
                FROM SYS_SCREEN_VAR
                WHERE SS_NAME = ? AND SSV_FIELD_TYPE = ? AND SSV_FIELD_STATUS = 'OK' " . $partQuery .
                                  "AND (SSV_TAB = ? OR SSV_TAB IS NULL)
                ORDER BY SSV_SEQUENCE";

        $headersList    = array();
        foreach($tabList as $key => $value){
            $headersList[$key]  =   $this->findList($sql, $tableName, 'SR', $key);
        }
        
        return $headersList;
    }

    /**
     * get list of IssnLine object
     *
     * @param array $clause filters for ISSN list where
     *                         KEY is field which should be filtered
     *                         VALUE is limit
     * @param integer $pageNo - Page No to Get
     * @param integer $resultsPerPage - Page Size
     *
     * @return array of IssnLines
     */
    public function getDBLog($clause = null )
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $sql = "insert into log(description) values(?)";
        $clause .= ":" . $this->deviceId . ":" . $this->userId . ":";
        if (false !== ($query = ibase_prepare($this->db, $sql))) {
            $result = ibase_execute($query, $clause);
            if (false !== $result) {
                ibase_free_result($result);
                ibase_free_query($query);
            }
            else {
                ibase_free_query($query);
            }
        }
    }
    /**
     * get list of IssnLine object
     *
     * @param array $clause filters for ISSN list where
     *                         KEY is field which should be filtered
     *                         VALUE is limit
     * @param integer $pageNo - Page No to Get
     * @param integer $resultsPerPage - Page Size
     *
     * @return array of IssnLines
     */
    public function getIssns($clause = null, $method = 'edit', $pageNo = null, $resultsPerPage = null)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $result = array('total' => 0, 'data' => array());
        $this->getDBLog('getissn start');

        if($method != 'edit'){
              $queryType  =   'SR';  
             list($sql, $sqlOrder) =  $this->getSelectQuery( "T", "ISSN");
         } else {
              $queryType    =   'SR';  
              list($sql, $sqlOrder) =  $this->getSelectQuery( "T", 'ISSN', $queryType);
         }
        
        //$sql .= $this->getWarehouseAndCompanyLimit();
        $sql .= $this->getWarehouseAndCompanyLimit( 0, True, "ISSN.", "ISSN.");
      
        $this->getDBLog('getissn got query');
        // New code
        
        $values = array();
        $tablePfx = "ISSN.";
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                    if(!empty($key)) {
                        if( false === strpos($key, '.')) {
                            $sql .= $tablePfx . $key. " AND ";
                        } else {
                            $sql .= $key. " AND ";
                        }
                        if(!empty($val) && false != strpos($key, 'LIKE')) {
                            $values[] = $val;  
                        } elseif (!empty($val) && false != strpos($key, '?')) {
                            $values[] = $val;
                        } elseif(true == strpos($key, '?') && empty($val) ) {
                            $values[] = '';  
                        }
                    }
                }
        }
    
        $sql  = substr($sql, 0, -5);
        //$sql .= ' ORDER BY SSN_CREATE_DATE DESC, SSN_ID DESC';
        //$sql .= ' ORDER BY ISSN.ORIGINAL_CREATE_DATE DESC';
        
        $this->getDBLog('getissn added order by and values');
        $log->info('sql:' . $sql);
        //if (false === ($values = $this->prepareArgs($sql, $values))) {
        //    throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg());
        //}
        
        //list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage, False);

        $sqlQuery .= $sqlOrder;
        $log->info('sqlCount:' . $sqlCount);
        $log->info('sqlQuery:' . $sqlQuery);
      
        //$total  = 999999;
        if (false === ($Query = $this->prepareArgs($sqlCount, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sqlQuery);
        }
        $total  = $this->findValue($sqlCount, $Query);
        $this->getDBLog('getissn performed the totals count');

        if (false === ($Query = $this->prepareArgs($sqlQuery, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sqlQuery);
        }
        
        $data   = $this->findAllAssocMod($sqlQuery, $Query);
        $this->getDBLog('getissn performed getting the primary data');
        $result['total'] = $total;
       
        if (count($data) > 0) {
            foreach ($data as $line) {
                // get the data for the ssn_id
                //$log->info('issn ssn_id:' . print_r($line, true));
                $log->info('issn ssn_id:' . $line['SSN_ID']);
                $issnData = $this->searchdIssn( $line['SSN_ID'], $queryType);
                //$temp = new IssnLine($line);
                $temp = new IssnLine($issnData);
                if ($temp->items['SSN_ID'] != null) {
                    $temp->id = $temp->items['SSN_ID']; //md5(serialize($line));
                } else {
                    //$temp->id = md5(serialize($line));
                    $temp->id = md5(serialize($issnData));
                }
                $result['data'][] = $temp;
            }
            //$result['total'] = $total;
        }
        $this->getDBLog('getissn performed getting the real data');
        if (null === $pageNo || null === $resultsPerPage) {
            $result = $result['data'];
        }
        
        return $result;
    }

    public function getIssnCountInLocation($whId, $locnId) {
        $sql = "SELECT SUM(CURRENT_QTY) FROM ISSN WHERE WH_ID = ? AND LOCN_ID = ? " . substr($this->getWarehouseAndCompanyLimit(0, false), 0, -5);

        return $this->fetchOne($sql, $whId, $locnId);
    }
    
    /**
     * get list of IssnLine object. Use this if you need all fields from ISSN tabel
     * (for example, for edit form), as getIssns() uses SYS_SCREEN_VAR so you will
     * have only limited list of fields
     *
     * @param array $clause filters for ISSN list where
     *                         KEY is field which should be filtered
     *                         VALUE is limit
     * @param integer $pageNo - Page No to Get
     * @param integer $resultsPerPage - Page Size
     *
     * @return array of IssnLines
     */
    public function getRawIssns($clause = null, $method = 'edit', $pageNo = null, $resultsPerPage = null) {
        $result = array('total' => 0, 'data' => array());
        
        $sql = "SELECT * FROM ISSN ";
        $sql .= $this->getWarehouseAndCompanyLimit(0, TRUE, 'ISSN.', 'ISSN.');

        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                    if(!empty($key)) {
                        $sql .= $key. " AND ";
                        if(!empty($val) && false != strpos($key, 'LIKE')) {
                            $values[] = $val;  
                        } elseif (!empty($val) && false != strpos($key, '?')) {
                            $values[] = $val;
                        } elseif(true == strpos($key, '?') && empty($val) ) {
                            $values[] = '';  
                        }
                    }
                }
        }
          
    
        $sql  = substr($sql, 0, -5);
        
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg());
        }
        
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
      
        $data   = $this->findAllAssocMod($sqlQuery, $values);
        $result['total'] = 0; //dont use
       
        if (count($data) > 0) {
            foreach ($data as $line) {
                $temp = new IssnLine($line);
                if ($temp->items['SSN_ID'] != null) {
                    $temp->id = $temp->items['SSN_ID']; //md5(serialize($line));
                } else {
                    $temp->id = md5(serialize($line));
                }
                $result['data'][] = $temp;
            }
            //$result['total'] = $total;
        }
        if (null === $pageNo || null === $resultsPerPage) {
            $result = $result['data'];
        }
        
        return $result;
    }
    
    /**
     * get list of IssnLine object
     *
     * @param array $clause filters for ISSN list where
     *                         KEY is field which should be filtered
     *            VALUE is limit
     *
     * @return array of IssnLines
     *-
    public function getIssns($clause = null, $pageNo = null, $resultsPerPage = null)
    {
        $result = array('total' => 0, 'data' => array());

        if ($this->isAdmin) {
            $sql = "SELECT * FROM (
                        SELECT
                        ISSN.SSN_ID,
                        ISSN.WH_ID,
                        ISSN.LOCN_ID,
                        ISSN.PROD_ID,
                        ISSN.CURRENT_QTY,
                        ISSN.ORIGINAL_SSN,
                        ISSN.COMPANY_ID,
                        ISSN.ISSN_STATUS,
                        ISSN.OTHER1,
                        ISSN.OTHER2,
                        ISSN.LAST_UPDATE_DATE,
                        ISSN.PREV_PROD_ID,
                        ISSN.PREV_PREV_PROD_ID,
                        ISSN.PROD_ID_UPDATE,
                        ISSN.PREV_PROD_ID_UPDATE,
                        ISSN.PREV_WH_ID,
                        ISSN.PREV_PREV_WH_ID,
                        ISSN.PREV_LOCN_ID,
                        ISSN.PREV_PREV_LOCN_ID,
                        ISSN.PREV_DATE,
                        ISSN.PREV_PREV_PROD_ID_UPDATE,
                        ISSN.PREV_PICK_ORDER,
                        ISSN.PREV_PREV_PICK_ORDER,
                        ISSN.PREV_PACK_ID,
                        ISSN.PREV_DESPATCH_ID,
                        ISSN.PREV_PREV_DESPATCH_ID,
                        ISSN.ISSN_DESCRIPTION, 
                        ISSN.PICKED_QTY,
                        ISSN.ORIGINAL_QTY,
                        ISSN.PREV_QTY,
                        ISSN.AUDIT_DATE,
                        ISSN.LABEL_DATE,
                        ISSN.USER_ID,
                        ISSN.CREATE_DATE,
                        ISSN.DESPATCHED_DATE,
                        ISSN.DIVISION_ID,
                        ISSN.KITTED,
                        ISSN.INTO_DATE,
                        ISSN.SERIAL_NUMBER,
                        ISSN.AUDITED,
                        ISSN.STATUS_CODE,
                        ISSN.PACK_ID,
                        ISSN.DESPATCH_ID,
                        ISSN.ISSN_PACKAGE_TYPE,
                        ISSN.ISSN_PREV_PACKAGE_TYPE,
                        SSN.PO_ORDER AS PO_ORDER,
                        SSN.CREATE_DATE AS SSN_CREATE_DATE,
                        SSN.GENERIC AS GENERIC,
                        SSN.BRAND AS BRAND,
                        SSN.SSN_TYPE AS SSN_TYPE,
                        SSN.SUPPLIER_ID AS SUPPLIER_ID,
                        SSN.SSN_DESCRIPTION AS SSN_DESCRIPTION,
                        SSN.OBJECT_NUMBER,
                        SSN.OBJECT_NAME,
                        SSN.LEGACY_ID,
                        SSN.HOME_LOCN_ID,
                        GRN.GRN_DATE AS GRN_CREATE_DATE,
                        ISSN.OTHER3,
                        ISSN.OTHER4,
                        (CASE WHEN P.PICK_LABEL_NO IS NULL
                            THEN PD.PICK_LABEL_NO
                            ELSE P.PICK_LABEL_NO
                         END) AS PICK_LABEL_NO,
                        (CASE WHEN P.PICK_ORDER IS NULL
                            THEN P2.PICK_ORDER
                            ELSE P.PICK_ORDER
                         END) AS PICK_ORDER,
                        '' AS REASON
                        FROM ISSN
                        JOIN CONTROL ON CONTROL.RECORD_ID = 1
                        LEFT OUTER JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
                        LEFT OUTER JOIN GRN ON GRN.GRN = SSN.GRN
                        LEFT OUTER JOIN PICK_ITEM AS P ON P.SSN_ID = ISSN.SSN_ID
                                   AND (POS(CONTROL.PICK_RESERVED_SSN_STATUS, P.PICK_LINE_STATUS, 0, 1) > -1)
                        LEFT OUTER JOIN PICK_ITEM_DETAIL AS PD ON PD.SSN_ID = ISSN.SSN_ID
                                   AND (POS(CONTROL.PICK_RESERVED_SSN_STATUS, PD.PICK_DETAIL_STATUS, 0, 1) > -1)
                        LEFT OUTER JOIN PICK_ITEM AS P2 ON P2.PICK_LABEL_NO = PD.PICK_LABEL_NO
                        WHERE P.PICK_LABEL_NO IN (
                                                          SELECT MAX(PICK_LABEL_NO)
                                                          FROM PICK_ITEM
                                                          WHERE PICK_ITEM.ssn_id = ISSN.ssn_id
                                                  )
                              OR P.PICK_LABEL_NO IS NULL
                    ) AS I";
        } else {
            $sql = "SELECT * FROM (
                        SELECT
                        ISSN.SSN_ID,
                        ISSN.WH_ID,
                        ISSN.LOCN_ID,
                        ISSN.PROD_ID,
                        ISSN.CURRENT_QTY,
                        ISSN.ORIGINAL_SSN,
                        ISSN.COMPANY_ID,
                        ISSN.ISSN_STATUS,
                        ISSN.OTHER1,
                        ISSN.OTHER2,
                        ISSN.LAST_UPDATE_DATE,
                        ISSN.PREV_PROD_ID,
                        ISSN.PREV_PREV_PROD_ID,
                        ISSN.PROD_ID_UPDATE,
                        ISSN.PREV_PROD_ID_UPDATE,
                        ISSN.PREV_WH_ID,
                        ISSN.PREV_PREV_WH_ID,
                        ISSN.PREV_LOCN_ID,
                        ISSN.PREV_PREV_LOCN_ID,
                        ISSN.PREV_DATE,
                        ISSN.PREV_PREV_PROD_ID_UPDATE,
                        ISSN.PREV_PICK_ORDER,
                        ISSN.PREV_PREV_DESPATCH_ID,
                        ISSN.ISSN_DESCRIPTION,
                        ISSN.PICKED_QTY,
                        ISSN.PREV_PREV_PICK_ORDER,
                        ISSN.PREV_PACK_ID,
                        ISSN.PREV_DESPATCH_ID,
                        ISSN.ORIGINAL_QTY,
                        ISSN.PREV_QTY,
                        ISSN.AUDIT_DATE,
                        ISSN.LABEL_DATE,
                        ISSN.USER_ID,
                        ISSN.CREATE_DATE,
                        ISSN.DESPATCHED_DATE,
                        ISSN.DIVISION_ID,
                        ISSN.KITTED,
                        ISSN.INTO_DATE,
                        ISSN.SERIAL_NUMBER,
                        ISSN.AUDITED,
                        ISSN.STATUS_CODE,
                        ISSN.PACK_ID,
                        ISSN.DESPATCH_ID,
                        ISSN.ISSN_PACKAGE_TYPE,
                        ISSN.ISSN_PREV_PACKAGE_TYPE,
                        SSN.PO_ORDER AS PO_ORDER,
                        SSN.CREATE_DATE AS SSN_CREATE_DATE,
                        SSN.GENERIC AS GENERIC,
                        SSN.BRAND AS BRAND,
                        SSN.SSN_TYPE AS SSN_TYPE,
                        SSN.SUPPLIER_ID AS SUPPLIER_ID,
                        SSN.SSN_DESCRIPTION AS SSN_DESCRIPTION,
                        SSN.OBJECT_NUMBER,
                        SSN.OBJECT_NAME,
                        SSN.LEGACY_ID,
                        SSN.HOME_LOCN_ID,
                        GRN.GRN_DATE AS GRN_CREATE_DATE,
                        ISSN.OTHER3,
                        P.PICK_LABEL_NO,
                        P.PICK_ORDER,
                        '' AS REASON
                        FROM ISSN
                        JOIN CONTROL ON CONTROL.RECORD_ID = 1
                        LEFT OUTER JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
                        LEFT OUTER JOIN GRN ON GRN.GRN = SSN.GRN
                        LEFT OUTER JOIN PICK_ITEM AS P ON P.SSN_ID = ISSN.SSN_ID
                                   AND (POS(CONTROL.PICK_RESERVED_SSN_STATUS, P.PICK_LINE_STATUS, 0, 1) > -1)
                        WHERE P.PICK_LABEL_NO IN (
                                                          SELECT MAX(PICK_LABEL_NO)
                                                          FROM PICK_ITEM
                                                          WHERE PICK_ITEM.ssn_id = ISSN.ssn_id
                                                  )
                              OR P.PICK_LABEL_NO IS NULL
                    ) AS I";
        }

        $sql .= $this->getWarehouseAndCompanyLimit();
      
        // New code
        
        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                    if(!empty($key)) {
                        $sql .= $key. " AND ";
                        if(!empty($val) && false != strpos($key, 'LIKE')) {
                            $values[] = $val;  
                        } elseif (!empty($val) && false != strpos($key, '?')) {
                            $values[] = $val;
                        } elseif(true == strpos($key, '?') && empty($val) ) {
                            $values[] = '';  
                        }
                    }
                }
        }
          
    
        $sql  = substr($sql, 0, -5);
        $sql .= ' ORDER BY SSN_CREATE_DATE DESC, SSN_ID DESC';
        
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg());
        }
        
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
      
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);
        $result['total'] = $total;
       
        if (count($data) > 0) {
            foreach ($data as $line) {
                $temp = new IssnLine($line);
                if ($temp->items['SSN_ID'] != null) {
                    $temp->id = $temp->items['SSN_ID']; //md5(serialize($line));
                } else {
                    $temp->id = md5(serialize($line));
                }
                $result['data'][] = $temp;
            }
            //$result['total'] = $total;
        }
        if (null === $pageNo || null === $resultsPerPage) {
            $result = $result['data'];
        }
        
        return $result;
    }
     */
    /**
     * get list of IssnLine object wuthout Warehouse list
     *
     * @param array $clause filters for ISSN list where
     *                         KEY is field which should be filtered
     *            VALUE is limit
     *
     * @return array of IssnLines
     */
    public function getClearIssns($clause = null, $pageNo = null, $resultsPerPage = null)
    {
        $result = array('total' => 0, 'data' => array());

        if ($this->isAdmin) {
            $sql = "SELECT * FROM (
                        SELECT
                        ISSN.SSN_ID,
                        ISSN.WH_ID,
                        ISSN.LOCN_ID,
                        ISSN.PROD_ID,
                        ISSN.CURRENT_QTY,
                        ISSN.ORIGINAL_SSN,
                        ISSN.COMPANY_ID,
                        ISSN.ISSN_STATUS,
                        ISSN.OTHER1,
                        ISSN.OTHER2,
                        ISSN.LAST_UPDATE_DATE,
                        ISSN.PREV_PROD_ID,
                        ISSN.PREV_PREV_PROD_ID,
                        ISSN.PROD_ID_UPDATE,
                        ISSN.PREV_PROD_ID_UPDATE,
                        ISSN.PREV_WH_ID,
                        ISSN.PREV_PREV_WH_ID,
                        ISSN.PREV_LOCN_ID,
                        ISSN.PREV_PREV_LOCN_ID,
                        ISSN.PREV_DATE,
                        ISSN.ORIGINAL_QTY,
                        ISSN.PREV_QTY,
                        ISSN.AUDIT_DATE,
                        ISSN.LABEL_DATE,
                        ISSN.USER_ID,
                        ISSN.CREATE_DATE,
                        ISSN.DESPATCHED_DATE,
                        ISSN.DIVISION_ID,
                        ISSN.KITTED,
                        ISSN.INTO_DATE,
                        ISSN.SERIAL_NUMBER,
                        ISSN.AUDITED,
                        ISSN.STATUS_CODE,
                        ISSN.PACK_ID,
                        ISSN.DESPATCH_ID,
                        ISSN.ISSN_PACKAGE_TYPE,
                        ISSN.ISSN_PREV_PACKAGE_TYPE,
                        SSN.PO_ORDER AS PO_ORDER,
                        SSN.CREATE_DATE AS SSN_CREATE_DATE,
                        SSN.GENERIC AS GENERIC,
                        SSN.BRAND AS BRAND,
                        SSN.SSN_TYPE AS SSN_TYPE,
                        SSN.SUPPLIER_ID AS SUPPLIER_ID,
                        SSN.SSN_DESCRIPTION AS SSN_DESCRIPTION,
                        GRN.GRN_DATE AS GRN_CREATE_DATE,
                        ISSN.OTHER3,
                        (CASE WHEN P.PICK_LABEL_NO IS NULL
                            THEN PD.PICK_LABEL_NO
                            ELSE P.PICK_LABEL_NO
                         END) AS PICK_LABEL_NO,
                        (CASE WHEN P.PICK_ORDER IS NULL
                            THEN P2.PICK_ORDER
                            ELSE P.PICK_ORDER
                         END) AS PICK_ORDER,
                        '' AS REASON
                        FROM ISSN
                        JOIN CONTROL ON CONTROL.RECORD_ID = 1
                        LEFT OUTER JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
                        LEFT OUTER JOIN GRN ON GRN.GRN = SSN.GRN
                        LEFT OUTER JOIN PICK_ITEM AS P ON P.SSN_ID = ISSN.SSN_ID
                                   AND (POS(CONTROL.PICK_RESERVED_SSN_STATUS, P.PICK_LINE_STATUS, 0, 1) > -1)
                        LEFT OUTER JOIN PICK_ITEM_DETAIL AS PD ON PD.SSN_ID = ISSN.SSN_ID
                                   AND (POS(CONTROL.PICK_RESERVED_SSN_STATUS, PD.PICK_DETAIL_STATUS, 0, 1) > -1)
                        LEFT OUTER JOIN PICK_ITEM AS P2 ON P2.PICK_LABEL_NO = PD.PICK_LABEL_NO
                        WHERE P.PICK_LABEL_NO IN (
                                                          SELECT MAX(PICK_LABEL_NO)
                                                          FROM PICK_ITEM
                                                          WHERE PICK_ITEM.ssn_id = ISSN.ssn_id
                                                  )
                              OR P.PICK_LABEL_NO IS NULL
                    ) AS I WHERE 1=1 AND ";
        } else {
            $sql = "SELECT * FROM (
                        SELECT
                        ISSN.SSN_ID,
                        ISSN.WH_ID,
                        ISSN.LOCN_ID,
                        ISSN.PROD_ID,
                        ISSN.CURRENT_QTY,
                        ISSN.ORIGINAL_SSN,
                        ISSN.COMPANY_ID,
                        ISSN.ISSN_STATUS,
                        ISSN.OTHER1,
                        ISSN.OTHER2,
                        ISSN.LAST_UPDATE_DATE,
                        ISSN.PREV_PROD_ID,
                        ISSN.PREV_PREV_PROD_ID,
                        ISSN.PROD_ID_UPDATE,
                        ISSN.PREV_PROD_ID_UPDATE,
                        ISSN.PREV_WH_ID,
                        ISSN.PREV_PREV_WH_ID,
                        ISSN.PREV_LOCN_ID,
                        ISSN.PREV_PREV_LOCN_ID,
                        ISSN.PREV_DATE,
                        ISSN.ORIGINAL_QTY,
                        ISSN.PREV_QTY,
                        ISSN.AUDIT_DATE,
                        ISSN.LABEL_DATE,
                        ISSN.USER_ID,
                        ISSN.CREATE_DATE,
                        ISSN.DESPATCHED_DATE,
                        ISSN.DIVISION_ID,
                        ISSN.KITTED,
                        ISSN.INTO_DATE,
                        ISSN.SERIAL_NUMBER,
                        ISSN.AUDITED,
                        ISSN.STATUS_CODE,
                        ISSN.PACK_ID,
                        ISSN.DESPATCH_ID,
                        ISSN.ISSN_PACKAGE_TYPE,
                        ISSN.ISSN_PREV_PACKAGE_TYPE,
                        SSN.PO_ORDER AS PO_ORDER,
                        SSN.CREATE_DATE AS SSN_CREATE_DATE,
                        SSN.GENERIC AS GENERIC,
                        SSN.BRAND AS BRAND,
                        SSN.SSN_TYPE AS SSN_TYPE,
                        SSN.SUPPLIER_ID AS SUPPLIER_ID,
                        SSN.SSN_DESCRIPTION AS SSN_DESCRIPTION,
                        GRN.GRN_DATE AS GRN_CREATE_DATE,
                        ISSN.OTHER3,
                        P.PICK_LABEL_NO,
                        P.PICK_ORDER,
                        '' AS REASON
                        FROM ISSN
                        JOIN CONTROL ON CONTROL.RECORD_ID = 1
                        LEFT OUTER JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
                        LEFT OUTER JOIN GRN ON GRN.GRN = SSN.GRN
                        LEFT OUTER JOIN PICK_ITEM AS P ON P.SSN_ID = ISSN.SSN_ID
                                   AND (POS(CONTROL.PICK_RESERVED_SSN_STATUS, P.PICK_LINE_STATUS, 0, 1) > -1)
                        WHERE P.PICK_LABEL_NO IN (
                                                          SELECT MAX(PICK_LABEL_NO)
                                                          FROM PICK_ITEM
                                                          WHERE PICK_ITEM.ssn_id = ISSN.ssn_id
                                                  )
                              OR P.PICK_LABEL_NO IS NULL
                    ) AS I WHERE 1=1 AND ";
        }

        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                $sql .= $key . " AND ";
                if (false !== strpos($key, '?')) {
                    if (false !== strpos($key, 'PICK_LABEL_NO')) {
                        $val = substr(trim($val), 0, 7);
                    }
                    $values[] = $val;
                }
            }
        }
        $sql = substr($sql, 0, -5);
        $sql .= ' ORDER BY INTO_DATE DESC ';
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
      
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);
        $result['total'] = $total;

        if (count($data) > 0) {
            foreach ($data as $line) {
                $temp = new IssnLine($line);
                if ($temp->items['SSN_ID'] != null) {
                    $temp->id = $temp->items['SSN_ID']; //md5(serialize($line));
                } else {
                    $temp->id = md5(serialize($line));
                }
                $result['data'][] = $temp;
            }
            //$result['total'] = $total;
        }
        if (null === $pageNo || null === $resultsPerPage) {
            $result = $result['data'];
        }
        return $result;
    }

    /**
     * get list of user ID's
     *
     * @return array
     */
    public function getUserList()
    {
        $sql = 'SELECT DISTINCT S.USER_ID, S.USER_ID FROM SYS_USER S ';
                // JOIN ACCESS_COMPANY A ON S.USER_ID = A.USER_ID ';

        $sql .= $this->getWarehouseAndCompanyLimit(1);
        /*
        $companyList = $this->getCompanyList();
        if ($companyList) {
            $sql .= ' WHERE A.COMPANY_ID IN (  ';
            foreach ($companyList as $companyId) {
                $sql .= "'" . $companyId . "', ";
            }
            $sql = substr($sql, 0, -2) . ')';
        }
        */
        $sql = substr($sql, 0, -5);
        return $this->findList($sql);
    }

    public function getDeviceList($type=null) {
        
        if($type != null) {
             $sql = "SELECT DEVICE_ID, DEVICE_ID 
                     FROM SYS_EQUIP
                     WHERE DEVICE_TYPE = '" . $type . "'";

             return $this->findList($sql);    
        }
        
        $sql = "SELECT DEVICE_ID, EQUIPMENT_DESCRIPTION_CODE, CURRENT_PERSON
                FROM SYS_EQUIP
                WHERE DEVICE_TYPE = 'HH' OR DEVICE_TYPE='PC'
                ORDER BY DEVICE_ID";

        return $this->findList($sql);
    }
    /**
    * @desc get user list from SYS_USER table
    * @param string $invOperator = F|T 
    * 
    * @return list of users
    */
    public function getSysUserList($invOperator = 'T') {
        
        $sql = "SELECT USER_ID, USER_ID
                FROM SYS_USER
                WHERE INVENTORY_OPERATOR = '" . $invOperator .  "'";
    
        return $this->findList($sql);
    }

    /**
     * get list of options from OPTIONS table
     *
     * @param string $groupCode
     * @param string $orderBy
     * @return array
     */
    public function getOptionsList($groupCode = null, $code = null, $orderBy = 'DESCRIPTION', $extinfo = false)
    {

        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);

	if ($code == "DESCRIPTION") {
		$code = null;
	}
	if ($code == "CODE") {
		$orderBy = $code ;
		$code = null;
	}

        $result = array();
        if (!$extinfo) {
            if ($groupCode !== null) {
                if ($code !== null) {
                    $sql = 'SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = ? AND CODE = ? ORDER BY ' . $orderBy;
                    $log->info('SQL ' . $sql);
                    $result = $this->findList($sql, $groupCode, $code);
                } else {
                    $sql = 'SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = ?  ORDER BY ' . $orderBy;
                    $log->info('SQL ' . $sql);
                    $result = $this->findList($sql, $groupCode );
                }

            } else {
                $sql = 'SELECT CODE, DESCRIPTION FROM OPTIONS ORDER BY ' . $orderBy;
                $log->info('SQL ' . $sql);
                $result = $this->findList($sql);
            }
        } else {
            if ($groupCode !== null) {
                if ($code !== null) {
                    $sql = 'SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = ? AND CODE = ? ORDER BY ' . $orderBy;
                    $log->info('SQL ' . $sql);
                    $findList = $this->findList($sql, $groupCode, $code);
                    foreach($findList as $key => $value) {
                        $result[$key] = $value . sprintf(' (%s)', $groupCode);
                    }
                } else {
                    $sql = 'SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = ?  ORDER BY ' . $orderBy;
                    $log->info('SQL ' . $sql);
                    $findList = $this->findList($sql, $groupCode);
                    foreach($findList as $key => $value) {
                        $result[$key] = $value . sprintf(' (%s)', $groupCode);
                    }
                }
            } else {
                $sql = 'SELECT CODE, DESCRIPTION, GROUP_CODE FROM OPTIONS ORDER BY ' . $orderBy;
                $log->info('SQL ' . $sql);
                $findList = $this->findList($sql);
                foreach($findList as $item) {
                    $result[$item['CODE']] = $item['DESCRIPTION'] . sprintf(' (%s)', $item['GROUP_CODE']);
                }
            }
        }
    $wk_var_text = var_export($result, true);
        $log->info($wk_var_text);
        return $result;
    }


    /**
     * get extended list of options from OPTIONS table
     *
     * @param string $groupCode
     * @param string $orderBy
     * @return array
     */
  public function getExtOptionsList($groupCode = null, $orderBy = 'DESCRIPTION')
    {
        $result = array();
        if ($groupCode !== null) {
            $sql = 'SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = ? ORDER BY ' . $orderBy;
            $findList = $this->findList($sql, $groupCode);
            foreach($findList as $key => $value) {
                $result[$key] = $value . sprintf(' (%s)', $key);
            }
        } else {
            $sql = 'SELECT CODE, DESCRIPTION, GROUP_CODE FROM OPTIONS ORDER BY ' . $orderBy;
            $findList = $this->findList($sql);
            foreach($findList as $item) {
                $result[$item['CODE']] = $item['DESCRIPTION'] . sprintf(' (%s)', $item['CODE']);
            }
        }
        return $result;
    }

    public function getDefaultBorrowerLabelQty() {
        $options = $this->getOptionsList('QTY_B_LABL');

        return (count($options) > 0) ? key($options) : 0;
    }


    /**
     * get AUDIT action list
     *
     * @return array
     */
    public function getAudActionList() {
      //return $this->getOptionsList('AUD_ACTION');
      return $this->getExtOptionsList('AUD_ACTION');
    }

    public function getAudStatusList() {
      //return $this->getOptionsList('AUD_STATUS');
      return $this->getExtOptionsList('AUD_STATUS');
    }


    /**
     * Get values from OPTIONS
     * where GROUP_CODE = 'ISSN_STATU'
     *
     * @return array where CODE is key, DESCRIPTION is value
     */
    public function getIssnStatusList()
    {
        return $this->getExtOptionsList('ISSN_STATU');
    }

    /**
     * Get values from OPTIONS
     * where GROUP_CODE = 'SSN_STA_CO'
     *
     * @return array where CODE is key, DESCRIPTION is value
     */
    public function getSsnStatusList()
    {
        //return $this->getOptionsList('SSN_STA_CO');
          return $this->getExtOptionsList('SSN_STA_CO');
    }

    /**
     * Get SUPPLIER_ID from SSN
     *
     * @return array
     */
    public function getSupplierIdListFromSsn()
    {
        $sql = "SELECT SUPPLIER_ID, SUPPLIER_ID FROM SSN ORDER BY 1";

        return $this->findList($sql);
    }

    /**
     * Get values from column in ISSN table
     *
     * @param string $field
     *
     * @return array
     */
    public function getFieldListFromIssn($field, $q = null) {

        if ($q !== null) {
            $q = strtoupper($q) . '%';
            $sql = 'SELECT ' . $field . ' , ' . $field
                 . ' FROM ISSN'
                 . ' WHERE ' . $field
                 . " LIKE ?"
                 . ' OR ' . $field
                 . " LIKE ?"
                 . ' GROUP BY ' . $field . ' ORDER BY 1';
            $this->lastError = $sql;
            return $this->findList($sql, $q, $q);
        } else {
            $sql = 'SELECT ' . $field . ' , ' . $field
                 . ' FROM ISSN'
                 . ' GROUP BY ' . $field . ' ORDER BY 1';
            $this->lastError = $sql;
            return $this->findList($sql);
        }

    }
    /**
     * Get without $this->warehouseLimit list of Location
     *
     * Return array where LOCN_ID is key, and LOCN_NAME is value
     *
     * @param string LOCN_ID or LOCN_NAME
     * @param string WH_ID  
     * 
     * @return array
     */
    public function getClearLocationList($q, $whId) {
       $sql = 'SELECT LOCN_ID, LOCN_NAME FROM LOCATION';
        if ($q !== null) {
            $sql .= ' WHERE (UPPER(LOCN_ID) = ? OR UPPER(LOCN_NAME) = ?) AND (WH_ID = ?)';
            $sql .= ' ORDER BY LOCN_ID';
            return $this->findList($sql, $q, $q, $whId);
        } 
    }
    /**
     * Get list of Location
     *
     * Return array where LOCN_ID is key, and LOCN_NAME is value
     *
     * @return array
     */
    public function getLocationList($q = null)
    {

        $sql = 'SELECT LOCN_ID, LOCN_NAME FROM LOCATION';
        if ($q !== null) {
            $q = strtoupper($q) . '%';
            $sql .= ' WHERE UPPER(LOCN_ID) LIKE ? OR UPPER(LOCN_NAME) LIKE ?';
            $sql .= ' AND ';

            //-- if not limited by warehouse
            if ($this->limitWarehouse != 'all') {
                $sql .= " WH_ID = '" . $this->limitWarehouse . "' AND ";
            } else {
            //-- else assume all Warehouses accessible to User.
//                if ($this->isAdmin || $this->isInventoryOperator) {
                    $warehouseList = $this->getWarehouseList();
                    if (count($warehouseList) > 0 ) {
                        $sql .= " WH_ID IN (";
                        foreach ($warehouseList as $key => $val) {
                            $sql .= "'" . $key . "', ";
                        }
                        $sql = substr($sql, 0, strlen($sql) - 2);
                        $sql .= ") AND ";
                    }
//                }
            }
            $sql = substr($sql, 0, -5);

            $sql .= ' ORDER BY LOCN_ID';
            return $this->findList($sql, $q, $q);
        } else {
            $sql .= ' WHERE 1=1 AND ';

            //-- if not limited by warehouse
            if ($this->limitWarehouse != 'all') {
                $sql .= " WH_ID = '" . $this->limitWarehouse . "' AND ";
            } else {
            //-- else assume all Warehouses accessible to User.
//                if ($this->isAdmin || $this->isInventoryOperator) {
                    $warehouseList = $this->getWarehouseList();
                    if (count($warehouseList) > 0 ) {
                        $sql .= " WH_ID IN (";
                        foreach ($warehouseList as $key => $val) {
                            $sql .= "'" . $key . "', ";
                        }
                        $sql = substr($sql, 0, strlen($sql) - 2);
                        $sql .= ") AND ";
                    }
                }
//            }
            $sql = substr($sql, 0, -5);

            $sql .= ' ORDER BY LOCN_ID';
            return $this->findList($sql);
        }

    }

    /**
     * Get list of Location
     *
     * Return array where LOCN_ID or WH_ID+LOCN_ID is key, and LOCN_NAME is value
     * 
     * @param  array   $clause        - search conditions
     * @param  boolean $getOnlyLocnId - get only LOCN_ID as list key or WH_ID+LOCN_ID
     *
     * @return array
     */
    public function getLocationListByClause($clause = array(), $getOnlyLocnId = true)
    {
        if ($getOnlyLocnId) {
            $sql = 'SELECT LOCN_ID, LOCN_NAME FROM LOCATION WHERE 1=1 AND ';
        } else {
            $sql = 'SELECT WH_ID || LOCN_ID, LOCN_NAME FROM LOCATION WHERE 1=1 AND ';
        }

        //-- if not limited by warehouse
        if ($this->limitWarehouse != 'all') {
            $sql .= " WH_ID = '" . $this->limitWarehouse . "' AND ";
        } else {
        //-- else assume all Warehouses accessible to User.
            $warehouseList = $this->getWarehouseList();
            if (count($warehouseList) > 0 ) {
                $sql .= " WH_ID IN (";
                foreach ($warehouseList as $key => $val) {
                    $sql .= "'" . $key . "', ";
                }
                $sql = substr($sql, 0, strlen($sql) - 2);
                $sql .= ") AND ";
            }
        }
        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                $sql .= $key . " AND ";
                if (false !== strpos($key, '?')) {
                    $values[] = $val;
                }
            }
        }
        $sql = substr($sql, 0, -5);
        $sql .= ' ORDER BY LOCN_ID';
        array_unshift($values, $sql);
        $log = Zend_Registry::get('logger');
        $log->info(trim(implode(', ', $values), ', '));
      
        $data = call_user_func_array(array($this, 'findList'), $values);

        return $data;
    }

    /**
     * Get list of Location by WH_ID
     *
     * Return array where LOCN_ID is key, and LOCN_NAME is value
     *
     * @return array
     */
    public function getLocationListByWhID($q = null)
    {
        $sql = 'SELECT LOCN_ID, LOCN_ID || \'-\' || LOCN_NAME AS LOCN_NAME FROM LOCATION ';
        if ($q !== null) {
            $q = strtoupper($q);
            $sql .= ' WHERE WH_ID = ? AND ';
            $sql .= ' 1=1 AND ';

            //-- if not limited by warehouse
            if ($this->limitWarehouse != 'all') {
                $sql .= " WH_ID = '" . $this->limitWarehouse . "' AND ";
            } else {
            //-- else assume all Warehouses accessible to User.
                //if ($this->isAdmin || $this->isInventoryOperator) {
                    $warehouseList = $this->getWarehouseList();
                    if (count($warehouseList) > 0 ) {
                        $sql .= " WH_ID IN (";
                        foreach ($warehouseList as $key => $val) {
                            $sql .= "'" . $key . "', ";
                        }
                        $sql = substr($sql, 0, strlen($sql) - 2);
                        $sql .= ") AND ";
                    }
                //}
            }
            $sql = substr($sql, 0, -5);
            $sql .= ' ORDER BY LOCN_ID';
            return $this->findList($sql, $q);
        } else {
            $sql .= ' WHERE 1=1 AND ';

            //-- if not limited by warehouse
            if ($this->limitWarehouse != 'all') {
                $sql .= " WH_ID = '" . $this->limitWarehouse . "' AND ";
            } else {
            //-- else assume all Warehouses accessible to User.
//                if ($this->isAdmin || $this->isInventoryOperator) {
                    $warehouseList = $this->getWarehouseList();
                    if (count($warehouseList) > 0 ) {
                        $sql .= " WH_ID IN (";
                        foreach ($warehouseList as $key => $val) {
                            $sql .= "'" . $key . "', ";
                        }
                        $sql = substr($sql, 0, strlen($sql) - 2);
                        $sql .= ") AND ";
                    }
//                }
            }
            $sql = substr($sql, 0, -5);

            $sql .= ' ORDER BY LOCN_ID';
            return $this->findList($sql);
        }

    }

    /**
     * Get list of Location
     *
     * Return array where LOCN_ID is key, and LOCN_NAME is value
     *
     * @return array
     */
    public function getLocationListFromIssn()
    {
        //$sql = 'SELECT ISSN.LOCN_ID, LOCATION.LOCN_NAME FROM ISSN,LOCATION WHERE ISSN.LOCN_ID = LOCATION.LOCN_ID ORDER BY LOCN_ID';
        $sql = 'SELECT ISSN.LOCN_ID, LOCATION.LOCN_NAME FROM ISSN JOIN LOCATION ON  ISSN.WH_ID = LOCATION.WH_ID AND ISSN.LOCN_ID = LOCATION.LOCN_ID ';
        $sql .= $this->getWarehouseAndCompanyLimit( 0, True, "ISSN.", "ISSN.");
        $sql  = substr($sql, 0, -5);
        $sql .= " GROUP BY ISSN.LOCN_ID, LOCATION.LOCN_NAME ";
Zend_Registry::get('logger')->debug(array('file' => __FILE__, 'line' => __LINE__, $sql));
        return $this->findList($sql);
    }

    /**
     * get SSN_TYPE list from SSN_TYPE for combo
     * in /minder/warehouse/issn/
     *
     * @return array
     */
    public function getSsnTypeListFromSsnType($q = null)
    {
        $sql = 'SELECT CODE, DESCRIPTION FROM SSN_TYPE ORDER BY DESCRIPTION';

        if($q != null) {
            $sql  = 'SELECT CODE, DESCRIPTION
                     FROM SSN_TYPE
                     WHERE UPPER(CODE) LIKE ? OR UPPER(DESCRIPTION) LIKE ?
                     ORDER BY DESCRIPTION';
            $log = Zend_Registry::get('logger');
            $log->info(__FUNCTION__);
            $log->info($sql);
            return $this->findList($sql, '%'. strtoupper($q) . '%', '%'. strtoupper($q) . '%');
        }
        return $this->findList($sql);
    }

    public function getSsnTypeByCode($code = null)
    {
        if ($code === null) {
            throw new Exception('Invalide code');
        }
        
        $sql  = 'SELECT * FROM SSN_TYPE WHERE UPPER(CODE) LIKE UPPER(?)';
        
        return $this->fetchAssoc($sql, $code);
        
    }
    
    /**
     * Get SSN_SUB_TYPE list
     *
     * @param array $clause
     * @return array
     */
    public function getSsnSubTypeList($clause = null)
    {
        $sql = 'SELECT CODE, DESCRIPTION FROM SSN_SUB_TYPE';

        if ($clause !== null && is_array($clause)) {
            $sql .= ' WHERE ';
            foreach($clause as $key =>$val) {
                if ($val != null) {
                    $sql .= $key . " LIKE '" . trim($val) . "' AND ";
                } else {
                    if ($key != null) {
                        $sql .= $key . " AND ";
                    }
                }
            }
            $sql = substr($sql, 0, strlen($sql) - 5) . ' ORDER BY DESCRIPTION';
        }
    
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info($sql);
        return $this->findList($sql);

    }

   /**
     * get default Home warehouse 
     * @return OPTIONS.DESCRIPTION
     */

    public function defaulthomewarehouse($companyId) {
	$sql='SELECT DESCRIPTION FROM OPTIONS WHERE GROUP_CODE=\'DEF_RET_LO\' AND CODE LIKE \''.$companyId.'%\''; 
	return $this->findValue($sql);
    }


   /**
     * get warehouse JOIN location list for Home warehouse snd home location dropdown(ssn edit)
     * @return array
     */

    public function getHomeWarehouses() {

	$limitwarehouselist = $this->getWarehouseList();
	foreach($limitwarehouselist as $key=>$val ) {
	$array[]=$key;
	}
	$sql = '
        SELECT
        WAREHOUSE.WH_ID AS WH_ID,
	WAREHOUSE.DESCRIPTION AS DESCRIPTION,
	LOCATION.LOCN_ID AS LOCN_ID,
        \'[\' || LOCATION.LOCN_ID || \']\' || LOCATION.LOCN_NAME AS LOCN_NAME
        FROM
        WAREHOUSE
        LEFT JOIN LOCATION ON WAREHOUSE.WH_ID = LOCATION.WH_ID WHERE WAREHOUSE.WH_ID IN ('. substr(str_repeat('?, ', count($array)), 0, -2) .') AND LOCATION.LOCN_STAT=\'OK\' AND LOCATION.MOVE_STAT=\'ST\'
    ';
	array_unshift($array, $sql);
	return call_user_func_array(array($this, 'fetchAllAssoc'), $array);
    }


    public function getSsnSubTypes() {
        $sql = "
        SELECT
        ssn_type.code as ssn_type_code,
        ssn_type.description as ssn_type_description,
        generic.code as generic_code,
        generic.description as generic_description,
        ssn_sub_type.code as ssn_sub_type_code,
        ssn_sub_type.description as ssn_sub_type_description
        FROM
        ssn_type
        LEFT JOIN generic ON ssn_type.code = generic.ssn_type
        LEFT JOIN ssn_sub_type on ssn_type.code = ssn_sub_type.ssn_type and generic.code = ssn_sub_type.generic
    ";
    
    return $this->fetchAllAssoc($sql);
    }
    
    public function getProductTypeList($clause = null)
    {
        $sql = 'SELECT CODE, DESCRIPTION FROM PROD_TYPE';

        if ($clause !== null && is_array($clause)) {
            $sql .= ' WHERE ';
            foreach($clause as $key =>$val) {
                if ($val != null) {
                    $sql .= $key . " LIKE '" . trim($val) . "' AND ";
                } else {
                    if ($key != null) {
                        $sql .= $key . " AND ";
                    }
                }
            }
            $sql = substr($sql, 0, strlen($sql) - 5);
        }
    
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info($sql);
        return $this->findList($sql);

    }    

    /**
     * get SSN_TYPE list from PROD_PROFILE where PROD_ID = $clause
     * for combo in /minder/warehouse/issn/
     *
     * @param string $clause
     * @return array
     */
    public function getSsnTypeListFromProdProfile($q)
    {
        $sql = 'SELECT PROD_PROFILE.SSN_TYPE, SSN_TYPE.DESCRIPTION FROM PROD_PROFILE, SSN_TYPE WHERE SSN_TYPE.CODE = PROD_PROFILE.SSN_TYPE AND PROD_PROFILE.PROD_ID = ? ORDER BY SSN_TYPE.DESCRIPTION';

        return $this->findList($sql, $q);
    }
    
    public function getSsnTypeLiestFromProdProfileForReceive($q) {
        
        $sql = 'SELECT PROD_PROFILE.SSN_TYPE 
                FROM PROD_PROFILE 
                WHERE PROD_PROFILE.PROD_ID = ?';
        
        return $this->findValue($sql, $q);

    }

    /**
     * get Brand list
     *
     * @return array
     */
    public function getBrandList(array $q = array())
    {
        $params = array();

        $sql = 'SELECT CODE, DESCRIPTION FROM BRAND ';
        if (count($q) > 0) {
            $sql .= ' WHERE ';
            foreach ($q as $key => $val) {
                $sql .= $key . ' AND ';
                $params[] = strtoupper($val) . '%';
            }
            $sql = substr($sql, 0, -5);
            $sql .= ' ORDER BY 2';
            array_unshift($params, $sql);
            return call_user_func_array(array($this, 'findList'), $params);
        } else {
            $sql .= ' ORDER BY 2';
            return $this->findList($sql);
        }
    }

    /**
     * get Variety list
     *
     * @param string $q
     *
     * @return array
     */
    public function getVarietyList($q = null)
    {
        if (null === $q) {
            $sql = 'SELECT CODE, DESCRIPTION FROM GENERIC ORDER BY 2';
            return $this->findList($sql);
        } else {
            $sql = 'SELECT CODE, DESCRIPTION FROM GENERIC WHERE SSN_TYPE = ? ORDER BY 2';
            return $this->findList($sql, $q);
        }
    }


    /**
     * Get Variety List for autocomplete box
     *
     * @param string $q
     * @return array
     */
    public function getAutocompleteVarietyList($q = null)
    {
        if (null === $q) {
            $sql = 'SELECT CODE, DESCRIPTION FROM GENERIC ORDER BY 2';
            return $this->findList($sql);
        } else {
            $sql = 'SELECT CODE, DESCRIPTION FROM GENERIC WHERE CODE LIKE ? ORDER BY 2';
            return $this->findList($sql, strtoupper($q) . '%');
        }
    }


    /**
     * get Division list
     *
     * @return array
     */
    public function getDivisionList()
    {
        $sql = 'SELECT CODE, DESCRIPTION FROM DIVISION ORDER BY 2';

        return $this->findList($sql);
    }

    /**
     * get Department list
     *
     * @return array
     */
    public function getDepartmentList()
    {
        $sql = 'SELECT CODE, DESCRIPTION FROM DEPARTMENT ORDER BY 2';

        return $this->findList($sql);
    }

    /**
     * get Reticulation list
     *
     * @return array
     */
    public function getReticulationList()
    {
        $sql = 'SELECT CODE, DESCRIPTION FROM RETICULATION ORDER BY 2';

        return $this->findList($sql);
    }

    /**
     * get LabelLocation list
     *
     * @return array
     */
    public function getLabelLocationList()
    {
        $sql = 'SELECT CODE, DESCRIPTION FROM LABEL_LOCATION ORDER BY 1';

        return $this->findList($sql);
    }

    /**
     * Retrieve value from field in SSN_GROUP
     * using for fetch name of labels on screens e.g. /minder/warehouse/issn/
     *
     * @param $field
     *
     * @return string
     */
    public function getFieldFromSsnGroup($field)
    {
        $data = '';

        $sql    = 'SELECT ' . $field . ' FROM SSN_GROUP';

        $result = ibase_query($this->db, $sql);
        if (false !== $result) {
            $row = ibase_fetch_row($result);
            if (false !== $row) {
                $data = $row[0];
                ibase_free_result($result);
            }
        }
        return $data;
    }


    /**
     * get searched for SsnLine object
     *
     * @param string $ssnId - SSN's SSN_ID to Get
     * @return  SsnLine
     */
    public function searchdSsn($ssnId , $queryType = 'SR')
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
 
        list($sql, $sqlOrder) =  $this->getSelectQuery( "F", "SSN", $queryType);
    $sql .= "
                        WHERE  SSN.SSN_ID = ? 
                    ";
        // New code
        
        $values = array( $ssnId );
    
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $data   = $this->findAllAssocMod($sql, $values);
       
        return $data[0];
    }





    /**
     * get SSN_ID's to be replaced (Replace Master Data)
     *
     * @return  ssnList
     */

    public function dataGetSsns($clause = null, $pageNo = null, $resultsPerPage = null)
    {
	$sql='SELECT SSN_ID,WH_ID,LOCN_ID,CURRENT_QTY FROM SSN WHERE ';

	if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                    $sql .= $key;
                    if(!empty($val) && false != strpos($key, 'LIKE')) {
                        $values[] = $val; 
                    } elseif (!empty($val) && false != strpos($key, '?')) {
                        $values[] = trim(str_replace(array('\'', '"'), '', $val));
                    } elseif(true == strpos($key, '?') && empty($val)) {
                        $values[] = ''; 
                    }
                }
        }

	$sql .= '1=1' ;

	$data   = $this->findAllAssocMod($sql, $values);
	$total = count($data);

	$result['total'] = $total;
        $result['data']  = $data; 
         
	return $result;
    }





    public function getSsns($clause = null, $method = 'edit', $pageNo = null, $resultsPerPage = null)
    {
        
        $this->getDBLog('getssn start');
        $ssnLines = array();
        
        if($method != 'edit'){
              $queryType  =   'SR';  
              list($sql, $sqlOrder) =  $this->getSelectQuery( "T", 'SSN');
         } else {
              $queryType    =   'SR';  
              list($sql, $sqlOrder) =  $this->getSelectQuery( "T", 'SSN', $queryType);
         }
        
        $this->getDBLog('getssn got query');
        
        //$sql .= str_replace(array('WH_ID', 'COMPANY_ID'), array('SSN.WH_ID', 'SSN.COMPANY_ID'), $this->getWarehouseAndCompanyLimit());
        $sql .= $this->getWarehouseAndCompanyLimit( 0, True, "SSN.", "SSN.");
        
        $values =   array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                    $sql .= $key;
                    if(!empty($val) && false != strpos($key, 'LIKE')) {
                        $values[] = $val; 
                    } elseif (!empty($val) && false != strpos($key, '?')) {
                        $values[] = trim(str_replace(array('\'', '"'), '', $val));
                    } elseif(true == strpos($key, '?') && empty($val)) {
                        $values[] = ''; 
                    }
                }
        }
   
        $sql = substr($sql, 0, strlen($sql) - 5);

        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
   
        //list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage, False);
        Zend_Registry::get('logger')->debug(array('file' => __FILE__, 'line' => __LINE__, $sqlCount, $sqlQuery));
        $sqlQuery .= $sqlOrder;
        
        $this->getDBLog('getssn added order by and values');
        
        $rawValues = $values;

        if (false === ($values = $this->prepareArgs($sqlCount, $rawValues))) {
            $this->lastError = $sqlCount;
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sqlCount);
        }

        $total  = $this->findValue($sqlCount, $values);
        $this->getDBLog('getssn got totals ');
        
        $log->info($sqlQuery . ' : ' . implode(', ', $rawValues));
        
        if (false === ($values = $this->prepareArgs($sqlQuery, $rawValues))) {
            $this->lastError = $sqlQuery;
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sqlQuery);
        }

        $data   = $this->findAllAssocMod($sqlQuery, $values);
        $this->getDBLog('getssn got primary data');
        
        $result['total'] = $total;
        $result['data']  = $data; 
   
        if (count($data) > 0) {
            foreach ($data as $line) {
                $log->info('issn ssn_id:' . $line['SSN_ID']);
                
                $ssnData = $this->searchdSsn($line['SSN_ID'], $queryType);
                
                //$temp = new SsnLine($line);
                $temp = new SsnLine($ssnData);

                if ($temp->items['SSN_ID'] != null) {
                    $temp->id = $temp->items['SSN_ID'];
                } else {
                    $temp->id = md5(serialize($line));
                }
                $ssnLines[] = $temp;
            }
            $result['data']  = $ssnLines;
        }
        $this->getDBLog('getssn got real data');
        if (null === $pageNo || null === $resultsPerPage) {
            $result = $ssnLines;
        }
 
        return $result;
    }
    
    /**
    * Use this method instead of getSsns() when you need to fetch paticular fieldset 
    * as there is no guaranty that this fieldset will be defined in SYS_SCREEN_VAR
    * 
    * @todo add ability to fetch only needed fields but not all
    * 
    * @param mixed $clause
    * @param mixed $method
    * @param mixed $pageNo
    * @param mixed $resultsPerPage
    * @return SsnLine
    */
    public function getSsnsNotForScreen($clause = null, $method = 'edit', $pageNo = null, $resultsPerPage = null) {
        $this->getDBLog('getSsnsNotForScreen start');
        $ssnLines = array();
        
        $sql = 'SELECT * FROM SSN ';
        $sqlOrder = '';
        
        $this->getDBLog('getssn got query');
        
        //$sql .= str_replace(array('WH_ID', 'COMPANY_ID'), array('SSN.WH_ID', 'SSN.COMPANY_ID'), $this->getWarehouseAndCompanyLimit());
        $sql .= $this->getWarehouseAndCompanyLimit( 0, True, "SSN.", "SSN.");
        
        $values =   array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                    $sql .= $key;
                    if(!empty($val) && false != strpos($key, 'LIKE')) {
                        $values[] = $val; 
                    } elseif (!empty($val) && false != strpos($key, '?')) {
                        $values[] = trim(str_replace(array('\'', '"'), '', $val));
                    } elseif(true == strpos($key, '?') && empty($val)) {
                        $values[] = ''; 
                    }
                }
        }
   
        $sql = substr($sql, 0, strlen($sql) - 5);

        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
   
        //list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage, False);
        Zend_Registry::get('logger')->debug(array('file' => __FILE__, 'line' => __LINE__, $sqlCount, $sqlQuery));
        $sqlQuery .= $sqlOrder;
        
        $this->getDBLog('getssn added order by and values');
        
        $rawValues = $values;

        if (false === ($values = $this->prepareArgs($sqlCount, $rawValues))) {
            $this->lastError = $sqlCount;
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sqlCount);
        }

        $total  = $this->findValue($sqlCount, $values);
        $this->getDBLog('getssn got totals ');
        
        $log->info($sqlQuery . ' : ' . implode(', ', $rawValues));
        
        if (false === ($values = $this->prepareArgs($sqlQuery, $rawValues))) {
            $this->lastError = $sqlQuery;
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sqlQuery);
        }

        $data   = $this->findAllAssocMod($sqlQuery, $values);
        $this->getDBLog('getssn got primary data');
        
        $result['total'] = $total;
        $result['data']  = $data; 
   
        if (count($data) > 0) {
            foreach ($data as $line) {
                $log->info('issn ssn_id:' . $line['SSN_ID']);
                
//                $ssnData = $this->searchdSsn($line['SSN_ID'], $queryType);
                
                $temp = new SsnLine($line);
//                $temp = new SsnLine($ssnData);

                if ($temp->items['SSN_ID'] != null) {
                    $temp->id = $temp->items['SSN_ID'];
                } else {
                    $temp->id = md5(serialize($line));
                }
                $ssnLines[] = $temp;
            }
            $result['data']  = $ssnLines;
        }
        $this->getDBLog('getssn got real data');
        if (null === $pageNo || null === $resultsPerPage) {
            $result = $ssnLines;
        }
 
        return $result;
    }
    
    public function getFieldSum($tableName, $fieldName, $conditions) {
        $tmpFilter = array();
        $args      = array();
        
        if (is_array($conditions)) {
            $tmpFilter = array_keys($conditions);
            $args = array_reduce($conditions, create_function('$res, $item', '$res = (is_array($res)) ? $res : array(); return array_merge($res, $item);'), $args);
        }
        
        $sql = 'SELECT SUM(' . $fieldName . ') FROM ' . $tableName;
        
        if (count($tmpFilter)) {
            $sql .= ' WHERE ' . implode(', ', $tmpFilter);
        }
        array_unshift($args, $sql);
        return call_user_func_array(array($this, 'findValue'), $args);
    }
    
    /**
     * Return list of values for dropdown combos in SSN screen
     *
     * @param array $clause pick up conditions for records
     * @return
     */
    public function getListFromGlobalConditions($clause)
    {
        $result = array();
        $sql = 'SELECT DESCRIPTION, DESCRIPTION FROM GLOBAL_CONDITIONS';
        if ($clause !== null) {
            $sql .= ' WHERE 1=1 AND ';
            foreach($clause as $key =>$val) {
                if ($val != null) {
                    $sql .= $key . " LIKE '" . str_replace("'", "''", $val) . "%' AND ";
                } else {
                    $sql .= $key . " AND ";
                }
            }
            $sql = substr($sql, 0, strlen($sql) - 5);
            $sql .= ' ORDER BY 1';
            $result = $this->findList($sql);
        }

        return $result;
    }

    /**
     * Get types of persons
     *
     * @return array
     */
    public function getPersonTypeList()
    {
        $sql = 'SELECT CODE, DESCRIPTION FROM PERSON_TYPE';

        return $this->findList($sql);
    }

    /**
     * Retrieve value from column in PERSON table
     * using for fetch name of labels on screens e.g. /minder/admin/contacts
     *
     * @param $field
     *
     * @return string
     */
    public function getFieldListFromPerson($field, $q = null)
    {
        if ($q != null) {
            $q = strtoupper($q) . '%';
            $sql = 'SELECT ' . $field . ' , ' . $field
                 . ' FROM PERSON'
                 . ' WHERE ' . $field
                 . " LIKE ?"
                 . ' OR ' . $field
                 . " LIKE ?"
                 . ' GROUP BY ' . $field . ' ORDER BY 1';
            return $this->findList($sql, $q, $q);
        } else {
            $sql = 'SELECT ' . $field . ' , ' . $field
                 . ' FROM PERSON'
                 . ' GROUP BY ' . $field . ' ORDER BY 1';
            return $this->findList($sql);
        }
    }

    /**
     * Retrieve value from column in SSN table
     *
     * @param $field
     *
     * @return string
     */
    public function getFieldListFromSsn($field, $q = null)
    {
        if ($q != null) {
            $sql = 'SELECT ' . $field . ' , ' . $field
                 . ' FROM SSN'
                 . ' WHERE UPPER(SSN.' . $field
                 . ") LIKE ? "
                 . ' OR UPPER(SSN.' . $field
                 . ") LIKE ? "
                 . 'GROUP BY SSN.' . $field . ' ORDER BY 1';
            return $this->findList($sql, strtoupper($q) . '%', strtoupper($q) . '%');
        } else {
            $sql = 'SELECT ' . $field . ' , ' . $field
                 . ' FROM SSN'
                 . ' GROUP BY SSN.' . $field . ' ORDER BY 1';
        }

        return $this->findList($sql);
    }

    /**
     * get list of ContactLine objects
     *
     * @todo: Check it. Probably it can be merged with Person object and appropriate functions
     *
     * @param array $clause filters for list where
     *                      KEY is field which should be filtered
     *                      VALUE is limit
     *
     * @return array of ContactLines
     */
    public function getContacts($clause = null)
    {
        $contactLines = array();
        $sql = 'SELECT
                    PERSON_ID                 AS PERSON_ID,
                    PERSON_TYPE               AS PERSON_TYPE,
                    ADDRESS_LINE2             AS ADDRESS_LINE2,
                    CITY                      AS CITY,
                    STATE                     AS STATE,
                    POST_CODE                 AS POST_CODE,
                    COUNTRY                   AS COUNTRY,
                    MOBILE_NO                 AS MOBILE_NO,
                    EMAIL                     AS EMAIL,
                    CONTACT_FIRST_NAME        AS CONTACT_FIRST_NAME,
                    CONTACT_LAST_NAME         AS CONTACT_LAST_NAME,
                    CREATE_DATE               AS CREATE_DATE,
                    STATUS                    AS STATUS,
                    MAIL_ADDRESS1             AS MAIL_ADDRESS1,
                    MAIL_ADDRESS2             AS MAIL_ADDRESS2,
                    MAIL_CITY                 AS MAIL_CITY,
                    MAIL_STATE                AS MAIL_STATE,
                    MAIL_POST_CODE            AS MAIL_POST_CODE,
                    MAIL_COUNTRY              AS MAIL_COUNTRY,
                    SECOND_CONTACT_FIRST_NAME AS SECOND_CONTACT_FIRST_NAME,
                    SECOND_CONTACT_LAST_NAME  AS SECOND_CONTACT_LAST_NAME,
                    SECOND_MOBILE_NO          AS SECOND_MOBILE_NO,
                    SECOND_EMAIL              AS SECOND_EMAIL,
                    LAST_NAME                 AS LAST_NAME,
                    SECOND_FAX_NO             AS SECOND_FAX_NO,
                    SECOND_PHONE_NO           AS SECOND_PHONE_NO,
                    FAX_NO                    AS FAX_NO,
                    PHONE_NO                  AS PHONE_NO,
                    TITLE                     AS TITLE,
                    MAIL_PHONE                AS MAIL_PHONE,
                    CONTACT_ADDRESS1          AS CONTACT_ADDRESS1,
                    CONTACT_ADDRESS2          AS CONTACT_ADDRESS2,
                    CONTACT_CITY              AS CONTACT_CITY,
                    CONTACT_STATE             AS CONTACT_STATE,
                    CONTACT_POST_CODE         AS CONTACT_POST_CODE,
                    CONTACT_PHONE             AS CONTACT_PHONE,
                    CREATE_BY                 AS CREATE_BY,
                    CONTACT_COUNTRY           AS CONTACT_COUNTRY,
                    FIRST_NAME                AS FIRST_NAME,
                    ADDRESS_LINE1             AS ADDRESS_LINE1,
                    ADDRESS_LINE3             AS ADDRESS_LINE3,
                    ADDRESS_LINE4             AS ADDRESS_LINE4,
                    AUST_POST_4STATE_ID       AS AUST_POST_4STATE_ID,
                    ADDRESS_LINE5             AS ADDRESS_LINE5,
                    WEB_SITE                  AS WEB_SITE,
                    COMPANY_ID                AS COMPANY_ID
               FROM PERSON';

        //-- if not limited by company
        if ($this->limitCompany != 'all') {
            $sql .= " WHERE COMPANY_ID = '" . $this->limitCompany . "' AND ";
        } else {
            //-- else assume all Companies accessible to User.
            if ($this->isAdmin || $this->isInventoryOperator) {
                $sql .= " WHERE ";
            } else {
                $companyList = $this->getCompanyList();
                if (count($companyList) > 0 ) {
                    $sql .= ' WHERE COMPANY_ID IN (';
                    foreach ($companyList as $key => $val) {
                        $sql .= "'" . $val . "', ";
                    }
                    $sql = substr($sql, 0, strlen($sql) - 2);
                    $sql .= ') AND ';
                } else {
                    $sql .= ' WHERE ';
                }
            }
        }
        $sql .= ' 1=1 AND ';

        $params = array();
        if ($clause !== null && is_array($clause)) {
            foreach($clause as $key =>$val) {
                if ($val != null) {
                    if ('PERSON_ID' == $key) {
                        $sql .= $key . " = ? AND ";
                        $params[] = $val;
                    } else {
                        $sql .= $key . " LIKE ? AND ";
                        $params[] = $val;
                    }
                }
            }
        }
        $sql = substr($sql, 0, strlen($sql) - 5);
        $sql .= ' ORDER BY PERSON_ID, CONTACT_FIRST_NAME, CONTACT_LAST_NAME';
        array_unshift($params, $sql);
        $data = call_user_func_array(array($this, 'findAllAssocMod'), $params) ;
        if (count($data) > 0) {
            foreach ($data as $line) {
                $contact = new ContactLine($line);
                $contact->id = $line['PERSON_ID'];
                $contactLines[] = $contact;

            }
            return $contactLines;
        }
        return $contactLines;
    }

    public function getAddressTypeList()
    {
        //return $this->getOptionsList('ADDR_TYPE');
        return $this->getExtOptionsList('ADDR_TYPE');
    }

    public function getAddressStatusList()
    {
        //return $this->getOptionsList('ADDR_STATU');
        return $this->getExtOptionsList('ADDR_STATU');
    }

    public function getLoanPeriodList()
    {
        //return $this->getOptionsList('LOAN_DAYS');
          return $this->getExtOptionsList('LOAN_DAYS');
        //$sql = 'SELECT CODE, DESCRIPTION FROM UOM WHERE UOM_TYPE = ?';
        //return $this->findList($sql, 'LP');
    }

    public function getLoanSafetyPeriodList($extinfo = true)
    {
         return $this->getOptionsList('SAFE_CALIB', 'DESCRIPTION', $extinfo);
    }

    public function getLoanCalibratePeriodList($extinfo = true)
    {
         return $this->getOptionsList('SAFE_CALIB', 'DESCRIPTION', $extinfo);
    }

    public function getLoanInspectPeriodList($extinfo = true)
    {
         return $this->getOptionsList('SAFE_CALIB', 'DESCRIPTION', $extinfo);
    }

    public function getLoanStatusList()
    {
        //return $this->getOptionsList('LOAN_STAT');
        return $this->getExtOptionsList('LOAN_STAT');
    }

    /**
     * get list of AddressLine objects
     *
     * @todo: Check it. Probably it can be merged with Address object and appropriate functions
     *
     * @param array $clause filters for list where
     *                      KEY is field which should be filtered
     *                      VALUE is limit
     *
     * @return array of AddressLine
     */
    public function getAddressLines($clause = null)
    {
        $addressLines = array();
        $sql = 'SELECT
                    RECORD_ID,
                    PERSON_ID,
                    ADDR_TYPE,
                    ADDR_LINE1,
                    ADDR_LINE2,
                    ADDR_SUBURB,
                    ADDR_CITY,
                    ADDR_STATE,
                    ADDR_POST_CODE,
                    ADDR_COUNTRY,
                    ADDR_POST_4STATE_ID,
                    ADDR_MOBILE_NO,
                    ADDR_PHONE_NO,
                    ADDR_FAX_NO,
                    ADDR_EMAIL,
                    ADDR_TITLE,
                    ADDR_FIRST_NAME,
                    ADDR_LAST_NAME,
                    ADDR_STATUS,
                    ADDR_CREATED_DATE,
                    ADDR_CREATED_BY,
                    COMPANY_ID
               FROM PERSON_ADDRESS';

        $sql .= ' WHERE 1=1 AND ';
        $params = array();
        if ($clause !== null && is_array($clause)) {
            foreach($clause as $key =>$val) {
                if ($val != null) {
                    $sql .= $key . " LIKE ? AND ";
                    $params[] = $val;
                }
            }
        }
        $sql = substr($sql, 0, strlen($sql) - 5);
        $sql .= ' ORDER BY RECORD_ID';
        array_unshift($params, $sql);
        $data = call_user_func_array(array($this, 'findAllAssocMod'), $params) ;

        if (count($data) > 0) {
            foreach ($data as $line) {
                $address = new AddressLine($line);
                $address->id = $line['RECORD_ID'];
                $addressLines[] = $address;

            }
            return $addressLines;
        }
        return $addressLines;
    }

    /**
     * this a stub for fields which does not have Transaction for Update
     *
     * @param string $ssnId SSN_ID which should be updated
     * @param string $field FIELD name for update
     * @param string $value Value for update
     *
     * @return bool
     */
    public function updateIssn($ssnId, $field, $value)
    {

	if($this->isValidDate($value)){
            $value = $this->getFormatedDateToDb($value);
        }

        $sql    = 'UPDATE ISSN SET ' . $field . ' = ? WHERE SSN_ID = ? ' ;
        $query  = ibase_prepare($this->db, $sql);

        if ($query) {
            if (false !== ($result = ibase_execute($query, $value, $ssnId))) {
                ibase_free_query($query);
                return $result;
            }
            else {
                ibase_free_query($query);
                return false;
            }
        }

        return false;
    }

    /**
     * Update record in PERSON table
     *
     * @param object $contact
     * @return boolean
     */
    public function personUpdate(&$contact)
    {
        $sql = "UPDATE PERSON SET ";
        foreach ($contact->items as $key => $val) {
            $field = $key;
            if ($key == 'CREATE_DATE' && $val == null) {
            } else {
                $sql .= $field . " = '" . $val . "', ";
            }
        }
        $sql = substr($sql, 0, strlen($sql) - 2);
        $sql .= " WHERE PERSON.PERSON_ID = '" . $contact->id . "'";

        if (false !== ($result = ibase_query($this->db, $sql))) {
            return $result;
        }

        return false;
    }

    /**
     * Insert new record into PERSON table
     *
     * @param object $contact ContactLine
     * @return boolean
     */
    public function personAdd(&$contact)
    {
        $result = false;

        // get instance of Zend_Log
        $log = Zend_Registry::get('logger');

        $sql = "INSERT INTO PERSON (";
        $values = "VALUES(";
        $params = array();
        foreach ($contact->items as $key => $val) {
            $field = $key;
            $sql .= $field . ", ";
            if ($key == 'CREATE_DATE') {
                $values .= "'NOW', ";
            } elseif ($key == 'CREATE_BY') {
                $values .= "?, ";
                $params[] = $this->userId;
            } else {
                $values .= "?, ";
                $params[] = $val;
            }
        }
        $sql = substr($sql, 0, strlen($sql) - 2);
        $values = substr($values, 0, strlen($values) - 2);
        $sql .= ") " . $values . ")";
        $log->info($sql . ' : ' . implode(',', $params));

        $params = $this->prepareArgs($sql, $params);

        return $this->execSQL($sql, $params);
    }

    /**
     * Remove record specified by $id from PERSON table
     *
     * @param string $id
     * @return boolean
     */
    public function personDelete($id)
    {
        $sql = 'DELETE FROM PERSON WHERE PERSON_ID = ?';
        $query = ibase_prepare($this->db, $sql);
        if (false !== $query) {
            $result = ibase_execute($query, $id);
            ibase_free_query($query);
            return $result;
        } else {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
            return false;
        }
    }

    /**
     * Update record in PERSON_ADDRESS table
     *
     * @param object $address
     * @return boolean
     */
    public function personAddressUpdate(&$address)
    {
        $result = false;

        $sql = "UPDATE PERSON_ADDRESS SET ";
        $params = array();
        foreach ($address->items as $key => $val) {
            $field = $key;
            if ($key == 'ADDR_CREATED_DATE' && $val == null) {
            } else {
                $params[] = $val;
                $sql .= $field . " = ?, ";
            }
        }
        $sql = substr($sql, 0, strlen($sql) - 2);
        $sql .= " WHERE PERSON_ADDRESS.RECORD_ID = ? ";

        $params[] = $address->id;
        if (false != ($query = ibase_prepare($sql))) {
            array_unshift($params, $query );
            if (false != ($result = call_user_func_array('ibase_execute', $params))) {
                ibase_free_query($query);
                return $result;
            }
            ibase_free_query($query);
        }
        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        return false;
    }

    /**
     * Insert new record to PERSON_ADDRESS table
     *
     * @param object Address $address
     * @return boolean
     */
    public function personAddressAdd(&$address)
    {
        $result = false;
        $sql = "INSERT INTO PERSON_ADDRESS (";
        $values = "VALUES(";
        $params = array();
        foreach ($address->items as $key => $val) {
            $field = $key;
            $sql .= $field . ", ";
            if ($key == 'RECORD_ID') {
                $values .= "?, ";
                $params[] = ibase_gen_id('ADDR_GEN');
            } elseif ($key == 'ADDR_CREATED_DATE') {
                $values .= "'NOW', ";
            } elseif ($key == 'ADDR_CREATED_BY') {
                $values .= "?, ";
                $params[] = $this->userId;
            } else {
                $values .= "?, ";
                $params[] = $val;
            }
        }
        $sql = substr($sql, 0, strlen($sql) - 2);
        $values = substr($values, 0, strlen($values) - 2);
        $sql .= ") " . $values . ")";
        if (false !== ($query = ibase_prepare($sql))) {
            array_unshift($params, $query );
            if (false !== ($result = call_user_func_array('ibase_execute', $params))) {
                ibase_free_result($result);
                ibase_free_query($query);
                return true;
            }
            ibase_free_query($query);
        }
        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        return false;
    }

    /**
     * Removes record specified by $id from PERSON_ADDRESS table
     *
     * @param integer $id
     * @return boolean
     */
    public function personAddressDelete($id)
    {
        $sql = 'DELETE FROM PERSON_ADDRESS WHERE RECORD_ID = ?';
        $query = ibase_prepare($this->db, $sql);
        if (false !== $query) {
            $result = ibase_execute($query, $id);
            ibase_free_query($query);
            return $result;
        } else {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
            return false;
        }
    }

    /**
     * this a stub for fields which does not have Transaction for Update
     *
     * @param $grnNo GRN which should be updated
     * @param $field FIELD name for update
     * @param $value Value for update
     *
     * return string
     */
    public function updateGrn($grnNo, $field, $value)
    {

	if($this->isValidDate($value)){
            $value = $this->getFormatedDateToDb($value);
        }

        $sql   = 'UPDATE GRN SET ' . $field . ' = ? WHERE GRN = ? ' ;
        $query = ibase_prepare($this->db, $sql);

        if ($query) {
            $result = ibase_execute($query, $value, $grnNo);
            if (false !== $result) {
                ibase_free_query($query);
                return $result;
            } else {
                ibase_free_query($query);
                return false;
            }
        }

        return false;
    }

    public function massUpdateSsnField($field, $newValue, $oldValue)
    {
        $sql = 'UPDATE SSN SET ' . $field . ' = ? WHERE ' . $field . ' = ?';
        return $this->execSQL($sql, array($newValue, $oldValue));
    }
    
    /**
     * this a stub for fields which does not have Transaction for Update
     *
     * @param $ssnId string which should be updated
     * @param $field string name for update
     * @param $value string for update
     *
     * return string
     */
    public function updateSsn($ssnId, $field, $value)
    {

	if($this->isValidDate($value)){
            $value = $this->getFormatedDateToDb($value);
        }

        $sql   = 'UPDATE SSN SET ' . $field . ' = ? WHERE SSN_ID = ? ' ;
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info($sql . ' : ' . $ssnId . ',' . $field . ', ' . $value);

        $query = ibase_prepare($this->db, $sql);
        if ($query) {
            $result = ibase_execute($query, $value, $ssnId);
            if (false !== $result) {
                ibase_commit();
                ibase_free_result($result);
                ibase_free_query($query);
                return true;

            } else {
                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                ibase_free_query($query);
                $log->info($this->lastError);
                return false;
            }
        }

        $log->info($this->lastError);
        return false;
    }

    /**
     *
     * Function to update SSN records in single query
     *
     **/

    public function updateSsnType($sql)
    { 
	$result = ibase_query($this->db, $sql);
	return $result;
    }


    /**
     * !!!! NEVER USE THIS FUNCTION !!!!
     *
     * @param string $sql
     */
    public function directSQL($sql)
    {
        $log = Zend_Registry::get('logger');
        $log->info('WARNING! USED directSQL function! ' . $sql);
        if (false !== ($result = ibase_query($this->db, $sql))) {
            ibase_free_result($result);
            return true;
        }
        else {
            return false;
        }
    }

    public function execSQL($sql, $params = array()) {

        $result = false;
        $params = (array) $params;
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $queryMsg = 'Query text: ' . $sql . '; args: ' . implode(', ', array_slice($params, 1));

        $log->getClassicLog()->info('execSQL function! ' . $queryMsg);
        $this->msg('execSQL function! ' . $sql . ' : ' .implode(',', $params) . PHP_EOL);
        $query = ibase_prepare($this->db, $sql);
        if ($query !== false) {
            array_unshift($params, $query);
//            debug_print_backtrace();
            $result = call_user_func_array('ibase_execute', $params);
            if (false !== $result) {
                $result = ibase_affected_rows();
                ibase_free_query($query);
                $log->info($queryMsg);
            } else {
                array_shift($params);
                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql . '. Values: ("' . implode('", "', $params) . '")';
                ibase_free_query($query);
                ibase_free_result($result);
                $log->error($queryMsg);
            }
        } else {
            $log->error($queryMsg);
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql . '. Values: ("' . implode('", "', $params) . '")';
        }
        $log->info('end function' );
        return $result;
    }

    /**
     * Now it is better to use doTransactionResponse()
     *
     * method for sending transaction to database.
     * refactored from barcode4 doTransaction procedure
     *
     * @todo: Need to rewrite
     *
     * @param Transaction $trans
     *
     * @return string
     */
    public function doTransaction($transaction, $wk_docommit='Y', $my_source = 'SSBSSKSSS', $tran_trandate = '', $instance = 'MASTER  ')
    {
        $my_message = "";
        // write transaction
        //$WH_ID = 'FX';
        //$LOCN_ID ='GRNUPDTE';
        $query = "EXECUTE PROCEDURE ADD_TRAN('";
        $query .= substr($transaction->getLocation(),0,2) . "','";
        $query .= substr($transaction->getLocation(),
                         2,
                         strlen($transaction->getLocation()) - 2) . "','";
        $query .= $transaction->getObjectId() . "','";
        $query .= $transaction->getTransCode() . "','";
        $query .= $transaction->getTransClass() . "','";
        if ($tran_trandate == '') {
            //$tran_trandate = date("Y-M-d H:i:s");
            $tran_trandate = gmdate("Y-M-d H:i:s");
        }
        $query .= $tran_trandate . "','";
        $query .= $transaction->getReference() . "',";
        $query .= $transaction->getQuantity() . ",'F','','" . $instance . "',0,'";
        $query .= $transaction->getSubLocation() . "','";
        $query .= $my_source . "','";
        $query .= $this->userId . "','";
        $query .= $this->deviceId . "')";
        
        $this->beginTransaction();
        if (false === ($result = ibase_query($this->db, $query))) {
            $my_message = "Unable to Add Transaction!" ;
            //return $my_message;
        }
        ibase_free_result($result);
        // must get the record id just created
        $query = "SELECT RECORD_ID FROM TRANSACTIONS WHERE WH_ID ='";
        if ($transaction->getLocation() != '') {
            $query .= substr($transaction->getLocation(),0,2)."' AND LOCN_ID = '";
            $query .= substr($transaction->getLocation(),2,strlen($transaction->getLocation()) - 2)."' AND OBJECT = '";
        } else {
            if (isset($pickOrder)) {
                $query .= substr($pickOrder,0,2)."' AND LOCN_ID = '";
                $query .= substr($pickOrder,2,strlen($pickOrder) - 2)."' AND OBJECT = '";
            }
        }
        $query .= $transaction->getObjectId() . "' AND TRN_DATE = '";
        $query .= $tran_trandate . "' AND TRN_CODE = '";
        $query .= $transaction->getTransClass() . "' AND DEVICE_ID = '";
        $query .= $this->deviceId . "' AND COMPLETE = 'F'";
        $tran_recordid = NULL;

        if (false === ($result = ibase_query($this->db, $query))) {
            // processed ok
        } else {
            if (($row = ibase_fetch_row($result))) {
                $tran_recordid =  $row[0];
                ibase_free_result($result);
            }
        }
        if (isset($tran_recordid)) {
            // must get the record id just updated
            $query = "SELECT ERROR_TEXT,COMPLETE,RECORD_ID
                      FROM TRANSACTIONS
                      WHERE RECORD_ID = ".$tran_recordid;

            if (false === ($result = ibase_query($this->db, $query))) {

                $my_message = "Unable to query Transaction!" ;
                $this->rollbackTransaction() . ' rolled ';
                return $my_message;
            }
            $tran_error = NULL;
            $tran_complete = NULL;
            if (false !== ($row = ibase_fetch_row($result))) {
                $tran_error =  $row[0];
                $tran_complete =  $row[1];
            }
            ibase_free_result($result);
            if (false == isset($tran_complete)) {
                $query = "UPDATE TRANSACTIONS
                          SET complete = 'T'
                          WHERE RECORD_ID = " . $tran_recordid;
                if (false === ($result = ibase_query($this->db, $query))) {
                    $my_message = "Unable to Update Transaction!" ;
                    $this->rollbackTransaction();
                    return $my_message . ' rolled ';
                }
            }
            if (isset($tran_complete)) {
                if ($tran_complete == "F") {
                    if (isset($tran_error)) {
                        if ($tran_error != "") {
                            $my_message = urlencode($tran_error);
                            $this->commitTransaction();
                            return $my_message;
                        }
                    }
                }
            }
        }
        if ($wk_docommit == 'Y') {
            //commit
            //ibase_commit($dbTran);
            $this->commitTransaction();
        }
        return $my_message;
    }


    /**
     * method for sending transaction to database
     * refactored from barcode4 doTransaction procedure
     *
     * @todo: Need to rewrite
     *
     * @param Transaction $transaction
     * @param string $my_source
     * @param string $wk_docommit
     * @return string
     */
    public function doTransactionResponse($transaction, $wk_docommit='Y', $my_source = 'SSBSSKSSS', $tran_trandate = '', $instance = 'MASTER  ')
    {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);

        $sql = "SELECT RESPONSE_TEXT FROM ADD_TRAN_RESPONSE(?,?,?,?,?,?,?,?,'F','',?,0,?,?,?,?)";
        $query = ibase_prepare($this->db, $sql);

        if ($query) {

            if ($wk_docommit == 'Y') {
                $this->beginTransaction();
            }
            /*
             * for debug purposes
             *
             *
             * $sql = " SELECT LAST_PALLET_NO FROM GRN WHERE GRN = (SELECT GRN FROM SSN WHERE SSN_ID =
            (SELECT ORIGINAL_SSN FROM ISSN WHERE SSN_ID = '" . $transaction->getObjectId() . "'))" ;

            $result = ibase_query($sql);
            $row = ibase_fetch_row($result);
            if ($transaction->getTransCode() == 'UISS') {
                $sql = "UPDATE GRN SET LAST_PALLET_NO = '" . ($row[0]+1) . "' WHERE GRN = (SELECT GRN FROM SSN WHERE SSN_ID =
                (SELECT ORIGINAL_SSN FROM ISSN WHERE SSN_ID = '" . $transaction->getObjectId() . "'))";
                ibase_query($sql);
            }
            $res = 'Processed successfully|' . substr($transaction->getObjectId(), 0, 6) . str_pad($row[0], 2, '0', STR_PAD_LEFT);
            return $res;
            */

            if ($tran_trandate == '') {
                //$tran_trandate = date("Y-M-d H:i:s");
                $tran_trandate = gmdate("Y-M-d H:i:s");
            }

            $wh_id = substr($transaction->getLocation(),0,2);

            if (false === $wh_id) {
                $wh_id = current($this->getListByField('CONTROL.DEFAULT_WH_ID'));
            }

            $location = substr($transaction->getLocation(),2,strlen($transaction->getLocation()) - 2) === false ? '': substr($transaction->getLocation(),2,strlen($transaction->getLocation()) - 2);


    //        var_dump($wh_id . '/' . $location . '/' . $transaction->getObjectId() . '/' . $transaction->getTransCode() . '/' . $transaction->getTransClass() . '/' .
    //                 $tran_trandate . '/' . $transaction->getReference() . '/' . $transaction->getQuantity() . '/' . $instance . '/' . $transaction->getSubLocation() . '/' .
    //                 $my_source . '/' . $this->userId . '/' . $this->deviceId);
    //      die();

            if (false === ($result = ibase_execute($query,
                                     $wh_id,
                                     $location,
                                     $transaction->getObjectId(),
                                     $transaction->getTransCode(),
                                     $transaction->getTransClass(),
                                     $tran_trandate,
                                     $transaction->getReference(),
                                     $transaction->getQuantity(),
                                     $instance,
                                     $transaction->getSubLocation(),
                                     $my_source,
                                     $this->userId,
                                     $this->deviceId)))
            {
                $this->lastError = "Unable to Add Transaction!";
                $this->rollbackTransaction();
                ibase_free_query($query);

                return false;
            } else {
                    $output = "SELECT RESPONSE_TEXT FROM ADD_TRAN_RESPONSE('";
                    $output .= substr($transaction->getLocation(),0,2) === false  ? 'FX' : substr($transaction->getLocation(),0,2);
                    $output .= "','";
                    $output .= substr($transaction->getLocation(),2,strlen($transaction->getLocation()) - 2) === false ? '': substr($transaction->getLocation(),2,strlen($transaction->getLocation()) - 2);
                    $output .= "','";
                    $output .= $transaction->getObjectId() . "','";
                    $output .= $transaction->getTransCode() . "','";
                    $output .= $transaction->getTransClass() . "','";
                    $output .= $tran_trandate . "','";
                    $output .= $transaction->getReference() . "',";
                    $output .= $transaction->getQuantity() . ",'F','','MASTER',0,'";
                    $output .= $transaction->getSubLocation() . "','";
                    $output .= $my_source . "','";
                    $output .= $this->userId . "','";
                    $output .= $this->deviceId . "')";
                    //$this->lastError = $output;
                    $log->info($output);
                    //-- end of debug info
                if (false !== ($row = ibase_fetch_row($result))) {
                    //-- debug info
                    // set response from DB

                    $log->info(implode(";\n", $row));
                    $this->lastError = $row[0];
                    $this->lastError = $row[0];
                    ibase_free_result($result);
                    if ($wk_docommit == 'Y') {
                        //commit
                        $this->commitTransaction();
                    }

                    // if reponse does not contains 'success' - error occurred
                    if (stripos($this->lastError, 'success') === false) {
                        if (strlen($this->lastError) == 0) {
                            $this->lastError = 'Unknown error';

                        }

                        return false;
                    }


                    return $row[0];
                } else {
                    $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;

                    ibase_free_result($result);
                    //$this->lastError = 'Can\'t fetch row';
                }
                //release memory
                if (isset($result))
                {
                    ibase_free_result($result);
                }

                if ($wk_docommit == 'Y') {
                    //commit
                    $this->commitTransaction();
                }
                return false;
            }
        } else {
            $log->error($sql);
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;

            return false;
        }
    }

    public function doTransactionResponseV6(Transaction_V6Interface $transaction, $doCommit = 'Y') {


        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);

        $sql = "SELECT RESPONSE_TEXT FROM ADD_TRAN_RESPONSE_V6(?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?,?)";
        $query = ibase_prepare($this->db, $sql);

        if (false === $query) {
            $msg = 'Error preparing query: ' . ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
            $log->error($msg);
            throw new Exception($msg);
        }

        $args = array(
            $transaction->getWhId(),
            $transaction->getLocnId(),
            $transaction->getObjectId(),
            $transaction->getType(),
            $transaction->getCode(),
            $transaction->getDate(),
            $transaction->getReference(),
            $transaction->getQuantity(),
            $transaction->getComplete(),
            $transaction->getErrorText(),
            $transaction->getInstanceId(),
            $transaction->getExported(),
            $transaction->getSubLocation(),
            $transaction->getInputSource(),
            $transaction->getPersonId(),
            $transaction->getDeviceId(),
            $transaction->getProdId(),
            $transaction->getCompanyId(),
            $transaction->getOrderNo(),
            $transaction->getOrderType(),
            $transaction->getOrderSubType(),
            $transaction->getFamily()
        );

        $log->info("SELECT RESPONSE_TEXT FROM ADD_TRAN_RESPONSE_V6('" . implode("', '", $args) . "')");

        if ($doCommit == 'Y') {
            $this->beginTransaction();
        }

        array_unshift($args, $query);

        if (false === ($result = call_user_func_array('ibase_execute', $args))) {
            $msg = 'Error executing transaction: ' . ibase_errcode() . ' ' . ibase_errmsg();
            ibase_free_query($query);
            $log->error($msg);
            if ($doCommit == 'Y') {
                $this->rollbackTransaction();
            }
            throw new Exception($msg);
        }

        if (false === ($resultRow = ibase_fetch_assoc($result))) {
            $msg = 'Error reading transaction result: ' . ibase_errcode() . ' ' . ibase_errmsg();
            ibase_free_result($result);
            ibase_free_query($query);
            $log->error($msg);
            if ($doCommit == 'Y') {
                $this->rollbackTransaction();
            }
            throw new Exception($msg);
        }

        ibase_free_result($result);
        ibase_free_query($query);

        $log->info('Got response: ' . implode(', ', $resultRow));
        $responseText = $resultRow['RESPONSE_TEXT'];
	$this->lastError = $responseText;
        if (empty($responseText)) {
            $msg = 'Empty transaction response';
            $log->error($msg);
            if ($doCommit == 'Y') {
                $this->commitTransaction();
            }
            throw new Exception($msg);
        }

        if (stripos($responseText, 'success') === false) {
            $msg = 'Transaction failed with response: ' . $responseText;
            $log->error($msg);
            if ($doCommit == 'Y') {
                $this->commitTransaction();
            }
            throw new Exception($msg);
        }

        if ($doCommit == 'Y') {
            $this->commitTransaction();
        }

        return $responseText;
    }

    /**
     * Get List from source specified by $fieldname
     *
     * @param string $fieldname name of source represented by TABLENAME.FIELDNAME
     * @return array
     */
    public function getListByField($mixedname, $fieldname = null)
    {
        $output = array();

        if (null == $fieldname) {
            $data  = pathinfo($mixedname);
            $table = $data['filename'];
            $field = $data['extension'];
        }

        $sql    = 'SELECT ' . $field . ', ' . $field . ' FROM ' . $table;

        $output = $this->findList($sql);

        return $output;
    }

    protected function removePasswordColumnFromReportResults($originalResults) {
        $results = $originalResults;

        if (count($results) < 1)
            return $results;

        $fields = array_keys($results[0]);

        foreach (array('PASS_WORD') as $passwordField) {
            if (false !== ($key = array_search($passwordField, $fields))) {
                unset($fields[$key]);
                foreach ($results as &$tableRow)
                    unset($tableRow[$passwordField]);
            }
        }

        return $results;
    }

    /**
     * Returns a FALSE if the report could not be run or an array.
     *
     * @param string $reportId ID of report
     * @param array  $params   array of params for report
     *
     * @return boolean|array
     */
    public function reportRun($reportId, $params = null)
    {
        if (false !== ($report = $this->getReport($reportId))) {

            $output = array();

            $log = Zend_Registry::get('logger');
            $log->info('Report Query to DB');
            $log->info(print_r($params, true));

            if (null != $params) {
                $prepared = $this->preparePlaceholders($report->items['QUERY'], $params);
                $log->info(print_r($prepared['sql'], true));
                $log->info(print_r($prepared['params'], true));
                $table = $this->findAllAssocMod($prepared['sql'], $prepared['params']);
            } else {
                $log->info($report->items['QUERY']);
                $table = $this->findAllAssoc($report->items['QUERY']);
                
            }
            $patterns = array_merge((array) $params, array(array('%totalrows%' => count($table)),
                                                   array('%company%'   => $this->limitCompany)
                                                   )
                                   );
            if (!$this->isSysAdmin())
                $table = $this->removePasswordColumnFromReportResults($table);
            
            $output['table'] = $table;
            if (count($table) > 0 ) {
                $output['fields'] = array_keys($table[0]);
            } else {
                $output['fields'] = array();
            }
            $temp = $this->preparePlaceholders($report->items['REPORT_HEADER'], $patterns, false);
            $output['report_header'] = $temp['sql'];
            $temp = $this->preparePlaceholders($report->items['REPORT_FOOTER'], $patterns, false);
            $output['report_footer'] = $temp['sql'];
            
            return $output;
        } else {
            $this->lastError = "No report exists";
            return false;
        }
    }

    /**
     * Prepare sql query string for SQL-injection proof execution
     *
     * @param string $sql string an SQL query with patterns
     * @param array  $listOfPatterns array of arrays patterns where second-level
     *                               array contains only one element where KEY is pattern, VALUE is value
     * @param boolean $safe if TRUE return SQL string ready to be prepared. if FALSE return string with direct injection of values.
     * NOTE: Order of pairs in $listOfPatterns is IMPORTANT, because identical pattern will be processed in natural order,
     * first traped VALUE will replace first pattern in SQL query.
     * e.g.
     * <pre>
     * <b>Sample query:</b>
     * <code>SQL * FROM TABLE WHERE (FIELD1 = %pattern1% AND FIELD2 = %pattern2%) OR (FIELD2 > %pattern2%)</code>
     * <b>Sample $listOfPatterns:</b>
     * <code>array(array('%pattern1%' => 10), array('%pattern2%' => 'first'), array('%pattern2%' => 'second'));</code>
     * <br />
     * <b>Result:</b>
     *
     * <i>array
     *      'sql'    => SQL * FROM TABLE WHERE (FIELD1 = ? AND FIELD2 = ?) OR (FIELD2 > ?)
     *      'params' =>
     *          array
     *              0 => int 10
     *              1 => string 'first' (length=5)
     *              2 => string 'second' (length=6)
     * </i>
     * </pre>
     *
     * @return array Array of two elements: key 'sql' is string with '?' as placeholders, and key 'params' - array with values
     */
    public function preparePlaceholders($sql, $listOfPatterns = null, $safe = true)
    {
        $preparedParams = array();
        $preparedQuery  = $sql;

        //-- if exists predefined patterns, replace them
        $predefined    = array('%now%', '%userid%', '%rundate%', '%company%', '%deviceid%');
        $preparedQuery = str_ireplace('%now%', date("G:i:s T"), $preparedQuery);
        $preparedQuery = str_ireplace('%userid%', $this->userId, $preparedQuery);
        $preparedQuery = str_ireplace('%rundate%', date("Y M j G:i:s T"), $preparedQuery);
        $company       = 'all' != strtolower($this->limitCompany) ? $this->limitCompany : '';
        $preparedQuery = str_ireplace('%company%', $company, $preparedQuery);
        $preparedQuery = str_ireplace('%deviceid%', $this->deviceId, $preparedQuery);

        foreach ($listOfPatterns as  $pair) {
            list($pattern, $value) = each($pair);
            if (false == in_array($pattern, $predefined)) {
                $offset = 0;
                while (false !== ($pos = strpos($preparedQuery, $pattern, $offset))) {
                    $preparedParams[$pos] = $value;
                    $offset = $pos + 1;
                }
                if ($safe) {
                    $preparedQuery = preg_replace('/' . $pattern . '/', '?', $preparedQuery, 1, $count);
                } else {
                    $preparedQuery = preg_replace('/' . $pattern . '/', $value, $preparedQuery, 1);
                }
            }
        }
        ksort($preparedParams);

        $result['sql']    = $preparedQuery;
        $result['params'] = $preparedParams;

        return $result;
    }

    /**
     * Translate array of clause into SQL string with patterns and array of params
     * Should be used with preparePlaceholders()
     *
     *
     * @param array $clause
     * @return array
     */
    public function prepareClause($clause = null)
    {
        $outputSql    = '';
        $listOfPatterns = array();
        if (null != $clause) {
            throw Exception('Not yet implemented');
        }
        $result['sql']    = $outputSql;
        $result['params'] = $listOfPatterns;

        return $result;
    }

    
    /**
    * Return list of report types.
    * 
    * @return array
    * 
    */
    public function getReportTypes()
    {
        //return $this->findList('SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = ? ORDER BY CODE', 'REP_TYPE');
        return $this->findList('SELECT CODE, DESCRIPTION FROM REPORTS_TYPE  WHERE RT_STATUS  = ? ORDER BY CODE', 'OK');
    }

    public function getReportMenuTypes() {
        return $this->findList('SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = ? ORDER BY CODE', 'REP_TYPE');
    }
    
    /**
     * Get report by id
     * Returns a ReportLine object or FALSE if no reports exists
     *
     * @return object|false
     */
    public function getReport($reportId)
    {
        $log = Minder_Registry::getLogger()->startDetailedLog(__METHOD__);
        $sql = "SELECT
                    REPORT_ID,
                    NAME,
                    DESCRIPTION,
                    QUERY,
                    COMPANY_ID,
                    CREATE_DATE,
                    CREATED_BY,
                    LAST_UPDATE_DATE,
                    LAST_UPDATE_BY,
                    REPORT_FREQUENCY,
                    REPORT_OUTPUT_FORMAT,
                    REPORT_HEADER,
                    REPORT_FOOTER,
                    REPORT_TYPE,
                    REPORT_ACTIVITY,
                    REPORT_URI,
                    REPORT_FORMAT,
                    REPORT_MENU_TYPE
                FROM REPORTS
                WHERE REPORT_ID = ?";

        $data = $this->findAllAssoc($sql, $reportId);
        if (count($data) > 0) {
//editing query maxtime, zerotime portions
/*
            $query=$data[0]['QUERY'];


            $query=str_replace("(","{",$query);
            $query=str_replace(")","}",$query);

            if (preg_match('/maxtime{(.*?)}}/', $query, $replace_from) === 1) {
                   
                $replace_froma="maxtime{".$replace_from[1]."}";  

                $cast_a=preg_replace('/[{}]/', '', $replace_froma)." as timestamp";
                $cast_a=str_replace("maxtime","",$cast_a);               
                $replace_to_a="dateadd(day,1,cast(".$cast_a."))";
                $new_query=preg_replace('/'.$replace_froma.'/', $replace_to_a, $query);
               
            }

            if (preg_match('/zerotime{(.*?)}/', $query, $replace_from) === 1) {
                
                $replace_fromb="zerotime{".$replace_from[1]."}";
           
                $cast_b=preg_replace('/[{}]/', '', $replace_fromb)." as timestamp";
                $cast_b=str_replace("zerotime","",$cast_b);
                $replace_to_b="dateadd(day,1,cast(".$cast_b."))";
                if(isset($new_query)){
                $new_query=preg_replace('/'.$replace_fromb.'/', $replace_to_b, $new_query);
                }
                else{
                $new_query=preg_replace('/'.$replace_fromb.'/', $replace_to_b, $query);
                }                

            }

            if(isset($new_query)){
                
                        $new_query=str_replace("{","(",$new_query);
                        $new_query=str_replace("}",")",$new_query);

                        $data[0]['QUERY']=$new_query;
            }
//editing query maxtime, zerotime portions
*/

            $reportActivity =   ++$data[0]['REPORT_ACTIVITY'];
            $sql = 'UPDATE REPORTS SET REPORT_ACTIVITY = ? WHERE REPORT_ID = ? ';
            $this->execSQL($sql, array($reportActivity, $reportId));
            
            $report = new ReportLine($data[0]);
            $report->id = $data[0]['REPORT_ID'];
  
            $blob = ibase_blob_open($this->db, $report->items['DESCRIPTION']);
            if (false !== $blob) {
                $blob_info = ibase_blob_info($this->db, $report->items['DESCRIPTION']);
                $report->items['DESCRIPTION'] = ibase_blob_get($blob, $blob_info['length']);
                ibase_blob_close($blob);
            } else {
                $report->items['DESCRIPTION'] = '';
            }
  
            $blob = false;
  
            $blob = ibase_blob_open($this->db, $report->items['QUERY']);
            if (false !== $blob) {
                $blob_info = ibase_blob_info($this->db, $report->items['QUERY']);
                $report->items['QUERY'] = ibase_blob_get($blob, $blob_info['length']);
                ibase_blob_close($blob);
            } else {
                $report->items['QUERY'] = '';
            }
  
//editing query maxtime, zerotime portions

            $query=$report->items['QUERY'];

            $query=str_replace("(","{",$query);
            $query=str_replace(")","}",$query);

            if (preg_match('/maxtime{(.*?)}}/', $query, $replace_from) === 1) {
                   
                $replace_froma="maxtime{".$replace_from[1]."}";  

                $cast_a=preg_replace('/[{}]/', '', $replace_froma)." as timestamp";
                $cast_a=str_replace("maxtime","",$cast_a);               
                $replace_to_a="dateadd(day,1,cast(".$cast_a."))";
                $new_query=preg_replace('/'.$replace_froma.'/', $replace_to_a, $query);
               
            }

            if (preg_match('/zerotime{(.*?)}/', $query, $replace_from) === 1) {
                
                $replace_fromb="zerotime{".$replace_from[1]."}";
           
                $cast_b=preg_replace('/[{}]/', '', $replace_fromb)." as timestamp";
                $cast_b=str_replace("zerotime","",$cast_b);
                $replace_to_b="dateadd(day,1,cast(".$cast_b."))";
                if(isset($new_query)){
                $new_query=preg_replace('/'.$replace_fromb.'/', $replace_to_b, $new_query);
                }
                else{
                $new_query=preg_replace('/'.$replace_fromb.'/', $replace_to_b, $query);
                }                

            }

            if(isset($new_query)){
                
                        $new_query=str_replace("{","(",$new_query);
                        $new_query=str_replace("}",")",$new_query);

                        $report->items['QUERY'] = $new_query;
            }

            return $report;
        }
        $this->lastError = 'No report exists';
        return false;
    }
    
    /**
    * get Drop Down list for Reports Prompt
    * 
    * @param mixed $sql
    * @return array
    */
    public function getDropDownList($sql){
        return $this->findList($sql);
    }

    /**
     * Get list of ReportLines object
     *
     * @param $clause array of conditions
     * <b>ex:</b>
     * <code>$clause = array('SOME_KEY' => 'SOME_VALUE');</code>
     * translated to <code>"SOME_KEY LIKE 'SOME_VALUE%'";</code>
     *
     * If SOME_VALUE is NULL then SOME_KEY used as single condition
     * <b>ex:</b>
     * <code>$clause = array("SOME_KEY = '11'" => null);</code>
     * translated to <code>"SOME_KEY = '11'";</code>
     *
     * @return array
     */
    public function getReports($clause = null)
    {
        $reportLines = array();
        $sql = "SELECT
                    REPORT_ID,
                    NAME,
                    DESCRIPTION,
                    QUERY,
                    COMPANY_ID,
                    CREATE_DATE,
                    CREATED_BY,
                    LAST_UPDATE_DATE,
                    LAST_UPDATE_BY,
                    REPORT_FREQUENCY,
                    REPORT_OUTPUT_FORMAT,
                    REPORT_HEADER,
                    REPORT_FOOTER,
                    REPORT_TYPE,
                    REPORT_ACTIVITY,
                    REPORT_URI,
                    REPORT_FORMAT
                FROM REPORTS ";

        $values =   array();
        if(!empty($clause)){
            $i = 1;
            $where = 'WHERE ';
            foreach($clause as $key =>  $value){
                $values[] =  (false === stripos($key, 'LIKE')) ? $value : ('%' . trim($value, '%') . '%');
                $where .=   $key;

                if ($i < count($clause)) {
                    $where .= ' AND ';
                    $i++;
                }
            }
            
            $sql .=  $where;
        }
        
        $sql .= ' ORDER BY REPORT_ACTIVITY DESC, REPORT_ID DESC';
        array_unshift($values, $sql);
        $data = call_user_func_array(array($this, 'findAllAssoc'), $values);
        if (count($data) > 0) {
            foreach ($data as $line) {
                $report = new ReportLine($line);
                $report->id = $line['REPORT_ID'];
  
                $blob = ibase_blob_open($this->db, $report->items['DESCRIPTION']);
                if (false !== $blob) {
                    $blob_info = ibase_blob_info($this->db, $report->items['DESCRIPTION']);
                    $report->items['DESCRIPTION'] = ibase_blob_get($blob, $blob_info['length']);
                    ibase_blob_close($blob);
                } else {
                    $report->items['DESCRIPTION'] = '';
                }
  
                $blob = false;
   
               $blob = ibase_blob_open($this->db, $report->items['QUERY']);
                if (false !== $blob) {
                    $blob_info = ibase_blob_info($this->db, $report->items['QUERY']);
                    $report->items['QUERY'] = ibase_blob_get($blob, $blob_info['length']);
                    ibase_blob_close($blob);
                } else {
                    $report->items['QUERY'] = '';
                }
  
                $reportLines[] = $report;
            }
            return $reportLines;
        }
        return $reportLines;
    }

    /**
     * Insert new report into REPORTS table
     * if fails return FALSE;
     *
     * @param object $report
     * @return boolean
     */
    public function reportCreate(&$report)
    {
        $id = ibase_gen_id("REPORT_ID_GEN");

        $report->items["REPORT_ID"] = $id;
        $report->id = $id;
        $sql = "INSERT INTO REPORTS (
                            REPORT_ID,
                            NAME,
                            DESCRIPTION,
                            QUERY,
                            COMPANY_ID,
                            CREATE_DATE,
                            CREATED_BY,
                            LAST_UPDATE_DATE,
                            LAST_UPDATE_BY,
                            REPORT_FREQUENCY,
                            REPORT_OUTPUT_FORMAT,
                            REPORT_HEADER,
                            REPORT_FOOTER,
                            REPORT_TYPE,
                            REPORT_ACTIVITY,
                            REPORT_URI,
                            REPORT_FORMAT,
                            REPORT_MENU_TYPE)
                       VALUES (?, ?, ?, ?, ?, 'NOW', '" . $this->userId . "', 'NOW', '" . $this->userId . "', ?, ?, ?, ?, ?, ?, ?, ?, ?)";
        $this->lastError = '';

        /*if (false !== ($blob = ibase_blob_create($this->db)) ) {
            if (false !== ibase_blob_add($blob, $report->items['DESCRIPTION'])) {
                $report->items['DESCRIPTION'] = $blob;
            } else {
                $this->lastError .= ibase_errcode() . ' ' . ibase_errmsg() . "\n";
            }
        }
        $blob = false;
        if (false !== ($blob = ibase_blob_create($this->db)) ) {
            if (false !== ibase_blob_add($blob, $report->items['QUERY'])) {
                $report->items['QUERY'] = $blob;
            } else {
                $this->lastError .= ibase_errcode() . ' ' . ibase_errmsg() . "\n";
            }
        }*/

        if (false !== ($query = ibase_prepare($this->db, $sql))) {
            $result = ibase_execute($query,
                                    $report->items['REPORT_ID'],
                                    $report->items['NAME'],
                                    $report->items['DESCRIPTION'],
                                    $report->items['QUERY'],
                                    $report->items['COMPANY_ID'],
                                    $report->items['REPORT_FREQUENCY'],
                                    $report->items['REPORT_OUTPUT_FORMAT'],
                                    $report->items['REPORT_HEADER'],
                                    $report->items['REPORT_FOOTER'],
                                    $report->items['REPORT_TYPE'],
                                    $report->items['REPORT_ACTIVITY'],
                                    $report->items['REPORT_URI'],
                                    $report->items['REPORT_FORMAT'],
                                    $report->items['REPORT_MENU_TYPE']
                                    );
            if (false !== $result) {
                ibase_free_result($result);
                ibase_free_query($query);
                return true;
            } else {
                ibase_free_query($query);
                return false;
            }
        }

        return false;
    }

    /**
     * Update report with new data
     *
     * @param object $report
     * @return boolean
     */
    public function reportUpdate($report)
    {  
        $sql = "UPDATE REPORTS SET REPORT_ID = ?,
                                NAME = ?,
                                DESCRIPTION = ?,
                                QUERY = ?,
                                COMPANY_ID = ?,
                                CREATE_DATE = ?,
                                CREATED_BY = ?,
                                LAST_UPDATE_DATE = 'NOW',
                                LAST_UPDATE_BY = ?,
                                REPORT_FREQUENCY = ?,
                                REPORT_OUTPUT_FORMAT = ?,
                                REPORT_HEADER = ?,
                                REPORT_FOOTER = ?,
                                REPORT_TYPE = ?,
                                REPORT_URI = ?,
                                REPORT_FORMAT = ?,
                                REPORT_MENU_TYPE = ?
                            WHERE REPORT_ID = ?";
        if (false !== ($query = ibase_prepare($this->db, $sql))) {
            $result = ibase_execute($query,
                                    $report->items['REPORT_ID'],
                                    $report->items['NAME'],
                                    $report->items['DESCRIPTION'],
                                    $report->items['QUERY'],
                                    $report->items['COMPANY_ID'],
                                    $report->items['CREATE_DATE'],
                                    $report->items['CREATED_BY'],
                                    $this->userId,
                                    $report->items['REPORT_FREQUENCY'],
                                    $report->items['REPORT_OUTPUT_FORMAT'],
                                    $report->items['REPORT_HEADER'],
                                    $report->items['REPORT_FOOTER'],
                                    $report->items['REPORT_TYPE'],
                                    $report->items['REPORT_URI'],
                                    $report->items['REPORT_FORMAT'],
                                    $report->items['REPORT_MENU_TYPE'],
                                    $report->items['REPORT_ID']
                                    );
            if (false !== $result) {
                ibase_free_query($query);
                return $result;
            } else {
                $this->lastError = 'Wrong execution' . ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                ibase_free_query($query);
                return false;
            }
        }
        $this->lastError = 'Something happened' . ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        return false;
    }

    /**
     * Removes record specified by $reportId from REPORT table
     *
     * @param string $reportId
     * @return boolean
     */
    public function reportDelete($reportId)
    {
        $sql = 'DELETE FROM REPORTS WHERE REPORT_ID = ?';
        $query = ibase_prepare($this->db, $sql);
        if (false !== $query) {
            $result = ibase_execute($query, $reportId);
            if (false !== $result) {
                ibase_free_query($query);
                return $result;
            }
            else {
                ibase_free_query($query);
                return false;
            }

        } else {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
            return false;
        }
    }

    public function getReportDetails($report_id)
    {
        //$log = Zend_Registry::get('logger');
        //$log->info(__FUNCTION__);
        $output = array();
        $sql = "SELECT
                    REPORT_ID,
                    REPORT_DETAIL_ID,
                    SEQUENCE,
                    QUERY_FIELD,
                    QUERY_PROMPT,
                    QUERY_DB_FIELD,
                    QUERY_PROMPT_TYPE,
                    QUERY_COPY_FIELD
                FROM REPORTS_DETAIL
                WHERE REPORT_ID = ?
                ORDER BY SEQUENCE";  


        $data = $this->findAllAssoc($sql, $report_id);  
        if (count($data) > 0) {
            foreach ($data as $line) {
                $reportDetail = new ReportDetail($line);
                $reportDetail->id = $line['REPORT_DETAIL_ID'];
                
                $output[] = $reportDetail;
            }
        }
        return $output;
    }
    
    /**
    * update report activity
    * 
    * @param int $reportId
    */
    public function updateReportActivity($reportId){
        
        // update report activity
        $sql = 'SELECT 
                    REPORT_ACTIVITY
                FROM REPORTS
                WHERE REPORT_ID = ?';
        
        $reportActivity = $this->findOneAssoc($sql, $reportId);
        
        if(!empty($reportActivity)){
            if(is_null($reportActivity['REPORT_ACTIVITY']) || empty($reportActivity['REPORT_ACTIVITY'])){
                $reportActivity = 1; 
            } else {
                $reportActivity = ++$reportActivity['REPORT_ACTIVITY'];   
            }
            
            $sql = 'UPDATE 
                        REPORTS
                    SET REPORT_ACTIVITY = ?
                    WHERE REPORT_ID = ?';
            
            $this->execSQL($sql, array($reportActivity, $reportId));    
        
        }
    }

    public function getReportDetail($report_detail_id)
    {
        $output = false;
        $sql = "SELECT
                    REPORT_ID,
                    REPORT_DETAIL_ID,
                    SEQUENCE,
                    QUERY_FIELD,
                    QUERY_PROMPT,
                    QUERY_DB_FIELD,
                    QUERY_PROMPT_TYPE,
                    QUERY_COPY_FIELD
                FROM REPORTS_DETAIL
                WHERE REPORT_DETAIL_ID = ?";
        $data = $this->findAllAssoc($sql, $report_detail_id);
        if (count($data) > 0) {
            $reportDetail = new ReportDetail($data[0]);
            $reportDetail->id = $data[0]['REPORT_DETAIL_ID'];
            $output = $reportDetail;
        }
        return $output;
    }

    /**
     * Insert new report detail into REPORTS_DETAIL table
     * if fails return FALSE;
     *
     * @param object $reportDetail
     * @return boolean
     */
    public function reportDetailCreate(&$reportDetail)
    {
        $id = ibase_gen_id("REPORT_DETAIL_ID_GEN");

        $reportDetail->items["REPORT_DETAIL_ID"] = $id;
        $reportDetail->id = $id;
        $sql = "INSERT INTO REPORTS_DETAIL (
                            REPORT_ID,
                            REPORT_DETAIL_ID,
                            SEQUENCE,
                            QUERY_FIELD,
                            QUERY_PROMPT,
                            QUERY_DB_FIELD,
                            QUERY_PROMPT_TYPE,
                            QUERY_COPY_FIELD)
                       VALUES (?, ?, ?, ?, ?, ?, ?, ?)";
        $this->lastError = '';

        if (false !== ($query = ibase_prepare($this->db, $sql))) {
            $result = ibase_execute($query,
                                    $reportDetail->items['REPORT_ID'],
                                    $reportDetail->items['REPORT_DETAIL_ID'],
                                    $reportDetail->items['SEQUENCE'],
                                    $reportDetail->items['QUERY_FIELD'],
                                    $reportDetail->items['QUERY_PROMPT'],
                                    $reportDetail->items['QUERY_DB_FIELD'],
                                    $reportDetail->items['QUERY_PROMPT_TYPE'],
                                    $reportDetail->items['QUERY_COPY_FIELD']
                                    );
            if (false !== $result) {
                ibase_free_result($result);
                ibase_free_query($query);
                return true;
            } else {
                ibase_free_query($query);
                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                return false;
            }
        }
        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        return false;
    }

    /**
     * Update report detail with new data
     *
     * @param object $reportDetail
     * @return boolean
     */
    public function reportDetailUpdate($reportDetail)
    {
        $sql = "UPDATE REPORTS_DETAIL SET
                                REPORT_ID = ?,
                                REPORT_DETAIL_ID = ?,
                                SEQUENCE = ?,
                                QUERY_FIELD = ?,
                                QUERY_PROMPT = ?,
                                QUERY_DB_FIELD = ?,
                                QUERY_PROMPT_TYPE = ?,
                                QUERY_COPY_FIELD = ?
                            WHERE REPORT_DETAIL_ID = ?";
        if (false !== ($query = ibase_prepare($this->db, $sql))) {
            $result = ibase_execute($query,
                                    $reportDetail->items['REPORT_ID'],
                                    $reportDetail->items['REPORT_DETAIL_ID'],
                                    $reportDetail->items['SEQUENCE'],
                                    $reportDetail->items['QUERY_FIELD'],
                                    $reportDetail->items['QUERY_PROMPT'],
                                    $reportDetail->items['QUERY_DB_FIELD'],
                                    $reportDetail->items['QUERY_PROMPT_TYPE'],
                                    $reportDetail->items['QUERY_COPY_FIELD'],
                                    $reportDetail->items['REPORT_DETAIL_ID']
                                    );
            if (false !== $result) {
                ibase_free_query($query);
                return $result;
            } else {
                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                ibase_free_query($query);
                return false;
            }
        }
        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        return false;
    }

    /**
     * Removes record specified by $reportDetailId from REPORT_DETAIL table
     *
     * @param string $reportDetailId
     * @return boolean
     */
    public function reportDetailDelete($reportDetailId)
    {
        $sql = 'DELETE FROM REPORTS_DETAIL WHERE REPORT_DETAIL_ID = ?';
        $query = ibase_prepare($this->db, $sql);
        if (false !== $query) {
            if (false !== ($result = ibase_execute($query, $reportDetailId))) {
                ibase_free_query($query);
                return $result;
            }
            else {
                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                ibase_free_query($query);
                return false;
            }

        }

        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        return false;
    }

    public function getProductStockStatus($clause = null) {
        $result = new stdClass();
        $result->totalQty = 0;
        $result->onHandQty = 0;

        $minder = Minder::getInstance();

        $subquery = "
            SELECT DISTINCT
                PROD_ID
            FROM (SELECT
                          ISSN.PROD_ID,
                          (SELECT
                               PROD_PROFILE.PROD_ID
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS PP_PROD_ID,
                          (SELECT
                               PROD_PROFILE.PROD_TYPE
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS PROD_TYPE,
                           (SELECT
                               PROD_PROFILE.SSN_TYPE
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS SSN_TYPE,
                           (SELECT
                               PROD_PROFILE.SALE_PRICE
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS SALE_PRICE,
                          (SELECT
                               PROD_PROFILE.SHORT_DESC
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS SHORT_DESC,
                          (SELECT
                               PROD_PROFILE.LONG_DESC
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS LONG_DESC,
                          (SELECT
                                PROD_PROFILE.TOG_C
                            FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS TOG_C,
                          (SELECT
                              PROD_PROFILE.TEMPERATURE_ZONE
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS TEMPERATURE_ZONE,
                          (SELECT
                                PROD_PROFILE.ALTERNATE_ID
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS ALTERNATE_ID,
                          ISSN.WH_ID,
                          SUM(ISSN.CURRENT_QTY) AS QTY,
                          (SELECT
                               PROD_PROFILE.ISSUE_UOM
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS UOM,
                          ISSN.ISSN_STATUS,
                          ISSN.COMPANY_ID,
                          (SELECT
                               SSN.BRAND
                           FROM SSN
                           WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS BRAND,
                          (SELECT
                               SSN.GENERIC
                           FROM SSN
                           WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS GENERIC,
                           (SELECT
                               SSN.SSN_SUB_TYPE
                           FROM SSN
                           WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS SSN_SUB_TYPE,
                          (SELECT
                               GRN
                           FROM SSN
                           WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN) AS GRN,
                          (SELECT
                               SHIP_CONTAINER_TYPE
                           FROM GRN
                           WHERE GRN.GRN = (SELECT
                                                GRN
                                            FROM SSN
                                            WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN)) AS SHIP_CONTAINER_TYPE,
                          (SELECT
                               GRN.RETURN_ID
                           FROM GRN
                           WHERE GRN.GRN = (SELECT
                                                GRN
                                            FROM SSN
                                            WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN)) AS RETURN_ID,
                          ISSN.ORIGINAL_SSN,
                          (SELECT
                                STOCK
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS STOCK
                      FROM ISSN
                      WHERE ISSN.PROD_ID IS NOT NULL AND ISSN.PROD_ID <> '0' AND ISSN.PROD_ID <> ''
                      GROUP BY
                          ISSN.PROD_ID,
                          PP_PROD_ID,
                          SHORT_DESC,
                          LONG_DESC,
                          TOG_C,
                          TEMPERATURE_ZONE,
                          ALTERNATE_ID,
                          ISSN.WH_ID,
                          UOM,
                          ISSN.ISSN_STATUS,
                          ISSN.COMPANY_ID,
                          BRAND,
                          GENERIC,
                          ISSN.ORIGINAL_SSN,
                          SALE_PRICE,
                          STOCK
                          )
            WHERE 1=1 AND ";

        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                $subquery .= $key;
                if (false !== strpos($key, '?')) {
                     if($key == 'STOCK') {
                       $values[] = substr($val, 0, 1);
                    } else {
                       $values[] = $val;
                    }
                }
            }
        }
        $subquery = substr($subquery, 0, strlen($subquery) - 5);

        $sql = "
            SELECT
                SUM(STOCK_STATUS.ONSITE_QTY) AS ONSITE_QTY,
                SUM(STOCK_STATUS.UNPICKED_ORDER_QTY) AS UNPICKED_ORDER_QTY,
                SUM(STOCK_STATUS.AVAILABLE_QTY) AS AVAILABLE_QTY
            FROM
                PRODUCT_CMP_WH_STOCK_STATUS_V(
                    '%',
                    '" . implode('|', $this->getCompanyListLimited()) . "',
                    '" . implode('|', array_keys($this->getWarehouseListLimited())) . "',
                    '" . $this->userId . "',
                    'ONSITE_QTY|UNPICKED_ORDER_QTY|AVAILABLE_QTY'
                ) AS STOCK_STATUS
            WHERE
                PROD_ID IN (" . $subquery . ")
        ";

        array_unshift($values, $sql);

        Zend_Registry::get('logger')->debug(array('file' => __FILE__, 'line' => __LINE__, $values));

        if (false !== ($response = call_user_func_array(array($this, "fetchAssoc"), $values))) {
            $result->totalQty = $response['AVAILABLE_QTY'] - $response['UNPICKED_ORDER_QTY'];
            $result->onHandQty = $response['ONSITE_QTY'];
        }

        return $result;
    }

    /**
     * Retrieves result of grouping Product
     *
     * @param array $clause
     * @return array
     */
    public function getProductLine1s($clause = null)
    {
        $productLines = array();

        //-- removed. Look at ticket #194
        //              RETURN_ID,
        //--
        $sql = 'SELECT
                    PROD_ID,
                    PP_PROD_ID,
                    SHORT_DESC AS DESCRIPTION,
                    WH_ID,
                    SUM(QTY) AS QTY,
                    UOM,
                    ISSN_STATUS,
                    COMPANY_ID,
                    ALTERNATE_ID,
                    SALE_PRICE,
                    STOCK
                 FROM (SELECT
                          ISSN.PROD_ID,
                          (SELECT
                               PROD_PROFILE.PROD_ID
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS PP_PROD_ID,
                          (SELECT
                               PROD_PROFILE.PROD_TYPE
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS PROD_TYPE,
                           (SELECT
                               PROD_PROFILE.SSN_TYPE
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS SSN_TYPE,
                           (SELECT
                               PROD_PROFILE.SALE_PRICE
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS SALE_PRICE,
                          (SELECT
                               PROD_PROFILE.SHORT_DESC
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS SHORT_DESC,
                          (SELECT
                               PROD_PROFILE.LONG_DESC
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS LONG_DESC,
                          (SELECT
                                PROD_PROFILE.TOG_C
                            FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS TOG_C,
                          (SELECT
                              PROD_PROFILE.TEMPERATURE_ZONE
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS TEMPERATURE_ZONE,
                          (SELECT
                                PROD_PROFILE.ALTERNATE_ID
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS ALTERNATE_ID,
                          ISSN.WH_ID,
                          SUM(ISSN.CURRENT_QTY) AS QTY,
                          (SELECT
                               PROD_PROFILE.ISSUE_UOM
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS UOM,
                          ISSN.ISSN_STATUS,
                          ISSN.COMPANY_ID,
                          (SELECT
                               SSN.BRAND
                           FROM SSN
                           WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS BRAND,
                          (SELECT
                               SSN.GENERIC
                           FROM SSN
                           WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS GENERIC,
                           (SELECT
                               SSN.SSN_SUB_TYPE
                           FROM SSN
                           WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS SSN_SUB_TYPE,
                          (SELECT
                               GRN
                           FROM SSN
                           WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN) AS GRN,
                          (SELECT
                               SHIP_CONTAINER_TYPE
                           FROM GRN
                           WHERE GRN.GRN = (SELECT
                                                GRN
                                            FROM SSN
                                            WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN)) AS SHIP_CONTAINER_TYPE,
                          (SELECT
                               GRN.RETURN_ID
                           FROM GRN
                           WHERE GRN.GRN = (SELECT
                                                GRN
                                            FROM SSN
                                            WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN)) AS RETURN_ID,
                          ISSN.ORIGINAL_SSN,
                          (SELECT
                                STOCK
                           FROM PROD_PROFILE
                           WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS STOCK
                      FROM ISSN
                      WHERE ISSN.PROD_ID IS NOT NULL AND ISSN.PROD_ID <> \'0\' AND ISSN.PROD_ID <> \'\'
                      GROUP BY
                          ISSN.PROD_ID,
                          PP_PROD_ID,
                          SHORT_DESC,
                          LONG_DESC,
                          TOG_C,
                          TEMPERATURE_ZONE,
                          ALTERNATE_ID,
                          ISSN.WH_ID,
                          UOM,
                          ISSN.ISSN_STATUS,
                          ISSN.COMPANY_ID,
                          BRAND,
                          GENERIC,
                          ISSN.ORIGINAL_SSN,
                          SALE_PRICE,
                          STOCK
                          )';
     
        $sql .= $this->getWarehouseAndCompanyLimit();
        
        if ($this->defaultControlValues['CONFIRM_WITH_NO_PROD'] != 'T')
            $sql .= 'QTY <> 0 AND ';
        
        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                $sql .= $key;
                if (false !== strpos($key, '?')) {
                     if($key == 'STOCK') {
                       $values[] = substr($val, 0, 1);
                    } else {
                       $values[] = $val;
                    }
                }
            }
        }
        $sql = substr($sql, 0, strlen($sql) - 5);
       
        $sql .= ' GROUP BY
                    PROD_ID,
                    DESCRIPTION,
                    WH_ID,
                    UOM,
                    ISSN_STATUS,
                    COMPANY_ID,
                    PP_PROD_ID,
                    ALTERNATE_ID,
                    SALE_PRICE,
                    STOCK';
        //-- removed. Look ticket #194
        //            RETURN_ID,

        $sql .= ' ORDER BY PROD_ID, ISSN_STATUS';
     
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info($sql);
    
        $data = $this->findAllAssocMod($sql, $values);
        
        if (count($data) > 0) {
            foreach ($data as $line) {
                $temp = new ProductLine1($line);
                $temp->id = md5(serialize($line));
                $productLines[] = $temp;
            }
            return $productLines;
        }
        return $productLines;
    }

    /**
     * Retrieves result of grouping Product
     *
     * @param array $clause
     * @return array
     */
    public function getProductLine2s($clause = null)
    {
        $productLines = array();

        $sql = 'SELECT
                    CREATE_DATE,
                    SUM(QTY) AS QTY,
                    PROD_ID,
                    DESCRIPTION,
                    WH_ID,
                    ISSN_STATUS,
                    COMPANY_ID,
                    RETURN_ID,
                    STOCK
                FROM (SELECT
                        (SELECT
                            SSN.CREATE_DATE
                         FROM SSN
                         WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS CREATE_DATE,
                         SUM(ISSN.CURRENT_QTY) AS QTY,
                         ISSN.PROD_ID,
                         (SELECT
                            PROD_PROFILE.PROD_TYPE
                         FROM PROD_PROFILE
                         WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS PROD_TYPE,
                        (SELECT
                            SSN.SSN_DESCRIPTION
                         FROM SSN
                         WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS DESCRIPTION,
                        (SELECT
                             PROD_PROFILE.SHORT_DESC
                         FROM PROD_PROFILE
                         WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS SHORT_DESC,
                        (SELECT
                             PROD_PROFILE.LONG_DESC
                         FROM PROD_PROFILE
                         WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS LONG_DESC,
                        (SELECT
                            PROD_PROFILE.TOG_C
                            FROM PROD_PROFILE
                            WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS TOG_C,
                        (SELECT
                            PROD_PROFILE.TEMPERATURE_ZONE
                         FROM PROD_PROFILE
                         WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS TEMPERATURE_ZONE,
                        (SELECT
                            PROD_PROFILE.ALTERNATE_ID
                         FROM PROD_PROFILE
                         WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS ALTERNATE_ID,
                         ISSN.WH_ID,
                         ISSN.ISSN_STATUS,
                         ISSN.COMPANY_ID,
                        (SELECT
                            SSN.BRAND
                         FROM SSN
                         WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS BRAND,
                        (SELECT
                            SSN.GENERIC
                         FROM SSN
                         WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS GENERIC,
                         (SELECT
                            SSN.SSN_TYPE
                         FROM SSN
                         WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS SSN_TYPE,
                         (SELECT
                            SSN.SSN_SUB_TYPE
                         FROM SSN
                         WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS SSN_SUB_TYPE,
                        (SELECT
                             GRN
                         FROM SSN
                         WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN) AS GRN,
                        (SELECT
                             SHIP_CONTAINER_TYPE
                         FROM GRN
                         WHERE GRN.GRN = (SELECT
                                              GRN
                                          FROM SSN
                                          WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN)) AS SHIP_CONTAINER_TYPE,
                        (SELECT
                            GRN.RETURN_ID
                         FROM GRN
                         WHERE GRN.GRN = (SELECT
                                            GRN
                                        FROM SSN
                                        WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN)) AS RETURN_ID,
                         ISSN.ORIGINAL_SSN,
                        (SELECT
                            STOCK
                         FROM PROD_PROFILE
                         WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS STOCK

                    FROM ISSN
                    WHERE ISSN.PROD_ID IS NOT NULL AND ISSN.PROD_ID <> \'0\' AND ISSN.PROD_ID <> \'\'
                    GROUP BY
                        CREATE_DATE,
                        ISSN.PROD_ID,
                        DESCRIPTION,
                        SHORT_DESC,
                        LONG_DESC,
                        TOG_C,
                        TEMPERATURE_ZONE,
                        ALTERNATE_ID,
                        ISSN.WH_ID,
                        ISSN.ISSN_STATUS,
                        ISSN.COMPANY_ID,
                        BRAND,
                        GENERIC,
                        ISSN.ORIGINAL_SSN,
                        STOCK
                        )';

        $sql .= $this->getWarehouseAndCompanyLimit();
        
        if ($this->defaultControlValues['CONFIRM_WITH_NO_PROD'] != 'T')
            $sql .= 'QTY <> 0 AND ';
        
        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                $sql .= $key;
                if (false !== strpos($key, '?')) {
                     if($key == 'STOCK') {
                       $values[] = substr($val, 0, 1);
                    } else {
                       $values[] = $val;
                    }
                }
            }
        }
        $sql = substr($sql, 0, strlen($sql) - 5);

        $sql .= ' GROUP BY
                     CREATE_DATE,
                     PROD_ID,
                     DESCRIPTION,
                     WH_ID,
                     ISSN_STATUS,
                     COMPANY_ID,
                     RETURN_ID,
                     STOCK';
        $sql .= ' ORDER BY CREATE_DATE';
        //$this->lastError = $sql;
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info($sql);

        $data = $this->findAllAssocMod($sql, $values);

        if (count($data) > 0) {
            foreach ($data as $line) {
                $temp = new ProductLine2($line);
                $temp->id = md5(serialize($line));
                $productLines[] = $temp;
            }
            return $productLines;
        }
        return $productLines;
    }

    /**
     * Retrieves result of grouping Product
     *
     * @param array $clause
     * @return array
     */
    public function getProductLine3s($clause = null)
    {
        $productLines = array();
        $sql = 'SELECT
                    CREATE_DATE,
                    RETURN_ID,
                    QTY,
                    ISSN_STATUS,
                    PROD_ID,
                    DESCRIPTION,
                    WH_ID,
                    SSN_ID,
                    COMPANY_ID,
                    STOCK
                FROM
                (SELECT
                    (SELECT
                        SSN.CREATE_DATE
                     FROM SSN
                     WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS CREATE_DATE,
                     (SELECT
                        PROD_PROFILE.PROD_TYPE
                     FROM PROD_PROFILE
                     WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS PROD_TYPE,
                    (SELECT
                        GRN.RETURN_ID
                     FROM GRN
                     WHERE GRN.GRN = (SELECT
                                        GRN
                                        FROM SSN
                                        WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN)) AS RETURN_ID,
                    (SELECT
                         PROD_PROFILE.SHORT_DESC
                     FROM PROD_PROFILE
                     WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS SHORT_DESC,
                    (SELECT
                         PROD_PROFILE.LONG_DESC
                     FROM PROD_PROFILE
                     WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS LONG_DESC,
                    (SELECT
                         PROD_PROFILE.TOG_C
                     FROM PROD_PROFILE
                     WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS TOG_C,
                    (SELECT
                         PROD_PROFILE.TEMPERATURE_ZONE
                     FROM PROD_PROFILE
                     WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS TEMPERATURE_ZONE,
                    (SELECT
                         PROD_PROFILE.ALTERNATE_ID
                     FROM PROD_PROFILE
                     WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS ALTERNATE_ID,
                     ISSN.CURRENT_QTY as QTY,
                     ISSN.ISSN_STATUS,
                     ISSN.PROD_ID,
                    (SELECT
                        SSN.BRAND
                     FROM SSN
                     WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS BRAND,
                    (SELECT
                        SSN.GENERIC
                     FROM SSN
                     WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS GENERIC,
                     (SELECT
                        SSN.SSN_TYPE
                     FROM SSN
                     WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS SSN_TYPE,
                     (SELECT
                        SSN.SSN_SUB_TYPE
                     FROM SSN
                     WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS SSN_SUB_TYPE,
                    (SELECT
                         GRN
                     FROM SSN
                     WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN) AS GRN,
                    (SELECT
                         SHIP_CONTAINER_TYPE
                     FROM GRN
                     WHERE GRN.GRN = (SELECT
                                          GRN
                                      FROM SSN
                                      WHERE SSN.SSN_ID = ISSN.ORIGINAL_SSN)) AS SHIP_CONTAINER_TYPE,
                    (SELECT
                        SSN.SSN_DESCRIPTION
                     FROM SSN
                     WHERE ISSN.ORIGINAL_SSN = SSN.SSN_ID) AS DESCRIPTION,
                     ISSN.WH_ID,
                     ISSN.SSN_ID,
                     ISSN.COMPANY_ID,
                    (SELECT
                        STOCK
                     FROM PROD_PROFILE
                     WHERE PROD_PROFILE.PROD_ID = ISSN.PROD_ID) AS STOCK
                 FROM ISSN
                 WHERE ISSN.PROD_ID IS NOT NULL AND ISSN.PROD_ID <> \'0\' AND ISSN.PROD_ID <> \'\')';

        $sql .= $this->getWarehouseAndCompanyLimit();
        
        if ($this->defaultControlValues['CONFIRM_WITH_NO_PROD'] != 'T')
            $sql .= 'QTY <> 0 AND ';
        
        /*
        //-- if not limited by company
        if ($this->limitCompany != 'all') {
            $sql .= " WHERE COMPANY_ID = '" . $this->limitCompany . "' AND ";
        } else {
            //-- else assume all Companies accessible to User.
            if ($this->isAdmin || $this->isInventoryOperator) {
                $sql .= " WHERE ";
            } else {
                $companyList = $this->getCompanyList();
                if (count($companyList) > 0 ) {
                    $sql .= ' WHERE COMPANY_ID IN (';
                    foreach ($companyList as $key => $val) {
                        $sql .= "'" . $val . "', ";
                    }
                    $sql = substr($sql, 0, strlen($sql) - 2);
                    $sql .= ') AND ';
                } else {
                    $sql .= ' WHERE ';
                }
            }
        }
        $sql .= ' 1=1 AND ';



        //-- if not limited by warehouse
        if ($this->limitWarehouse != 'all') {
            $sql .= " WH_ID = '" . $this->limitWarehouse . "' AND ";
        } else {
        //-- else assume all Warehouses accessible to User.
//            if ($this->isAdmin || $this->isInventoryOperator) {
                //$sql .= " WHERE ";
//            } else {
                $warehouseList = $this->getWarehouseList();
                if (count($warehouseList) > 0 ) {
                    $sql .= " WH_ID IN (";
                    foreach ($warehouseList as $key => $val) {
                        $sql .= "'" . $key . "', ";
                    }
                    $sql = substr($sql, 0, strlen($sql) - 2);
                    $sql .= ") AND ";
                }
//            }
        }
        $sql = $sql . ' 1=1 AND ';
        */

        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                $sql .= $key;
                if (false !== strpos($key, '?')) {
                     if($key == 'STOCK') {
                       $values[] = substr($val, 0, 1);
                    } else {
                       $values[] = $val;
                    }
                }
            }
        }
        $sql = substr($sql, 0, strlen($sql) - 5);
        $sql .= ' ORDER BY CREATE_DATE, SSN_ID';

        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info($sql);

        $data = $this->findAllAssocMod($sql, $values);

        if (count($data) > 0) {
            foreach ($data as $line) {
                $temp = new ProductLine3($line);
                $temp->id = md5(serialize($line));
                $productLines[] = $temp;
            }
            return $productLines;
        }
        return $productLines;
    }

    public function getStockListFromProdProfile()
    {
        $sql = "SELECT STOCK, STOCK FROM PROD_PROFILE";

        return $this->findList($sql);
    }

    /**
     * Get Pick Import Ssn Status
     *
     * @return string
     */
    public function getPickImportSsnStatus()
    {
        $sql = "SELECT CONTROL.PICK_IMPORT_SSN_STATUS FROM CONTROL";

        return $this->findValue($sql);
    }

    /**
     * Get Stock options list from OPTIONS
     *
     * @return unknown
     */
    public function getStockList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'PROD_STOCK'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('PROD_STOCK');
    }

    /**
     * Get TOG options list from OPTIONS
     *
     * @return array
     */
    public function getTurnoverGroupList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'TOG'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('TOG');
    }

    /**
     * Get Temperature Zone list from OPTIONS
     *
     * @return array
     */
    public function getTemperatureZoneList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'LOC_TEMP'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('LOC_TEMP');
    }

    /**
     * get list of LocationLine objects
     *
     * @param array $clause
     * @return array
     */
    public function getLocationLines($clause = null, $pageNo = null, $resultsPerPage = null)
    {   
        $locationLines = array();

        $sql = "SELECT *
        
                FROM (
                SELECT
                    LOCATION.WH_ID,
                    LOCATION.LOCN_ID,
                    LOCATION.LOCN_NAME,
                    LOCATION.LOCN_TYPE,
                    LOCATION.LOCN_STAT,
                    LOCATION.MOVE_STAT,
                    LOCATION.STORE_METH,
                    LOCATION.STORE_AREA,
                    LOCATION.STORE_TYPE,
                    LOCATION.TEMPERATURE_ZONE,
                    LOCATION.LAST_AUDITED_DATE,
                    LOCATION.MOVEABLE_LOCN,
                    LOCATION.LOCN_SEQ,
                    LOCATION.REPLENISH,
                    LOCATION.PERM_LEVEL,
                    COUNT(ISSN.SSN_ID) AS COUNT_ISSN,
                    SUM(ISSN.CURRENT_QTY) AS QTY,
                    ISSN.PROD_ID,
                    ISSN.COMPANY_ID,
                    CASE WHEN PROD_PROFILE.SHORT_DESC IS NULL THEN SSN.SSN_DESCRIPTION ELSE PROD_PROFILE.SHORT_DESC END AS DESCRIPTION
                FROM LOCATION
                LEFT OUTER JOIN ISSN ON (ISSN.LOCN_ID = LOCATION.LOCN_ID AND ISSN.WH_ID = LOCATION.WH_ID)
                LEFT OUTER JOIN PROD_PROFILE ON (ISSN.PROD_ID = PROD_PROFILE.PROD_ID)
                LEFT OUTER JOIN SSN ON (ISSN.ORIGINAL_SSN = SSN.SSN_ID)
                GROUP BY
                    LOCATION.LOCN_ID,
                    LOCATION.WH_ID,
                    LOCN_NAME,
                    LOCN_TYPE,
                    LOCN_STAT,
                    MOVE_STAT,
                    STORE_METH,
                    STORE_AREA,
                    STORE_TYPE,
                    LOCATION.TEMPERATURE_ZONE,
                    LOCATION.LAST_AUDITED_DATE,
                    MOVEABLE_LOCN,
                    LOCN_SEQ,
                    REPLENISH,
                    PERM_LEVEL,
                    ISSN.PROD_ID,
                    ISSN.COMPANY_ID,
                    DESCRIPTION)";

        //-- if not limited by company
        if ($this->limitCompany != 'all') {
            $sql .= " WHERE COMPANY_ID = '" . $this->limitCompany . "' AND ";
        } else {
            //-- else assume all Companies accessible to User.
            if ($this->isAdmin || $this->isInventoryOperator) {
                $sql .= " WHERE ";
            } else {
                $companyList = $this->getCompanyListLimited();
                if (count($companyList) > 0 ) {
                    $sql .= ' WHERE COMPANY_ID IN (';
                    foreach ($companyList as $key => $val) {
                        $sql .= "'" . $val . "', ";
                    }
                    $sql = substr($sql, 0, strlen($sql) - 2);
                    $sql .= ') AND ';
                } else {
                    $sql .= ' WHERE ';
                }
            }
        }
        $sql .= ' 1=1 AND ';

        //-- if not limited by warehouse
        if ($this->limitWarehouse != 'all') {
            $sql .= " WH_ID = '" . $this->limitWarehouse . "' AND ";
        } else {
        //-- else assume all Warehouses accessible to User.
//            if ($this->isAdmin || $this->isInventoryOperator) {
                //$sql .= " WHERE ";
//            } else {
                $warehouseList = $this->getWarehouseListLimited();
                if (count($warehouseList) > 0 ) {
                    $sql .= " WH_ID IN (";
                    foreach ($warehouseList as $key => $val) {
                        $sql .= "'" . $key . "', ";
                    }
                    $sql = substr($sql, 0, strlen($sql) - 2);
                    $sql .= ") AND ";
                }
//            }
        }
        $sql = $sql . ' 1=1 AND ';


        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                if (false !== strpos($key, '?')) {
                    $values[]    = $val;
                    $sql        .= $key . " AND ";
                } elseif(!empty($key) && empty($val)){
                    $sql        .= $key . " AND ";    
                }
            }
        }
        
        $sql = substr($sql, 0, -5);
        $sql .= ' ORDER BY 1, 2';
        
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
       
        $log->info($sqlQuery . ' : ' . implode(', ', $values));
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);
        
        $result['total'] = $total;
        $result['data']  = $data; 
   
        if (count($data) > 0) {
            foreach ($data as $line) {
                $temp           = new LocationLine($line);
                $temp->id       = md5(serialize($line)); //md5(serialize($line));
                $locationLines[]= $temp;
            }
            $result['data']  = $locationLines;
        }
        if (null === $pageNo || null === $resultsPerPage) {
            $result = $locationLines;
        }
        
        return $result;
        
        
    /*    
        $this->lastError = $sql;
        try {
            $data = $this->findAllAssocMod($sql, $values);
        } catch (Exception $e) {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg();
            return false;
        }
        if (count($data) > 0) {
            foreach ($data as $line) {
                $temp = new LocationLine($line);
                $temp->id = md5(serialize($line));
                $locationLines[] = $temp;
            }
            return $locationLines;
        }
        return $locationLines;
    */
    }

    public function getEnvSession($uid, $name)
    {
        $sql = 'SELECT PARAM_NAME, PARAM_VALUE, CREATE_DATE, USER_ID FROM USER_ENV WHERE USER_ID = ? AND PARAM_NAME = ?';
        if (($result = $this->findAllAssocMod($sql, $uid, $name))) {
            return $result[0];
        } else {
            return $result;
        }
    }

    /*
     * Removes saved enviroment for selected user
     *
     * @param $uid  USER_ID
     * @param $name Name of param which being removed
     */
    public function deleteEnvSession($uid, $name = null)
    {
        $sql = 'DELETE FROM USER_ENV WHERE USER_ID = ? ';
        if ($name !== null) {
            $sql .= 'AND PARAM_NAME = ?';
        }
        if (false !== ($query = ibase_prepare($this->db, $sql))) {
            if ($name !== null) {
                $result = ibase_execute($query, $uid, $name);
            } else {
                $result = ibase_execute($query, $uid);
            }
            if (false !== $result) {
                ibase_commit();
                ibase_free_result($result);
                ibase_free_query($query);
                return true;
            } else {
                ibase_free_query($query);
            }
        }
        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        return false;
    }

    public function saveEnvSession($uid, $name, $session)
    {
        $sql = 'UPDATE USER_ENV SET PARAM_VALUE = ?, CREATE_DATE = ?, CREATED_BY = ? WHERE USER_ID = ? AND PARAM_NAME = ?';
        if (false !== ($query = ibase_prepare($this->db, $sql))) {
            $config = Zend_Registry::get('config');
            $result = ibase_execute($query, $session, date($config->date->dateformat, time()), $this->userId, $uid, $name);
            if (false !== $result) {
                ibase_commit();
                ibase_free_result($result);
                ibase_free_query($query);
                return true;
            } else {
                ibase_free_query($query);
            }
        }
        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        return false;
    }

    public function createEnvSession($uid, $name, $session)
    {
        $sql = 'INSERT INTO USER_ENV (USER_ID, PARAM_NAME, PARAM_VALUE, CREATE_DATE, CREATED_BY) VALUES (?, ?, ?, ?, ?)';
        if (false !== ($query = ibase_prepare($this->db, $sql))) {
            $config = Zend_Registry::get('config');
            $result = ibase_execute($query, $uid, $name, $session, date($config->date->dateformat, time()), $this->userId);
            if (false !== $result) {
                ibase_commit();
                ibase_free_result($result);
                ibase_free_query($query);
                return true;
            } else {
                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                ibase_free_query($query);
                return false;
            }
        }
        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        return false;
    }

    public function getLocations($clause = null, $pageNo = null, $resultsPerPage = null)
    {
        $result = array('total' => 0, 'data' => array());

        $sql = 'SELECT * FROM LOCATION WHERE ';

        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                $sql .= $key . " AND ";
                if (false !== strpos($key, '?')) {
                    $values[] = $val;
                }
            }
        }
        $sql = substr($sql, 0, -5);

        $sql .= ' ORDER BY 1, 2';
        
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);
        
        $result['total'] = $total;
        if (count($data) > 0) {
            foreach ($data as $line) {
                $temp = new Location($line);
                $temp->id = md5(serialize($line));
                $result['data'][] = $temp;
            }
        }

        if (null === $pageNo || null === $resultsPerPage) {
            $result = $result['data'];
        }
        return $result;

    }

    public function updateLocationSelectively(array $values4Update, $clause)
    {
        $temp = array();
        if (count($values4Update) > 0) {
            $temp[] = $this->userId;
            $sql = "UPDATE LOCATION SET
                                LAST_UPDATE_DATE = 'NOW',
                                LAST_UPDATE_BY = ?, ";
            foreach ($values4Update as $key => $val) {
                $sql .= $key . ", ";
                $temp[] = $val;
            }
            $sql  = substr($sql, 0, -2);
            $sql .= " WHERE LOCN_ID = ? AND WH_ID = ? ";
            if (false !== ($query = ibase_prepare($this->db, $sql))) {
                $params = array($query);
                $params = array_merge($params, $temp);
                $params[] = $clause['LOCN_ID'];
                $params[] = $clause['WH_ID'];
                $result   = call_user_func_array("ibase_execute", $params);
                if (false !== $result) {
                    $this->lastError = 'Successfully updated';
                    ibase_free_query($query);
                    return $result;
                } else {
                    $this->lastError = 'Wrong execution ' . ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                    ibase_free_query($query);
                    return false;
                }
            } else {
                $this->lastError = 'Something happened ' . ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                return false;
            }
        }
        $this->lastError = "Nothing to update";
        return false;
    }

    public function updateLocation($location)
    {
        $sql = "UPDATE LOCATION SET
                        WH_ID = ?,
                        LOCN_ID = ?,
                        LOCN_NAME = ?,
                        LOCN_TYPE = ?,
                        LOCN_METRIC = ?,
                        LOCN_HGHT = ?,
                        PARENT_LOCN_ID = ?,
                        ZONE_C = ?,
                        CC_C = ?,
                        TOG_C = ?,
                        LOCN_STAT = ?,
                        MOVE_STAT = ?,
                        REPLENISH = ?,
                        PACK_T = ?,
                        STORE_TYPE = ?,
                        STORE_AREA = ?,
                        STORE_METH = ?,
                        PERM_LEVEL = ?,
                        LABEL_DATE = ?,
                        LAST_AUDITED_DATE = ?,
                        PROD_ID = ?,
                        INSTANCE_ID = ?,
                        MAX_QTY = ?,
                        MIN_QTY = ?,
                        REORDER_QTY = ?,
                        AISLE_SEQ = ?,
                        BAY_SEQ = ?,
                        SHELF_SEQ = ?,
                        COMPARTMENT_SEQ = ?,
                            LAST_UPDATE_DATE = 'NOW',
                            LAST_UPDATE_BY = ?,
                        PUTAWAY_QTY = ?,
                        LOCN_OWNER = ?,
                        CURRENT_WH_ID = ?,
                        MOVEABLE_LOCN = ?,
                        SSN_TRACK = ?,
                        LOCN_SEQ = ?,
                        TEMPERATURE_ZONE = ?
                            WHERE LOCN_ID = ? AND WH_ID = ? ";
        if (false !== ($query = ibase_prepare($this->db, $sql))) {
            $result = ibase_execute($query,
                                    $location->items['WH_ID'],
                                    $location->items['LOCN_ID'],
                                    $location->items['LOCN_NAME'],
                                    $location->items['LOCN_TYPE'],
                                    $location->items['LOCN_METRIC'],
                                    $location->items['LOCN_HGHT'],
                                    $location->items['PARENT_LOCN_ID'],
                                    $location->items['ZONE_C'],
                                    $location->items['CC_C'],
                                    $location->items['TOG_C'],
                                    $location->items['LOCN_STAT'],
                                    $location->items['MOVE_STAT'],
                                    $location->items['REPLENISH'],
                                    $location->items['PACK_T'],
                                    $location->items['STORE_TYPE'],
                                    $location->items['STORE_AREA'],
                                    $location->items['STORE_METH'],
                                    $location->items['PERM_LEVEL'],
                                    $location->items['LABEL_DATE'],
                                    $location->items['LAST_AUDITED_DATE'],
                                    $location->items['PROD_ID'],
                                    $location->items['INSTANCE_ID'],
                                    $location->items['MAX_QTY'],
                                    $location->items['MIN_QTY'],
                                    $location->items['REORDER_QTY'],
                                    $location->items['AISLE_SEQ'],
                                    $location->items['BAY_SEQ'],
                                    $location->items['SHELF_SEQ'],
                                    $location->items['COMPARTMENT_SEQ'],
                                    $this->userId,
                                    $location->items['PUTAWAY_QTY'],
                                    $location->items['LOCN_OWNER'],
                                    $location->items['CURRENT_WH_ID'],
                                    $location->items['MOVEABLE_LOCN'],
                                    $location->items['SSN_TRACK'],
                                    $location->items['LOCN_SEQ'],
                                    $location->items['TEMPERATURE_ZONE'],
                                    $location->items['LOCN_ID'],
                                    $location->items['WH_ID']
                                    );
            if (false !== $result) {
                ibase_free_query($query);
                return $result;
            } else {
                $this->lastError = 'Wrong execution' . ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                ibase_free_query($query);
                return false;
            }
        }
        $this->lastError = 'Something happened' . ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        return false;
    }

    public function deleteLocation($location)
    {
        $sql = 'DELETE FROM LOCATION WHERE WH_ID = ? AND LOCN_ID = ?';
        $query = ibase_prepare($this->db, $sql);
        if (false !== $query) {
            $result = ibase_execute($query, $location->items['WH_ID'], $location->items['LOCN_ID']);
            if ($result !== false) {
                ibase_free_query($query);
                return $result;
            }
            else {
                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                ibase_free_query($query);
                return false;
            }
        }
        else {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
            return false;
        }
    }

    public function createLocation(&$location)
    {
        if (null != $this->getLocations(array('LOCN_ID = ?' => $location->items['LOCN_ID'],
                                              'WH_ID = ?' => $location->items['WH_ID']) )) {
            $this->lastError = 'Location already exists';
            return false;
        }

        $sql = "INSERT INTO LOCATION (
                        WH_ID,
                        LOCN_ID,
                        LOCN_NAME,
                        LOCN_TYPE,
                        LOCN_METRIC,
                        LOCN_HGHT,
                        PARENT_LOCN_ID,
                        ZONE_C,
                        CC_C,
                        TOG_C,
                        LOCN_STAT,
                        MOVE_STAT,
                        REPLENISH,
                        PACK_T,
                        STORE_TYPE,
                        STORE_AREA,
                        STORE_METH,
                        PERM_LEVEL,
                        LABEL_DATE,
                        LAST_AUDITED_DATE,
                        PROD_ID,
                        INSTANCE_ID,
                        MAX_QTY,
                        MIN_QTY,
                        REORDER_QTY,
                        AISLE_SEQ,
                        BAY_SEQ,
                        SHELF_SEQ,
                        COMPARTMENT_SEQ,
                            LAST_UPDATE_DATE,
                            LAST_UPDATE_BY,
                        PUTAWAY_QTY,
                        LOCN_OWNER,
                        CURRENT_WH_ID,
                        MOVEABLE_LOCN,
                        SSN_TRACK,
                        LOCN_SEQ,
                        TEMPERATURE_ZONE)
                    VALUES (?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?, 'NOW',
                            ?, ?, ?,
                            ?, ?, ?,
                            ?, ?)";
        if (false !== ($query = ibase_prepare($this->db, $sql))) {
            $result = ibase_execute($query,
                                    $location->items['WH_ID'],
                                    $location->items['LOCN_ID'],
                                    $location->items['LOCN_NAME'],
                                    $location->items['LOCN_TYPE'],
                                    $location->items['LOCN_METRIC'],
                                    $location->items['LOCN_HGHT'],
                                    $location->items['PARENT_LOCN_ID'],
                                    $location->items['ZONE_C'],
                                    $location->items['CC_C'],
                                    $location->items['TOG_C'],
                                    $location->items['LOCN_STAT'],
                                    $location->items['MOVE_STAT'],
                                    $location->items['REPLENISH'],
                                    $location->items['PACK_T'],
                                    $location->items['STORE_TYPE'],
                                    $location->items['STORE_AREA'],
                                    $location->items['STORE_METH'],
                                    $location->items['PERM_LEVEL'],
                                    $location->items['LABEL_DATE'],
                                    $location->items['LAST_AUDITED_DATE'],
                                    $location->items['PROD_ID'],
                                    $location->items['INSTANCE_ID'],
                                    $location->items['MAX_QTY'],
                                    $location->items['MIN_QTY'],
                                    $location->items['REORDER_QTY'],
                                    $location->items['AISLE_SEQ'],
                                    $location->items['BAY_SEQ'],
                                    $location->items['SHELF_SEQ'],
                                    $location->items['COMPARTMENT_SEQ'],
                                    $this->userId,
                                    $location->items['PUTAWAY_QTY'],
                                    $location->items['LOCN_OWNER'],
                                    $location->items['CURRENT_WH_ID'],
                                    $location->items['MOVEABLE_LOCN'],
                                    $location->items['SSN_TRACK'],
                                    $location->items['LOCN_SEQ'],
                                    $location->items['TEMPERATURE_ZONE']
                                    );
            if (false !== $result) {
                ibase_free_result($result);
                ibase_free_query($query);
                return true;
            } else {
                $this->lastError = 'Wrong execution' . ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                ibase_free_query($query);
                return false;
            }
        }
        $this->lastError = 'Something happened' . ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        return false;
    }
    
    /**
    * @desc add location list or update if exists
    * 
    * @param array $locationList - list of generated locations
    * @return boolean  
    */
    public function insertLocationList($locationList) {
        
        $updateSql    = 'UPDATE LOCATION SET %s 
                         WHERE WH_ID = ? AND LOCN_ID = ? ';
        
        $insertSql    = 'INSERT INTO LOCATION(%s) VALUES(%s)';
        
        $chekSql      = 'SELECT COUNT(*) 
                         FROM LOCATION
                         WHERE WH_ID = ? AND LOCN_ID = ?';
        
        $isUpdate     = false;
        $isInsert     = false; 
        
        foreach($locationList as $location) {
            
            $updateArgs   = array();
            $updateFields = '';
            
            $insertArgs   = array();
            $insertFields = '';
            $insertValues = '';
            
            foreach($location->items as $key => $value) {
                if($key != 'WH_ID' && $key != 'LOCN_ID') {
                    $updateArgs[]   = $value;
                    $updateFields  .= $key . ' = ?, ';
                }
                
                 $insertArgs[]   = $value;
                 $insertFields  .= $key . ', ';
                 $insertValues  .= '?, ';
            }
                    $whId   = $updateArgs[] = $location->items['WH_ID']; 
                    $locnId = $updateArgs[] = $location->items['LOCN_ID']; 
            
            
            $updateSql = sprintf($updateSql, substr($updateFields, 0, -2));
            $insertSql = sprintf($insertSql, substr($insertFields, 0, -2), substr($insertValues, 0, -2));
            
            
            $result    = $this->findOneAssoc($chekSql, $whId, $locnId);
            
            if($result['COUNT'] == 0) {
                 $result    = $this->execSQL($insertSql, $insertArgs);
                 $isInsert  = true;
            } else {
                 $result   = $this->execSQL($updateSql, $updateArgs);
                 $isUpdate = true;
            }
            
            if(!$result) {
                $result = '';
                $result['result'] = false;
                return $result;
            }
        }
            $result = '';
            if($isInsert) {
                $result['result'] = true;
                $result['insert'] = true;
            } else {
                $result['result'] = true;
                $result['update'] = true;
            }
            
            return $result;
                
    }
    

    public function getMoveStatusList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'LOC_MOVE'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('LOC_MOVE');
    }

    public function getLocationStatusList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'LOC_STATUS'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('LOC_STATUS');
    }

    public function getLocationTypeList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'LOC_TYPE'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('LOC_TYPE');
    }

    public function getStoreTypeList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'LOC_ST_TY'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('LOC_ST_TY');
    }

    public function getStoreAreaList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'LOC_ST_AR'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('LOC_ST_AR');
    }

    public function getStoreMethodList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'LOC_ST_ME'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('LOC_ST_ME');
    }

    public function getPackageTypeList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'PACK_TYPE'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('PACK_TYPE');
    }

    public function getPermissionLevelList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'LOC_ST_PE'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('LOC_ST_PE');
    }

    public function getLocationMetricList()
    {
        //$sql = "SELECT CODE, DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = 'LOC_METRIC'";

        //return $this->findList($sql);
        return $this->getExtOptionsList('LOC_METRIC');
    }
    public function getZoneList()
    {
        $sql = "SELECT CODE, DESCRIPTION FROM ZONE";

        return $this->findList($sql);
    }

    /**
     * Retrieve image logo from Blob
     *
     * @return image
     */
    public function getLogo()
    {
        $sql       = "SELECT COMPANY_LOGO FROM CONTROL";
        if (false !== ($result = ibase_query($sql))) {
            $data      = ibase_fetch_object($result);
            $blob_data = ibase_blob_info($data->COMPANY_LOGO);
            $blob_hndl = ibase_blob_open($data->COMPANY_LOGO);
            $logoData  = ibase_blob_get($blob_hndl, $blob_data[0]);
        
//            ibase_free_result($result);
            ibase_blob_close($blob_hndl);
            ibase_free_result($result);
        
            return $logoData;
        }
        else
            return array();
    }

    /**
     * get list of values for Autocomplete
     *
     * @author Sergey Boroday <sergey.boroday@binary-studio.com>
     * @param string $table
     * @param string $field
     * @param string $value
     * @param string $descriptionField
     * @return array
     */
    public function getAutocompleteList($table, $field, $value = null, $descriptionField = 'DESCRIPTION')
    {
        $result = array();

        $table = addslashes(strtoupper(trim($table)));
        $field = addslashes(strtoupper(trim($field)));
        if (false != ($listTables = $this->getTableList())) {
            if (array_key_exists($table, $listTables)) {
                if (false != ($listFields = $this->getFieldList($table))) {
                    if ($descriptionField != '') {
                        if (!array_key_exists($descriptionField, $listFields)) {
                            $descriptionField = '';
                        }
                    }
                    if (array_key_exists($field, $listFields)) {
                        $sql = 'SELECT ' . $field . ', ' . $field;
                        if ($descriptionField != '') {
                            $sql .= ', ' . $descriptionField;
                        }

                        if ('' == $value) {
                            $sql .= ' FROM ' . $table . ' ORDER BY 1';
                            return $this->findList($sql);
                        } else {
                            $sql .= ' FROM ' . $table . ' WHERE UPPER(' . $field . ') LIKE ? ORDER BY 1';
                            $res = $this->findList($sql, strtoupper($value) . '%');
                            return $res;
                        }
                    }
                }
            }
        }
        return $result;
    }

    /**
     * Get array of fieldnames which are used for unique key
     *
     * @param string $table
     * @return array|boolean
     */
    public function getUniqueConstraint($table)
    {
        $sql = 'SELECT FIRST 1 RDB$INDEX_NAME, RDB$INDEX_NAME FROM RDB$INDICES WHERE RDB$UNIQUE_FLAG = 1 AND RDB$RELATION_NAME = ?';
        try {
            $result = $this->findOne($sql, $table);
        } catch (Exception $e) {
            return false;
        }

        if (false != $result) {
            $sql = 'SELECT trim(RDB$FIELD_NAME), trim(RDB$FIELD_NAME) FROM RDB$INDEX_SEGMENTS WHERE RDB$INDEX_NAME = ?';
            return $this->findList($sql, $result[0]);
        } else {
            return false;
        }
    }

    /**
     * Add FIRST and SKIP for existing query.
     * Returns query for count total records and query with limits
     *
     * @author Sergey Boroday <sergey.boroday@binary-studio.com>
     * @param string $sql
     * @param integer $pageNo
     * @param integer $resultsPerPage
     * @return array
     *-
    private function __addLimitToQuery($sql, $pageNo = null, $resultsPerPage = null)
    {
        $first = '';
        $skip  = '';

        $limits = $this->getOptionsList('QueryLimit');
        if (null == $pageNo)  {
            if (isset($limits['PageNo'])) {
                $pageNo = $limits['PageNo'];
            }
        }
        if (null == $resultsPerPage) {
            if (isset($limits['PerPage'])) {
                $resultsPerPage = $limits['PerPage'];
            }
        }
        if (null !== $pageNo && null !== $resultsPerPage) {
            $first = ' FIRST ' . $resultsPerPage;
            $skip  = ' SKIP ' . $resultsPerPage * $pageNo;
        }
        $sqlStart = 'SELECT ' . $first . ' ' . $skip . ' * ';
        $result[] = 'SELECT COUNT(*) FROM (' . $sql . ')';
        $result[] = $sqlStart . ' FROM ( ' . $sql . ')';
        return $result;
    }
     */

    /**
     * Add FIRST and SKIP for existing query.
     * Returns query for count total records and query with limits
     *
     * @author Sergey Boroday <sergey.boroday@binary-studio.com>
     * @param string $sql
     * @param integer $pageNo
     * @param integer $resultsPerPage
     * @param Boolean $useEmbed
     * @return array
     */
    private function __addLimitToQuery($sql, $pageNo = null, $resultsPerPage = null, $useEmbed = false)
    {
        $first = '';
        $skip  = '';

        $limits = Minder_SysScreen_Legacy_OptionManager::getQueryLimits();
        if (null == $pageNo)  {
            if (isset($limits['PageNo'])) {
                $pageNo = $limits['PageNo'];
            }
        }
        if (null == $resultsPerPage) {
            if (isset($limits['PerPage'])) {
                $resultsPerPage = $limits['PerPage'];
            }
        }
        if (null !== $pageNo && null !== $resultsPerPage) {
            $first = ' FIRST ' . $resultsPerPage;
            $skip  = ' SKIP ' . $resultsPerPage * $pageNo;
        }
        $sqlStart = 'SELECT ' . $first . ' ' . $skip . ' * ';
    if ($useEmbed) {
            $result[] = 'SELECT COUNT(*) FROM (' . $sql . ')';
            $result[] = $sqlStart . ' FROM ( ' . $sql . ')';
    } else {
            $sqlCountPos1 = stripos ( $sql, ' FROM '  );
                if ($sqlCountPos1 === False) {
                    // no from
                    $sqlCount = $sql ;
                } else {
                    $sqlCount = 'SELECT COUNT(*) ' .  substr($sql, $sqlCountPos1) ;
                }
            $sqlCountPos3 = stripos ( $sqlCount, 'ORDER BY'  );
                if ($sqlCountPos3 === False) {
                    // no order by
                    $sqlCount2 = $sqlCount  ;
                } else {
                    $sqlCount2 = substr($sqlCount ,0, $sqlCountPos3) ;
                }
            $result[] = $sqlCount2 ;
            $sqlStart  = substr($sqlStart, 0, -2);
            
            if ($sqlCountPos1 === False) {
                //no from, strange query
                $result[] = str_replace( 'SELECT', $sqlStart, $sql );
            } else {
                //replace only first occurence of select
                $result[] = str_replace( 'SELECT', $sqlStart, substr($sql, 0, $sqlCountPos1)) . substr($sql, $sqlCountPos1) ;
            }
    	}

	if($this->isNewDateCalculation() == true){
            foreach($result as $intKey => $strQuery){
                $strQuery = str_ireplace("  ", " ", $strQuery); 
                if (stripos($strQuery, "_DATE >= ?") !== false) {
                    $strQuery = str_ireplace("_DATE >= ?", "_DATE >= zerotime(?)", $strQuery); 
                }
                if (stripos($strQuery, "_DATE <= ?") !== false) {
                    $strQuery = str_ireplace("_DATE <= ?", "_DATE <= maxtime(?)", $strQuery); 
                }

                $result[$intKey] = $strQuery;
            }
        }
    
        return $result;
    }

    /**
     * Create DataSet from selected table with list of Fields
     *
     * @author Sergey Boroday <sergey.boroday@binary-studio.com>
     * @param string $table        Table name
     * @param array  $listOfFields list of fields which should be retrieved
     * @param array  $clause       list of clauses for query
     * @apram array  $order        list oc order instructions
     * @return MasterTable_DataSet
     */
    public function getMasterTableDataSet($table, $listOfFields = array('*'), $clause = array(), $order = null)
    {
        try {
            $uniqueConstrait = $this->getUniqueConstraint($table);
        } catch (Exception $e) {
            $uniqueConstrait = '';
        }
        // LIMIT & SKIP
            $first = '';
            if (array_key_exists('_limit_', $clause)) {
                if (!empty($clause['_limit_'])) {
                    $first = 'FIRST ' . (int)$clause['_limit_'];
                }
                unset($clause['_limit_']);
            }
            $skip = '';
            if (array_key_exists('_offset_', $clause)) {
                if (!empty($clause['_offset_'])) {
                    $skip = 'SKIP ' . (int)$clause['_offset_'];
                    $skipNumber = (int)$clause['_offset_'];
                } else {
                    $skipNumber = 0;
                }

                unset($clause['_offset_']);
            } else {
                $skipNumber = 0;
            }

            // query count number of retrieved records.
            $sqlNumRecords = 'SELECT COUNT(*) ';
            $sql = 'SELECT ' . $first . ' ' . $skip . ' ';
            if (!is_array($listOfFields) && !is_a($listOfFields, 'Iterator')) {
                $listOfFields = array($listOfFields);
            }
            if (count($listOfFields) > 0) {
                foreach ($listOfFields as $key => $val) {
                    $sql .= strtoupper($val) . ', ';
                }
                $sql = substr($sql, 0, -2);
                $sql .= ' FROM ' . strtoupper($table) ;
                $sqlNumRecords .= ' FROM ' . strtoupper($table);

                $sql .= ' WHERE 1=1 AND ';
                $sqlNumRecords .= ' WHERE 1=1 AND ';
                $values = array();
                if ($clause !== null && is_array($clause)) {
                    foreach ($clause as $key => $val) {
                        $sql .= $key . " AND ";
                        $sqlNumRecords .= $key . " AND ";
                        if (false !== strpos($key, '?')) {
                            $values[] = strtoupper($val);
                        }
                    }
                }
                $sql = substr($sql, 0, -5);
                
                //if we dont need sorting just leave $order null or empty array
                if (!empty($order)) {
                    $sql .= ' ORDER BY  ';
                    foreach($order as $instruction){
                        $sql .= $instruction . ', '; 
                    }
                    $sql = substr($sql, 0, -2);
                }

                $sqlNumRecords = substr($sqlNumRecords, 0, -5);
                if (($query = ibase_prepare($sql)) ) {
                    // && ($queryCount = ibase_prepare($sqlNumRecords))
                    if (null != $values) {
                        $cvalues = $values;
                        array_unshift($cvalues, $sqlNumRecords);
                        array_unshift($values, $query);
                        $result = call_user_func_array('ibase_execute', $values);
                        $counted = (int)call_user_func_array(array(Minder::$minder, 'findValue'), $cvalues);
                    } else {
                        
                        $result = ibase_execute($query);
                        $counted = (int)$this->findValue($sqlNumRecords);
                    }
                    if (false !== $result) {
                        $row = ibase_fetch_assoc($result, IBASE_TEXT);
                        $fieldsList = array();
                        $data       = array();
                        //$blobList   = array();

                        $numFields = ibase_num_fields($result);
                        $temp = array();
                        
                        for ($i=0; $i < $numFields; $i++) {
                            $info = ibase_field_info($result, $i);
                            $fieldsList[$info['name']] = new MasterTable_Field($info['name'], $info['length'], $info['type'], $info['relation']);
                            if (false == ($uniqueConstrait)) {
                                $temp[$info['name']] = $info['name'];
                            }
                        }
                        
                        if (false == ($uniqueConstrait)) {
                            $uniqueConstrait = $temp;
                        }
                        
                        if (false !== $row) {
                            $data[] = $row;
                            while (false !== ($row = ibase_fetch_assoc($result, IBASE_TEXT))) {
                                foreach($row as &$value){
                                    //$value  =   trim($value);    
                                }
                                $data[] = $row;
                            }
                        } else {
                            $data = array();
                        }

			foreach($data as $intRowKey => $arrRowData){
                            foreach($arrRowData as $strKey => $strData){ 
                                if($this->isValidDate($strData)){
                                    $data[$intRowKey][$strKey] = $this->getFormatedDate($strData);
                                }
                            }
                        }
                        
                        //echo "<pre>"; die(print_r($data));
                        
                        $dataSet = new MasterTable_DataSet($data, $fieldsList, $uniqueConstrait, $counted, $skipNumber);
                        $dataSet->table = $table;
                        ibase_free_result($result);
                        ibase_free_query($query);
                    } else {
                        ibase_free_query($query);
                        $dataSet = false;
                    }
                } else {
                    $dataSet = false;
                }
            }
            return $dataSet;
    }

    /**
     * Provide INSERT/UPDATE/DELETE  for MasterTable_DataSet
     *
     * @param MasterTable_DataSet $dataSet
     * @return boolean
     */
    public function updateMasterTableDataSet(MasterTable_DataSet &$dataSet)
    {
        $result = true;
        $errorMessage = '';

        foreach ($dataSet as $row) {

            if ($row->isDeleted()) {
                if (false === ($query = $this->prepareRecordDeleteSql($dataSet->table, $row))) {
                    $result = false;
                } else {
                    if (false !== ($result = @ibase_execute($query))) {
                        if (is_resource($result)) { ibase_free_result($result); }
                        ibase_free_query($query);
                    }
                    else {
                        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '.';
                        $result = false;
                        ibase_free_query($query);
                    }
                }
            } elseif ($row->isModified() && !$row->isNew()) {
                if (($query = $this->prepareRecordUpdateSql($dataSet->table, $row))) {
                    if (false !== ($res = call_user_func_array("ibase_execute",  $query))) {
                        $row->unModified();
                        if (is_resource($res)) { ibase_free_result($res); }
                        $queryRes = array_shift($query);
                        ibase_free_query($queryRes);
                        $result = $result && true;
                    } else {
                        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '.';
                        $result = false;
                        $queryRes = array_shift($query);
                        ibase_free_query($queryRes);
                    }
                }
            } elseif ($row->isNew()) {
                if (($query = $this->prepareRecordInsertSql($dataSet->table, $row))) {
                    if (false !== ($res = call_user_func_array("ibase_execute",  $query))) {
                        $row->unModified();
                        if (is_resource($res)) { ibase_free_result($res); }
                        $queryRes = array_shift($query);
                        ibase_free_query($queryRes);
                        $result = $result && true;
                    } else {
                        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '.';
                        $result = false;
                        $queryRes = array_shift($query);
                        ibase_free_query($queryRes);
                    }
                }
            }
        }
        
        if (!$result) {
            $this->lastError .= ' Query text: ' . $this->_lastQuery;
        } else {
            $this->lastError = 'Successfully';
        }
        return $result;
    }

    /**
     * Prepare SQL string and array of params for update record (based upon information from $record)
     * in table specified by $table.
     *
     * @param string             $table
     * @param MasterTable_Record $record
     * @return array
     */
    public function prepareRecordUpdateSql($table, MasterTable_Record &$record)
    {
        $result = array();
        $values = array();
        $sql = 'UPDATE ' . strtoupper($table) . ' SET ';
        foreach ($record as $field => $val) {
            $val  =   trim($val);
            
            if($record->getFieldInfo($field)->type == 'INTEGER'){
                $sql .= $field . ' = ?, '; 
            } else {
                if(!is_numeric($val) && empty($val)) {
                    $sql .= $field . ' = NULL, ';
                     continue;     
                } else {
                    $sql .= $field . ' = ?, ';    
                }
            }
           
            if ($record->getFieldInfo($field)->type == 'TIMESTAMP') {
                $config = Zend_Registry::get('config');
                $val = date($config->date->dateformat, strtotime($val));
            }
            
            $values[] = $val;    
        }
        
        $sql = substr($sql, 0, -2);
        $sql .= ' WHERE ' . $record->getIdAsSql();
        
        $this->_lastQuery = $sql . '. Values: (' . implode(', ', $values) . ').';
       
        if (false !== ($query = ibase_prepare($sql))) {
            $result = array_merge(array($query), $values);
        } else {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '.';
            $result = false;
        }
        return $result;
    }

    /**
     * Prepare SQL string and array of params for update record (based upon information from $record)
     * in table specified by $table.
     *
     * @param string             $table
     * @param MasterTable_Record $record
     * @return array
     */
    public function prepareRecordInsertSql($table, MasterTable_Record &$record)
    {
        $result  = array();
        $values  = array();
        $sql     = 'INSERT INTO ' . strtoupper($table);

        $fields       = ' (';
        $placeholders = ' (';
        foreach ($record as $field => $val) {
            if($val != ''){
                $fields .= $field . ', ';
                $placeholders .= '?, ';
                $values[] = $val;    
            }
        }
        $sql .= substr($fields, 0, -2) . ') VALUES ';
        $sql .= substr($placeholders, 0, -2) . ')';
        
        $this->_lastQuery = $sql . '. Values: (' . implode(', ', $values) . ').';
       
        if (false !== ($query = ibase_prepare($sql))) {
            $result = array_merge(array($query), $values);
        } else {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '.';
            $result = false;
        }
        return $result;
    }

    /**
    * Prepare SQL string and array of params for delete record (based upon information from $record)
    * in table specified by $table.
    *
    * @param string             $table
    * @param MasterTable_Record $record
    * @return resource|false
    */
    public function prepareRecordDeleteSql($table, MasterTable_Record &$record)
    {
        $sql = 'DELETE FROM ' . strtoupper($table) . ' WHERE ' . stripslashes($record->getIdAsSql());
        
        $this->_lastQuery = $sql;
       
        if (false !== ($query = @ibase_prepare($sql))) {
            return $query;
        } else {
            $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '.';
            return false;
        }
    }

    public function createSsnLine(SsnLine &$newLine)
    {



        $sql = 'SELECT DEFAULT_WH_ID FROM SYS_USER WHERE USER_ID = ?';
        if (false == ($wh_id = $this->findValue($sql, $this->userId))) {
            $sql   = 'SELECT DEFAULT_WH_ID FROM CONTROL';
            if (false == ($wh_id = $this->findOne($sql))) {
                throw new Exception("Can't read default Warehouse for new SSN");
            }
        }
        if ($wh_id == '') {
            return false;
        }
        $newLine->items['WH_ID'] = $wh_id;

        $sql = 'SELECT NEW_LABEL_LOCN_ID FROM CONTROL';
        if (false == ($locn_id = $this->findValue($sql))) {
            throw new Exception("Can't read default Location for new SSN");
            //$locn_id = '';
        }
        if ($locn_id == '') {
            return false;
        }
        $newLine->items['LOCN_ID'] = $locn_id;

        $sql = 'SELECT COMPANY_ID FROM CONTROL';
        if (false == ($company_id = $this->findValue($sql))) {
            throw new Exception("Can't read default Company for new SSN");
            //$company_id = '';
        }
        $newLine->items['COMPANY_ID'] = $company_id;

        $newLine->items['CREATED_BY'] = $this->userId;
        $newLine->items['CREATE_DATE'] = date("Y-m-d H:i:s");
        return true;
    }

    /**
     * get list of non system tables in DB
     *
     * @return array
     */
    public function getTableList()
    {
        $sql = 'SELECT TRIM(RDB$RELATION_NAME), TRIM(RDB$RELATION_NAME) FROM RDB$RELATIONS WHERE RDB$SYSTEM_FLAG<>1 ORDER BY RDB$RELATION_NAME';

        return $this->findList($sql);
    }

    /**
     * Get list of available fields for specified table
     *
     * @param string $table
     * @return array|boolean
     */
    public function getFieldList($table, $strMode = "default")
    {
        if($strMode == "default"){
            $sql = 'SELECT TRIM(RDB$FIELD_NAME), TRIM(RDB$FIELD_NAME) FROM RDB$RELATION_FIELDS WHERE RDB$RELATION_NAME = ? ORDER BY RDB$FIELD_POSITION';
            try {
                $res = $this->findList($sql, $table);
            } catch (Exception $e) {
                $this->lastError = $e->getMessage();
                $res = false;
            }
        }
        else{
            $sql = 'SELECT TRIM(R.RDB$FIELD_NAME) AS field_name,
                     CASE F.RDB$FIELD_TYPE
                     WHEN 7 THEN \'SMALLINT\'
                     WHEN 8 THEN \'INTEGER\'
                     WHEN 9 THEN \'QUAD\'
                     WHEN 10 THEN \'FLOAT\'
                     WHEN 11 THEN \'D_FLOAT\'
                     WHEN 12 THEN \'DATE\'
                     WHEN 13 THEN \'TIME\'     
                     WHEN 14 THEN \'CHAR\'
                     WHEN 16 THEN \'INT64\'
                     WHEN 27 THEN \'DOUBLE\'
                     WHEN 35 THEN \'TIMESTAMP\'
                     WHEN 37 THEN \'VARCHAR\'
                     WHEN 40 THEN \'CSTRING\'
                     WHEN 261 THEN \'BLOB\'
                     ELSE \'UNKNOWN\'
                    END AS field_type,
                    F.RDB$FIELD_LENGTH AS field_length,
                    CSET.RDB$CHARACTER_SET_NAME AS field_charset
                    FROM RDB$RELATION_FIELDS R
                    LEFT JOIN RDB$FIELDS F ON R.RDB$FIELD_SOURCE = F.RDB$FIELD_NAME
                    LEFT JOIN RDB$CHARACTER_SETS CSET ON F.RDB$CHARACTER_SET_ID = CSET.RDB$CHARACTER_SET_ID
                    WHERE R.RDB$RELATION_NAME = ?
                    ORDER BY R.RDB$FIELD_POSITION';
            try {
                $arrTableData = $this->fetchAllAssoc($sql, $table);
                foreach($arrTableData as $arrData){
                    $res[$arrData["FIELD_NAME"]] = $arrData["FIELD_TYPE"];
                }

            } catch (Exception $e) {
                $this->lastError = $e->getMessage();
                $res = false;
            }
        } 

        return $res;
    }

    public function getTableDataList($table, $fieldlist = array(), $clause, $pageNo = null, $resultsPerPage = null)
    {
        $result = array('total' => 0, 'data' => array());

        if (($tables = $this->getTableList()) && in_array($table, (array) $tables)) {
            $from = ' FROM ' . $table;
        } else {
            $result = false;
        }
        if ($result && (array() == $fieldlist || is_int($fieldlist))) {
            $tfieldlist = $this->getFieldList($table);
            if (is_int($fieldlist)) {
                $fieldlist = array_slice($tfieldlist, 0, $fieldlist);
            } else {
                $fieldlist = $tfieldlist;
            }
        }
        if ($result && $fieldlist) {
            $sql = 'SELECT ';
            foreach ($fieldlist as $field) {
                $sql .= $field . ', ';
            }
            $sql = substr($sql, 0, -2) . $from;

            $sql .= ' WHERE 1=1 AND ';
            $values = array();
            if ($clause !== null && is_array($clause)) {
                foreach ($clause as $key => $val) {
                    $sql .= $key;
                    if (false !== strpos($key, '?')) {
                        $values[] = $val;
                    }
                }
            }
            $sql = substr($sql, 0, -5);

            if (false === ($values = $this->prepareArgs($sql, $values))) {
                throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
            }
            list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
            $log = Zend_Registry::get('logger');
            $log->info($sqlCount . ' : ' . implode(', ', $values));

            $total  = $this->findValue($sqlCount, $values);
            if ($pageNo * $resultsPerPage > $total) {
                $pageNo = 0;
            }
            list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
            $log->info($total);

            $log->info($sqlQuery . ' : ' . implode(', ', $values));
            $data   = $this->findAllAssocMod($sqlQuery, $values);
            $result['total'] = $total;
            $result['data']  = $data;
        }
        return $result;
    }

    /**
     * Update PurchaseOrderLines
     *
     * @param array $lines
     * @return boolean
    */
    public function updatePurchaseOrderLines($lines)
    {
        if (!is_array($lines)) {
            $lines = array($lines);
        }

        $result = false;
        $log = Zend_Registry::get('logger');

        foreach ($lines as $key => $obj) {
            $log->info('trying to check order line ' . $obj['PURCHASE_ORDER'] . ':' . $obj['PO_LEGACY_LINE']);
            if(false !== $this->getPurchaseOrderLineByLegacyId($obj->items['PURCHASE_ORDER'], $obj->items['PO_LEGACY_LINE'])) {
                $log->info('found ' . $obj['PURCHASE_ORDER'] . ':' . $obj['PO_LEGACY_LINE']);

                $sql = 'UPDATE PURCHASE_ORDER_LINE SET PO_REVISION_STATUS = ?, ';
                $where = ' WHERE PURCHASE_ORDER = ? AND PO_LEGACY_LINE = ?';
                $values = '';
                $params = array();
                $params[] = 'LR';
                foreach ($obj->items as $key => $val) {
                    if ($key !== 'tranId' && $key !=='PURCHASE_ORDER' && $key !== 'PO_LINE') {
                        if (strtoupper($key) == 'PERSON_ID') {
                            $params[] = substr($val, 0, 10);
                            $values .= $key. ' = ?, ';
                        } else {
                            $params[] = $val;
                            $values .= $key. ' = ?, ';
                        }
                    }
                }
                $params[] = $obj->items['PURCHASE_ORDER'];
                $params[] = $obj->items['PO_LEGACY_LINE'];

                $values = substr($values, 0, -2);
                $sql .=  $values;
                $sql .=  $where;
                $result = $this->execSQL($sql, $params);

                $this->lastError = 'Purchase Order Line already updated.';

            } else {
                $log->info('not found ' . $obj['PURCHASE_ORDER'] . ':' . $obj['PO_LEGACY_LINE']);

                $sql = 'INSERT INTO PURCHASE_ORDER_LINE (';
                $fields = '';
                $values = '';
                $params = array();
                foreach ($obj->items as $key => $val) {
                    if ($key !== 'tranId') {
                        $fields .= strtoupper($key)  . ', ';
                        if (strtoupper($key) == 'PERSON_ID') {
                          $params[] = substr($val, 0, 10);
                            $values .= ' ?, ';
                        } else {
                          $params[] = $val;
                            $values .= '?, ';
                        }
                    }
                }

                $fields = substr($fields, 0, -2);
                $values = substr($values, 0, -2);
                $sql .= $fields . ') VALUES (' . $values . ')';
                $result = $this->execSQL($sql, $params);

                $this->lastError = 'Purchase Order Line already updated.';
            }
        }

        if (false !== $result) {
            return true;
        } else {
            return false;
        }
    }

    /**
    * @desc mark field PO_LEGACY_LINE = 'CS'
    * @param id of purchase order
    * @return boolean
    */
    protected function markPurchaseOrderLines($purchaseOrder) {

        $sql = 'UPDATE PURCHASE_ORDER_LINE SET PO_REVISION_STATUS = ? ';
        $where = 'WHERE PURCHASE_ORDER = ?';
        $params = array();
        $params[] = 'CS';
        $params[] = $purchaseOrder;

        $sql .= $where;

        $result = $this->execSQL($sql, $params);

        return $result;
    }

    /**
     * delete order line
     *
     * @param string $purchaseOrder
     * @param string $lineNo
     *
     * @return boolean
     */
    public function deletePurchaseOrderLine($purchaseOrder, $lineNo)
    {
        $sql = 'DELETE FROM PURCHASE_ORDER_LINE ';
        $where = 'WHERE PURCHASE_ORDER = ?  AND PO_LINE = ? ';
        $sql .= $where;
        $params = array();
        $params[] = $purchaseOrder;
        $params[] = $lineNo;
        $result = $this->execSQL($sql, $params);

        return $result;
    }

     /**
     * delete order line
     *
     * @param string $pickOrder
     * @param string $legacyLineNo
     *
     * @return boolean
     */
    public function deletePickOrderLine($pickOrder, $legacyLineNo, $pickSsn, $pickProduct)
    {
        $sql = 'DELETE FROM PICK_ITEM ';
        $where = 'WHERE PICK_ORDER = ?  AND PI_LEGACY_LINENO = ? ';
        //$where .= " AND (POS(',UC,CF,OP,AS,HD,CN,UP,', PICK_LINE_STATUS, 0, 1) > -1) ";
        $where .= " AND (PICK_LINE_STATUS IN ( 'UC','CF','OP','AS','HD','CN','UP')) ";
        $sql .= $where;
        $params = array();
        $params[] = $pickOrder;
        $params[] = $legacyLineNo;
        if ($pickSsn != '') {
            $where .= " AND SSN_ID = ? ";
            $params[] = $pickSsn;
        }
        if ($pickProduct != '') {
            $where .= " AND PROD_ID = ? ";
            $params[] = $pickProduct;
        }
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info($sql . ' : ' . implode(',', $params));
        $result = $this->execSQL($sql, $params);

        return $result;
    }

    /**
    * @desc delete purchase order linse if PO_LEGACY_LINE == 'CS'
    * @param id of purchase order
    * @return boolean
    */
    protected function deleteCsPurchaseOrderLines($purchaseOrder) {
        $sql = 'DELETE FROM PURCHASE_ORDER_LINE ';
        $where = 'WHERE PURCHASE_ORDER = ? AND PO_REVISION_STATUS = ? ';
        $params = array();
        $params[] = $purchaseOrder;
        $params[] = 'CS';

        $sql .= $where;

        $result = $this->execSQL($sql, $params);

        return $result;
    }

    /**
     * add new PurchaseOrder
     *
     * @param PurchaseOrder $po
     * @return boolean
     */
    public function addPurchaseOrder(PurchaseOrder $po, $import = true)
    {
        $lines = $po->items['itemList'];
        unset($po->items['itemList']);
        
        try {
            $this->getPurchaseOrderById($po->id);
            try {
                $this->updatePurchaseOrder($po);
                $this->lastError = 'Purchase Order already updated.' . $po->id;
                $this->lastErrorCode = -201;
                $result = true;
            } catch (Exception $e) {
                $this->lastError = $e->getMessage();
                $result = false;
            }
        } catch (Minder_Exception $e) {
            $sql         = 'INSERT INTO PURCHASE_ORDER (';
            $params      = array();
            $fieldsArray = array();

            foreach ($po->items as $key => $val) {
                if ($key !== 'tranId') {

                    $key = strtoupper($key);

                    if($this->isValidDate($val)) {
                        $val = $this->getFormatedDateToDb($val);
                    }

                    switch ($key) {
                        case 'PERSON_ID':
                            $val = substr($val, 0, 10);
                            break;
                        case 'ORDER_TYPE':
                            if (empty($val)) continue 2;
                            $val = substr($val, 0, 2);
                            break;
                        case 'COMPANY_ID':
                            $val = substr($val, 0, 20);
                            break;
                        case 'PO_STATUS':
                            $val = substr($val, 0, 2);
                            break;
                        case 'PURCHASE_ORDER':
                            if (empty($val)) continue 2;
                            break;
                    }

                    $params[] = strval($val);
                    $fieldsArray[] = $key;
                }
            }

            $sql    .= implode(', ', $fieldsArray) . ') VALUES (' . substr(str_repeat('?, ', count($fieldsArray)), 0, -2) . ')';
            $result  = $this->execSQL($sql, $params);
        }

        if (false !== $result) {
            if ($import) {
                // mark purchase order linse with flag CS
                $this->markPurchaseOrderLines($po->id);
            }
            $this->updatePurchaseOrderLines($lines);
            // delete purchase order lines with flag CS
            $this->deleteCsPurchaseOrderLines($po->id);
        }
        if (false !== $result) {
            return true;
        } else {
            return false;
        }
    }

    /**
    * Get PurchaseOrderLine by ID
    *
    * @param string $id
    * @return PurchaseOrderLine
    */
    public function getPurchaseOrderLineById($id, $poLine) {
     
        $sql = 'SELECT * FROM PURCHASE_ORDER_LINE WHERE PURCHASE_ORDER = ? AND PO_LINE = ?';
        if (count($line = $this->findAllAssocMod($sql, array($id, $poLine))) == 0) {
            return false;
        }
        return $line;
    }

    /**
    * Get PurchaseOrderLine by LEGACY ID
    *
    * @param string $id
    * @return PurchaseOrderLine
    */
    public function getPurchaseOrderLineByLegacyId($id, $poLegacyLine) {
        $sql = 'SELECT * FROM PURCHASE_ORDER_LINE WHERE PURCHASE_ORDER = ? AND PO_LEGACY_LINE = ?';
        if (count($line = $this->findAllAssocMod($sql, array($id, $poLegacyLine))) == 0) {
            return false;
        }
        return $line;
    }

    /**
     * get Purchase Orders for ReceiveController
     *
     * @param array $conditions
     * @return array
     */
    public function getPurchaseOrders(array $conditions, $pageNo = null, $resultsPerPage = null)
    {
        $values = array();
        $result = array('total' => 0, 'data' => array());


/* Old code

  (SELECT COUNT(PURCHASE_ORDER_LINE.PO_LINE_STATUS)
                        FROM PURCHASE_ORDER_LINE
                        WHERE PURCHASE_ORDER.PURCHASE_ORDER = PURCHASE_ORDER_LINE.PURCHASE_ORDER
                              AND PURCHASE_ORDER_LINE.PROD_ID = ?
                              AND PURCHASE_ORDER_LINE.PO_LINE_STATUS <> \'CL\') > 0 AND 
        
*/        
        //$sql = 'SELECT * FROM PURCHASE_ORDER WHERE';

//Sergey Golovin (16.08.2010):
//think this should select all PURCHASE_ORDERs which have at least one line with non 'CL' status
//        $sql = 'SELECT * FROM PURCHASE_ORDER ';

//        if(array_key_exists('PROD_ID', $conditions)) {
//            $where = ' (CASE WHEN 
//                          (SELECT FIRST 1 SKIP 0 PURCHASE_ORDER_LINE.PO_LINE_STATUS 
//                                  FROM PURCHASE_ORDER_LINE
//                                  WHERE PURCHASE_ORDER.PURCHASE_ORDER = PURCHASE_ORDER_LINE.PURCHASE_ORDER
//                                  AND PURCHASE_ORDER_LINE.PROD_ID = ? )
//                          <> \'CL\'
//                          THEN 1 ELSE 0
//                          END ) = 1 AND ';

//            $values[] = $conditions['PROD_ID'];
//            unset($conditions['PROD_ID']);
//        } else {
//            $where = ' (CASE WHEN 
//                          (SELECT FIRST 1 SKIP 0 PURCHASE_ORDER_LINE.PO_LINE_STATUS 
//                                  FROM PURCHASE_ORDER_LINE
//                                  WHERE PURCHASE_ORDER.PURCHASE_ORDER = PURCHASE_ORDER_LINE.PURCHASE_ORDER )
//                          <> \'CL\'
//                          THEN 1 ELSE 0
//                          END ) = 1 AND ';

//        }

//will fix this

        $sql = "
            SELECT 
                DISTINCT PURCHASE_ORDER.* 
            FROM 
                PURCHASE_ORDER 
                LEFT OUTER JOIN PURCHASE_ORDER_LINE ON PURCHASE_ORDER.PURCHASE_ORDER = PURCHASE_ORDER_LINE.PURCHASE_ORDER
        ";
        $where = " PURCHASE_ORDER_LINE.PO_LINE_STATUS <> 'CL' AND ";
        if(array_key_exists('PROD_ID', $conditions)) {
            $where .= " PURCHASE_ORDER_LINE.PROD_ID = ? AND ";
            $values[] = $conditions['PROD_ID'];
            unset($conditions['PROD_ID']);
        }
        
        if (!$this->isAdmin) {
            $where .= 'PO_STATUS =\'OP\' AND ';
        }
        foreach ($conditions as $key => $value) {
            $where .= $key . ' = ? AND ';
            $values[] = $value;
        }
        $where = substr($where, 0, -5);

        if (!empty($where)) {
            $sql .= ' WHERE ' . $where;
        }
        
        
        $sql .= ' ORDER BY PURCHASE_ORDER.PURCHASE_ORDER DESC';
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info($sql . ' : ' . implode(',', $values));
        //array_unshift($values, $sql);
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);

        $result['total'] = $total;

        if (count($data) > 0) {
            $result['data'] = $data;
        }
        if (null === $pageNo || null === $resultsPerPage) {
            $result = $result['data'];
        }
        return $result;

        //return call_user_func_array(array($this, 'fetchAllAssoc'), $args);
    }

    /**
     * Get PURCHASE_ORDERs for common case
     *
     * @param array $conditions
     * @param integer $pageNo
     * @param integer $resultsPerPage
     * @return array
     */
    public function getPurchaseOrdersCommon(array $clause, $pageNo = null, $resultsPerPage = null)
    {
        $values = array();
        $result = array('total' => 0, 'data' => array());

        $sql = 'SELECT * FROM PURCHASE_ORDER WHERE 1=1 AND ';
        
        foreach ($clause as $key => $value) {
            $sql .= $key;
            if(!empty($value)){
                $values[] = $value;
            }
        }
        $sql = substr($sql, 0, -5);

        if ($this->limitWarehouse != 'all') {
            $sql     .= ' AND PURCHASE_ORDER.PO_RECEIVE_WH_ID = ?';
            $values[] = $this->limitWarehouse;
        } else {
            $warehouseList = $this->getWarehouseListLimited();
            if (count($warehouseList) > 0 ) {
                $sql .= ' AND PURCHASE_ORDER.PO_RECEIVE_WH_ID IN (';
                foreach ($warehouseList as $key => $val) {
                    $sql      .= '?, ';
                    $values[]  = $key;
                }
                $sql = substr($sql, 0, -2) . ')';
            }
        }
        
        $sql .= ' ORDER BY PO_DATE DESC';
     
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info($sql . ' : ' . implode(',', $values));
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);

        $result['total'] = $total;

        if (count($data) > 0) {
            $result['data'] = $data;
        }
        if (null === $pageNo || null === $resultsPerPage) {
            $result = $result['data'];
        }
        return $result;
    }


    public function getPurchaseOrdersList( $orderType = NULL)
    {
        if ($orderType == NULL) {
            $sql = 'SELECT DEFAULT_PURCHASE_TYPE FROM CONTROL';
            $orderType = $this->findValue($sql);
        }
        //$sql = 'SELECT PURCHASE_ORDER, PURCHASE_ORDER FROM PURCHASE_ORDER ORDER BY 1 DESC';
        $sql = 'SELECT PURCHASE_ORDER, PURCHASE_ORDER FROM PURCHASE_ORDER WHERE ORDER_TYPE = ? ORDER BY 1 DESC';
        return $this->findList($sql, $orderType);
    }

    public function getPoLegacyConsignmentList()
    {
        $sql = 'SELECT PO_LEGACY_CONSIGNMENT, PO_LEGACY_CONSIGNMENT FROM PURCHASE_ORDER ORDER BY 1 DESC';
        return $this->findList($sql);
    }

    /**
     * Get PurchaseOrder by ID
     *
     * @param string $id
     * @return PurchaseOrder
     */
    public function getPurchaseOrderById($id)
    {
        $sql = 'SELECT * FROM PURCHASE_ORDER WHERE PURCHASE_ORDER = ?';
        if (false === ($line = $this->fetchAssoc($sql, $id))) {
            throw new Minder_Exception('Invalid PK.');
        }
        return new PurchaseOrder($line);
    }

    public function updatePurchaseOrder(PurchaseOrder $purchaseOrder)
    {

        $args = $purchaseOrder->items;

        unset($args['PURCHASE_ORDER']);

        $sql = 'UPDATE PURCHASE_ORDER SET  ';
        foreach ($args as $key => $arg) {
            if($this->isValidDate($arg)) {
                $args[$key] = $this->getFormatedDateToDb($arg);
            }
            $sql .= "$key = ?, ";
        }
        $sql = substr($sql, 0, -2);

        if ($purchaseOrder->id) {
            $sql .= ' WHERE PURCHASE_ORDER = ?';
            $args['PURCHASE_ORDER'] = $purchaseOrder->id;
        } else {
            throw new Minder_Exception('Invalid PK.');
        }

        if (false === ($query = ibase_prepare($this->db, $sql))) {
            ibase_free_query($query);
            $this->lastError = ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql;
            throw new Minder_Exception($this->lastError);
        }

        array_unshift($args, $query);
        $args = $this->prepareArgs($args);
        array_shift($args);
        $this->execSQL($sql, $args);
        ibase_free_query($query);
    }

    public function getPurchaseOrderLinesByPurchaseOrder($id, $lineNo = null, $all = false)
    {
        if (null == $lineNo) {

            $sql = '
            SELECT  PURCHASE_ORDER,
                    PO_LINE,
                    PO_LINE_QTY,
                    RECVD,
                    PROD_ID,
                    PO_LINE_DESCRIPTION,
                    PO_LINE_STATUS,
                    ORIGINAL_QTY,
                    PO_LEGACY_RECV_ID,
                    PO_LINE_CUSTOMER_NAME,
                    PO_LEGACY_LINE,
                    PO_REVISION_STATUS
            FROM (
                SELECT
                    PURCHASE_ORDER,
                    PURCHASE_ORDER_LINE.PO_LINE,
                    PO_LINE_QTY,
                    QT.RECVD AS RECVD,
                    PROD_ID,
                    PO_LINE_DESCRIPTION,
                    PO_LINE_STATUS,
                    ORIGINAL_QTY,
                    PO_LEGACY_RECV_ID,
                    PO_LINE_CUSTOMER_NAME,
                    PO_LEGACY_LINE,
                    PO_REVISION_STATUS
                FROM PURCHASE_ORDER_LINE
                LEFT JOIN
                    (SELECT SUM(SSN.ORIGINAL_QTY) AS RECVD,
                            SSN.PO_LINE,
                            SSN.PO_ORDER
                    FROM SSN, PURCHASE_ORDER_LINE
                    WHERE SSN.PO_ORDER = PURCHASE_ORDER_LINE.PURCHASE_ORDER
                        AND SSN.PO_LINE = PURCHASE_ORDER_LINE.PO_LINE
                        AND PURCHASE_ORDER = ?
                    GROUP BY
                        PO_LINE,
                        PO_ORDER) AS QT
                ON QT.PO_LINE = PURCHASE_ORDER_LINE.PO_LINE
                AND QT.PO_ORDER = PURCHASE_ORDER_LINE.PURCHASE_ORDER
                WHERE PURCHASE_ORDER = ?)';
            if (!$all) {
                $sql .= ' WHERE PO_LINE_QTY >= 0 AND PO_LINE_STATUS <> \'CL\'';
            }

            return $this->fetchAllAssoc($sql, $id, $id);
        } else {
            $sql = '
            SELECT  PURCHASE_ORDER,
                    PO_LINE,
                    PO_LINE_QTY,
                    RECVD,
                    PROD_ID,
                    PO_LINE_DESCRIPTION,
                    PO_LINE_STATUS,
                    ORIGINAL_QTY,
                    PO_LEGACY_RECV_ID,
                    PO_LINE_CUSTOMER_NAME,
                    PO_LEGACY_LINE,
                    PO_REVISION_STATUS
            FROM (
                SELECT
                    PURCHASE_ORDER,
                    PURCHASE_ORDER_LINE.PO_LINE,
                    PO_LINE_QTY,
                    QT.RECVD AS RECVD,
                    PROD_ID,
                    PO_LINE_DESCRIPTION,
                    PO_LINE_STATUS,
                    ORIGINAL_QTY,
                    PO_LEGACY_RECV_ID,
                    PO_LINE_CUSTOMER_NAME,
                    PO_LEGACY_LINE,
                    PO_REVISION_STATUS
                FROM PURCHASE_ORDER_LINE
                LEFT JOIN
                    (SELECT SUM(SSN.ORIGINAL_QTY) AS RECVD,
                            SSN.PO_LINE,
                            SSN.PO_ORDER
                    FROM SSN, PURCHASE_ORDER_LINE
                    WHERE SSN.PO_ORDER = PURCHASE_ORDER_LINE.PURCHASE_ORDER
                        AND SSN.PO_LINE = PURCHASE_ORDER_LINE.PO_LINE
                        AND PURCHASE_ORDER = ?
                    GROUP BY
                        PO_LINE,
                        PO_ORDER) AS QT
                ON QT.PO_LINE = PURCHASE_ORDER_LINE.PO_LINE
                AND QT.PO_ORDER = PURCHASE_ORDER_LINE.PURCHASE_ORDER
                WHERE PURCHASE_ORDER = ? AND PURCHASE_ORDER_LINE.PO_LINE = ?)';
            if (!$all) {
                $sql .= ' WHERE PO_LINE_QTY >= 0 AND PO_LINE_STATUS <> \'CL\'';
            }
        

            return $this->fetchAllAssoc($sql, $id, $id, $lineNo);
        }
    }
    
    function getPurchaseLinesByPurchaseOrders($orderList, $pageSelector, $showBy, $fieldsData){
         
        $selectedFields    =   null;
         if(count($fieldsData['db_fileds']) > 0){
             foreach($fieldsData['db_fileds'] as $field){
                 if($field != 'PURCHASE_ORDER_LINE.PO_LINE'){
                    $selectedFields .= $field . ', ';  
                 }
             }
         }
         
         $where     =   '';
         
         foreach($orderList as $order){
            $where .= "'". $order ."'" . ', ';     
         }
         
         $where = substr($where, 0, -2);
         $sql   = sprintf('SELECT
                              %s  
                              PURCHASE_ORDER_LINE.PO_LINE
                           FROM PURCHASE_ORDER_LINE
                           LEFT JOIN PROD_PROFILE ON PURCHASE_ORDER_LINE.PROD_ID = PROD_PROFILE.PROD_ID   
                           WHERE 1=1 AND PURCHASE_ORDER_LINE.PURCHASE_ORDER IN(%s)', $selectedFields, $where);
       
         $sql  .= ' ORDER BY  PURCHASE_ORDER_LINE.PO_LINE ASC'; 
     
         $log = Zend_Registry::get('logger');
         $log->info(__FUNCTION__);
         $this->lastError = $sql;
      
        
         list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageSelector, $showBy);
         $log->info($sqlQuery);
    
         $total  = $this->findValue($sqlCount);
         $data   = $this->findAllAssocMod($sqlQuery);
        
         $result['total'] = $total;
         $result['data']  = $data;
        
         return $result; 
            
    }

    public function getPoLine($poLineId, $poId)
    {
        $sql = 'SELECT
                    PURCHASE_ORDER_LINE.*,
                    (SELECT SUM(SSN.ORIGINAL_QTY)
                    FROM SSN, PURCHASE_ORDER_LINE
                    WHERE SSN.PO_ORDER = PURCHASE_ORDER_LINE.PURCHASE_ORDER
                    AND SSN.PO_LINE = PURCHASE_ORDER_LINE.PO_LINE
                    AND PURCHASE_ORDER = ?) AS RECVD
                FROM PURCHASE_ORDER_LINE
                WHERE PO_LINE = ? AND PURCHASE_ORDER = ?';
        //$sql = 'SELECT * FROM PURCHASE_ORDER_LINE WHERE PO_LINE = ? AND PURCHASE_ORDER = ?';
        return $this->fetchAssoc($sql, $poId, $poLineId, $poId);
    }

    /**
     * Obsolete
     *
     * @todo check and remove
     *
     * @param mixed $data
     * @return boolean
     */
    public function addSalesOrderToCache($data) {
      $sql = 'SELECT COUNT(PARAM_NAME) FROM USER_ENV WHERE USER_ID = \'TEMPUSER\'';
      $number = $this->findOne($sql);
      $number = ((int)$number[0]) + 1;
        $value = serialize($data);
        $result = $this->createEnvSession('TEMPUSER', 'T' . $number, $value);
        return $result;
    }

    /**
     * Check is allowed CLI
     *
     * @return boolean
     */
    public function isAllowedCli()
    {
        if (($status = $this->getSoapCache('CLI'))) {
            if ($status == 'started') {
                $result = true;
            } else {
                $result = false;
            }
        } else {
            $result = true;
        }
        return $result;
    }

    /**
     * Allow CLI to run
     *
     * @return boolean
     */
    public function allowCli()
    {
        return $this->updateSoapCache('CLI', 'started');
    }

    /**
     * Disallow CLI to run
     *
     * @return boolean
     */
    public function denyCli()
    {
        return $this->updateSoapCache('CLI', 'stopped');
    }

    /**
     *
     *
     */
    private function __setCliStatus($status)
    {
        $result = $this->updateSoapCache('CLI', $status);
        return $result;
    }

    /**
     * Get date of Soap Cache item
     *
     * @param string $id
     * @return string
     */
    public function getSoapCacheDate($id)
    {
        $result = $this->getEnvSession('SOAPCACHE', $id);
        if ($result) {
            $result = $result['CREATE_DATE'];
        } else {
            $result = false;
        }
        return $result;
    }

    /**
     * Update item in SOAP cache
     *
     * @param string $paramName
     * @param mixed $data
     * @return boolean
     */
    public function updateSoapCache($paramName, $data = array())
    {
        $result = true;
        $sql = 'DELETE FROM USER_ENV WHERE USER_ID = \'SOAPCACHE\' AND PARAM_NAME = \'' . $paramName . '\'';

        if (false !== ($query = ibase_query($sql))) {
            ibase_commit();
            $value = serialize($data);
            $result = $result && $this->createEnvSession('SOAPCACHE', $paramName, $value);
            ibase_free_result($query);
            return $result;
        }
        else
            return false;
    }

    /**
     * Get an item from SOAP cache
     *
     * @param string $paramName
     * @return mixed
     */
    public function getSoapCache($paramName = 'S')
    {
        $result = $this->getEnvSession('SOAPCACHE', $paramName);
        if ($result) {
            $result = unserialize($result['PARAM_VALUE']);
        }
        return $result;
    }

    /*
     * Clears SOAP cache or specified objects
     * @param $idList ID list for remove
     *
     * @return void
     */
    public function deleteSoapCache(array $idList = array())
    {
        $this->deleteEnvSession('SOAPCACHE', $idList);
        return;
    }

    /**
     * RePacks ISSN using list of IssnLines and array of new stack
     *
     * @param array $lines4update
     * @param array $newStack     list of QTY and # Packages
     *
     * @return boolean
     */
    public function rePack(array $lines4update, array $newStack)
    {
        $qtyRepacked = 0;
        $qtyToRepack = 0;
        $level       = 0; //-- number pair Qty and Pkg
        $output      = array(); //-- updated IssnLines;
        $usedParents = array();
        $issnParents = array(); //-- list of parents for newly created ISSNs
        foreach ($newStack['QTY'] as $val) {
            $qtyToRepack += $val;
        }

        if ($qtyToRepack < count($lines4update)) {
            end($lines4update);
            $notEOL    = true;
            $qtyStored = 0;
            do {
                if ($newStack['QTY'][$level] == 0) {
                    $level++;
                } else {
                    $qtyStored += current($lines4update)->items['CURRENT_QTY'];
                    if ($qtyStored >= $newStack['PKG'][$level]) {
                        $newIssn = clone(current($lines4update));
                        $newIssn->items['CURRENT_QTY'] = $newStack['PKG'][$level];
                        $newIssn->items['ISSN_PACKAGE_TYPE']   = $newStack['PACK_TYPE'];
                        $output[] = $newIssn;
                        $qtyStored -= $newStack['PKG'][$level];
                        $newStack['QTY'][$level]--;
                    } else {
                        current($lines4update)->items['CURRENT_QTY'] = 0;
                        $usedParents[] = current($lines4update);
                    }
                    if (!prev($lines4update)) {
                        $notEOL = false;
                    }
                    $qtyRepacked++;
                }
            } while ($notEOL && $level < 4);
        } else {
            //$qtyRepacked = 1;
            //-- start from last IssnLine
            end($lines4update);
            do {
                if ($newStack['QTY'][$level] == 0) {
                    $level ++;
                }
                $newIssn = clone(current($lines4update));
                if ($newIssn->items['CURRENT_QTY'] > $newStack['PKG'][$level])  {
                    //-- if CURRENT_QTY > NEW_QTY then save SSN_ID for later using as Parent for split
                    $issnParents[] = current($lines4update)->id;
                }
                $newIssn->items['CURRENT_QTY'] = $newStack['PKG'][$level];
                $newIssn->items['ISSN_PACKAGE_TYPE']   = $newStack['PACK_TYPE'];

                //-- add new ISSN to list for using later
                $output[]                      = $newIssn;
                //-- decrease number of issns to be repacked for current $level
                $newStack['QTY'][$level]--;
                if (!prev($lines4update)) {
                    $notEOL = false;
                }
                $qtyRepacked ++;
            } while ($notEOL && $qtyToRepack > $qtyRepacked);
            if ($newStack['QTY'][$level] == 0) {
                $level ++;
            }
        }

        //-- Make Transaction and send it
        //-- first run UISS transaction for split one ISSN into 2
        $this->beginTransaction();
        for ($i = $qtyRepacked; $i < $qtyToRepack; $i++) {
            $transaction = new Transaction_UISSA();

            if ($lines4update[end($issnParents)]->items['CURRENT_QTY'] <= $newStack['PKG'][$level]) {
                //-- remove ISSN from list of Parents to used
                array_pop($issnParents);
            }
                //-- decrease CURRENT_QTY by splited QTY
            $lines4update[end($issnParents)]->items['CURRENT_QTY'] -= $newStack['PKG'][$level];
            $issnLine                    = $lines4update[end($issnParents)];
            $transaction->locationId     = $issnLine->items['LOCN_ID'];
            $transaction->whId           = $issnLine->items['WH_ID'];
            $transaction->objectId       = $issnLine->id;
            $transaction->issnCurrentQty = $newStack['PKG'][$level];
            if (false != ($result = $this->doTransactionResponse($transaction, false, "SSBSSSSKS"))) {
                list(, $newSsnId)  = explode("|", $result);

                $newIssn                       = clone($issnLine);
                $newIssn->id                   = $newSsnId;
                $newIssn->items['SSN_ID']      = $newSsnId;
                $newIssn->items['CURRENT_QTY'] = $newStack['PKG'][$level];
                $newIssn->items['ISSN_PACKAGE_TYPE']   = $newStack['PACK_TYPE'];
                //-- add new ISSN to list for using later
                $output[]                      = $newIssn;
                //-- decrease number of issns to be repacked for current $level
                $newStack['QTY'][$level]--;
                if ($newStack['QTY'][$level] == 0) {
                    $level ++;
                }
            } else {
                $this->rollbackTransaction();
                return false;
            }
        }
        $this->lastError = '';
        foreach ($usedParents as $line) {
            $transaction = new Transaction_UICQA();
            $transaction->locationId     = $line->items['LOCN_ID'];
            $transaction->whId           = $line->items['WH_ID'];
            $transaction->objectId       = $line->id;
            $transaction->currentQty     = $line->items['CURRENT_QTY'];
            if (false != ($result = $this->doTransactionResponse($transaction, false, "SSBSSKSKS"))) {
                $this->lastError .= $line->id . ' updated successfully. ';
            } else {
                $this->rollbackTransaction();
                return false;
            }
        }

        foreach ($output as  $line) {
            $transaction = new Transaction_UICQA();
            $transaction->locationId     = $line->items['LOCN_ID'];
            $transaction->whId           = $line->items['WH_ID'];
            $transaction->objectId       = $line->id;
            $transaction->currentQty     = $line->items['CURRENT_QTY'];
            if (false != ($result = $this->doTransactionResponse($transaction, false, "SSBSSKSKS"))) {
                $this->lastError .= $line->id . ' updated successfully. ';
            } else {
                $this->rollbackTransaction();
                return false;
            }

            $transaction = new Transaction_UIPTA();
            $transaction->locationId      = $line->items['LOCN_ID'];
            $transaction->whId            = $line->items['WH_ID'];
            $transaction->objectId        = $line->id;
            $transaction->issnPackageType = $newStack['PACK_TYPE'];

            if (false != ($result = $this->doTransactionResponse($transaction, false, "SSBSSSSKS"))) {
                $this->lastError .= $line->id . ' updated successfully. ';
            } else {
                $this->rollbackTransaction();
                return false;
            }

            $transaction = new Transaction_UILDA();
            $transaction->locationId      = $line->items['LOCN_ID'];
            $transaction->whId            = $line->items['WH_ID'];
            $transaction->objectId        = $line->id;
            $transaction->qty             = '1';
            $transaction->printerId       = $newStack['PRINTER'];

            if (false != ($result = $this->doTransactionResponse($transaction, false, "SSBSSSSKS"))) {
                $this->lastError .= $line->id . ' updated successfully. ';
            } else {
                $this->rollbackTransaction();
                return false;
            }
        }
        if ($result) {
            $this->commitTransaction();

            return array_merge($usedParents, $output);
        }
        return false;
    }

    /**
     * ReSort ISSN using list of IssnLines and array of new stack
     *
     * @param array $lines4update
     * @param array $newStack     list of QTY and # Packages
     *
     * @return boolean
     */
    public function reSort(array $lines4update, array $newStack)
    {
        $qtyResorted  = 0;
        $qtyToResort1 = 0;
        $qtyToResort2 = 0;
        $level        = 0; //-- number pair Qty and Pkg
        $level1       = 0; //-- number pair Qty and Pkg
        $output       = array(); //-- updated IssnLines by Sort #1
        $output2      = array(); //-- updated IssnLines by Sort #2
        $issnParents  = array(); //-- list of parent ISSNs for newly created ISSNs
        $usedParents  = array(); //-- list of parent ISSNs which allready used for new ISSN
        foreach ($newStack['QTY'] as $val) {
            $qtyToResort1 += $val;
        }

        foreach ($newStack['QTY1'] as $val) {
            $qtyToResort2 += $val;
        }
        //-- start from last IssnLine
        end($lines4update);

        //-- ReSort #1
        $notEOL = true;
        while ($notEOL && $qtyToResort1 > 0) {
            if ($newStack['QTY'][$level] == 0) {
                $level ++;
            }
            $newIssn = clone(current($lines4update));
            $newIssn->items['ISSN_PACKAGE_TYPE'] = $newStack['PACK_TYPE1'];
            if (current($lines4update)->items['CURRENT_QTY'] >= $newStack['PKG'][$level])  {
                $newIssn->items['CURRENT_QTY'] = $newStack['PKG'][$level];
                //-- if CURRENT_QTY > NEW_QTY then save SSN_ID for later using as Parent for split
                current($lines4update)->items['CURRENT_QTY'] -= $newStack['PKG'][$level];
                $issnParents[] = $newIssn;
                //-- decrease number of issns to be repacked for current $level
                $newStack['QTY'][$level]--;
                $notEOL = prev($lines4update);
            } else {
                //-- set ISSN qty to null (qty merged to other)
                $newIssn->items['CURRENT_QTY'] = 0;
                $usedParents[] = $newIssn;
                //-- store current ISSNLine
                $curIssn = clone(current($lines4update));
                //-- set qty in original array = 0
                current($lines4update)->items['CURRENT_QTY'] = 0;
                //-- grow new Stack by stored ISSN qty
                prev($lines4update)->items['CURRENT_QTY'] += $curIssn->items['CURRENT_QTY'];
                $notEOL = current($lines4update);
            }
            $qtyResorted ++;
        }
        if ($newStack['QTY'][$level] == 0) {
             $level ++;
        }
        //-- ReSort #2
        while ($notEOL && $qtyToResort2 > 0) {
            if ($newStack['QTY1'][$level1] == 0) {
                $level1 ++;
            }
            $newIssn = clone(current($lines4update));
            $newIssn->items['ISSN_PACKAGE_TYPE']   = $newStack['PACK_TYPE2'];
            if (current($lines4update)->items['CURRENT_QTY'] >= $newStack['PKG1'][$level1])  {
                $newIssn->items['CURRENT_QTY'] = $newStack['PKG1'][$level1];
                //-- if CURRENT_QTY > NEW_QTY then save SSN_ID for later using as Parent for split
                current($lines4update)->items['CURRENT_QTY'] -= $newStack['PKG1'][$level1];
                $issnParents[] = $newIssn;
                //-- decrease number of issns to be repacked for current $level
                $newStack['QTY1'][$level1]--;
                $notEOL = prev($lines4update);
            } else {
                //-- set ISSN qty to null (qty merged to other)
                $newIssn->items['CURRENT_QTY'] = 0;
                $usedParents[] = $newIssn;
                //-- store current ISSNLine
                $curIssn = clone(current($lines4update));
                //-- set qty in original array = 0
                current($lines4update)->items['CURRENT_QTY'] = 0;
                //-- grow new Stack by stored ISSN qty
                prev($lines4update)->items['CURRENT_QTY'] += $curIssn->items['CURRENT_QTY'];
                $notEOL = current($lines4update);
            }
            $qtyResorted ++;
        }
        if ($newStack['QTY1'][$level1] == 0) {
            $level1 ++;
        }
        //-- Make Transaction and send it
        //-- first run UISS transaction for split one ISSN into 2
        $this->beginTransaction();
        for ($i = $qtyResorted; $i < $qtyToResort1; $i++) {
            //-- if CURRENT_QTY for current Parent ISSN greater then 0
            if ($lines4update[end($issnParents)->id]->items['CURRENT_QTY'] > 0) {
                //-- decrease CURRENT_QTY by splited QTY
                $lines4update[end($issnParents)->id]->items['CURRENT_QTY'] -= $newStack['PKG'][$level];
                $issnLine = $lines4update[end($issnParents)->id];

                $transaction = new Transaction_UISSA();

                $transaction->locationId     = $issnLine->items['LOCN_ID'];
                $transaction->whId           = $issnLine->items['WH_ID'];
                $transaction->objectId       = $issnLine->id;
                $transaction->issnCurrentQty = $newStack['PKG'][$level];
                if (($result = $this->doTransactionResponse($transaction, false, "SSBSSSSKS"))) {
                    list(, $newSsnId)  = explode("|", $result);
                    $newIssn                       = clone($issnLine);
                    $newIssn->id                   = $newSsnId;
                    $newIssn->items['SSN_ID']      = $newSsnId;
                    $newIssn->items['CURRENT_QTY'] = $newStack['PKG'][$level];
                    $newIssn->items['ISSN_PACKAGE_TYPE']   = $newStack['PACK_TYPE1'];
                    //-- add new ISSN to list for using later
                    $output[]                      = $newIssn;
                    //-- decrease number of issns to be repacked for current $level
                    $newStack['QTY'][$level]--;
                    if ($newStack['QTY'][$level] == 0) {
                        $level ++;
                    }
                } else {
                    $this->rollbackTransaction();
                    return false;
                }
            } else {
                //-- move ISSN from list of Parent ISSNs to list of USED Parent ISSNs
                $usedParents[] = array_pop($issnParents);
                if (end($issnParents)) {
                    $i--;
                } else {
                    break;
                }
            }
            $qtyResorted++;
        }
        for ($i = $qtyResorted; $i < $qtyToResort1 + $qtyToResort2; $i++) {
            //-- if CURRENT_QTY for current Parent ISSN greater then 0
            if ($lines4update[end($issnParents)->id]->items['CURRENT_QTY'] > 0) {
                //-- decrease CURRENT_QTY by splited QTY
                $lines4update[end($issnParents)->id]->items['CURRENT_QTY'] -= $newStack['PKG1'][$level1];
                $issnLine = $lines4update[end($issnParents)->id];

                $transaction = new Transaction_UISSB();

                $transaction->locationId     = $issnLine->items['LOCN_ID'];
                $transaction->whId           = $issnLine->items['WH_ID'];
                $transaction->objectId       = $issnLine->id;
                $transaction->issnCurrentQty = $newStack['PKG1'][$level1];
                if (($result = $this->doTransactionResponse($transaction, false, "SSBSSSSKS"))) {
                    list(, $newSsnId)  = explode("|", $result);
                    $newIssn                       = clone($issnLine);
                    $newIssn->id                   = $newSsnId;
                    $newIssn->items['SSN_ID']      = $newSsnId;
                    $newIssn->items['CURRENT_QTY'] = $newStack['PKG1'][$level1];
                    $newIssn->items['ISSN_PACKAGE_TYPE']   = $newStack['PACK_TYPE2'];
                    //-- add new ISSN to list for using later
                    $output2[]                      = $newIssn;
                    //-- decrease number of issns to be repacked for current $level1
                    $newStack['QTY1'][$level1]--;
                    if ($newStack['QTY1'][$level1] == 0) {
                        $level1 ++;
                    }
                } else {
                    $this->rollbackTransaction();
                    return false;
                }
            } else {
                //-- move ISSN from list of Parent ISSNs to list of USED Parent ISSNs
                $usedParents[] = array_pop($issnParents);
                if (end($issnParents)) {
                    $i--;
                } else {
                    break;
                }
            }
            $qtyResorted++;
        }
        $usedParents = array_merge($usedParents, $issnParents);
        $this->lastError = '';
        //-- drop $level to init value
        foreach ($usedParents as $line) {
            $transaction                  = new Transaction_UICQA();
            $transaction->locationId      = $line->items['LOCN_ID'];
            $transaction->whId            = $line->items['WH_ID'];
            $transaction->objectId        = $line->id;
            $transaction->currentQty      = $line->items['CURRENT_QTY'];
            if (($result = $this->doTransactionResponse($transaction, false, "SSBSSKSKS"))) {
                $this->lastError .= $line->id . ' updated successfully. ';
            } else {
                //$flag = false;
                $this->rollbackTransaction();
                return false;
            }

            $transaction = new Transaction_UIPTA();
            $transaction->locationId      = $line->items['LOCN_ID'];
            $transaction->whId            = $line->items['WH_ID'];
            $transaction->objectId        = $line->id;
            $transaction->issnPackageType = $line->items['ISSN_PACKAGE_TYPE'];
            if (($result = $this->doTransactionResponse($transaction, false, "SSBSSSSKS"))) {
                $this->lastError .= $line->id . ' updated successfully. ';
            } else {
                $this->rollbackTransaction();
                return false;
            }

            $transaction = new Transaction_UILDA();
            $transaction->locationId      = $line->items['LOCN_ID'];
            $transaction->whId            = $line->items['WH_ID'];
            $transaction->objectId        = $line->id;
            $transaction->qty             = '1';
            $transaction->printerId       = $newStack['PRINTER'];

            if (($result = $this->doTransactionResponse($transaction, false, "SSBSSSSKS"))) {
                $this->lastError .= $line->id . ' updated successfully. ';
            } else {
                $this->rollbackTransaction();
                return false;
            }
        }
        foreach ($output as  $line) {
            $transaction = new Transaction_UIPTA();
            $transaction->locationId      = $line->items['LOCN_ID'];
            $transaction->whId            = $line->items['WH_ID'];
            $transaction->objectId        = $line->id;
            $transaction->issnPackageType = $line->items['ISSN_PACKAGE_TYPE'];
            if ($result = $this->doTransactionResponse($transaction, false, "SSBSSSSKS")) {
                $this->err[] = $line->id . ' updated successfully. ';
            } else {
                $this->rollbackTransaction();
                return false;
            }

            $transaction = new Transaction_UILDA();
            $transaction->locationId      = $line->items['LOCN_ID'];
            $transaction->whId            = $line->items['WH_ID'];
            $transaction->objectId        = $line->id;
            $transaction->qty             = '1';
            $transaction->printerId       = $newStack['PRINTER'];

            if ($result = $this->doTransactionResponse($transaction, false, 'SSBSSSSKS')) {
                $this->lastError .= $line->id . ' updated successfully. ';
            } else {
                $this->rollbackTransaction();
                return false;
            }
        }

        foreach ($output2 as  $line) {
            $transaction = new Transaction_UIPTB();
            $transaction->locationId      = $line->items['LOCN_ID'];
            $transaction->whId            = $line->items['WH_ID'];
            $transaction->objectId        = $line->id;
            $transaction->issnPackageType = $line->items['ISSN_PACKAGE_TYPE'];
            if (($result = $this->doTransactionResponse($transaction, false, "SSBSSSSKS"))) {
                $this->lastError .= $line->id . ' updated successfully. ';
            } else {
                $this->rollbackTransaction();
                return false;
            }

            $transaction = new Transaction_UILDB();
            $transaction->locationId      = $line->items['LOCN_ID'];
            $transaction->whId            = $line->items['WH_ID'];
            $transaction->objectId        = $line->id;
            $transaction->qty             = '1';
            $transaction->printerId       = $newStack['PRINTER'];

            if (($result = $this->doTransactionResponse($transaction, false, "SSBSSSSKS"))) {
                $this->lastError .= $line->id . ' updated successfully. ';
            } else {
                $this->rollbackTransaction();
                return false;
            }
        }

        if ($result) {
            $this->commitTransaction();

            return array_merge($usedParents, $output, $output2);
        }
        return $result;
    }

    public function importFromClipboard($importData)
    {
        $data   = $importData['data'];
        $table  = $importData['table'];
        $fields = $importData['headers'];

        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info(print_r($data, true));

        /**
         *  @todo FireBird doesn't support prepared statement for unknown table and fields
         *  Additional improvement is required to prevent SQL-injection
         *  (check all fields, which should exist in selected table)
         */

        $sqlFirstInsert = 'INSERT INTO ' . addslashes(trim($table)) . ' (';
        $sqlFirstUpdate = 'UPDATE ' . addslashes(trim($table)) . ' SET ';
        $sqlFirstSelect = 'SELECT 1 FROM ' . addslashes(trim($table)) . ' WHERE ';

        foreach ($fields as $v) {
            $sqlFirstInsert .= addslashes(trim($v)) . ', ';
        }
        $sqlFirstInsert = substr($sqlFirstInsert, 0, -2) . ') VALUES (';

        $rowCount = 0;

        $this->beginTransaction();
        try {
            $pkCols = array_intersect($this->getUniqueConstraint($table), array_keys($fields));
            foreach ($data as $row) {
                $rowCount++;

                $tmp    = array();
                $forSsn = array();
                foreach ($fields as $key => $value) {
                    $forSsn[$key] = $tmp[$key] = array_shift($row);
                }

                // Create array of PK and SQL WHERE clause.
                $pkVals = array();
                $where = '';
                foreach ($pkCols as $key => $value) {
                    $where .= "$key = ? AND ";
                    $pkVals[] = $tmp[$key];
                }
                $where = substr($where, 0, -5);

                if (false === call_user_func_array(array($this, 'fetchOne'), array_merge(array($sqlFirstSelect . $where), $pkVals))) {
                    /**
                     * Insert row.
                     */
                    $sqlInsert = '';
                    $params = array();
                    foreach ($tmp as $value) {
                        $params[] = ($value === '') ? null : $value;
                        $sqlInsert .= '?, ';
                    }
                    $sqlInsert = $sqlFirstInsert . substr($sqlInsert, 0, -2) . ')';
                    if (false === ($query = @ibase_prepare($this->db, $sqlInsert))) {
                        throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sqlInsert);
                    }
                    array_unshift($params, $query);
                    if (false === ($result = @call_user_func_array('ibase_execute', $params))) {
                        $errcode = ibase_errcode();
                        $errmsg = ibase_errmsg();
                        ibase_free_query($query);
                        throw new Minder_Exception($errcode . ': ' . $errmsg . '. Query text: ' . $sqlInsert);
                    }
                    ibase_free_result($result);
                    ibase_free_query($query);
                } else {
                    /**
                     * Update row.
                     */

                    // Create SQL query string and build args.
                    $args = array();
                    $sqlUpdate = '';
                    foreach ($tmp as $key => $value) {
                        $sqlUpdate .= addslashes($key) . ' = ?, ';
                        $args[] = ($value === '') ? null : $value;
                    }
                    $sqlUpdate = $sqlFirstUpdate . substr($sqlUpdate, 0, -2) . ' WHERE ' . $where;
                    $args = array_merge($args, $pkVals);

                    // Send query.
                    if (false === ($query = @ibase_prepare($this->db, $sqlUpdate))) {
                        throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sqlUpdate);
                    }
                    array_unshift($args, $query);
                    if (false === ($result = @call_user_func_array('ibase_execute', $args))) {
                        $errcode = ibase_errcode();
                        $errmsg = ibase_errmsg();
                        ibase_free_query($query);
                        throw new Minder_Exception($errcode . ': ' . $errmsg . '. Query text: ' . $sqlUpdate);
                    }
                    ibase_free_result($result);
                    ibase_free_query($query);
                }
                
                if ($table == 'ISSN') {
                    $sqlCreateIssnFromSsn = 'EXECUTE PROCEDURE ADD_ISSN_FROM_SSN(?)';
                    $res = $this->execSQL($sqlCreateIssnFromSsn, array($forSsn['SSN_ID']));
                }
                
                // #452
                if ($table == 'SSN')  {
                    foreach ($pkVals as $ssn_id) {
                        $sqlCreateIssnFromSsn = 'EXECUTE PROCEDURE ADD_ISSN_FROM_SSN(?)';
                        $res = $this->execSQL($sqlCreateIssnFromSsn, array($ssn_id));
                    }
                }
            }
            $this->lastError = 'Successfully imported ' . $rowCount . ' row(s)';
            $this->commitTransaction();

            $result = true;
            
        } catch (Exception $e) {
            $this->lastError = $e->getCode() . ' ' . $e->getMessage();
            $this->rollbackTransaction();
            $result = false;
        }
        return $result;
    }

    /**
     * Validate the username and password as a minder administrator
     *
     * This function validates the username and password as belonging to a
     * minder administrator
     *
     * @param string $userId user ID for login
     * @param string $pass   user pass for login
     *
     * @return boolean
     */
    public function validateAdministrator($userId, $pass)
    {
        $isAdmin = false;

        $queryString = "SELECT PASS_WORD, USER_ID, SYS_ADMIN FROM SYS_USER WHERE USER_ID = ? ";

        $query = ibase_prepare($queryString);

        if (false !== $query) {
            if (false !== ($result = ibase_execute($query, $userId))) {
                if (false !== ($row = ibase_fetch_row($result))) {
                    if ($row[0] == $pass && $row[1] == $userId && $row[2] == 'T') {
                        $isAdmin = true;
                    }

                }
                ibase_free_result($result);
            }

            ibase_free_query($query);
        }

        return $isAdmin;
    }

    /**
     * get PROD_ID from SSN table by specified SSN_ID
     *
     * @param string $ssnId
     * @return string
     */
    public function getProdIdBySSN($ssnId)
    {
        $sql = 'SELECT PROD_ID FROM SSN WHERE SSN_ID = ?';
        return $this->findValue($sql, $ssnId);
    }


    /**
     * get SSN_ID by specified PROD_ID from SSN table
     *
     * @param $prodId
     * @internal param string $ssnId
     * @return string
     */
    public function getSsnIdByProdId($prodId)
    {
        $sql = 'SELECT SSN_ID FROM SSN WHERE PROD_ID = ?';
        return $this->findValue($sql, $prodId);
    }

    /**
     * get getPickItemDetail from PICK_ITEM_DETAIL by PICK_DETAIL_STATUS
     *
     * @param string $status
     * @return array
     */
    public function getPickItemDetail($status = 'DL')
    {
        $sql = 'SELECT
                    PID.PICK_DETAIL_ID,
                    PI.PI_LEGACY_LINENO,
                    PI.PROD_ID,
                    PI.PI_LEGACY_WH_ID,
                    PI.WH_ID,
                    PI.PI_LEGACY_WH_NAME,
                    PO.SO_LEGACY_INTERNAL_ID,
                    PID.SSN_ID,
                    PID.QTY_PICKED,
                    PID.DESPATCH_ID,
                    PI.PICK_ORDER,
                    PI.PICK_LABEL_NO
                    FROM PICK_ITEM_DETAIL AS PID
                JOIN PICK_ITEM AS PI ON PI.PICK_LABEL_NO = PID.PICK_LABEL_NO
                JOIN PICK_ORDER AS PO ON PO.PICK_ORDER = PI.PICK_ORDER
                JOIN ISSN ON ISSN.SSN_ID = PID.SSN_ID
                WHERE PID.PICK_DETAIL_STATUS = \'' . $status . '\'';
        //$sql .= ' ORDER BY PID.CREATE_DATE';
        $sql .= ' ORDER BY PI.PICK_ORDER';
        $sql .= ' , PI.PI_LEGACY_LINENO';
        $sql .= ' , PI.PICK_LABEL_NO';
        $sql .= ' , ISSN.ORIGINAL_SSN';
        $result = $this->findAllAssocMod($sql);
        $data   = array();
        $pickItemDetailsToDropStatus = array();
        foreach ($result as $key => $line) {
            if ($line['QTY_PICKED'] != 0) {
                $ssnId      = $line['SSN_ID'];
                //$this->msg($ssnId);
                $original   = $this->getOriginalSsn($ssnId);
                //$this->msg($original);
                try {
                    $this->msg($ssnId . ' = trying to get additional detail' . PHP_EOL);
                    //$prodId = $this->getProdIdBySSN($ssnId);
                    $prodId = $this->getProdIdBySSN($original);
                    if ($prodId) {
                        $line['SSN.PROD_ID'] = $prodId;
                    } else {
                        throw new Exception($ssnId . ' = no prod for this SSN');
                    }
                } catch (Exception $e) {
                    $line['SSN.PROD_ID'] = $ssnId . ' = no prod for this SSN';
                    $this->msg('fails - ' . $e->getMessage() . PHP_EOL);
                }
                $line['SSN_ID'] = $original;
                $result[$key]   = $line;
                $data[$line['DESPATCH_ID']][$original]['QTY_PICKED'] = 0;
            } else {
                $pickItemDetailsToDropStatus[] = $line['PICK_DETAIL_ID'];
                unset($result[$key]);
            }
        }

        if (count($pickItemDetailsToDropStatus) > 0) {
            if ($this->updatePickItemDespatched($pickItemDetailsToDropStatus)) {
                // do nothing;
            }
        }
        foreach ($result as $line) {
            $data[$line['DESPATCH_ID']][$line['SSN_ID']]['QTY_PICKED'] += $line['QTY_PICKED'];
            $data[$line['DESPATCH_ID']][$line['SSN_ID']]['PICK_ORDER'] = $line['PICK_ORDER'];
            $data[$line['DESPATCH_ID']][$line['SSN_ID']]['SO_LEGACY_INTERNAL_ID'] = $line['SO_LEGACY_INTERNAL_ID'];
            $data[$line['DESPATCH_ID']][$line['SSN_ID']]['PI_LEGACY_LINENO']      = $line['PI_LEGACY_LINENO'];
            $data[$line['DESPATCH_ID']][$line['SSN_ID']]['PROD_ID']               = $line['PROD_ID'];
            $data[$line['DESPATCH_ID']][$line['SSN_ID']]['SSN.PROD_ID']           = $line['SSN.PROD_ID'];
            $data[$line['DESPATCH_ID']][$line['SSN_ID']]['PICK_DETAIL_ID'][]      = $line['PICK_DETAIL_ID'];
            $data[$line['DESPATCH_ID']][$line['SSN_ID']]['WH_ID']                 = $line['WH_ID'];
            $data[$line['DESPATCH_ID']][$line['SSN_ID']]['PI_LEGACY_WH_ID']       = $line['PI_LEGACY_WH_ID'];
            $data[$line['DESPATCH_ID']][$line['SSN_ID']]['PICK_LABEL_NO']       = $line['PICK_LABEL_NO'];
        }

        return $data;
    }
    /**
     * get getPickItemDetail from PICK_ITEM_DETAIL
     *
     * @param string $pickLabelNo 
     * @return array
     */
    public function getAllPickItemDetail($pickLabelNo)
    {
        $sql = 'SELECT * 
                FROM
                PICK_ITEM_DETAIL
                WHERE PICK_LABEL_NO = \'' . $pickLabelNo . '\'';
      
        $data = $this->findAllAssocMod($sql);
        return $data;
    }

    /**
     * Update PickItem status to DESPATCH EXIT
     *
     * @param array $items
     * @return boolean
     */
    public function updatePickItemDespatchExit($items)
    {
        $params = array();
        if (!is_array($items)) {
            $items = array($items);
        }

        $sql = 'UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = \'Dl\' WHERE PICK_DETAIL_ID IN (';

        foreach ($items as $val) {
            $params[] = $val;
            $sql .= '?, ';
        }
        $sql = substr($sql, 0, -2) . ')';
        $result = $this->execSQL($sql, $params);
        if (false !== $result) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * Update PickItem status to DESPATCHED
     *
     * @param array $items
     * @return boolean
     */
    public function updatePickItemDespatched($items)
    {
        if (!is_array($items)) {
            $items = array($items);
        }

        $sql = 'UPDATE PICK_ITEM_DETAIL SET PICK_DETAIL_STATUS = \'DX\' WHERE PICK_DETAIL_ID IN (';

        foreach ($items as $val) {
            $params[] = $val;
            $sql .= '?, ';
        }
        $sql = substr($sql, 0, -2) . ')';
        $result = $this->execSQL($sql, $params);
        if (false !== $result) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * get list of stocktake lines grouped by SSN
     *
     * @param array $clause
     * @param integer $pageNo
     * @param integer $resultsPerPage
     * @return array
     */
    public function getStocktakeSSNLines($clause = array(), $pageNo = null, $resultsPerPage = null)
    {
        $result = array();
        $sql = 'SELECT
                    PROD_ID,
                    MAX(SSN_DESCRIPTION) AS SSN_DESCRIPTION,
                    ORIGINAL_SSN,
                    SUM(ST_COUNT) AS ST_COUNT,
                    SUM(ST_VARIANCE) AS ST_VARIANCE,
                    WH_ID
                FROM (
                    SELECT
                        ISSN.PROD_ID,
                        SSN.SSN_DESCRIPTION,
                        ISSN.ORIGINAL_SSN,
                        ST_COUNT,
                        ST_WH_ID AS WH_ID,
                        ST_VARIANCE,
                        ST_AUDIT_DATE,
                        ST_COMPANY_ID,
                        ST_AUDIT_BY,
                        ST_DEVICE_ID,
                        ST_LOCN_ID,
                        ST_APPLIED_BY,
                        ST_STATUS,
                        ST_ACTION
                    FROM STOCKTAKE
                    JOIN ISSN ON STOCKTAKE.ST_SSN_ID = ISSN.SSN_ID
                    JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID
                    WHERE ST_ACTION <> \'PA\' AND NOT ST_ACTION LIKE \'I_\')';

        // 2 = NO COMPANY LIMIT
        // 1 = NO WAREHOUSE LIMIT
        // 0 = ALL LIMIT
        $mode = 2;
        $sql .= $this->getWarehouseAndCompanyLimit($mode);

        $values = array();

        foreach ($clause as $key => $val) {
            $sql .= $key;
            if (false !== strpos($key, '?')) {
                $values[] = $val;
            }
        }
        $sql = substr($sql, 0, -5);

        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);

        $sqlQuery .= ' GROUP BY
            PROD_ID,
            ORIGINAL_SSN,
            WH_ID ';

        $sqlQuery .= ' ORDER BY PROD_ID, ORIGINAL_SSN';

        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);
        $result['total'] = $total;
        $result['data']  = array();
        if (count($data) > 0) {
            foreach ($data as $line) {
                $result['data'][] = new StocktakeSSNLine($line);
            }
        }
        return $result;
    }

    /**
     * Retrieve stocktake lines
     *
     * @author Sergey Boroday <sergey.boroday@binary-studio.com>
     *
     * @param array $clause
     * @param integer $pageNo
     * @param integer $resultsPerPage
     * @param array $ssns
     * @return array
     */
    public function getStocktakeISSNLines($clause = null, $pageNo = null, $resultsPerPage = null, $ssns = array())
    {
        $result = array();
        $sql = 'SELECT * FROM (SELECT
            STOCKTAKE.RECORD_ID,
            ST_SSN_ID,
            SSN.SSN_DESCRIPTION,
            ISSN.PROD_ID,
            ST_COUNT,
            ST_VARIANCE,
            ST_STATUS,
            ST_ACTION,
            ST_AUDIT_DATE,
            ST_WH_ID AS WH_ID,
            ST_LOCN_ID,
            ST_AUDIT_BY
        FROM STOCKTAKE
        JOIN ISSN ON STOCKTAKE.ST_SSN_ID = ISSN.SSN_ID
        JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID ';

        $values = array();
        //ST_ACTION <> \'PA\' AND ST_ACTION <> \'IR\'
        // ST_ACTION = \'RC\' AND
        //$sql .= 'WHERE (ST_ACTION = \'RC\' AND 1=1  ';
        $sql .= 'WHERE (ST_ACTION = \'RC\'  ';
        $sql .= 'OR    ST_ACTION = \'AV\' ) AND 1=1 ';
        if (count($ssns) > 0) {
            $sql .= ' AND ISSN.ORIGINAL_SSN IN (';
            foreach ($ssns as $id) {
                $sql .= '?, ';
                $values[] = $id;
            }
            $sql = substr($sql, 0, -2) . ') ';
        }
        $sql .= ') ';
        $sql .= $this->getWarehouseAndCompanyLimit(2);

        foreach ($clause as $key => $val) {
            $sql .= $key;
            if (false !== strpos($key, '?')) {
                $values[] = $val;
            }
        }
        $sql = substr($sql, 0, -5);

        $sql .= ' ORDER BY ST_SSN_ID, RECORD_ID';
        $log = Zend_Registry::get('logger');
        $log->info($sql . ' : ' . implode(', ', $values));

        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);

        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);

        $result['total'] = $total;
        $result['data']  = array();
        if (count($data) > 0) {
            foreach ($data as $line) {
                $result['data'][] = new StocktakeISSNLine($line);
            }
        }
        return $result;
    }

    /**
     * get data into array of LegacyAdjustment models
     *
     * @author Sergey Boroday <sergey.boroday@binary-studio.com>
     *
     * @param array $clause
     * @param integer $pageNo
     * @param integer $resultsPerPage
     * @return array
     */
    public function getLegacyAdjustments($clause, $pageNo = null, $resultsPerPage = null)
    {
        $result = array();

        $values = array();
        $sql = 'SELECT * FROM LEGACY_ADJUSTMENT WHERE 1=1 AND ';

        foreach ($clause as $key => $val) {
            $sql .= $key;
            if (false !== strpos($key, '?')) {
                $values[] = $val;
            }
        }
        $sql = substr($sql, 0, -5);
        $sql .= ' ORDER BY 1';
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        try {
            $total  = $this->findValue($sqlCount, $values);
            $data   = $this->findAllAssocMod($sqlQuery, $values);
        } catch (Exception $e) {
            $log = Zend_Registry::get('logger');
            $log->info($e->getTraceAsString() . PHP_EOL . $e->getMessage());
            return false;
        }
        $result['total'] = $total;
        $result['data']  = array();
        if (count($data) > 0) {
            foreach ($data as $line) {
                $result['data'][] = new LegacyAdjustment($line);
            }
        }
        return $result;
    }

    /**
     * Update status for LEGACY_ADJUSTMENT
     * if success any to -> PA
     * if fails PU -> PV
     *          PV -> PX
     *
     * @param array|integer $ids
     * @param boolean $status
     */
    public function updateAdjustmentStatus($ids, $status)
    {
        $result = array();

        if (null == $ids) {
            $this->lastError = 'Received NULL as RECORD_ID';
            return false;
        }
        if (!is_array($ids)) {
            $ids = array($ids);
        }
        $sql = 'SELECT RECORD_ID, LA_STATUS FROM LEGACY_ADJUSTMENT WHERE RECORD_ID IN (';
        $values = array();
        foreach ($ids as $id) {
            $sql .= '?, ';
            $values[] = $id;
        }
        $sql  = substr($sql, 0, -2) . ')';
        $list = $this->findAllAssocMod($sql, $values);
        if ($list) {
            $updateList = array();
            $inClause   = array();
            $sql = 'UPDATE LEGACY_ADJUSTMENT SET LA_STATUS = ? WHERE RECORD_ID IN (';
            foreach ($list as $record) {
                $updateList[$record['LA_STATUS']][] = $record['RECORD_ID'];
                if (isset($inClause[$record['LA_STATUS']])) {
                    $inClause[$record['LA_STATUS']] .= '?, ';
                } else {
                    $inClause[$record['LA_STATUS']] = '?, ';
                }
            }
            $result[true]  = '';
            $result[false] = '';
            foreach ($inClause as $key => $item) {
                if ($status) {
                    $statusToSet = 'PA';
                } else {
                    if ($key == 'PU') {
                        $statusToSet = 'PV';
                    } elseif ($key == 'PV') {
                        $statusToSet = 'PX';
                    } else {
                        $statusToSet = 'PX';
                    }
                }
                $res = $this->execSQL($sql . substr($item, 0, -2) . ')',
                                      array_merge(array($statusToSet), $updateList[$key]));
                if ($res) {
                    $result[true]  .= implode(',', $updateList[$key]) . ',';
                } else {
                    $result[false] .= implode(',', $updateList[$key]) . ',';
                }
            }
            return $result;
        } else {
            return false;
        }
    }

    public function updateAdjustmentInternalId($list, $internalId)
    {
        $values = array();

        if (!is_array($list)) {
            $list = array($list);
        }

        $sql = 'UPDATE LEGACY_ADJUSTMENT SET LA_INTERNAL_ID = ? WHERE RECORD_ID IN (';
        $values = array($internalId);
        foreach ($list as $id) {
            $sql .= '?, ';
            $values[] = $id;
        }
        $sql  = substr($sql, 0, -2) . ')';

        $res = $this->execSQL($sql, $values);
        return $res;
    }

    /**
     * Returns limiting SQL clause for Warehouse and Company
     *
     * @author Sergey Boroday <sergey.boroday@binary-studio.com>
     *
     * @param ineger  $mode = 0 - all limits (default)| 1 - no warehouse limit| 2 - no company limit
     * @return string
     *-
    public function getWarehouseAndCompanyLimit($mode = 0)
    {
        if ($mode != 2) {
            $sql = '';
            //-- if not limited by company
            if ($this->limitCompany != 'all') {
                $sql .= " WHERE COMPANY_ID = '" . $this->limitCompany . "' AND ";
            } else {
                //-- else assume all Companies accessible to User.
                if ($this->isAdmin || $this->isInventoryOperator) {
                    $sql .= " WHERE ";
                } else {
                    $companyList = $this->getCompanyListLimited();
                    if (count($companyList) > 0 ) {
                        $sql .= ' WHERE COMPANY_ID IN (';
                        foreach ($companyList as $key => $val) {
                            $sql .= "'" . $val . "', ";
                        }
                        $sql = substr($sql, 0, strlen($sql) - 2);
                        $sql .= ') AND ';
                    } else {
                        $sql .= ' WHERE ';
                    }
                }
            }
            $sql .= ' 1=1 AND ';
        } else {
            $sql = ' WHERE 1=1 AND ';
        }

        if ($mode != 1) {
            //-- if not limited by warehouse
            if ($this->limitWarehouse != 'all') {
                $sql .= " WH_ID = '" . $this->limitWarehouse . "' AND ";
            } else {
                $warehouseList = $this->getWarehouseListLimited();
                if (count($warehouseList) > 0 ) {
                    $sql .= " WH_ID IN (";
                    foreach ($warehouseList as $key => $val) {
                        $sql .= "'" . $key . "', ";
                    }
                    $sql = substr($sql, 0, strlen($sql) - 2);
                    $sql .= ") AND ";
                }
            }
            $sql .= ' 1=1 AND ';
        }

        return $sql;
    }
     */

    public function formatWarehouseLimit($tableAlias) {
        $fieldFullName = empty($tableAlias) ? 'WH_ID' : $tableAlias . '.WH_ID';
        if ($this->limitWarehouse !='all') {
            return '(' . $fieldFullName . " = '" . $this->limitWarehouse . "' OR " . $fieldFullName . ' IS NULL OR ' . $fieldFullName . " = '')";
        } else {
            if (!$this->isAdmin) {
                return '(' . $fieldFullName . " IN ('" . implode("', '", $this->getWarehouseListLimited()) . "') OR " . $fieldFullName . ' IS NULL OR ' . $fieldFullName . " = '')";
            }
        }

        return '1 = 1';
    }

    public function formatCompanyLimit($tableAlias) {
        $fieldFullName = empty($tableAlias) ? 'COMPANY_ID' : $tableAlias . '.COMPANY_ID';
        if ($this->limitCompany !='all') {
            return '(' . $fieldFullName . " = '" . $this->limitCompany . "' OR " . $fieldFullName . ' IS NULL OR ' . $fieldFullName . " = '')";
        } else {
            if (!($this->isAdmin || $this->isInventoryOperator)) {
                return '(' . $fieldFullName . " IN ('" . implode("', '", $this->getCompanyListLimited()) . "') OR " . $fieldFullName . ' IS NULL OR ' . $fieldFullName . " = '')";
            }
        }

        return '1 = 1';

    }

    /**
     * Returns limiting SQL clause for Warehouse and Company
     *
     * @author Sergey Boroday <sergey.boroday@binary-studio.com>
     *
     * @param integer  $mode = 0 - all limits (default)| 1 - no warehouse limit| 2 - no company limit
     * @param integer  $addWhere= True - add a Where or And Clause
     * @param integer  $whPrefix  - Prefix for wh_id alias 
     * @param integer  $companyPrefix - Prefix for Company_ID alias 
     * @return string
     */
    public function getWarehouseAndCompanyLimit($mode = 0, $addWhere = True, $whPrefix = '', $companyPrefix = '')
    {
        if ($addWhere) {
        $where = "WHERE";
    } else {
        $where = "AND";
        }
        if ($mode != 2) {
            $sql = '';
            //-- if not limited by company
            if ($this->limitCompany != 'all') {
                    //$sql .= " WHERE COMPANY_ID = '" . $this->limitCompany . "' AND ";
                    $sql .= " " . $where . " " . $companyPrefix ."COMPANY_ID = '" . $this->limitCompany . "' AND ";
            } else {
                //-- else assume all Companies accessible to User.
                if ($this->isAdmin || $this->isInventoryOperator) {
                    //$sql .= " WHERE ";
                    $sql .= " " . $where . " ";
                } else {
                    $companyList = $this->getCompanyListLimited();
                    if (count($companyList) > 0 ) {
                        //$sql .= ' WHERE COMPANY_ID IN (';
                        $sql .= ' ' . $where . ' ' . $companyPrefix . 'COMPANY_ID IN (';
                        foreach ($companyList as $key => $val) {
                            $sql .= "'" . $val . "', ";
                        }
                        $sql = substr($sql, 0, strlen($sql) - 2);
                        $sql .= ') AND ';
                    } else {
                        //$sql .= ' WHERE ';
                        $sql .= ' ' . $where . ' ';
                    }
                }
            }
            $sql .= ' 1=1 AND ';
        } else {
            //$sql = ' WHERE 1=1 AND ';
            $sql = ' ' . $where . ' 1=1 AND ';
        }

        if ($mode != 1) {
            //-- if not limited by warehouse
            if ($this->limitWarehouse != 'all') {
                //$sql .= " WH_ID = '" . $this->limitWarehouse . "' AND ";
                $sql .= " " . $whPrefix . "WH_ID = '" . $this->limitWarehouse . "' AND ";
            } else {
                $warehouseList = $this->getWarehouseListLimited();
//                $warehouseList = $this->whId;
//                $warehouseList = array(($this->whId) => ($this->whId));
                if (count($warehouseList) > 0 ) {
                    //$sql .= " WH_ID IN (";
                    $sql .= " " . $whPrefix . "WH_ID IN (";
                    foreach ($warehouseList as $key => $val) {
                        $sql .= "'" . $key . "', ";
                    }
                    $sql = substr($sql, 0, strlen($sql) - 2);
                    $sql .= ") AND ";
                }
            }
            $sql .= ' 1=1 AND ';
        }

        return $sql;
    }

    public function freezeLocation($whId, $locnId)
    {
        $tran = new Transaction_STLOA();

        $tran->whId       = $whId;
        $tran->locationId = $locnId;

        $result = $this->doTransactionResponse($tran);
        if ($result) {
            $result = explode('|', $result);
        }
        return $result;
    }

    public function releaseLocation($whId, $locnId)
    {
        $tran = new Transaction_STLXA();

        $tran->whId = $whId;
        $tran->locationId = $locnId;
        $result = $this->doTransactionResponse($tran);
        if ($result) {
            $result = explode('|', $result);
        }
        return $result;
    }

    public function updateStocktake($whId, $locnId, $issn, $qty, $first = false)
    {
        if ($first) {
            $tran = new Transaction_STISF();
        } else {
            $tran = new Transaction_STISR();
        }
        $tran->issnCurrentQty = $qty;
        $tran->objectId       = $issn;
        $tran->locationId     = $locnId;
        $tran->whId           = $whId;

        $result = $this->doTransactionResponse($tran);
        if ($result) {
            $result = explode('|', $result);
        }
        return $result;
    }

    public function deleteStocktakeCount($listId)
    {
        $result = array();

        if (!is_array($listId)) {
            $listId = array($listId);
        }

        $transaction = new Transaction_STUAA();
        $transaction->stAction = 'PA';

        foreach ($listId as $id) {
            $transaction->recordId = $id;
            $response = $this->doTransactionResponse($transaction);

            if (false === $response) {
                $result[$id] = $this->lastError;
            } else {
                $result[$id] = $response;
            }
        }

        return $result;
    }

    public function updatePendingStocktake(array $list, $action, $safeupdate = true)
    {
        $result = array();

        $tran = new Transaction_STUAA();
        $i = 0;
        foreach ($list as $id) {
            $i++;
            $lines = $this->getStocktakeISSNLines(array('RECORD_ID = ? AND ' => $id));
            $line = current($lines['data']);

            if ($line['ST_ACTION'][0] != 'I' && $safeupdate) {
                $tran->locationId = $line['ST_LOCN_ID'];
                $tran->objectId   = $line['ST_SSN_ID'];
                $tran->whId       = $line['WH_ID'];
                $tran->recordId   = $line['RECORD_ID'];
                $tran->stAction   = $action;

                $response = $this->doTransactionResponse($tran);
            } else {
                $response = false;
                $this->lastError = 'Can\'t update pending for Pending = \'' . $line['ST_ACTION']. '\'';
            }
            if ($response === false) {
                $result[$line->id] = array($this->lastError);
            } else {
                $result[$line->id] = $response;
            }
        }
        return $result;
    }

    public function applyVariance(array $list)
    {
        $result = array();
        $tran = new Transaction_STAVA();
        $i = 0;
        foreach ($list as $id) {
            $i++;
            $lines = $this->getStocktakeISSNLines(array('RECORD_ID = ? AND ' => $id));
            $line  = current($lines['data']);
            if ($line['ST_ACTION'] == 'AV') {
                $tran->locationId = $line['ST_LOCN_ID'];
                $tran->objectId   = $line['ST_SSN_ID'];
                $tran->whId       = $line['WH_ID'];
                $tran->recordId   = $line['RECORD_ID'];
                $tran->stVariance = $line['ST_VARIANCE'];

                $response = $this->doTransactionResponse($tran);
                if ($response === false) {
                    $result[$line->id] = $this->lastError;
                } else {
                    $result[$line->id] = $response;
                }
            } else {
                $result[$line->id] = 'Not AV action.';
            }
        }
        return $result;
    }

    /**
     * allows output depends on $this->silent mode
     *
     * @param mixed $output
     */
    private function msg($output)
    {
        if (!$this->silent) {
            print_r($output);
        }
    }

    /**
     * get mail list of customers
     *
     * @param string $code
     * @return array
     */
    public function getCustomerMailList($code = 'EMAIL_L_Dl')
    {
        return $this->getOptionsList($code);
    }

    /**
     * get mail list of technicians
     *
     * @param string $code
     * @return array
     */
    public function getTechnicalMailList($code = 'EMAIL_TECH')
    {
        return $this->getOptionsList($code);
    }

    /**
     * returns array of allowed Legacy Locations ID's
     *
     * @return array
     */
    public function getAllowedLegacyLocations()
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
    $result = array();
        //return array('1' => 'X Shed');
    // want wh_legacy_wh_id and wh_legacy_wh_name where wh_legacy_wh_id is not null;
        $sql = 'SELECT WH_LEGACY_WH_ID, WH_LEGACY_WH_NAME
                FROM WAREHOUSE
                WHERE WH_LEGACY_WH_ID IS  NOT NULL ';
        $sql = 'SELECT OPTIONS.DESCRIPTION, COMPANY.LEGACY_NAME
                FROM COMPANY
                JOIN OPTIONS ON OPTIONS.CODE = COMPANY.COMPANY_ID 
                WHERE OPTIONS.GROUP_CODE STARTING \'CmpLocID\' ';

        $rows  = $this->findAllAssocMod($sql );
        foreach ($rows as $row) {
            //$result[$row['WH_LEGACY_WH_ID']] = $row['WH_LEGACY_WH_NAME'];
            $result[$row['DESCRIPTION']] = $row['LEGACY_NAME'];
        }

        $log->info(print_r($result, true));
        return $result;
    }


    /**
     * returns array of allowed Legacy Locations ID's
     *
     * @return array
     */
    public function getAllowedLegacyCompanys()
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
    $result = array();
        $sql = 'SELECT LEGACY_INTERNAL_ID, LEGACY_NAME 
                FROM COMPANY
                WHERE LEGACY_INTERNAL_ID IS  NOT NULL ';

        $rows  = $this->findAllAssocMod($sql );
        foreach ($rows as $row) {
            $result[$row['LEGACY_INTERNAL_ID']] = $row['LEGACY_NAME'];
        }

        $log->info(print_r($result, true));
        return $result;
    }


    /**
     * returns Company ID for  Legacy Department ID
     *
     * @return string
     */
    public function getCompanyIdforLegacyCompany( $legacyCompanyId)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
    $result = '';
        $sql = 'SELECT COMPANY_ID
                FROM COMPANY
                WHERE LEGACY_INTERNAL_ID = ? ';

        $rows  = $this->findAllAssocMod($sql , $legacyCompanyId);
        foreach ($rows as $row) {
            $result = $row['COMPANY_ID'];
        }

        $log->info(print_r($result, true));
        return $result;
    }


    /**
     * returns Company's ISSN Prefix for Legacy Department ID's
     *
     * @return string
     */
    public function getCompanyPrefixforLegacyCompany( $legacyCompanyId)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
    $result = '';
        $sql = 'SELECT COMPANY_ID_PREFIX
                FROM COMPANY
                WHERE LEGACY_INTERNAL_ID = ? ';

        $rows  = $this->findAllAssocMod($sql , $legacyCompanyId);
        foreach ($rows as $row) {
            $result = $row['COMPANY_ID_PREFIX'];
        }

        $log->info(print_r($result, true));
        return $result;
    }


    /**
     * returns Legacy Location ID for wh and company
     *
     * @return string
     */
    public function getLegacyLocationIdforCompany( $WhId, $CompanyId)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $wkGroup = 'CmpLocID' . $WhId;
    $result = '';
        $sql = 'SELECT DESCRIPTION
                FROM OPTIONS
                WHERE GROUP_CODE = ? 
                AND   CODE  = ? ';

        $rows  = $this->findAllAssocMod($sql , $wkGroup, $CompanyId);
        foreach ($rows as $row) {
            $result = $row['DESCRIPTION'];
        }

        $log->info(print_r($result, true));
        return $result;
    }


    public function updatePurchaseOrderField(array $clause, $fieldName, $fieldValue)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info(print_r($clause, true));
        $result = true;
        $params = array($fieldValue);
        //$log->info(print_r($params, true));

        $sql = 'UPDATE PURCHASE_ORDER SET ' . $fieldName . ' = ? WHERE 1=1 AND ';
        foreach ($clause as $key => $val) {
            if (false !== strpos($key, '?')) {
                $params[] = $val;
            }
            $sql .= $key;
        }
        //$sql = substr($sql, 0, -5);

        $log->info($sql . ' : ' . implode(',', $params));
        //$log->info(print_r($params, true));
        $result  = $this->execSQL($sql, $params);
        return $result;
    }

    public function updatePurchaseOrderLine(array $clause, $fieldName, $fieldValue)
    {
        $result = true;
        $params = array($fieldValue);

        $sql = 'UPDATE PURCHASE_ORDER_LINE SET ' . $fieldName . ' = ? WHERE 1=1 AND ';
        foreach ($clause as $key => $val) {
            if (false !== strpos($key, '?')) {
                $params[] = $val;
            }
            $sql .= $key;
        }
        $sql = substr($sql, 0, -5);

        $result  = $this->execSQL($sql, $params);
        return $result;
    }
    
    public function updatePurchaseOrderLineByOrderId($cluase, $orderNo, $lineNo){
        
        $sql = 'UPDATE PURCHASE_ORDER_LINE
                SET ';
        
        $values =   array();
        foreach($cluase as $key => $value){
            $sql       .= $key;
            $values[]   =   $value;
        }
        
        $sql  =   substr($sql, 0, -2);  
        $sql .= ' WHERE PURCHASE_ORDER = ? AND PO_LINE = ?';
            
            $values[]   =   $orderNo;
            $values[]   =   $lineNo;
        
        $result = $this->execSQL($sql, $values);
      
        return $result;     
     }

    /**
     * Get label name for field in views
     *
     * @param string $table
     * @param string $field
     */
    public function getLabelName($domain, $field)
    {
        $domain = strtoupper($domain);
        $field  = strtoupper($field);

        switch ($domain) {
            case 'SSN':
                switch ($field) {
                    case 'GENERIC':
                        $field = 'FIELD_GENERIC';
                       break;
                    case 'BRAND':
                        $field = 'FIELD_BRAND';
                       break;
                    case 'SSN_TYPE':
                        $field = 'FIELD_SSN_TYPE';
                       break;
                    case 'MODEL':
                        $field = 'FIELD_MODEL';
                        break;
                    case 'SUB_TYPE':
                        $field = 'FIELD_SUB_TYPE';
                        break;
                    default:
                        return 'NOTHING';
                    break;
                }
                $domain = 'SSN_GROUP';
                $sql = 'SELECT ' . $field . ' FROM ' . $domain;
            break;
            case 'ISSN':
                switch ($field) {
                    case 'GENERIC':
                        $field = 'FIELD_GENERIC';
                       break;
                    case 'BRAND':
                        $field = 'FIELD_BRAND';
                       break;
                    case 'SSN_TYPE':
                        $field = 'FIELD_SSN_TYPE';
                       break;
                    case 'MODEL':
                        $field = 'FIELD_MODEL';
                        break;
                    case 'SUB_TYPE':
                        $field = 'FIELD_SUB_TYPE';
                        break;
                    default:
                        return 'NOTHING';
                    break;
                }
                $domain = 'SSN_GROUP';
                $sql = 'SELECT ' . $field . ' FROM ' . $domain;
            break;
            default:
                $sql = false;
            break;
        }

        if ($sql) {
            $result = $this->findValue($sql);
        } else {
            $result = false;
        }
        return $result;
    }
    /**
    * @desc get date of selected ISSN
    * @param array selected ISSN ids
    * @param int $pagNo - number of selected page
    * @param int $resultsPerPage - total records showing per page
    * @return array ISNN id
    */
    public function getSsnDates($issnId, $pageNo = null, $resultsPerPage = null) {

        $sql = 'SELECT LOAN_DUE_DATE, LOAN_RETURN_DATE, SSN.SSN_ID
                FROM LOAN_ORDER_LINE
                LEFT JOIN SSN ON (SSN.SSN_ID = LOAN_ORDER_LINE.SSN_ID)
                WHERE SSN.PROD_ID IS NULL AND ';


        if(count($issnId) > 0) {
            $sql .= '(';
        }

        for($i=0; $i<count($issnId); $i++) {
            $sql .= 'SSN.SSN_ID = ? OR ';
        }

        $sql = substr($sql, 0, -4);
        if(count($issnId) > 0) {
            $sql .= ')';
        }

        $data  = $this->findAllAssocMod($sql, $issnId);

        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        $total  = $this->findValue($sqlCount, $issnId);
        $data   = $this->findAllAssocMod($sqlQuery, $issnId);
        $result['total'] = $total;
        $result['data']  = $data;

        return $result;
    }
    /**
    * @desc get date of selected PICK_ITEMS
    * @param array selected PICK_ITEM ids
    * @param int $pagNo - number of selected page
    * @param int $resultsPerPage - total records showing per page
    * @return array ISNN id
    */
    public function getPickItemDates($pickItems) {
   
        $data = array();
        $sql = 'SELECT *
                FROM PICK_ITEM
                WHERE PICK_LINE_DUE_DATE IS NOT NULL AND 
                      RETURN_DATE IS NOT NULL AND ';

        if(count($pickItems) > 0) {
            $sql .= '(';
        }

        for($i=0; $i<count($pickItems); $i++) {
            $sql .= 'PICK_LABEL_NO = ? OR ';
        }

        $sql = substr($sql, 0, -4);
        if(count($pickItems) > 0) {
            $sql .= ')';
        }
   
        $pickItems  = $this->findAllAssocMod($sql, $pickItems);
        foreach($pickItems as $pickItem) {
            // search PRODUCT or NON PRODUCT
            if(!empty($pickItem['PROD_ID']) && !is_null($pickItem['PROD_ID'] && $pickItem['PROD_ID'] !='')) {
                /*$sql = "SELECT *
                        FROM PICK_ITEM
                        LEFT OUTER JOIN PICK_ORDER ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER
                        WHERE PICK_ORDER.PICK_STATUS NOT IN ('UP', 'UC') AND
                              PICK_ITEM.PICK_LINE_DUE_DATE IS NOT NULL AND 
                              PICK_ITEM.RETURN_DATE IS NOT NULL AND
                              PICK_ITEM.RETURN_DATE >= ? AND PICK_ITEM.PICK_LINE_DUE_DATE <= ? AND 
                              PICK_ITEM.PROD_ID = ? AND PICK_ITEM.PICK_ORDER <> ?  ";
             
                $dep = $this->findAllAssoc($sql, $pickItem['PICK_LINE_DUE_DATE'], $pickItem['RETURN_DATE'], 
                                                 $pickItem['PROD_ID'], $pickItem['PICK_ORDER']);
                $data[$pickItem['PICK_LABEL_NO']] = array(array('PICK_LINE_DUE_DATE' => $pickItem['PICK_LINE_DUE_DATE'], 
                                                                'RETURN_DATE'        => $pickItem['RETURN_DATE'],
                                                                'PICK_ORDER'         => $pickItem['PICK_ORDER']),
                                                                'PROD_ID'            => $pickItem['PROD_ID'], $dep);
                */
                continue;  
            } else {
                $sql = "SELECT *
                        FROM PICK_ITEM
                        LEFT OUTER JOIN PICK_ORDER ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER
                        WHERE PICK_ORDER.PICK_STATUS NOT IN ('UP', 'UC') AND
                              PICK_ITEM.PICK_LINE_DUE_DATE IS NOT NULL AND 
                              PICK_ITEM.RETURN_DATE IS NOT NULL AND
                              PICK_ITEM.RETURN_DATE >= ? AND PICK_ITEM.PICK_LINE_DUE_DATE <= ? AND
                              PICK_ITEM.SSN_ID = ? AND PICK_ITEM.PICK_ORDER <> ? ";
              
                $dep = $this->findAllAssoc($sql, $pickItem['PICK_LINE_DUE_DATE'], $pickItem['RETURN_DATE'], 
                                                 $pickItem['SSN_ID'], $pickItem['PICK_ORDER']);
                $data[$pickItem['PICK_LABEL_NO']] = array(array('PICK_LABEL_NO'      => $pickItem['PICK_LABEL_NO'],
                                                                'PICK_LINE_DUE_DATE' => $pickItem['PICK_LINE_DUE_DATE'], 
                                                                'RETURN_DATE'        => $pickItem['RETURN_DATE'],
                                                                'PICK_ORDER'         => $pickItem['PICK_ORDER'],
                                                                'SSN_ID'             => $pickItem['SSN_ID']), $dep);  
            }
        }
        
        return $data;
    }
    /**
    * @desc get date of selected SSNS
    * @param array selected SSNS ids
    * @param int $pagNo - number of selected page
    * @param int $resultsPerPage - total records showing per page
    * @return array ISNN id
    */
    public function getSsnItemDates($ssnItems) {
   
        $data = array();
        
        foreach($ssnItems as $ssnItem) {
            $sql = 'SELECT *
                    FROM PICK_ITEM
                    WHERE SSN_ID = ? ';
            $pickItems = $this->findAllAssocMod($sql, $ssnItem);
            $data[$ssnItem] =   $pickItems;
        }
        
        return $data;
    }
    /**
    * @desc method return company id of current company
    * @param void
    * @return string $companyId
    */
    public function getCompanyName() {
        $sql = 'SELECT COMPANY_ID
                FROM CONTROL
                WHERE RECORD_ID = 1';

        $data = $this->findValue($sql);
        return strtolower($data);
    }
   /**
   * Return a list of pick orders
   *
   * @param $q filter for pick orders
   *
   * @return array
   */
    public function getPickOrdersIdList($q = null, $orderType = 'SO',  $orderBy = 'PICK_ORDER')
    {
        $result = array();
        if ($q ==! null) {
            $q = '%' . strtoupper($q) . '%';
            $sql = "SELECT PICK_ORDER AS ORDER_KEY, PICK_ORDER AS ORDER_VALUE
                    FROM PICK_ORDER
                    WHERE PICK_ORDER_TYPE = '" . $orderType . "'
                          AND UPPER(PICK_ORDER) LIKE ?
                    ORDER BY " . $orderBy;

            $result = $this->findList($sql, $q);
        }
        return $result;
    }

    public function getGenerateSsnMethod()
    {
        $result = array();
        $sql   = 'SELECT GENERATE_SSN_METHOD FROM CONTROL';
        $value = $this->findValue($sql);
        if ($value) {
            $list  = explode('|', $value);
        } else {
            foreach ($list as $value) {
                list($key, $val) = explode('=', $value);
                $result[$key]    = $val;
            }
        }
        return $result;
    }

    /**
    * @desc get param data for validation field
    * 
    * @param string $field - fild name to validate
    * @param boolean $all - true - get all rows for current field
    * 
    * @return array validation params  
    */
    public function getValidationParams($field, $all = false)
    {
        if($all === false) {
            $sql = 'SELECT DATA_EXPRESSION FROM PARAM WHERE DATA_ID = \'' . $field . '\'';
            return $this->findValue($sql);
        } else {
            $sql    = 'SELECT * FROM PARAM WHERE DATA_ID = \'' . $field . '\'';
            $result =  $this->findOneAssoc($sql);
            $result['SYMBOLOGY_PREFIX'] =  explode(";", $result['SYMBOLOGY_PREFIX']);
            $result['SYMBOLOGY_PREFIX'] =  $result['SYMBOLOGY_PREFIX'][0];
        
            return $result;
        }
    }
    
    public function getBarcodeScannerParamsByCode($code = null, $force_type = null)
    {
        if ($code === null) {
            return $code;
        }
        
        if ($force_type==null) {
            $sql    = "SELECT * FROM PARAM WHERE SYMBOLOGY_PREFIX LIKE '%$code;%' ";
        } else {
            $sql    = "SELECT * FROM PARAM WHERE SYMBOLOGY_PREFIX LIKE '%$code;%' AND DATA_ID = '$force_type'";
        }
        if (false !== ($result =  ibase_query($sql))) {
            $row = ibase_fetch_assoc($result);
            ibase_free_result($result);
            return $row;
        }
        else {
            return array();
        }
    }
    
    public function getAllBarcodeScannerParamsByCode($code = null)
    {
        if ($code === null) {
            return $code;
        }
        
        $sql = "SELECT DATA_ID FROM PARAM WHERE SYMBOLOGY_PREFIX LIKE ?";
        
        return $this->fetchAllAssoc($sql, "%$code%");
    }    

    /**
     * Update specified PURCHASE_ORDER to specified status
     *
     * @param string $purchaseOrderNo
     * @param string $status
     * @return boolean
     */
    public function updatePurchaseOrderStatus($purchaseOrderNo, $status)
    {
        $sql = 'UPDATE PURCHASE_ORDER SET PO_STATUS = ? WHERE PURCHASE_ORDER = ?';

        return $this->execSQL($sql, array($status, $purchaseOrderNo));
    }

    /**
     * Get Purchase Line Detail IDs for a status to Legacy awaiting Send
     *
     * @param string $status
     * @param boolean $thisDevice
     * @return array
     */
    public function getPurchaseLineDetailId($status = 'DL', $device = null)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $sql = 'SELECT
                    PLD.PURCHASE_DETAIL_ID
                    FROM PURCHASE_LINE_DETAIL AS PLD
                WHERE PLD.PURCHASE_DETAIL_STATUS = \'' . $status . '\'';
    if ($device !== null) {
            $sql .= '        AND PLD.DEVICE_ID = \'' . $device . '\'';
    }
        //$sql .= ' ORDER BY PID.CREATE_DATE';
        $sql .= ' ORDER BY PLD.PURCHASE_ORDER';
        $sql .= ' , PLD.PO_LINE';
        $result = $this->findAllAssocMod($sql);

        //$log->info($sql . ' : ' . implode(',', $result));
        //$log->info('print_r result');
        //$log->info(print_r($result, true));
        $data = array();
        foreach ($result as $key => $val) {
            {
                        $fields = strtoupper($key)  ;
                //$log->info('result record key:' . $key . ':' . implode(',', $val));
                foreach ($val as $keyField => $valField) {
                    //$log->info('val record key:' . $keyField . ':' . implode(',', $valField));
                            $data[] = $valField;
                }
            }
        }
        $log->info('data:' . implode(',', $data));
        //return $result;
        return $data;
    }

    /**
     * Add PurchaseLineDetails
     *
     * @param array $lines
     * @return boolean
    */
    public function addPurchaseLineDetails($lines)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        if (!is_array($lines)) {
            $lines = array($lines);
        }

        $result = false;

        foreach ($lines as $key => $obj) {
            $log->info('about to add po_line_detail ' . $obj['PURCHASE_ORDER'] . ':' . $obj['PO_LINE'] . ':' . $obj['SSN_ID']);

                $sql = 'INSERT INTO PURCHASE_LINE_DETAIL (';
                $fields = '';
                $values = '';
                $params = array();
                foreach ($obj->items as $key => $val) {
                    if ($key !== 'tranId') {
                        $fields .= strtoupper($key)  . ', ';
                        $params[] = $val;
                        $values .= '?, ';
                    }
                }

                $fields = substr($fields, 0, -2);
                $values = substr($values, 0, -2);
                $sql .= $fields . ') VALUES (' . $values . ')';
                $result = $this->execSQL($sql, $params);

                $this->lastError = 'Purchase Order Line Detail updated.';
        }

        if (false !== $result) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * Update Purchase Line Detail status to 
     *
     * @param array $items
     * @param status $string
     * @return boolean
     */
    public function updatePurchaseLineDetailStatus($items, $status = 'DL')
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $params = array();
        if (!is_array($items)) {
            $items = array($items);
        }

        $sql = 'UPDATE PURCHASE_LINE_DETAIL SET PURCHASE_DETAIL_STATUS = \'' . $status . '\' WHERE PURCHASE_DETAIL_ID IN (';

        foreach ($items as $val) {
            $params[] = $val;
            $sql .= '?, ';
        }
        $sql = substr($sql, 0, -2) . ')';
        //$log->info($sql . ' : ' . implode(',', $params));
        $log->info('print_r items');
        $log->info(print_r($items, true));
        $result = $this->execSQL($sql, $params);
        if (false !== $result) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * get getPurchaseLineDetail from PURCHASE_LINE_DETAIL by PURCHASE_DETAIL_STATUS
     *
     * @param string $status
     * @return array
     */
    public function getPurchaseLineDetail($status = 'DL', $wipstatus = 'RC')
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $sql = 'SELECT
                    PLD.PURCHASE_DETAIL_ID,
                    PI.PO_LEGACY_LINE,
                    PI.PROD_ID,
                    PO.PO_RECEIVE_WH_ID, 
                    PO.PO_RECEIVE_WH_NAME, 
                    PO.PO_LEGACY_RECEIVE_WH_ID, 
                    PO.PO_LEGACY_RECEIVE_WH_NAME, 
                    PO.PO_LEGACY_INTERNAL_ID,
                    PLD.SSN_ID,
                    PLD.QTY_RECEIVED,
                    PI.PURCHASE_ORDER,
                    PI.PO_LINE,
                    SSN.ORIGINAL_QTY,
                    PO.PO_LEGACY_RECV_ID
                    FROM PURCHASE_LINE_DETAIL AS PLD
                JOIN PURCHASE_ORDER_LINE AS PI ON PI.PURCHASE_ORDER = PLD.PURCHASE_ORDER AND PI.PO_LINE = PLD.PO_LINE
                JOIN PURCHASE_ORDER AS PO ON PO.PURCHASE_ORDER = PLD.PURCHASE_ORDER
                JOIN ISSN ON ISSN.SSN_ID = PLD.SSN_ID
                JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID
                WHERE PLD.PURCHASE_DETAIL_STATUS = \'' . $status . '\'';
         $sql .= ' AND (PO.PO_LEGACY_RECV_ID IS NULL)';  
         $sql .= ' AND (NOT EXISTS (SELECT P2.PURCHASE_DETAIL_ID FROM PURCHASE_LINE_DETAIL P2 WHERE P2.PURCHASE_ORDER = PLD.PURCHASE_ORDER AND P2.PURCHASE_DETAIL_STATUS = \'' . $wipstatus . '\'))';  
         //$sql .= ' AND (NOT EXISTS (SELECT P3.PURCHASE_ORDER FROM PURCHASE_ORDER_LINE P3 WHERE P3.PURCHASE_ORDER = PLD.PURCHASE_ORDER AND P3.PO_LINE_STATUS = \'' . $polstatus . '\' AND (P3.ORIGINAL_QTY IS NULL OR P3.PO_LINE_QTY = P3.ORIGINAL_QTY) ))';  
        //$sql .= ' ORDER BY PID.CREATE_DATE';
        $sql .= ' ORDER BY PLD.PURCHASE_ORDER';
        $sql .= ' , PI.PO_LINE';
        $sql .= ' , ISSN.ORIGINAL_SSN';
        $result = $this->findAllAssocMod($sql);
        $data   = array();
        $purchaseLineDetailsToDropStatus = array();
        foreach ($result as $key => $line) {
                $ssnId      = $line['SSN_ID'];
                //$this->msg($ssnId);
                $original   = $this->getOriginalSsn($ssnId);
                //$this->msg($original);
                try {
                    $this->msg($ssnId . ' = trying to get additional detail' . PHP_EOL);
                    //$prodId = $this->getProdIdBySSN($ssnId);
                    $prodId = $this->getProdIdBySSN($original);
                    if ($prodId) {
                        $line['SSN.PROD_ID'] = $prodId;
                    } else {
                        throw new Exception($ssnId . ' = no prod for this SSN');
                    }
                } catch (Exception $e) {
                    $line['SSN.PROD_ID'] = $ssnId . ' = no prod for this SSN';
                    $this->msg('fails - ' . $e->getMessage() . PHP_EOL);
                }
                $line['RECEIVE_ID'] = '1';
                $line['SSN_ID'] = $original;
                $result[$key]   = $line;
                //$data[$original]['QTY_RECEIVED'] = 0;
                $data[$line['RECEIVE_ID']][$original]['QTY_RECEIVED'] = 0;
        }

        $log->info('result:');
        $log->info(print_r($result));
        foreach ($result as $line) {
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['QTY_RECEIVED'] += $line['QTY_RECEIVED'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PURCHASE_ORDER']        = $line['PURCHASE_ORDER'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_LEGACY_INTERNAL_ID'] = $line['PO_LEGACY_INTERNAL_ID'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_LEGACY_LINE']        = $line['PO_LEGACY_LINE'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PROD_ID']               = $line['PROD_ID'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['SSN.PROD_ID']           = $line['SSN.PROD_ID'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['ORIGINAL_QTY']          = $line['ORIGINAL_QTY'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PURCHASE_DETAIL_ID'][]  = $line['PURCHASE_DETAIL_ID'];
            //$data[$line['RECEIVE_ID']][$line['SSN_ID']]['WH_ID']               = $line['WH_ID'];
            //$data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_RECEIVE_WH_ID']      = $line['PO_RECEIVE_WH_ID'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_LEGACY_RECEIVE_WH_ID']      = $line['PO_LEGACY_RECEIVE_WH_ID'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_LINE']               = $line['PO_LINE'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_LEGACY_RECV_ID']     = $line['PO_LEGACY_RECV_ID'];
        }

        $log->info('data after new orders:');
        //$log->info(print_r($data));
        $sql = 'SELECT
                    PLD.PURCHASE_DETAIL_ID,
                    PI.PO_LEGACY_LINE,
                    PI.PROD_ID,
                    PO.PO_RECEIVE_WH_ID, 
                    PO.PO_RECEIVE_WH_NAME, 
                    PO.PO_LEGACY_RECEIVE_WH_ID, 
                    PO.PO_LEGACY_RECEIVE_WH_NAME, 
                    PO.PO_LEGACY_INTERNAL_ID,
                    SSN.SSN_ID,
                    PLD.QTY_RECEIVED,
                    PI.PURCHASE_ORDER,
                    PI.PO_LINE,
                    SSN.ORIGINAL_QTY,
                    PO.PO_LEGACY_RECV_ID
                    FROM PURCHASE_LINE_DETAIL AS PLD
                JOIN PURCHASE_ORDER AS PO ON PO.PURCHASE_ORDER = PLD.PURCHASE_ORDER
                JOIN PURCHASE_ORDER_LINE AS PI ON PI.PURCHASE_ORDER = PLD.PURCHASE_ORDER 
                JOIN SSN ON PO.PURCHASE_ORDER = SSN.PO_ORDER AND PI.PO_LINE = SSN.PO_LINE
                WHERE PLD.PURCHASE_DETAIL_STATUS = \'' . $status . '\'';
         $sql .= ' AND (PO.PO_LEGACY_RECV_ID IS NOT NULL)';  
         $sql .= ' AND (NOT EXISTS (SELECT P2.PURCHASE_DETAIL_ID FROM PURCHASE_LINE_DETAIL P2 WHERE P2.PURCHASE_ORDER = PLD.PURCHASE_ORDER AND P2.PURCHASE_DETAIL_STATUS = \'' . $wipstatus . '\'))';  
        $sql .= ' ORDER BY PLD.PURCHASE_ORDER';
        $sql .= ' , PI.PO_LINE';
        $sql .= ' , SSN.SSN_ID';
        $result = $this->findAllAssocMod($sql);
        foreach ($result as $key => $line) {
                $ssnId      = $line['SSN_ID'];
                //$this->msg($ssnId);
                //$original   = $this->getOriginalSsn($ssnId);
                $original   = $ssnId;
                //$this->msg($original);
                try {
                    //$this->msg($ssnId . ' = trying to get additional detail' . PHP_EOL);
                    //$prodId = $this->getProdIdBySSN($ssnId);
                    $prodId = $this->getProdIdBySSN($original);
                    if ($prodId) {
                        $line['SSN.PROD_ID'] = $prodId;
                    } else {
                        throw new Exception($ssnId . ' = no prod for this SSN');
                    }
                } catch (Exception $e) {
                    $line['SSN.PROD_ID'] = $ssnId . ' = no prod for this SSN';
                    $this->msg('fails - ' . $e->getMessage() . PHP_EOL);
                }
                $line['RECEIVE_ID'] = '2';
                $line['SSN_ID'] = $original;
                $result[$key]   = $line;
                //$data[$original]['QTY_RECEIVED'] = 0;
                $data[$line['RECEIVE_ID']][$original]['QTY_RECEIVED'] = 0;
        }

        $log->info('result:');
        //$log->info(print_r($result));
        foreach ($result as $line) {
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['QTY_RECEIVED'] += $line['QTY_RECEIVED'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PURCHASE_ORDER']        = $line['PURCHASE_ORDER'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_LEGACY_INTERNAL_ID'] = $line['PO_LEGACY_INTERNAL_ID'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_LEGACY_LINE']        = $line['PO_LEGACY_LINE'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PROD_ID']               = $line['PROD_ID'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['SSN.PROD_ID']           = $line['SSN.PROD_ID'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['ORIGINAL_QTY']          = $line['ORIGINAL_QTY'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PURCHASE_DETAIL_ID'][]  = $line['PURCHASE_DETAIL_ID'];
            //$data[$line['RECEIVE_ID']][$line['SSN_ID']]['WH_ID']               = $line['WH_ID'];
            //$data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_RECEIVE_WH_ID']      = $line['PO_RECEIVE_WH_ID'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_LEGACY_RECEIVE_WH_ID']      = $line['PO_LEGACY_RECEIVE_WH_ID'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_LINE']               = $line['PO_LINE'];
            $data[$line['RECEIVE_ID']][$line['SSN_ID']]['PO_LEGACY_RECV_ID']     = $line['PO_LEGACY_RECV_ID'];
        }

        $log->info('data:');
        //$log->info(print_r($data));
        return $data;
    }

//========End of Purchase Line Details==============

    public function addIssnFromSsn($ssnId)
    {
         $sql = 'EXECUTE PROCEDURE ADD_ISSN_FROM_SSN(?)';

         return $this->execSQL($sql, $ssnId);
    }

    /**
    * @desc get all data from LOAN_RATE table
    * @param void
    * @return data
    */
    public function getLoanRateData($table = null) {
        $sql = 'SELECT * FROM LOAN_RATE ';
        $tabList = $this->getTableList();
        if (null !== $table && array_key_exists($table, $tabList)) {
            $sql.= 'WHERE LR_APPLIED_TO LIKE \'' . $table . '.%\'';
        }
        $result = $this->findAllAssocMod($sql);
        if ($result) {
            foreach ($result as &$val) {
                $val['LR_APPLIED_TO'] = substr(strstr($val['LR_APPLIED_TO'], '.'), 1);
            }
        }
        return $result;
    }
    /**
    * @desc update PICK ISSN ITEM after add(FROM ADD PRODUCT or NON PRODUCT) button
    * @param string $pickOrder
    * @param string $issnId
    * @param array $params - params to update
    * @param string S - SSN or P - PRODUCT
    * @return void
    */
    public function updatePickIssnItemFileds($pickOrder, $issnId, $params, $type = 'S') {
            
        $values = array();
             
        $sql = 'UPDATE PICK_ITEM 
                SET ';
            
        foreach($params as $key => $val) {
                $values[]   =   $val;
                $sql .= $key . ' = ?, ';
        }
            $values[] = $pickOrder;
            $values[] = $issnId;   
        
        $sql = substr($sql, 0, strlen($sql)-2);
        if($type === 'P') {
            $sql.= ' WHERE PICK_ORDER = ? AND PROD_ID = ?';
        } else {
            $sql.= ' WHERE PICK_ORDER = ? AND SSN_ID = ?';
        }
        
        $result = $this->execSQL($sql, $values);        
        if(!$result) {
            throw new Exception('Unable update data of PICK_ITEM - '. $issnId);
        }
    }
    /**
     * Update Pick Item status to  WP for lines able to be worked on
     *
     * @param Order $string
     * @param status $string
     * @return boolean
     */
    public function updatePickItemStatus($Order, $status = 'WP')
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $sql = 'SELECT CAN_GET_ORDER_PICK_STATUS FROM CONTROL';
        if (false == ($allowedStatus = $this->findValue($sql))) {
            throw new Exception("Can't read default Allowed Pick Statuses That can be Worked On");
        }
        $params = array();

        $sql = 'UPDATE PICK_ITEM SET PREV_LINE_STATUS=PICK_LINE_STATUS,PICK_LINE_STATUS = ? WHERE PICK_ORDER = ? AND POS( ? ,PICK_LINE_STATUS,0,1) > -1';

        $params[] = $status;
        $params[] = $Order;
        $params[] = $allowedStatus;
        $result = $this->execSQL($sql, $params);
        if (false !== $result) {
            return true;
        } else {
            return false;
        }
    }

    /**
     * Update Pick Item status to  Previous Status for lines not to be worked on
     *
     * @param Order $string
     * @param status $string
     * @return boolean
     */
    public function updatePickItemStatusBack($Order, $fromStatus = 'WP', $toStatus = Null)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $params = array();
    if ($toStatus == Null) {
            $sql = 'UPDATE PICK_ITEM SET PICK_LINE_STATUS = PREV_LINE_STATUS WHERE PICK_ORDER = ? AND PICK_LINE_STATUS = ? ';
            $params[] = $Order;
            $params[] = $fromStatus;
    } else {
            $sql = 'UPDATE PICK_ITEM SET PICK_LINE_STATUS = ? WHERE PICK_ORDER = ? AND PICK_LINE_STATUS = ? ';
            $params[] = $toStatus;
            $params[] = $Order;
            $params[] = $fromStatus;
    }
        $result = $this->execSQL($sql, $params);
        if (false !== $result) {
            return true;
        } else {
            return false;
        }
    }


    /**
    * @desc get value of SALE_PRICE for Issn
    * @param string $issnId
    * @return float $salePrice 
    */
    public function getSalePriceForIssn($issnId) {
      
        $salePrice = null;
        $sql = 'SELECT * 
                FROM PROD_PROFILE
                WHERE PROD_ID = ?';
        try{
            $data = $this->findOneAssoc($sql, $issnId);
        } catch (Exception $e) {
            throw new Exception('PROD_PROFILE.SALE_PRICE for SSN - ' . $issnId . ' is empty '); 
        }
    
        return $data['SALE_PRICE'];
    }
    
    /**
    * @desc     get history list for current SSN
    * @param    string $ssnId
    * @param    int    $pageNo
    * @param    int    $resultsPerPage
    * @param    bool   remove lecense condition 
    * 
    * @return   struct $result['data'] - selected data
    *                  $result['result'] - total count of data 
    */
    public function getHistoryList($ssnId, $pageNo = null, $resultsPerPage = null, $all = true) {
        
        $config = Zend_Registry::get('config');
        
        if ($all) {
            
            $sql = "SELECT *
                    FROM SSN_HIST
                    WHERE SSN_ID = ? AND
                          TRN_TYPE IN (
                                        SELECT CODE FROM OPTIONS WHERE GROUP_CODE ='SSN_HISTRY'
                                      )";
        
        } else {
            
            $sql = "SELECT *
                    FROM SSN_HIST
                    WHERE SSN_ID = ? AND
                          TRN_TYPE IN (
                                        SELECT DESCRIPTION
                                        FROM OPTIONS
                                        WHERE GROUP_CODE = '" . strtoupper($config->company->licensee) . "' AND CODE LIKE '%SSN_HISTORY%'
                                      ) ";
            
        }
        
        $sql    .=  ' AND LOCN_ID <> ? ORDER BY trn_date DESC';

        $log = Zend_Registry::get('logger');
        $log->info($sql . ' : ' . $ssnId);
        
        if (false === ($values = $this->prepareArgs($sql, array(0 => $ssnId, 1 => $this->defaultControlValues['NEW_LABEL_LOCN_ID'])))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);

        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);

        $result['total'] = $total;
        $result['data']  = array();
        if (count($data) > 0) {
            foreach ($data as $line) {
                $result['data'][] = new HistorySsnLine($line);
            }
        }
    
        return $result; 
    }
    
    public function getUoms($type = '')
    {
        if(!empty($type)){
            $sql = "SELECT CODE, DESCRIPTION FROM UOM WHERE UOM_TYPE = ?";
            $result = ibase_query ( $this->db, $sql, $type );    
        } else {
            $sql = "SELECT CODE, DESCRIPTION FROM UOM";
            $result = ibase_query ( $this->db, $sql);    
        }

        $d = array();

        if (false !== $result) {
            while ($row = ibase_fetch_assoc($result)) {
                $d[$row['CODE']] = $row['DESCRIPTION'];
            }
            ibase_free_result($result);
        }
        
        return $d;
    }
    
    /**
    * Return detailed information about UOMs. 
    * (getUoms() return only CODE and Descriptionm but I need more detailed information and I dont want
    * modify getUoms() as it is already used by several controllers, so I will create another one method)
    * 
    */
    public function getUomsDescription($filter = array()) {
        $sql  = 'SELECT CODE, DESCRIPTION, UOM_TYPE, TO_STANDARD_CONV FROM UOM';
        $args = array();
        
        if (count($filter) > 0) {
            $sql .= ' WHERE ' . implode(' AND ', array_keys($filter));
            
            $args = array_reduce($filter, create_function('$data, $item', '$data = is_array($data) ? $data : array(); return array_merge($data, array_values($item));'), $args);
        }
        array_unshift($args, $sql);
        
        $uoms = array();
        $result = call_user_func_array(array($this, 'fetchAllAssoc'), $args);
        foreach ($result as $row) {
            $uoms[$row['CODE']] = $row;
        }
        
        return $uoms;
    }
    
    /**
    * Return detailed information about UOM Types. 
    * 
    */
    public function getUomTypes($filter = array()) {
        $sql  = 'SELECT CODE, DESCRIPTION, STANDARD_UOM FROM UOM_TYPE';
        $args = array();
        
        if (count($filter) > 0) {
            $sql .= ' WHERE ' . implode(' AND ', array_keys($filter));
                                                                                                 
            $args = array_reduce($filter, create_function('$data, $item', '$data = is_array($data) ? $data : array(); return array_merge($data, array_values($item));'), $args);
        }
        array_unshift($args, $sql);

        $types = array();
        $result = call_user_func_array(array($this, 'fetchAllAssoc'), $args);
        foreach ($result as $row) {
            $types[$row['CODE']] = $row;
        }
        
        return $types;
    }
    
    /**
    * @desc method send data to print Location Label's
    * 
    * @param array $location
    * @param string $printer
    * @return boolean
    */
    public function printLocationLabel($printer, $locations) {

        $sql     = "EXECUTE PROCEDURE PC_LABEL_LOCATION(?)";
        $query   = ibase_prepare($this->db, $sql);
        $toPrint = $printer;
        
        foreach($locations as $location) {
            $toPrint .= $location->items['WH_ID'] .  $location->items['LOCN_ID'] . '|';
        }

        $result = ibase_execute($query, $toPrint);
        if($result !== false) {
            ibase_free_result($result);
            ibase_free_query($query);

            return true;
        }
        else {
            ibase_free_query($query);
            return false;
        }
    }
    
    public function getPickModes()
    {
        $sql = "SELECT * FROM PICK_MODE ORDER BY PICK_MODE_NO ASC";
        
        $rows = $this->findAllAssocMod($sql);
        
        $result['data'] = $rows;
        $result['total'] = count($rows);

        return $result;
    }
    
    
    public function pickMode($mode, $order_types = null, $order_modes = null, $orders = null, $order_statuses = null, $order_prioritys = null, $ids = null)
    {
        $sql = "SELECT * FROM $mode(?, ?, ?, ?, ?, ?)";
        
        $stmt = ibase_query($this->db, $sql, $order_types, $order_modes, $orders, $order_statuses, $order_prioritys, $ids); 

        $rows = array();
        $result = array();

        if (false !== $stmt) {
        
            while ($row = ibase_fetch_assoc($stmt)) {
                $rows[] = $row;
            }

            $result['data'] = $rows;
            $result['total'] = count($rows);

            ibase_free_result($stmt);
        }
        
        return $result;
    }
    /**
    * @desc get description for selected sys equipment
    * @param  string $deviceId
    * 
    * @return string $description
    */
    public function getSysEquipDescription($deviceId) {
        
        $sql = "SELECT EQUIPMENT_DESCRIPTION_CODE
                FROM SYS_EQUIP
                WHERE DEVICE_ID = '" . $deviceId ."'";
        
        return $this->findValue($sql);
    
    
    }
        
    public function getMoveableLocations() {
        $sql = '
            SELECT 
                LOCATION.WH_ID, 
                LOCATION.LOCN_ID,
                LOCATION.LOCN_STAT,
                LOCATION.LOCN_NAME,
                LOCATION.LOCN_TYPE
            FROM 
                SYS_EQUIP 
                JOIN LOCATION ON LOCATION.LOCN_ID STARTING SYS_EQUIP.DEVICE_ID
            WHERE 
                SYS_EQUIP.DEVICE_TYPE = ?
                AND (LOCATION.WH_ID NOT STARTING ?)
                AND LOCATION.MOVEABLE_LOCN = ?
        ';
        
        $rows = $this->findAllAssocMod($sql, 'TR', 'X', 'T');
        
        $result['data'] = $rows;
        $result['total'] = count($rows);

        return $result;
    }
    
    public function getLocationsForAssemblyScreen()
    {
        $wh_id = $this->limitWarehouse;
        if ($wh_id=='all') {
            $sql = "SELECT location.locn_id, locn_stat, locn_name, issn.prod_id
                FROM location
                LEFT OUTER JOIN issn ON issn.locn_id = location.locn_id
                WHERE  moveable_locn = 'T' AND locn_type ='TF'";
        } else {
            $sql = "SELECT location.locn_id, locn_stat, locn_name, issn.prod_id
                FROM location
                LEFT OUTER JOIN issn ON issn.locn_id = location.locn_id 
                WHERE location.wh_id = '$wh_id' AND moveable_locn = 'T' AND locn_type ='TF'";           
        }
        
        
        $rows = $this->findAllAssocMod($sql);
        
        $result['data'] = $rows;
        $result['total'] = count($rows);

        return $result;
    }
    
    public function getLRLocationsForAssemblyScreen()
    {
        $wh_id = $this->limitWarehouse;
        if ($wh_id=='all') {
            $sql = "SELECT location.locn_id, locn_stat, locn_name, issn.prod_id
                FROM location
                LEFT OUTER JOIN issn ON issn.locn_id = location.locn_id
                WHERE  moveable_locn = 'T' AND locn_type ='TV'";
        } else {
            $sql = "SELECT location.locn_id, locn_stat, locn_name, issn.prod_id
                FROM location
                LEFT OUTER JOIN issn ON issn.locn_id = location.locn_id 
                WHERE location.wh_id = '$wh_id' AND moveable_locn = 'T' AND locn_type ='TV'";           
        }
        
        
        $rows = $this->findAllAssocMod($sql);
        
        return $rows;
    }
    
    public function getProdInLocations($trolley = null, $clause = null)
    {
        
   
  /*    
        $sql = "SELECT po.pick_order, pid.pick_label_no, i1.prod_id, pp.short_desc, i1.ssn_id,
                     i1.current_qty AS issn_qty, pid.qty_picked, i1.locn_id,
                      pid.pick_detail_status AS pid_status
                FROM issn i1 
                JOIN prod_profile pp ON pp.prod_id = i1.prod_id
                LEFT OUTER JOIN pick_item_detail pid ON i1.ssn_id = pid.ssn_id
                LEFT OUTER JOIN pick_item pi ON pid.pick_label_no = pi.pick_label_no
                LEFT OUTER JOIN pick_order po ON pi.pick_order = po.pick_order
                WHERE i1.locn_id STARTING '$trolley' AND pid.pick_detail_status = 'PL'
                ORDER by po.pick_order, pid.pick_label_no";
*/
        
        
//                  #440            

        
//      $sql = "SELECT po.pick_order, i1.prod_id, pp.short_desc, 
//                     sum(i1.current_qty) AS issn_qty, sum(pid.qty_picked) as qty_picked, i1.locn_id,
//                      pid.pick_detail_status AS pid_status
//                FROM issn i1 
//                LEFT OUTER JOIN prod_profile pp ON pp.prod_id = i1.prod_id
//                LEFT OUTER JOIN pick_item_detail pid ON i1.ssn_id = pid.ssn_id
//                LEFT OUTER JOIN pick_item pi ON pid.pick_label_no = pi.pick_label_no
//                LEFT OUTER JOIN pick_order po ON pi.pick_order = po.pick_order
//                WHERE i1.locn_id STARTING '$trolley' AND pid.pick_detail_status = 'PL'
//                GROUP BY po.pick_order, i1.locn_id, i1.prod_id, pp.short_desc, pid.pick_detail_status ";

//      var_dump($trolley); die();

        
        if($clause!=null || $clause!='' ) {
            
            $sql = "SELECT po.pick_order, i1.prod_id, pp.short_desc, 
                     sum(i1.current_qty) AS issn_qty, sum(pid.qty_picked) as qty_picked, i1.locn_id,
                      pid.pick_detail_status AS pid_status, i1.ssn_id, i1.prev_prev_wh_id, i1.prev_prev_locn_id
                FROM issn i1 
                LEFT OUTER JOIN prod_profile pp ON pp.prod_id = i1.prod_id
                LEFT OUTER JOIN pick_item_detail pid ON i1.ssn_id = pid.ssn_id
                LEFT OUTER JOIN pick_item pi ON pid.pick_label_no = pi.pick_label_no
                LEFT OUTER JOIN pick_order po ON pi.pick_order = po.pick_order
                LEFT OUTER JOIN location lcn ON i1.locn_id = lcn.locn_id AND i1.wh_id = lcn.wh_id
                WHERE $clause " . substr($this->getWarehouseAndCompanyLimit(0, false, 'i1.', 'i1.'), 0, -5) . "
                GROUP BY po.pick_order, i1.locn_id, i1.prod_id, pp.short_desc, pid.pick_detail_status, i1.ssn_id, i1.prev_prev_wh_id, i1.prev_prev_locn_id";            
        } elseif ($trolley==null || $trolley=='') {
            
            $sql = "SELECT po.pick_order, i1.prod_id, pp.short_desc, 
                         sum(i1.current_qty) AS issn_qty, sum(pid.qty_picked) as qty_picked, i1.locn_id,
                          pid.pick_detail_status AS pid_status, i1.ssn_id, i1.prev_prev_wh_id, i1.prev_prev_locn_id
                    FROM issn i1 
                    LEFT OUTER JOIN prod_profile pp ON pp.prod_id = i1.prod_id
                    LEFT OUTER JOIN pick_item_detail pid ON i1.ssn_id = pid.ssn_id
                    LEFT OUTER JOIN pick_item pi ON pid.pick_label_no = pi.pick_label_no
                    LEFT OUTER JOIN pick_order po ON pi.pick_order = po.pick_order
                    LEFT OUTER JOIN location lcn ON il.locn_id = lcn.locn_id AND il.wh_id = lcn_wh_id
                    WHERE po.pick_order IS NOT NULL " . substr($this->getWarehouseAndCompanyLimit(0, false, 'i1.', 'i1.'), 0, -5) . "
                    GROUP BY po.pick_order, i1.locn_id, i1.prod_id, pp.short_desc, pid.pick_detail_status, i1.ssn_id, i1.prev_prev_wh_id, i1.prev_prev_locn_id";
        } else {
            
            $sql = "SELECT po.pick_order, i1.prod_id, pp.short_desc, 
                         sum(i1.current_qty) AS issn_qty, sum(pid.qty_picked) as qty_picked, i1.locn_id,
                          pid.pick_detail_status AS pid_status, i1.ssn_id, i1.wh_id, i1.prev_locn_id
                    FROM issn i1 
                    LEFT OUTER JOIN prod_profile pp ON pp.prod_id = i1.prod_id
                    LEFT OUTER JOIN pick_item_detail pid ON i1.ssn_id = pid.ssn_id
                    LEFT OUTER JOIN pick_item pi ON pid.pick_label_no = pi.pick_label_no
                    LEFT OUTER JOIN pick_order po ON pi.pick_order = po.pick_order
                    LEFT OUTER JOIN location lcn ON il.locn_id = lcn.locn_id AND il.wh_id = lcn_wh_id
                    WHERE i1.locn_id STARTING '$trolley' AND po.pick_order IS NOT NULL " . substr($this->getWarehouseAndCompanyLimit(0, false, 'i1.', 'i1.'), 0, -5) . "
                    GROUP BY po.pick_order, i1.locn_id, i1.prod_id, pp.short_desc, pid.pick_detail_status, i1.ssn_id, i1.prev_prev_wh_id, i1.prev_prev_locn_id";
        }
        
//      WHERE pid.despatch_location STARTING '$trolley' AND po.pick_order IS NOT NULL
//      var_dump($sql); die();

        $rows = $this->findAllAssocMod($sql);
        
        $result['data'] = $rows;
        $result['total'] = count($rows);

        return $result;     
    }
    
    public function getProductDescById($id)
    {
        $sql = "SELECT SHORT_DESC FROM PROD_PROFILE WHERE PROD_ID='$id' ";  
        $row = $this->findOneAssoc($sql);
        return $row['SHORT_DESC'];
        
    }
    public function getSupplierListProperty($id)
    {
        $sql = "SELECT SUPPLIER_LIST FROM PICK_ORDER WHERE PICK_ORDER='$id' ";  
        $row = $this->findOneAssoc($sql);
        return $row['SUPPLIER_LIST'];
    }

    public function getSpecialInstructionsProperty($id)
    {
        $sql = "SELECT SPECIAL_INSTRUCTIONS, SPECIAL_INSTRUCTIONS1, SPECIAL_INSTRUCTIONS2 FROM PICK_ORDER WHERE PICK_ORDER='$id' "; 
        $row = $this->findOneAssoc($sql);

        return $row;
    }
    
    public function isAllowedAsseblyDispatch()
    {
        $sql = "SELECT ASSEMBLE_DESPATCH FROM CONTROL WHERE RECORD_ID='1' ";    
        $row = $this->findOneAssoc($sql);

        return $row['ASSEMBLE_DESPATCH'];
    }
    
    /**
    * @desc get command list for printer
    * 
    * @param $clause - list of input params for search
    * @param $pageNo - integer page index
    * @param $resultsPerPage - integer result per page index
    */
    public function getPrintLabelData($clause = null, $pageNo = null, $resultsPerPage = null) {
        
        $commandDataList['data'] = array();
        $commandDataList['total']= 0;
        $commandDataList['all']  = array();
        
        $values = array();
        $where  = '';
        
        foreach($clause as $key => $value) {
            if(!empty($value)){
                $values[] = $value;
            }

            $where   .= $key;
        }
        
        $sql = 'SELECT
                    RECORD_ID,
                    SL_NAME,
                    SL_SEQUENCE,
                    SL_LINE,
                    SL_BRAND,
                    SL_IMAGE,
                    SL_FIRMWARE,
                    SL_MODEL
                FROM SYS_LABEL
                WHERE 1=1 AND ';
     
        $sql .= $where; 
        $sql  = substr($sql, 0, -5) . ' ORDER BY SL_NAME, SL_SEQUENCE';
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $this->lastError = $sql;
        
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        $log->info($sqlQuery . ' : ' . implode(', ', $values));
    
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);
        $all    = $this->findAllAssocMod($sql, $values);
        
        foreach($data as $line) {
            $dataLine             = new SysLabelLine($line);
            $dataLine->id         = $dataLine['RECORD_ID'];
            
            $commandDataList['data'][] = $dataLine;
        }
        
        foreach($all as $line) {
            $dataLine            = new SysLabelLine($line);
            $dataLine->id        = $dataLine['RECORD_ID'];
            
            $commandDataList['all'][] = $dataLine;
        }
        
        
       $commandDataList['total'] = $total;
      
        return $commandDataList;
    }
    /**
    * @desc get test data list for printer
    * 
    * @param $clause - list of input params for search
    * @param $pageNo - integer page index
    * @param $resultsPerPage - integer result per page index
    */
    public function getSysLabelVarData($clause = null, $pageNo = null, $resultsPerPage = null) {
        
        $dataList['data'] = array();
        $dataList['total']= 0;
        
        $values = array();
        $where  = '';
        
        foreach($clause as $key => $value) {
            $values[] = $value;
            $where   .= $key;
        }
        
        $sql = 'SELECT
                    RECORD_ID,
                    SLV_NAME,
                    SLV_DEFAULT,
                    SLV_EXPRESSION,
                    LAST_UPDATE_DATE,
                    LAST_UPDATE_BY,
                    SL_NAME,
                    SLV_SEQUENCE  
                FROM SYS_LABEL_VAR
                WHERE 1=1 AND ';
     
        $sql .= $where; 
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $this->lastError = $sql;
      
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        $log->info($sqlQuery . ' : ' . implode(', ', $values));
    
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);
        $all    = $this->findAllAssocMod($sql, $values);
        
        $dataList['total'] = $total;
        $dataList['data']  = $data;  
      
        return $dataList;
    }
    /**
    * @desc delete one or many rows from SYS_LABEL
    * 
    * @param $id - string|array id item for delate
    * @return boolean 
    */
    public function deleteDataLine($id) {
        $sql = 'DELETE FROM SYS_LABEL
                WHERE ';
        
        $arg = array();
        
                
        foreach($id as $value) {
            $sql .= 'RECORD_ID = ? OR ';
            $args[] = $value;    
        }
        $sql = substr($sql, 0 , -4);
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $this->lastError = $sql;
        $result = $this->execSQL($sql, $args);
        
        if($result) {
            return true;
        }
            return false;
    
    }
    
    /**
    * @desc insert new data line for printer
    * @param $clause - array data
    * 
    * @return boolean 
    */
    public function insertDataLine($clause) {
        $sql      = 'INSERT INTO SYS_LABEL(%s) VALUES(%s)';
        
        $command = $clause['SL_LINE'];
        
        $clause['SL_LINE']  =   trim($command);    
        $args               = array();
        $values             = '';
        $fields             = '';
    
        foreach($clause as $key => $value) {
            
            switch($key) {
                case 'SL_IMAGE':
                        $blh       = ibase_blob_create($this->db);
                        ibase_blob_add($blh, $value);
                        $blobImage = ibase_blob_close($blh);
                        $args['SL_IMAGE']    = $blobImage;
                        break;
                case 'SL_NOTES':
                        $blh       = ibase_blob_create($this->db);
                        ibase_blob_add($blh, $value);
                        $blobNotes = ibase_blob_close($blh);
                        $args['SL_NOTES']    = $blobNotes;
                        break;
                default:
                        $args[$key] = $value;
            }
            
            $fields .= $key . ', ';
            $values .= '?, ';
          
        }
        $sql = sprintf($sql, substr($fields, 0, -2), substr($values, 0, -2));
        
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $this->lastError = $sql;
        $result = $this->execSQL($sql, $args);
        
        
        if($result) {
            return true;
        }
            return false;
    }
    
    /**
    * @desc get label Format list from option table
    * @param $code - string group code
    * 
    * @return list
    */
    public function getFormatList($desc)
    {
        $sql = 'SELECT DESCRIPTION,
                       DESCRIPTION  
                FROM OPTIONS
                WHERE GROUP_CODE LIKE ? AND DESCRIPTION LIKE ?';
        
        $values[] = $this->limitPrinter . '_FORMAT';
        $values[] = '%'.strtoupper($desc).'%';
         
        return $result = $this->findList($sql, $values[0], $values[1]);
       
    }
    /**
    * @desc get all data for current RECORD_ID
    * @param $id - integer
    * 
    * @return list of the selected fields
    */
    public function getOnePrintLabelData($id) {
        $sql = 'SELECT *
                FROM SYS_LABEL
                WHERE RECORD_ID = ?';
        
        $data = $this->findOneAssoc($sql, $id);
        $dataLine = new SysLabelLine($data);
        $dataLine->id = $dataLine['RECORD_ID'];
        
        if(!empty($dataLine->items['SL_IMAGE'])) {
            $blob = ibase_blob_open($this->db, $dataLine->items['SL_IMAGE']);
            if (false !== $blob) {
                $blob_info = ibase_blob_info($this->db, $dataLine->items['SL_IMAGE']);
                $dataLine->items['SL_IMAGE'] = ibase_blob_get($blob, $blob_info['length']);
                ibase_blob_close($blob);
            } else {
                $dataLine->items['SL_IMAGE'] = '';
            }
        }
        if(!empty($dataLine->items['SL_NOTES'])) {
            $blob = ibase_blob_open($this->db, $dataLine->items['SL_NOTES']);
            if (false !== $blob) {
                $blob_info = ibase_blob_info($this->db, $dataLine->items['SL_NOTES']);
                $dataLine->items['SL_NOTES'] = ibase_blob_get($blob, $blob_info['length']);
                ibase_blob_close($blob);
            } else {
                $dataLine->items['SL_NOTES'] = '';
            }
        }
    
        return $dataLine;
    }
    /**
    * @desc update data for current RECORD_ID
    * @param $id - integer RECORD_ID
    * @param $data - array of update data
    * 
    * @return boolean 
    */
    public function updateDataLine($id, $data) {
        $sql = 'UPDATE SYS_LABEL
                SET %s
                WHERE RECORD_ID = ?';
        $params = '';
        $values = array();
        
        foreach($data as $key => $value) {
            $params .= $key . ' = ?, ';
            $values[]= $value;
        }
            $values[]= $id;
        
        $sql = sprintf($sql, substr($params, 0, -2));
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $this->lastError = $sql;
        $result = $this->execSQL($sql, $values);
        if($result) {
            return true;
        }
            return false;
    }
    
    public function itemExists($id = null, $type = null) {
        if ($id == null || $type == null) {
            throw new Exception("Invalid input data.");         
        }
        
        $type = strtoupper($type);
        
        switch ($type){
            case "BARCODE":
                    $sql = "SELECT COUNT (*) FROM SSN WHERE SSN_ID = ?";
                break;
            case "LOCATION_CODE":
                    $sql = "SELECT COUNT (*) FROM LOCATION WHERE LOCN_ID = ?";
                break;
            case "PROD_13":
            case "PROD_14":
            case "PROD_EAN8":
            case "PROD_INTERNAL":
            case "PROD_UCC":
            case "PROD_UPC12":
                    $sql = "SELECT COUNT (*) FROM SSN WHERE PROD_ID = ?";
                break;
            case "PURCHASE":
                    $sql = "SELECT COUNT (*) FROM PURCHASE_ORDER WHERE PURCHASE_ORDER = ?";
                break;
            case "SALES_ORDER":
                    $sql = "SELECT COUNT (*) FROM PICK_ORDER WHERE PICK_ORDER = ?";
                break;
            case "SSN_CODE":
                    $sql = "SELECT COUNT (*) FROM SSN WHERE SSN_ID = ?";
                break;
            default:
                throw new Exception("Provided DATA_ID isn't supported.");
        }
        
        $result = $this->findOneAssoc($sql, $id); 
        
        return $result['COUNT']=='1'?true:false;
        
    }
    
    public function getTrn($trn_prefix = null)
    {
        if ($trn_prefix == null) {
            throw new Exception("Inavalid input");
        }
        
        $sql = "SELECT * FROM TRANSACTION_TYPES WHERE TRN_PREFIX = ?";
        $result = $this->fetchAllAssoc($sql, $trn_prefix);
        
        return $result;
    }
    
    public function getBorrower($id = null)
    {
        if ($id==null) {
            throw new Exception('Invalid input');
        }
        
        $sql = "SELECT * FROM LOCATION WHERE WH_ID = 'XB' AND LOCN_ID = ?";
        
        $result = $this->fetchAssoc($sql, $id);
        
        return $result; 
    }
    
    public function getBorrowerForPrint($id = null)
    {
        if ($id==null) {
            throw new Exception('Invalid input');
        }
        
        $sql = "SELECT * FROM LOCATION WHERE WH_ID = 'XB' AND LOCN_ID = ?";
        
        $result = $this->findOneAssocExt($sql, $id);
        
        return $result; 
    }
    
    public function getEmployee($id = null)
    {
        if ($id==null) {
            throw new Exception('Invalid input');
        }
        
        $sql = "SELECT * FROM EMPLOYEE WHERE EMPLOYEE_ID = ?";
        
        $result = $this->fetchAssoc($sql, $id);
        
        return $result; 
    }
    
    /**
    * @desc insert new data line for printer
    * @param $clause - array data
    * 
    * @return boolean 
    */
    public function insertBarcodeCodes($clause) {
        $sql    = 'INSERT INTO BARCODE_CODES(%s) VALUES(%s)';
        $args   = array();
        $values = $fields = '';
        
        foreach($clause as $key => $value) {
            
            $args[] = $value;
            $fields .= $key . ', ';
            $values .= '?, ';
          
        }
        $sql = sprintf($sql, substr($fields, 0, -2), substr($values, 0, -2));
     
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $this->lastError = $sql;
        $result = $this->execSQL($sql, $args);
        if($result) {
            return true;
        }
            return false;
    }
    
    public function getSsn($id)
    {
        if ($id==null) {
            throw new Exception('Invalid input');
        }
        
        $sql = "SELECT * FROM SSN WHERE SSN_ID = ?";
        
        $result = $this->fetchAssoc($sql, $id);
        
        return $result;         
    }

///
    public function getLocnName($homLocnId, $homWhId)
    {

        $sql = "SELECT LOCN_NAME FROM LOCATION WHERE LOCN_ID = ? AND WH_ID = ?";
	$result = $this->fetchAssoc($sql, $homLocnId, $homWhId);        

        return $result;
    }
    ///
    
    public function getIssn($id)
    {
        if ($id==null) {
            throw new Exception('Invalid input');
        }
        
        $sql = "SELECT * FROM ISSN WHERE SSN_ID = ?";
        
        $result = $this->fetchAssoc($sql, $id);
        
        return $result;         
    }    

    public function getIssnBySsnId($id)
    {
        if ($id==null) {
            throw new Exception('Invalid input');
        }
        
        $sql = "SELECT * FROM ISSN WHERE ORIGINAL_SSN = ?";
        
        $result = $this->fetchAssoc($sql, $id);
        
        return $result;         
    }        


     public function getProdLine($product_id) {

        $sql = "SELECT PROD_TYPE FROM PROD_PROFILE WHERE PROD_ID = ?";
        
        $result = $this->fetchAssoc($sql, $product_id);

	return $result['PROD_TYPE'];
	}

      public function getProdStatus() {

	 $sql = "SELECT CHECKIN_ADD_PICK_ITEM FROM PROD_TYPE WHERE CODE='PM'";
        
        $result = $this->fetchAssoc($sql);

	return $result['CHECKIN_ADD_PICK_ITEM'];
	}

	public function getLoc($wh_id, $locationid) {

        $sql = "SELECT * FROM LOCATION WHERE WH_ID = ? AND LOCN_ID = ?";
        
        $result = $this->fetchAssoc($sql, $wh_id, $locationid);

	return $result;
	}


    
    public function getProd($id)
    {
        if ($id==null) {
            throw new Exception('Invalid input');
        }
        
        $sql = "SELECT * FROM PROD_PROFILE WHERE PROD_ID = ?";
        
        $result = $this->fetchAssoc($sql, $id);
        
        return $result;         
    }
    
    public function getProdForPrint($id)
    {
        if ($id==null) {
            throw new Exception('Invalid input');
        }
        
        $sql = "SELECT * FROM PROD_PROFILE WHERE PROD_ID = ?";
        
        $result = $this->findOneAssocExt($sql, $id);
        
        return $result;         
    }

    public function getPramsTable()
    {
        $sql = "SELECT * FROM PARAM";
        
        $result = $this->fetchAllAssoc($sql);
        
        return $result;             
    }
    
    /**
    * @desc get slotted products
    * 
    * @param $clauseProdProfile - array of search options for PROD_PROFILE table
    * @param $clauseLocation    - array of search options for LOCATIONS
    * 
    * @return $slottedProducts   
    */
    public function getSlottedProducts($clauseProdProfile, $clauseLocation, $pageNo = null, $resultsPerPage = null) {
    
        $args                      = array();
        $values                    = array();
        
        $slottedProducts['data']   = array();
        $slottedProducts['total']  = 0;
        
        $sql = "SELECT PROD_ID, 
                       SHORT_DESC,
                       PROD_TYPE,
                       ALT_PROD_TYPE,
                       STORE_TYPE,
                       TOG_C,
                       LOCN_VISIT_PER_MTH AS HITS,
                       SALE_PER_MTH AS SALES,
                       NET_WEIGHT,
                       COMPANY_ID,
                       ORIENTATION,
                       DIMENSION_X,
                       DIMENSION_Y,
                       DIMENSION_Z,
                       CAST(DIMENSION_X as float) * CAST(DIMENSION_Y as float) * CAST(DIMENSION_Z as float) * CAST(SALE_PER_MTH as float) as VOLUME 
                FROM PROD_PROFILE       
                WHERE (HOME_LOCN_ID IS NULL OR HOME_LOCN_ID = '') AND ";
                       
                        
        // for PROD_PROFILE
        foreach($clauseProdProfile as $key => $value) {
            $sql     .= $key;
            $values[] = $value;
        }
        
        $sql = substr($sql, 0, strlen($sql)-5) . ' ORDER BY HITS DESC';
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $this->lastError = $sql;
        
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        $log->info($sqlQuery . ' : ' . implode(', ', $values));
    
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);
      
        $values = array();
        $sql = "SELECT FIRST 1 SKIP 0 
                       LOCATION.WH_ID,
                       LOCATION.LOCN_ID,
                       LOCATION.ZONE_C,
                       LOCATION.STORE_TYPE,
                       LOCATION.TOG_C,
                       LOCATION.STORE_METH,
                       LOCATION.STORE_AREA,
                       LOCATION.LOCN_TYPE,
                       LOCATION.LOCN_METRIC,
                       LOCATION.LOCN_INT_DIMENSION_X,
                       LOCATION.LOCN_INT_DIMENSION_Y,
                       LOCATION.LOCN_INT_DIMENSION_Z
                FROM LOCATION
                JOIN ZONE ON ZONE.CODE = LOCATION.ZONE_C
                WHERE (PROD_ID IS NULL OR PROD_ID = '') AND LOCATION.WH_ID = 'VW' 
                                      AND ZONE.ZONE_SEQ IS NOT NULL 
                                      AND LOCATION.STORE_AREA = 'BS' AND ";
        
        // for LOCATION
        foreach($clauseLocation as $key => $value) {
            if(!empty($value)) {
                $sql      .= $key;
                $values[]  = $value;
            }
        }
        
        $dimensionsCount = 0;
        if(isset($clauseLocation['LOCN_INT_DIMENSION_X >= ? AND '])) {
            $sql .= 'LOCN_INT_DIMENSION_X >= ? AND ';
            $dimensionsCount++; 
        }
        if(isset($clauseLocation['LOCN_INT_DIMENSION_Y >= ? AND '])) {
            $sql .= 'LOCN_INT_DIMENSION_Y >= ? AND ';
            $dimensionsCount++;
        }
        if(isset($clauseLocation['LOCN_INT_DIMENSION_Z >= ? AND '])) {
            $sql .= 'LOCN_INT_DIMENSION_Z >= ? AND ';
            $dimensionsCount++;
        }
        
        if($dimensionsCount == 3) {
            $sql .= ' CAST(LOCN_INT_DIMENSION_X as float) * CAST(LOCN_INT_DIMENSION_Y as float) * CAST(LOCN_INT_DIMENSION_Z as float) >= ? AND ';
        }
        
        $sql = substr($sql, 0, strlen($sql)-5);
        for($i=0; $i<count($data); $i++) {
            $tempValues = $values;
            
            $data[$i]['LOCN_ID']                = '***';
            $data[$i]['LOCN_INT_DIMENSION_X']   = '***';
            $data[$i]['LOCN_INT_DIMENSION_Y']   = '***';
            $data[$i]['LOCN_INT_DIMENSION_Z']   = '***';
            
            if(isset($clauseLocation['LOCN_INT_DIMENSION_X >= ? AND '])) {
                $tempValues[] = $data[$i]['DIMENSION_X'];    
            }
            if(isset($clauseLocation['LOCN_INT_DIMENSION_Y >= ? AND '])) {
                $tempValues[] = $data[$i]['DIMENSION_Y'];    
            }
            if(isset($clauseLocation['LOCN_INT_DIMENSION_Z >= ? AND '])) {
                $tempValues[] = $data[$i]['DIMENSION_Z'];
            }
            
            if($dimensionsCount == 3) {
                $tempValues[] = $data[$i]['VOLUME'];
            }
            
            $data[$i] = $this->getLocationForProduct($data[$i], $sql, $tempValues);
            
        }
        
        $slottedProducts['data']    = $data;
        $slottedProducts['total']   = $total;
        
        return $slottedProducts;
    }
    
    /**
    * @desc 
    */
    private function getLocationForProduct($data, $sql, $values) {
        
            static $allocatedLocations = array();
            static $count = 0;
            
            
            if (false === ($values = $this->prepareArgs($sql, $values))) {
                throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
            }
            
            $order = ' ORDER BY ZONE.ZONE_SEQ ';
            $sql  .= $order;
            $locationData   = $this->findAllAssocMod($sql, $values);
            $sql  = substr($sql, 0, strlen($sql) - strlen($order));
            if(empty($locationData)) {
                return $data;
            }
            $locationData   = $locationData[0];
            
            //$count++;
            //var_dump($count);
            // save allocated location
            if(!empty($locationData)){
                if(!in_array($locationData['LOCN_ID'], $allocatedLocations)) {
                    $allocatedLocations[]           = $locationData['LOCN_ID'];
                    $data['LOCN_ID']                = $locationData['LOCN_ID'];
                    $data['LOCN_INT_DIMENSION_X']   = $locationData['LOCN_INT_DIMENSION_X'];
                    $data['LOCN_INT_DIMENSION_Y']   = $locationData['LOCN_INT_DIMENSION_Y'];
                    $data['LOCN_INT_DIMENSION_Z']   = $locationData['LOCN_INT_DIMENSION_Z'];
                    
                    return $data;
                } else {
                        
                            $sql        .= ' AND LOCN_ID <> ? ';
                            $values[]    = $locationData['LOCN_ID'];
                            $data        = $this->getLocationForProduct($data, $sql, $values);
                        
                        
                        
                }
            } 
            
            return $data;
            
    }
    
    /**
    * @desc method update product location 
    * 
    * @param string $prodId - PROD_ID
    * @param string $locnId - LOCATION
    * 
    * @return boolean 
    */
    public function updateSlottedProduct($prodId, $locnId) {
        $result = false;
        
        
        $sql = 'UPDATE PROD_PROFILE
                       SET HOME_LOCN_ID = ?
                WHERE PROD_ID = ? ';
        
        $result = $this->execSQL($sql, array($locnId, $prodId));
        
        return $result;
    }
    
    /**
    * @desc method update location  prod_id 
    * 
    * @param string $prodId - PROD_ID
    * @param string $locnId - LOCATION
    * 
    * @return boolean 
    */
    public function updateSlottedLocation($prodId, $locnId) {
        $result = false;
        
        
        $sql = 'UPDATE LOCATION
                       SET PROD_ID = ?
                WHERE LOCN_ID = ? ';
        
        $result = $this->execSQL($sql, array($prodId, $locnId));
        
        return $result;
    }

    /**
     * @throws Minder_Exception
     * @param $sql
     * @return resource
     */
    public function createCursor($sql) {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $args = func_get_args();
        $log->info($sql . ' : ' . implode(',', array_slice($args, 1)));
        $args[0] = $sql;

        $result = call_user_func_array('ibase_query', $args);
        if (false === $result) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        else {
            return $result;
        }
    }

    /**
     * @param resource $cursor
     * @param int $rowsAmount
     * @return array
     */
    public function fetchNext($cursor, $rowsAmount = 1) {
        $result = array();
        $toFetchLeft = $rowsAmount;

        while ($toFetchLeft > 0 && $row = ibase_fetch_assoc($cursor, IBASE_TEXT)) {
            $toFetchLeft--;
            $result[] = $row;
        }

        return $result;
    }

    /**
     * @param resource $cursor
     * @return void
     */
    public function freeCursor($cursor) {
        ibase_free_result($cursor);
    }

    /**
     * @desc get issues
     *
     * @param string $from_date
     * @param string $to_date
     * @param string|null $wh_id
     * @param bool $isConsumable
     *
     * @return resource
     */
    public function getIssues($from_date = null, $to_date = null, $wh_id = null, $isConsumable = false)
    {
        $filter = array();
        $args = array();
        if ($from_date != null) {
            $filter[] = 'TRN_DATE >= ZEROTIME(?)';
            $args[] = $from_date;
        }

        if ($to_date != null) {
            $filter[] = 'TRN_DATE <= MAXTIME(?)';
            $args[] = $to_date;
        }

        if ($wh_id != null && strtolower($wh_id) != 'all') {
            $filter[] = ($isConsumable) ? 'TRANSACTIONS_ARCHIVE.WH_ID = ?' : 'SSN_HIST.WH_ID = ?';
            $args[] = $wh_id;
        }

        $sql = ($isConsumable) ?
                "SELECT
                    TRANSACTIONS_ARCHIVE.TRN_DATE as datetime,
                    TRANSACTIONS_ARCHIVE.WH_ID || TRANSACTIONS_ARCHIVE.LOCN_ID as location,
                    TRANSACTIONS_ARCHIVE.OBJECT as PROD_ID,
                    TRANSACTIONS_ARCHIVE.REFERENCE as reference,
                    TRANSACTIONS_ARCHIVE.QTY as qty,
                    TRANSACTIONS_ARCHIVE.PERSON_ID as person_id,
                    TRANSACTIONS_ARCHIVE.DEVICE_ID as device_id,
                    LOCATION.LOCN_NAME as location_name,
                    PROD_PROFILE.SHORT_DESC as description,
                    'Issued To' AS FIELD_00
                FROM TRANSACTIONS_ARCHIVE
                LEFT JOIN LOCATION ON TRANSACTIONS_ARCHIVE.WH_ID = LOCATION.WH_ID AND TRANSACTIONS_ARCHIVE.LOCN_ID = LOCATION.LOCN_ID
                LEFT JOIN PROD_PROFILE ON PROD_PROFILE.PROD_ID = TRANSACTIONS_ARCHIVE.OBJECT
                WHERE TRANSACTIONS_ARCHIVE.TRN_TYPE = 'ISIZ' AND TRANSACTIONS_ARCHIVE.TRN_CODE = 'P'" . substr($this->getWarehouseAndCompanyLimit(0, false, 'TRANSACTIONS_ARCHIVE.'), 0, -5) :

                "SELECT
                    SSN_HIST.TRN_DATE as datetime,
                    SSN_HIST.WH_ID || SSN_HIST.LOCN_ID as location,
                    SSN_HIST.SSN_ID as ssn_id,
                    CASE
                        WHEN SSN_HIST.trn_type = 'TRIL' THEN 'Issued To'
                        WHEN SSN_HIST.trn_type = 'TROL' THEN 'Returned From'
                    END AS FIELD_00,
                    QTY,
                    LOCN_NAME as location_name,
                    SSN_DESCRIPTION as description
                FROM SSN_HIST
                JOIN LOCATION ON LOCATION.LOCN_ID = SSN_HIST.LOCN_ID AND LOCATION.WH_ID = SSN_HIST.WH_ID
                JOIN SSN ON SSN.SSN_ID = SSN_HIST.SSN_ID
                WHERE SSN_HIST.trn_type IN ('TRIL', 'TROL')" . substr($this->getWarehouseAndCompanyLimit(0, false, 'SSN_HIST.'), 0, -5);

        if (count($filter) > 0) {
            $sql .= ' AND ' . implode(' AND ', $filter);
        }

        $sql .= " ORDER BY " . (($isConsumable) ? " TRANSACTIONS_ARCHIVE.TRN_DATE DESC" : " SSN_HIST.TRN_DATE DESC");

        array_unshift($args, $sql);

        $result = call_user_func_array(array($this, 'createCursor'), $args);
        return $result;
    }

    /**
    * @desc clear slotting products. Set 
    *       HOME_LOCN_ID = null for PROD_PROFILE table 
    * @param void
    * 
    * @return boolean  
    */
    public function clearProductSlotting($prodId) {
        
        $homeLocnId = null;
        $sql = 'SELECT HOME_LOCN_ID
                FROM PROD_PROFILE
                WHERE PROD_ID = ? ';
        
        $result     = $this->findOneAssoc($sql, $prodId);
        $homeLocnId = $result['HOME_LOCN_ID']; 
        
        $sql = 'UPDATE PROD_PROFILE
                       SET HOME_LOCN_ID = NULL
                WHERE PROD_ID = ? ';
        
        $this->execSQL($sql, array($prodId));
        
        return $homeLocnId;
                
    }
    
    /**
    * @desc clear slotting products. Set PROD_ID = null for LOCATION table
    * @param void
    * 
    * @return boolean  
    */
    public function clearLocationSlotting($locnId) {
        
        $sql = 'UPDATE LOCATION
                       SET PROD_ID = NULL
                WHERE LOCN_ID = ? ';
        
        $result = $this->execSQL($sql, array($locnId));
        
        return $result;
                
    }
    
    /**
    * @desc getting location from DB
    * @param integer $id 
    * 
    * @return array  
    */
    public function getLocn($id = null, $wh_id )
    {
        if ($id == null) {
            throw new Exception ('ID cant be null');
        }
        
        $sql  = 'SELECT * FROM LOCATION WHERE LOCN_ID = ? AND WH_ID = ?';
        
        $result = $this->fetchAssoc($sql, $id, $wh_id);
        
        return $result;
        
    }
    
    /**
    * @desc getting values from CONTROL table
    * @param void
    * 
    * @return list of values
    */
    public function getValuesFromControl() {
        return Minder_SysScreen_Legacy_ControlManager::getControls();
    }
    
    /**
     * @desc resolve OS type
     * @param void
     * 
     * @return true if win
     */
    public function isWinOs()
    {
        if (strripos($_ENV['OS'], 'win')===false) {
            return false;
        } else {
            return true;
        }
    }
    
    
     /**
     * @desc get product description
     * @param $ssn_type varchar
     * @param $field_code int
     * 
     * @return array
     */   
    public function getProductDescription($ssn_type){
        
        $sql  = 'SELECT DESCRIPTION, FIELD_CODE FROM PRODUCT_DESCRIPTION WHERE TYPE_CODE = ?';
       
        if ($ssn_type == null)
        {
                $result = $this->fetchAllAssoc($sql, "");
        }
        else
        {
                $result = $this->fetchAllAssoc($sql, $ssn_type);
        }
        return $result;
    }
    /**
    * @desc get MODEL list
    * @param $model - string search expression
    * 
    * @return list of model or empty list  
    */
    public function getSysEquipModelList($model) {
        
        $sql = 'SELECT MODEL, MODEL
                FROM SYS_EQUIP
                WHERE MODEL LIKE ? ';
        
        $value = '%'.strtoupper($model).'%';
        
        return $this->findList($sql, $value);
        
    }
    /**
    * @desc get BRAND list
    * @param $brand - string search sxpression  
    * 
    * @return list of brands or empty list
    */
    public function getSysEquipBrandList($brand) {
        
        $sql = 'SELECT BRAND, BRAND
                FROM SYS_EQUIP
                WHERE BRAND LIKE ? ';
        
        $value = '%'.strtoupper($brand).'%';
        
        return $this->findList($sql, $value);
    }
    
    /**
    * @desc send data to print via PC_LABEL procedure
    * 
    * 
    * @param $deviceId - printer id
    * @param $prnType  - ISSN|DESPATH|LOGON|LOCATION etc
    * @param $prnFileName - format file name
    * @param $prnData - printed data
    * @param $personId - USER_ID
    * @param $fromDeviceId - Label Requestor
    * @param $prnCopy  - number of printed copys
    * 
    * @param boolean
    */
    public function pcLabelPrint($deviceId, $prnType, $prnFileName, $prnData, $personId, $fromDeviceId = '', $intNoCopyToPrint = "") {

        if(trim($intNoCopyToPrint) == "" || trim($intNoCopyToPrint) < 1){
            $intNoCopyToPrint = 1;
        }

        $sql    = "SELECT RES, ERROR_TEXT
                   FROM PC_LABEL(?, ?, ?, ?, ?, ?, ?)";
        
        //die(print_r(explode(",","$deviceId, $prnType, $prnFileName, $prnData, $personId, $fromDeviceId, $intNoCopyToPrint")));
        
        //$result = $this->findOneAssoc($sql, $deviceId, $prnType, $prnCopy, $prnFileName, $prnData, $personId);
        $result = $this->findOneAssoc($sql, $deviceId, $prnType, $intNoCopyToPrint, $prnFileName, $prnData, $personId, $fromDeviceId);
        
        return $result;
    }

    /**
    * @desc get Persons list from PICK_ORDER table by some criteria
    * 
    * @param  array $searchCriteria - array of search criteria in form array(CRITERIA_TEXT => array(CRITERIA_PARAMS))
    *                                 for example:
    *                                       array(
    *                                           'PERSON_TYPE IN (?, ?, ?) AND ORDER_TYPE = ? AND ' => array('CO', 'CU', 'IN', 'SO')
    *                                       )
    *                                 CRITERIA_TEXT should contains at the end of string ' AND ' term
    *                                 CRITERIA_ARGS should always be of type array, if no args needed use array()
    * @return array(PERSON_ID => PERSON_ID)
    */
    public function getPersonFromPickOrder($searchCriteria = array()) {
    
        $resultList = array();
         
        $sql = "SELECT DISTINCT
                       PERSON.PERSON_ID as PERSON_KEY,
                       '(' || PERSON.PERSON_ID || ') ' || COALESCE(PERSON.FIRST_NAME, '') || ' ' || COALESCE(PERSON.LAST_NAME, '') as PERSON_VAL
                FROM PICK_ORDER
                LEFT JOIN PERSON ON PICK_ORDER.PERSON_ID = PERSON.PERSON_ID ";

        $sql .= $this->getWarehouseAndCompanyLimit(0, true, 'PICK_ORDER.', 'PICK_ORDER.');
        $args   = array();
        
        foreach ($searchCriteria as $criteriaText => $criteriaArgs) {
            $sql  .= $criteriaText;
            $args  = array_merge($args, $criteriaArgs);
        }
        
        array_unshift($args, $sql);
        
        $resultList = call_user_func_array(array($this, 'findList'), $args);
        
        return $resultList;
    }
    
    /**
    * @desc get SYS_LABEL_VAR records
    * 
    * @param int $slName
    * @return records list
    */
    public function getSysLabelVarList($slName = null) {
    
        if(!is_null($slName)) {
        
              $sql = 'SELECT *
                      FROM SYS_LABEL_VAR
                      WHERE SL_NAME = ?';    
            
        } else {
            
              $sql = 'SELECT *
                      FROM SYS_LABEL_VAR';     
        }
        
        $data = $this->findAllAssocMod($sql, $slName);
        
        $result['data']     =   $data;
        $result['total']    =   count($data);
        
        return $result;
        
    }
    /**
    * @desc get SYS_LABEL_VAR record
    * 
    * @param int $recordId
    * @return one record
    */
    public function getSysLabelVarById($recordId) {
    
        $sql = 'SELECT *
                FROM SYS_LABEL_VAR
                WHERE RECORD_ID = ?';    
        
        
        $data = $this->findOneAssoc($sql, $recordId);
        
        return $data;
        
    }
    
    /**
    * @desc update SYS_LABEL_VAR record
    * 
    * @param args for update
    * 
    * @return void
    */
    public function updateSysLabelVar(array $args) {
    
        $sql = 'UPDATE SYS_LABEL_VAR
                SET SLV_NAME = ?, SLV_DEFAULT =?, SLV_EXPRESSION = ?, LAST_UPDATE_DATE = ?, SL_NAME = ?, LAST_UPDATE_BY = ?, SLV_SEQUENCE = ?  
                WHERE RECORD_ID = ?  ';
        
        $this->execSQL($sql, $args);
    }
    
    /**
    * @desc add SYS_LABEL_VAR record
    * @param arg for add
    * 
    * @return void 
    */
    public function addSysLabelVar(array $args){
    
        $sql = 'INSERT INTO SYS_LABEL_VAR(SLV_NAME, SLV_EXPRESSION, SLV_DEFAULT, SLV_SEQUENCE, SL_NAME, LAST_UPDATE_BY, LAST_UPDATE_DATE)
                            VALUES(?, ?, ?, ?, ?, ?, ?)';
        $this->execSQL($sql, $args);
        
    }
    
    /**
    * @desc get list from PICK_DESPATCH table
    */
    public function getPickDespatchList($clause, $pageNo = 0, $resultsPerPage = 15) {
        
        $sql = 'SELECT *
                FROM PICK_DESPATCH
                WHERE 1=1 AND ';
                
        
        $values = array();
     
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                    $sql .= $key;
                    if(!empty($val) && false != strpos($key, 'LIKE')) {
                        $values[] = $val . '%'; 
                    } elseif (!empty($val) && false != strpos($key, '?')) {
                        $values[] = $val;
                    }
                }
        }
        
        
        $sql = substr($sql, 0, strlen($sql) - 5);
        
        $sql .= ' ORDER BY DESPATCH_ID DESC';
    
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $this->lastError = $sql;
     
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
        $log->info($sqlQuery . ' : ' . implode(', ', $values));
    
        $total  = $this->findValue($sqlCount, $values);
        $data   = $this->findAllAssocMod($sqlQuery, $values);
        $all    = $this->findAllAssocMod($sql, $values);
        
        $result['total'] = $total;
        $result['data']  = $data;
        $result['all']   = $all;
        
        return $result; 
       
    }
    
    /**
    * @desc get PICK_CHARGED_TO list FROM PICK_DESPATCH
    * 
    * @return list  
    */
    public function getShipByList() {
    
         $sql    =   'SELECT DISTINCT PICKD_CARRIER_ID as ID, 
                                     PICKD_CARRIER_ID as VAL
                      FROM PICK_DESPATCH';
        
        return $result = $this->findList($sql);
    
    }
    
    /**
    * @desc get PICK_CARRIER_ID list FROM PICK_DESPATCH
    * 
    * @return list  
    */
    public function getPayerList() {
    
        $sql    =   'SELECT DISTINCT PICKD_CHARGE_TO as ID, 
                                     PICKD_CHARGE_TO as VAL
                     FROM PICK_DESPATCH';
        
        return $result = $this->findList($sql);
    
    }
    
    /**
    * get list from PACK_ID table
    * 
    * @param mixed $clause
    * @param mixed $pageNo
    * @param mixed $resultsPerPage
    */
    public function getPackIdList($clause, $pageNo = 0, $resultsPerPage = 15) {
    
         $sql = 'SELECT DISTINCT 
                    PACK_ID.PACK_ID,
                    PACK_ID.DESPATCH_ID,
                    PACK_ID.CREATE_DATE,
                    PACK_ID.LABEL_PRINTED_DATE,
                    PACK_ID.DESPATCH_LABEL_NO,
                    PACK_ID.LAST_UPDATE_DATE,
                    CASE WHEN PACK_ID.PROD_ID IS NULL OR PACK_ID.PROD_ID = \'\' 
                        THEN ISSN.PROD_ID
                    ELSE
                       PACK_ID.PROD_ID 
                    END PROD_ID,
                    PACK_ID.QTY,
                    PACK_ID.SSN_ID,
                    CASE WHEN (PACK_ID.PROD_ID IS NULL OR PACK_ID.PROD_ID = \'\') AND (IP.PROD_ID IS NOT NULL) 
                        THEN IP.SHORT_DESC
                    WHEN (PACK_ID.PROD_ID IS NOT NULL AND PACK_ID.PROD_ID <> \'\') AND (PP.PROD_ID IS NOT NULL) 
                        THEN PP.SHORT_DESC 
                    ELSE
                        SSN.SSN_DESCRIPTION
                    END ISSN_DESCRIPTION
                 FROM PACK_ID
                 LEFT OUTER JOIN ISSN ON PACK_ID.SSN_ID =  ISSN.SSN_ID 
                 LEFT OUTER JOIN PROD_PROFILE IP ON ISSN.PROD_ID = IP.PROD_ID
                 LEFT OUTER JOIN PROD_PROFILE PP ON PACK_ID.PROD_ID = PP.PROD_ID
                 LEFT OUTER JOIN SSN  ON ISSN.ORIGINAL_SSN = SSN.SSN_ID 
                 WHERE 1=1 AND PACK_ID.DESPATCH_ID IN (%s) ORDER BY PACK_ID DESC';
         
         $where = '';
         $values= array();
         
         if(!count($clause)) {
            
            $result['total']    =   0;
            $result['data']     =   array();
            
            return $result;    
             
         }
         foreach($clause as $key => $value) {
             $where     .=  '?, ';
             $data       =  explode('|', $value);
             $values[]   =  $data[0];     
         }
         
         $where = substr($where, 0, -2);
         $sql   = sprintf($sql, $where);
     
         $log = Zend_Registry::get('logger');
         $log->info(__FUNCTION__);
         $this->lastError = $sql;
     
         if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
         }
        
         list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
         $log->info($sqlQuery . ' : ' . implode(', ', $values));
    
         $total  = $this->findValue($sqlCount, $values);
         $data   = $this->findAllAssocMod($sqlQuery, $values);
        
         $result['total'] = $total;
         $result['data']  = $data;
        
         return $result;     
    }
    
    /**
    * Retrieve PACK_ID records which were created by DSOL transaction
    * 
    * @param string $connoteNo - Connote No to search PACK_IDs
    */
    public function getPackIdCretedByDSOL($connoteNo) {
        $sql = "
             SELECT 
                 PACK_ID.PACK_ID 
             FROM 
                 PACK_ID 
                 LEFT OUTER JOIN PICK_DESPATCH ON PACK_ID.DESPATCH_ID = PICK_DESPATCH.DESPATCH_ID 
             WHERE 
                 AWB_CONSIGNMENT_NO = ?
             AND
                 PACK_ID.PACK_TYPE IS NULL
        ";

        $sql = "
            SELECT 
                PACK_ID.PACK_ID 
            FROM 
                PICK_DESPATCH 
                JOIN PACK_ID ON PACK_ID.DESPATCH_ID = PICK_DESPATCH.DESPATCH_ID 
            WHERE 
                PICK_DESPATCH.AWB_CONSIGNMENT_NO = ?
            AND
                PACK_ID.PACK_TYPE IS NULL
        ";
        
        return $this->fetchAllAssoc($sql, $connoteNo);
    }
    
    /**
    * Updates PACK_ID dimension information for given ConnoteNo
    * Temporary method untill DSPI transaction will be available
    * 
    * @param array  $packIds 
    * @param array  $dimentions
    * 
    * @return int - updated records count 
    */
    public function updatePackIdDimensions($packIds, $dimentions = array()) {
        $enteredPacks = 0;
        foreach ($dimentions as $dimention) {
            $enteredPacks += $dimention['QTY'];
        }
        
        if (count($packIds) < $enteredPacks) {
            throw new Minder_Exception('Not enough PACK_ID records to fill in dimensions info.');
        }
        
        reset($packIds);
        foreach ($dimentions as $dimention) {
            for ($i = 0;$i < $dimention['QTY']; $i++) {
                list($key, $packRow) = each($packIds);
                
                $sql = "
                    UPDATE PACK_ID SET
                        DIMENSION_X     = ?,
                        DIMENSION_Y     = ?,
                        DIMENSION_Z     = ?,
                        VOLUME          = ?,
                        PACK_WEIGHT     = ?,
                        PACK_TYPE       = ?,
                        DIMENSION_UOM   = ?,
                        VOLUME_UOM      = ?,
                        PACK_WEIGHT_UOM = ?,
                        CUBIC_WEIGHT    = ?,
                        CHARGE_WEIGHT   = ?
                    WHERE
                        PACK_ID.PACK_ID = ?
                ";
                
                $dimention['CHARGE_WEIGHT'] = round($dimention['CHARGE_WEIGHT'],3);
                $dimention['WT'] = round($dimention['WT'],3);
                $dimention['CUBIC_WEIGHT'] = round($dimention['CUBIC_WEIGHT'],3);

                
                $this->execSQL(
                    $sql, 
                    array(
                        $dimention['L'], 
                        $dimention['W'], 
                        $dimention['H'], 
                        $dimention['VOL'], 
                        $dimention['WT'], 
                        $dimention['TYPE'], 
                        $dimention['DIMENSION_UOM'], 
                        $dimention['VOLUME_UOM'], 
                        $dimention['PACK_WEIGHT_UOM'], 
                        $dimention['CUBIC_WEIGHT'],
                        $dimention['CHARGE_WEIGHT'],
                        $packRow['PACK_ID']
                    )
                );
            }
        }
        
        return $enteredPacks;
    }
    
    /**
    * get list from PICK_ITEM_DETAIL table
    * 
    * @param mixed $clause
    * @param mixed $pageNo
    * @param mixed $resultsPerPage
    */
    public function getPickItemDetailList($clause, $pageNo = 0, $resultsPerPage = 15, $dbFields = array()) {
    
         $filteredColumns    =   array('PICK_ITEM_DETAIL.SSN_ID');
         $select             =   '';
         $from               =   '';
         if(count($dbFields['db_fileds']) > 0){
            for($i=0; $i < count($dbFields['db_fileds']); $i++){
                if(!in_array($dbFields['db_fileds'][$i], $filteredColumns)){
                   $select .= $dbFields['db_fileds'][$i] . ', '; 
                }
            }
         }
        
         $sql = "SELECT DISTINCT
                     $select
                     PICK_ITEM_DETAIL.SSN_ID
                     
                 FROM PICK_ITEM_DETAIL 
                 LEFT OUTER JOIN PICK_ITEM ON PICK_ITEM_DETAIL.PICK_LABEL_NO = PICK_ITEM.PICK_LABEL_NO
                 LEFT OUTER JOIN ISSN ON PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID  
                 LEFT OUTER JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID  
                 LEFT OUTER JOIN PACK_ID ON PICK_ITEM_DETAIL.DESPATCH_ID = PACK_ID.DESPATCH_ID   
                 AND PICK_ITEM_DETAIL.SSN_ID = PACK_ID.SSN_ID
                 WHERE 1=1 AND PICK_ITEM.PICK_ORDER IN (%s)";
         $sql = "SELECT DISTINCT
                     $select
                     PICK_ITEM_DETAIL.SSN_ID
                     
                 FROM PICK_ITEM 
                 JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.PICK_LABEL_NO = PICK_ITEM.PICK_LABEL_NO
                 LEFT OUTER JOIN PACK_ID ON PICK_ITEM_DETAIL.DESPATCH_ID = PACK_ID.DESPATCH_ID   
                 AND PICK_ITEM_DETAIL.SSN_ID = PACK_ID.SSN_ID
                 LEFT OUTER JOIN ISSN ON PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID  
                 LEFT OUTER JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID  
                 WHERE PICK_ITEM.PICK_ORDER IN (%s)";
         
         $where = '';
         $values= array();
         
         if(!count($clause)) {
            
            $result['total']    =   0;
            $result['data']     =   array();
            
            return $result;    
             
         }
         foreach($clause as $key => $value) {
             $where     .=  '?, ';
             $data       =  explode('|', $value);
             $values[]   =  $data[1];     
         }
         
         $where = substr($where, 0, -2);
         $sql   = sprintf($sql, $where);
         
         $log = Zend_Registry::get('logger');
         $log->info(__FUNCTION__);
         $this->lastError = $sql;

         if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
         }
        
         list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
         $log->info($sqlQuery . ' : ' . implode(', ', $values));
    
         $total  = $this->findValue($sqlCount, $values);
         $data   = $this->findAllAssocMod($sqlQuery, $values);
         
         $result['total'] = $total;
         $result['data']  = $data;
        
         return $result;     
    }
    
    /**
    * get list from PICK_ITEM_DETAIL table
    * 
    * @param int $packId
    */
    public function getPackItemDetail($ssnId) {
    
         $sql = "SELECT DISTINCT
                     PICK_ITEM.PICK_ORDER, 
                     PICK_ITEM_DETAIL.DESPATCH_ID,
                     PACK_ID.PACK_ID,
                     PICK_ITEM_DETAIL.SSN_ID,
                     ISSN.PROD_ID,
                     SSN.SSN_DESCRIPTION,
                     PICK_ITEM_DETAIL.QTY_PICKED,
                     PICK_ITEM_DETAIL.FROM_WH_ID,
                     PICK_ITEM_DETAIL.FROM_LOCN_ID       
                     
                 FROM PICK_ITEM_DETAIL 
                 LEFT OUTER JOIN PICK_ITEM ON PICK_ITEM_DETAIL.PICK_LABEL_NO = PICK_ITEM.PICK_LABEL_NO
                 LEFT OUTER JOIN ISSN ON PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID  
                 LEFT OUTER JOIN SSN ON ISSN.ORIGINAL_SSN = SSN.SSN_ID  
                 LEFT OUTER JOIN PACK_ID ON PICK_ITEM_DETAIL.DESPATCH_ID = PACK_ID.DESPATCH_ID   
                 AND PICK_ITEM_DETAIL.SSN_ID = PACK_ID.SSN_ID
                 WHERE 1=1 AND PICK_ITEM_DETAIL.SSN_ID = '%s' ORDER BY PACK_ID DESC";
         
         $sql   = sprintf($sql, $ssnId);
      
         $log = Zend_Registry::get('logger');
         $log->info(__FUNCTION__);
         $this->lastError = $sql;

         $data   = $this->findOneAssoc($sql);
      
         return $data;     
    }
    
    /**
    * get list Despatched Orders
    * 
    * @param aray $clause
    * @param int $pageNo
    * @param int $resultsPerPage
    * @param array $dbFields
    */
    function getDespatchedOrderList($clause, $pageNo = 0, $resultsPerPage = 15, $dbFields){
         
         $selectedFields    =   null;
         if(count($dbFields['db_fileds']) > 0){
             foreach($dbFields['db_fileds'] as $field){
                 if($field != 'PICK_DESPATCH.DESPATCH_ID'){
                    $selectedFields .= $field . ', ';  
                 }
             }
         }
         
                                            
         $sql = 'SELECT DISTINCT '
                    . $selectedFields .
                     
                    '
                      PICK_DESPATCH.DESPATCH_ID
                    FROM PICK_ORDER
                    
                    LEFT OUTER JOIN PICK_ITEM ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER
                    LEFT OUTER JOIN PICK_ITEM_DETAIL ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO 
                    LEFT OUTER JOIN PICK_DESPATCH ON PICK_DESPATCH.DESPATCH_ID = PICK_ITEM_DETAIL.DESPATCH_ID
                    LEFT OUTER JOIN PACK_ID ON PACK_ID.DESPATCH_ID = PICK_DESPATCH.DESPATCH_ID
                 
                 WHERE 1=1 AND PICK_ORDER.PICK_ORDER IS NOT NULL AND ';
        
         $values= array();
         if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                $sql .= $key;
                if(!empty($val)){
                    $values[] = $val;
                }
            }
         }
         
         $sql   = substr($sql, 0, -5);
      
         $sql  .= ' ORDER BY PICK_ORDER ASC'; 
         $log = Zend_Registry::get('logger');
         $log->info(__FUNCTION__);
         $this->lastError = $sql;
      
         if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
         }
        
         list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
         $log->info($sqlQuery . ' : ' . implode(', ', $values));
    
         $total  = $this->findValue($sqlCount, $values);
         $data   = $this->findAllAssocMod($sqlQuery, $values);
        
         $result['total'] = $total;
         $result['data']  = $data;
        
         return $result;     
    }
    
    
    /**
    * @desc get carrier list by clause
    * @param array $clause
    * 
    * @return void 
    */
    public function getCarrierByClause($clause){
    
        $sql = 'SELECT *
                FROM CARRIER
                WHERE 1=1 AND ';
        
        $values = array();
        
        foreach($clause as $key => $value){
            $sql       .=   $key;
            $values[]   =   $value;    
        }
        
        $sql = substr($sql, 0, -5);
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $this->lastError = $sql;
     
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $data   = $this->findAllAssocMod($sql, $values);
        
        return $data;
        
    }
    
    /**
    * @desc get KEY => VALUE list from table
    * @param string $table
    * @param array  $clause
    * 
    * @return list 
    */
    public function getFildListFromAnyTable($table, $fieldName) {
    
        $sql = 'SELECT DISTINCT 
                       %s          
                FROM   %s
                WHERE  %s';
        
        $fieldList = $fieldName . ' AS VAL_KEY, '.
                     $fieldName . ' AS VAL_VAL';
        
        $whereList = $fieldName . ' <> NULL OR ' . $fieldName . ' <> \'\' ';
        $sql       = sprintf($sql, $fieldList, $table, $whereList);

        $dataList  = minder_array_merge(array(''    =>  ''), $this->findList($sql));
        
        return $dataList; 
    }
    /**
    * @desc update ORDER information
    * @param array $clause
    * @param string $order
    * 
    * @return boolean 
    */
    public function updateOrder(array $clause, $order){
        $sql = 'UPDATE PICK_ORDER
                SET ';
        
        $args   =   array();
        $values =   array();
        foreach($clause as $key =>  $value){
            if(!empty($value)){
                $values[]   =   $value;
                $sql       .=   $key . ', ';
            }   
        }
                $values[]   =   $order; 
        
        $sql    =   substr($sql, 0, -2);
        $sql   .=   ' WHERE PICK_ORDER = ?';
        
        $result = $this->execSQL($sql, $values);    
        
        return $result;
    }
    
    public function updateOrderField(array $clause, $fieldName, $fieldValue)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info(print_r($clause, true));
        //$log->info(print_r($params, true));
    // do I have an order no
        $pickOrder = '';
        $personId = '';
        foreach ($clause as $key => $val) {
            // key is PICK_ORDER = ? 
            if (false !== strpos($key, 'PICK_ORDER')) {
                $pickOrder  = $val;
            }
            if (false !== strpos($key, 'PERSON_ID')) {
                $personId  = $val;
            }
        }
/*
        if the person exists
               if  person status is CU or OB then ok
               else cannot do this
        else an imported order so ok
*/
        if ($personId == '') {
            // no person in the update list
            // so need to get the person from the existing order
            $order = $this->getPickOrder($pickOrder, '') ;
            $personId = $order->personId;
        }
        $person = $this->getPerson($personId , false, 'OF');
        if ($person != null) {
            if ($person->status !== 'CU' and $person->status !== 'OB') {
                $this->lastError = 'Cannot Update Sales Order with Non Current Person.';
                return false;
            }
        }

        if (strtoupper($fieldName) == 'DESPATCH_LOCATION') {

            if (empty($fieldValue)) {
                $fieldValue = $this->defaultControlValues['DEFAULT_DESPATCH_LOCATION'];

                if (empty($fieldValue)) {
                    $this->lastError = 'Despatch Location cannot be NULL.';
                    return false;
                }
            }
        }

        $sql = 'UPDATE PICK_ORDER SET ' . $fieldName . ' = ? WHERE 1=1 AND ';
        $params = array($fieldValue);
        foreach ($clause as $key => $val) {
            if (false !== strpos($key, '?')) {
                $params[] = $val;
            }
            $sql .= $key;
        }
        //$sql = substr($sql, 0, -5);

        $log->info($sql . ' : ' . implode(',', $params));
        //$log->info(print_r($params, true));
        
        return $this->execSQL($sql, $params);
    }
    
    public function updatePickOrderItemField(array $clause, $fieldName, $fieldValue)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info(print_r($clause, true));
        $result = true;
        $params = array($fieldValue);
        //$log->info(print_r($params, true));

        $sql = 'UPDATE PICK_ITEM SET ' . $fieldName . ' = ? WHERE 1=1 AND ';
        foreach ($clause as $key => $val) {
            if (false !== strpos($key, '?')) {
                $params[] = $val;
            }
            $sql .= $key;
        }
        
        $sql = substr($sql, 0, -5);
        
        $log->info($sql . ' : ' . implode(',', $params));
        //$log->info(print_r($params, true));
        $result  = $this->execSQL($sql, $params);
   
        return $result;
    }
    
    /**
     * @desc retuns PRODUCT_COND_STATUS for ssn
     *
    */
    public function getProductConditions($ssn_id, $code = null, $view_by = null, $pages = null) {

        $show_by = ($view_by == null) ? 5 : $view_by;
        $page_no = ($pages   == null) ? 0 : $pages;

        $skip   = ($page_no * $show_by);
        $first  = $show_by;

        $conditionsList = array();

        if ( $code == null ) {
            $sql            = 'SELECT * FROM PRODUCT_COND_STATUS WHERE SSN_ID = ?';
            $conditionsList = $this->findAllAssoc($sql, $ssn_id);
            $total          = count($conditionsList);

            $offset = ($total < $skip) ? 0 : $skip;

            return array_splice($conditionsList, $offset, $first);

        } else {
            $sql            = 'SELECT * FROM PRODUCT_COND_STATUS WHERE SSN_ID = ? AND CODE = ?';
            $conditionsList = $this->findAllAssoc($sql, $ssn_id, $code);
            $total          = count($conditionsList);

            $offset = ($total < $show_by) ? 0 : $skip;

            return array_splice($conditionsList, $offset, $first);
        }

    }

    /*
     * restore old getProductConditions method
     * */
    public function getProductConditionsAll($ssn_id, $code = null) {
        if ( $code == null ) {
            $sql = 'SELECT * FROM PRODUCT_COND_STATUS WHERE SSN_ID = ?';
            return $this->findAllAssoc($sql, $ssn_id);

        } else {
            $sql = 'SELECT * FROM PRODUCT_COND_STATUS WHERE SSN_ID = ? AND CODE = ?';
            return $this->findAllAssoc($sql, $ssn_id, $code);
        }
    }

    
    /**
    * get ISSN data for PC_LABEL print
    * 
    * @param string $id - issn id
    * @return array of data
    */
    public function getIssnForPrint($id){
            
        $sql = "
                SELECT  ISSN.*,
                        SSN.*,
                        GRN.*,
                        PROD_PROFILE.*,
                        COMPANY.*
                FROM ISSN
                JOIN CONTROL ON CONTROL.RECORD_ID = 1
                LEFT OUTER JOIN SSN ON SSN.SSN_ID = ISSN.ORIGINAL_SSN
                LEFT OUTER JOIN GRN  ON GRN.GRN = SSN.GRN
                LEFT OUTER JOIN PROD_PROFILE ON (ISSN.PROD_ID = PROD_PROFILE.PROD_ID)
                LEFT OUTER JOIN COMPANY ON ISSN.COMPANY_ID = COMPANY.COMPANY_ID
                LEFT OUTER JOIN PICK_ITEM ON PICK_ITEM.SSN_ID = ISSN.SSN_ID
                           AND (POS(CONTROL.PICK_RESERVED_SSN_STATUS, PICK_ITEM.PICK_LINE_STATUS, 0, 1) > -1)
                WHERE (PICK_ITEM.PICK_LABEL_NO IN (
                                                  SELECT MAX(PICK_LABEL_NO)
                                                  FROM PICK_ITEM
                                                  WHERE PICK_ITEM.ssn_id = ISSN.ssn_id
                                          )
                      OR PICK_ITEM.PICK_LABEL_NO IS NULL) AND ISSN.SSN_ID = '$id'";
    
       $result =   $this->findOneAssocExt($sql); 
        
        return $result;
    }
    /**
    * get LOCATION data for PC_LABEL print
    * 
    * @param string $id - issn id
    * @return array of data
    */
    public function getLocationForPrint($id,$whId){
        
       $sql = "SELECT 
                    LOCATION.*,
                    ISSN.*,
                    PROD_PROFILE.*,
                    SSN.*
                FROM LOCATION
                LEFT OUTER JOIN ISSN ON (ISSN.LOCN_ID = LOCATION.LOCN_ID AND ISSN.WH_ID = LOCATION.WH_ID)
                LEFT OUTER JOIN PROD_PROFILE ON (ISSN.PROD_ID = PROD_PROFILE.PROD_ID)
                LEFT OUTER JOIN SSN ON (ISSN.ORIGINAL_SSN = SSN.SSN_ID)
                WHERE LOCATION.LOCN_ID = '$id' AND LOCATION.WH_ID='$whId'";
     
        $result =   $this->findOneAssocExt($sql); 
        
        return $result;
    }
    /**
    * get GRN data for PC_LABEL print
    * 
    * @param string $id - issn id
    * @return array of data
    */
    public function getGrnForPrint($id){
        
       $sql = "SELECT 
                    GRN.*,
                    GRN_ORDER.*
                FROM GRN
                LEFT OUTER JOIN GRN_ORDER ON GRN_ORDER.GRN = GRN.GRN 
                WHERE GRN.GRN = '$id'";
     
        $result =   $this->findOneAssocExt($sql); 
        
        return $result;
    }
    
    /**
    * get list from PACK_ID for print
    *
    * @deprecated remove when possible
    * @param string $id - DESPATCH_ID if $reprint == false | PACK_ID if $reprint == true
    * @param bool   $reprint - printing new lablels or reprinting old 
    */
    public function getPackIdListForPrint($id, $reprint = false) {
        
        $filter = array();
        $args   = array();
        
        if ($reprint) {
            $filter[] = 'PACK_ID.PACK_ID = ?';
            $args[]   = $id;
        } else {
            $filter[] = 'PACK_ID.DESPATCH_ID = ?';
            $filter[] = 'PACK_ID.LABEL_PRINTED_DATE IS NULL';
            $args[]   = $id;
        }
    
         $sql = "SELECT DISTINCT 
                    PACK_ID.PACK_ID,
                    PACK_ID.DESPATCH_ID,
                    PACK_ID.CREATE_DATE,
                    PACK_ID.LABEL_PRINTED_DATE,
                    PACK_ID.DESPATCH_LABEL_NO,
                    PACK_ID.LAST_UPDATE_DATE,
                    CASE WHEN PACK_ID.PROD_ID IS NULL OR PACK_ID.PROD_ID = '' 
                        THEN ISSN.PROD_ID
                    ELSE
                       PACK_ID.PROD_ID 
                    END PROD_ID,
                    PACK_ID.QTY,
                    PACK_ID.SSN_ID,
                    PACK_ID.DIMENSION_X,
                    PACK_ID.DIMENSION_Y,
                    PACK_ID.DIMENSION_Z,
                    PACK_ID.DIMENSION_UOM,
                    PACK_ID.VOLUME,
                    PACK_ID.VOLUME_UOM,
                    PACK_ID.PACK_WEIGHT,
                    PACK_ID.PACK_WEIGHT_UOM,
                    PACK_ID.PACK_TYPE,
                    PACK_ID.PACK_SERIAL_NO,
                    PACK_ID.PACK_SEQUENCE_NO,
                    PACK_ID.PACK_LAST_SEQUENCE_INDICATOR,
                    ISSN.ISSN_DESCRIPTION,
                    PICK_DESPATCH.*,
                    PICK_ITEM_DETAIL.*,
                    PICK_ORDER.*,
                    CARRIER_SERVICE.*,
                    CARRIER.CONNOTE_PREFIX,
                    CARRIER.NOT_LAST_PACK_INDICATOR,
                    CARRIER.LAST_PACK_INDICATOR
                 FROM PACK_ID
                 LEFT OUTER JOIN ISSN ON ISSN.ORIGINAL_SSN = PACK_ID.SSN_ID
                 LEFT OUTER JOIN PICK_DESPATCH ON PICK_DESPATCH.DESPATCH_ID = PACK_ID.DESPATCH_ID
                 LEFT OUTER JOIN PICK_ITEM_DETAIL ON PICK_ITEM_DETAIL.PACK_ID = PACK_ID.PACK_ID
                 LEFT OUTER JOIN PICK_ITEM ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
                 LEFT OUTER JOIN PICK_ORDER ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
                 LEFT OUTER JOIN CARRIER_SERVICE ON PICK_DESPATCH.PICKD_SERVICE_RECORD_ID = CARRIER_SERVICE.RECORD_ID
                 LEFT OUTER JOIN CARRIER ON CARRIER_SERVICE.CARRIER_ID = CARRIER.CARRIER_ID

                 WHERE " . implode(' AND ', $filter) . " 
                 ORDER BY PACK_ID.PACK_ID DESC";
         
         $values = $args;
         
         $log = Zend_Registry::get('logger');
         $log->info(__FUNCTION__);
         $this->lastError = $sql;
        
         if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
         }
        
         list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql);
         $log->info($sqlQuery . ' : ' . implode(', ', $values));
         
         array_unshift($values, $sql);
        Zend_Registry::get('logger')->debug(array('file' => __FILE__, 'line' => __LINE__, $values));

         $data['data']            = call_user_func_array(array($this, 'fetchAllAssocExt'), $values);
         $data['printed_ammount'] = 0;
         $data['labels_ammount']  = 0;
         
         $despatchId = null;
         if ($reprint) {
             $despatchId = (isset($data['data'][0])) ? $data['data'][0]['PACK_ID.DESPATCH_ID'] : null;
         } else {
             $despatchId = $id;
         }
         
         if (!empty($despatchId)) {
             //find how many labels is for selected despatch
             $sql = 'SELECT COUNT(DISTINCT PACK_ID.PACK_ID) FROM PACK_ID WHERE PACK_ID.DESPATCH_ID = ?';
             $value = $this->findValue($sql, $despatchId);
             $data['labels_ammount'] = (is_int($value)) ? $value : 0;
         }
         
         if (!$reprint) {
             //find how many labels was already printed for selected despatch
             $sql = 'SELECT COUNT(DISTINCT PACK_ID.PACK_ID) FROM PACK_ID WHERE PACK_ID.DESPATCH_ID = ? AND PACK_ID.LABEL_PRINTED_DATE IS NOT NULL';
             $value = $this->findValue($sql, $id);
             $data['printed_ammount'] = (is_int($value)) ? $value : 0;
         }
        
         return $data;     
    }
    
    /**
     * @desc retuns PRODUCT_CONDITION for code(A,B,C,D,E)
     *  
    */
    public function getProductConditionTypes($code = null)
    {
        if ( $code!=null ) {
            $sql = 'SELECT * FROM PRODUCT_CONDITION WHERE CODE = ?';
            return $this->findAllAssoc($sql, $code);
        } else {
            $sql = 'SELECT * FROM PRODUCT_CONDITION';
            return $this->findAllAssoc($sql);
        }
        
    }
    
    /**
     * @desc add Condition at  PRODUCT_COND_STATUS table
     * @return false when transaction fails otherwise count of inserted rows
     * 
     */
    public function addCondition($ssn_id, $code, $description, $original_test)
    {
        $updTime    = date('d.m.Y H:i:s');
        $userName   = $this->userId;

        $sql        = 'INSERT INTO PRODUCT_COND_STATUS VALUES(?, ?, ?, ?, ?)';
        
        $query      = ibase_prepare($this->db, $sql);

        if (false !== $query) {
            if (false === ($result = ibase_execute($query, $ssn_id, $code, $description, $original_test, $updTime))) {
                $errcode = ibase_errcode();
                $errmsg  = ibase_errmsg();
                ibase_free_query($query);
                $this->lastError = $errcode . ': ' . $errmsg . '. Query text: ' . $sql;
                return false;
            }
            else {
                $this->commitTransaction();
                ibase_free_result($result);
                ibase_free_query($query);
                return true;
            }
        }

        return false;
    }

    /**
     * @desc get number of loaned items for given borrower
     *
     */
    public function deleteCondition($ssn_id, $code, $description, $original_test)
    {
        $updTime    = date('d.m.Y H:i:s');
        $userName   = $this->userId;

        $sql = "DELETE FROM PRODUCT_COND_STATUS WHERE SSN_ID = '" . $ssn_id .
                                                  "' AND CODE = '" . $code .
                                                  "' AND ORIGINAL_TEST = '" . $original_test .
                                                  "' AND DESCRIPTION = '" .$description .'\'';

        try {
            if (false === ($result = $this->execSQL($sql))) {
                throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
            }
            else {
                $this->commitTransaction();
            }
        } catch (Exception $e) {
            $this->lastError = $e->getMessage();
            $this->rollbackTransaction();

            return false;
        }

        return $result;
    }

    /**
     * @desc get number of loaned items for given borrower
     * 
     */
    
    public function getLoanedByBorrower($id)
    {
        $sql = "SELECT COUNT (*) AS LOANED FROM ISSN WHERE WH_ID = 'XB' AND LOCN_ID = '$id'";
        $result =   $this->findOneAssocExt($sql);
        return $result['LOANED'];
    }
    
    /**
     * @desc get number of loaned items for given borrower
     * 
     */
    
    public function getListLoanedByBorrower($id = '', $clause = null)
    {
        if ($clause == null) {
            $sql = "select
                            issn.ssn_id,
                            issn.ssn_id as record_id,
                            ssn.into_date,
                            ssn.ssn_description, 
                            ssn.loan_last_safety_check_date,
                            ssn.loan_last_calibrate_check_date,
                            location.wh_id || location.locn_id as borrower_id,
                            location.locn_name
               from issn
               left outer join ssn on ssn.ssn_id = issn.ssn_id
               left join LOCATION ON issn.wh_id = location.wh_id and issn.locn_id = location.locn_id
               where issn.wh_id = 'XB' and issn.locn_id = '$id';";
        } else {
            $sql = "select issn.ssn_id, 
                            issn.ssn_id as record_id,
                            ssn.into_date,
                            ssn.ssn_description, 
                            ssn.loan_last_safety_check_date,
                            ssn.loan_last_calibrate_check_date,
                            location.wh_id || location.locn_id as borrower_id,
                            location.locn_name
               from issn
               left outer join ssn on ssn.ssn_id = issn.ssn_id
               left join LOCATION ON issn.wh_id = location.wh_id and issn.locn_id = location.locn_id
               where $clause ;";
        }
        $result =   $this->findAllAssoc($sql);
        return $result;
    }
    
    public function getIssuesAndReturnsByBorrower($borrowerId) {
        $sql = "
            SELECT FIRST 100
                SSN_HIST.WH_ID || SSN_HIST.LOCN_ID AS BORROWER_ID,
                LOCATION.LOCN_NAME,
                'T' || RECORD_ID AS RECORD_ID,
                SSN_HIST.SSN_ID AS TOOL_OR_PRODUCT,
                CASE
                    WHEN TRN_TYPE = 'TRIL' THEN 'I'
                    WHEN TRN_TYPE = 'TROL' THEN 'R'
                END AS ACTION,
                SSN.LOAN_LAST_SAFETY_CHECK_DATE,
                SSN.LOAN_LAST_CALIBRATE_CHECK_DATE,
                TRN_DATE,
                SSN.SSN_DESCRIPTION AS DESCRIPTION,
                1 AS QTY
            FROM
                SSN_HIST
                LEFT JOIN SSN ON SSN.SSN_ID = SSN_HIST.SSN_ID
                LEFT JOIN LOCATION ON SSN_HIST.WH_ID = LOCATION.WH_ID AND SSN_HIST.LOCN_ID = LOCATION.LOCN_ID
            WHERE
                TRN_TYPE IN ('TRIL', 'TROL')
                AND SSN_HIST.LOCN_ID = ?
                AND SSN_HIST.WH_ID = 'XB'
            ORDER BY
                SSN_HIST.TRN_DATE DESC,
                SSN_HIST.RECORD_ID DESC
        ";

        $tools = $this->fetchAllAssoc($sql, $borrowerId);

        $sql = "
            SELECT FIRST 100
                TRANSACTIONS_ARCHIVE.WH_ID || TRANSACTIONS_ARCHIVE.LOCN_ID AS BORROWER_ID,
                LOCATION.LOCN_NAME,
                'P' || RECORD_ID AS RECORD_ID,
                OBJECT AS TOOL_OR_PRODUCT,
                'I' AS ACTION,
                TRN_DATE,
                PROD_PROFILE.SHORT_DESC AS DESCRIPTION,
                TRANSACTIONS_ARCHIVE.QTY
            FROM
                TRANSACTIONS_ARCHIVE
                LEFT JOIN PROD_PROFILE ON TRANSACTIONS_ARCHIVE.OBJECT = PROD_PROFILE.PROD_ID
                LEFT JOIN LOCATION ON TRANSACTIONS_ARCHIVE.WH_ID = LOCATION.WH_ID AND TRANSACTIONS_ARCHIVE.LOCN_ID = LOCATION.LOCN_ID
            WHERE
                TRN_TYPE = 'ISIZ'
                AND TRANSACTIONS_ARCHIVE.WH_ID = 'XB'
                AND TRANSACTIONS_ARCHIVE.LOCN_ID = ?
            ORDER BY
                TRN_DATE DESC,
                RECORD_ID DESC
        ";

        $products = $this->fetchAllAssoc($sql, $borrowerId);

        $result = array_merge($tools, $products);

        usort($result, create_function('$a, $b', 'return strtotime($b["TRN_DATE"]) - strtotime($a["TRN_DATE"]);'));

        return array_slice($result, 0, 100) ;
    }
    
    public function getReturnsByBorrower($borrowerId) {
        $sql = "
            SELECT FIRST 100
                SSN_HIST.WH_ID || SSN_HIST.LOCN_ID AS BORROWER_ID,
                LOCATION.LOCN_NAME,
                RECORD_ID AS RECORD_ID,
                SSN_HIST.SSN_ID AS TOOL_OR_PRODUCT,
                SSN.LOAN_LAST_SAFETY_CHECK_DATE,
                SSN.LOAN_LAST_CALIBRATE_CHECK_DATE,
                TRN_DATE,
                SSN.SSN_DESCRIPTION AS DESCRIPTION
            FROM
                SSN_HIST
                LEFT JOIN SSN ON SSN.SSN_ID = SSN_HIST.SSN_ID
                LEFT JOIN LOCATION ON SSN_HIST.WH_ID = LOCATION.WH_ID AND SSN_HIST.LOCN_ID = LOCATION.LOCN_ID
            WHERE
                TRN_TYPE IN ('TROL')
                AND SSN_HIST.LOCN_ID = ?
                AND SSN_HIST.WH_ID = 'XB'
            ORDER BY
                SSN_HIST.TRN_DATE DESC,
                SSN_HIST.RECORD_ID DESC
        ";

        $tools = $this->fetchAllAssoc($sql, $borrowerId);

        return array_slice($tools, 0, 100) ;
    }

    /**
    * get list from IMPORT MAP table
    * 
    * @param array $clause
    * @param int $pageNo
    * @param int $resultsPerPage
    * 
    * @return array $result
    */
    public function getMapList($clause, $pageNo = null, $resultsPerPage = null){
        
        $sql    =   'SELECT *
                     FROM IMPORT_MAP
                     WHERE 1=1 AND ';
                     
         $values= array();
         if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                $sql .= $key;
                if(!empty($val)){
                    $values[] = $val;
                }
            }
         }
         
         $sql   = substr($sql, 0, -5);
         
         $log = Zend_Registry::get('logger');
         $log->info(__FUNCTION__);
         $this->lastError = $sql;
        
         if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
         }
        
         list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage);
         $log->info($sqlQuery . ' : ' . implode(', ', $values));
       
         $total  = $this->findValue($sqlCount, $values);
         $data   = $this->findAllAssocMod($sqlQuery, $values);
        
         $result['total'] = $total;
         $result['data']  = $data;
        
         return $result;     
        
    }
    /**
    * delete one record from IMPORT_MAP table
    * 
    * @param string|array $ids
    * 
    * @return boolean
    */
    public function deleteMapRecords($ids){

        $ids = (is_array($ids)) ? $ids : array($ids);

        $sql = 'DELETE FROM IMPORT_MAP
                WHERE RECORD_ID IN (' . substr(str_repeat('?, ', count($ids)), 0, -2) . ')';
        
        $result = $this->execSQL($sql, $ids);
        
        return $result;    
    }


    /**
     * get records from IMPORT_MAP table
     *
     * @param void
     *
     * @return array
     */
    public function getMapRecords()
    {
        $sql = 'SELECT * FROM IMPORT_MAP';

        $result = $this->fetchAllAssoc($sql);

        return $result;
    }

    /**
    * update IMPORT_MAP record
    * 
    * @param int $id
    * @param array $data
    */
    public function updateMapList($id, $data){
        
        
        $sql = 'UPDATE IMPORT_MAP
                SET %s
                WHERE RECORD_ID = ?';
        
        $params = '';
        $values = array();
        
        foreach($data as $key => $value) {
            $params .= $key . ' = ?, ';
            $values[]= $value;
        }
            $values[]= $id;
        
        $sql = sprintf($sql, substr($params, 0, -2));
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $this->lastError = $sql;
        $result = $this->execSQL($sql, $values);
        
        if($result) {
            return true;
        }
            return false;
           
    }
    
    /**
    * inset records into IMPORT_MAP table
    * 
    * @param string $mapType    -   map name, must be P|T|S
    * @param string $fileName   -   xls file name
    * @param string $sheet      -   shhet name
    * @param array $columns     -   list of excel columns 
    * @param string $tableName  -   table name to import
    * @param array $fields      -   array of importing fields
    * 
    * @return boolean
    */
    public function insertMapRecord($mapType, $fileName, $sheet, $columns, $tableName, $fields){
        
        $sql = 'INSERT 
                INTO IMPORT_MAP(MAP_TYPE, MAP_IMPORT_FILENAME, MAP_IMPORT_SHEET, MAP_IMPORT_COL,
                                MAP_IMS_TABLE, MAP_IMS_FIELDNAME, MAP_IMS_FIELDTYPE, MAP_IMS_FORMAT,
                                CREATED_BY, CREATED_DATE)
                VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?)';
        
        $creadetDate    =   date('Y-m-d H:i:s');
        $creadetBy      =   $this->userId;
        $tableName      =   trim($tableName);
        $fieldList      =   $this->getTableFieldType($tableName);
        $fieldType      =   array();
        
        $result         =   false;
        $fildTypeCode   =   array('BLOB'     =>  261,    'CHAR'      =>  14, 'CSTRING'   =>  40, 'D_FLOAT'   =>  11,
                                  'DOUBLE'   =>  27,     'FLOAT'     =>  10, 'INT64'     =>  16, 'INTEGER'   =>  8,
                                  'QUAD'     =>  9,      'SMALLINT'  =>  7,  'DATE'      =>  12, 'TIME'      =>  13,
                                  'TIMESTAMP'=>  35,     'VARCHAR'   =>  37, 
                                 );
        
        foreach($fieldList as $value){
           $fieldType[trim($value['FIELD_NAME'])]   =  $fildTypeCode[trim($value['FIELD_TYPE'])];       
        }
        
        foreach($fields as $key =>  $value){
        
            $params =   array();
            
            $params[]   =   $mapType;
            $params[]   =   $fileName;
            $params[]   =   $sheet;
            $params[]   =   $columns[$key];
            $params[]   =   $tableName;
            $params[]   =   $value;
            if($value == 'IGNORE COLUMN'){
                $params[]   =   0;
            } else {
                $params[]   =   $fieldType[$value];    
            }
            if($value != 'IGNORE COLUMN' && ($fieldType[$value] == 35 || $fieldType[$value] == 12)){
                $params[]   =   date('d-m-Y');    
            } else {
                $params[]   =   date('d-m-Y');
            }
            $params[]   =   $creadetBy;
            $params[]   =   $creadetDate;
            
            if (false === ($result =   $this->execSQL($sql, $params)))
                throw new Minder_Exception('Error inserting Import Map record: ' . $this->lastError);
            
        }
        
        return $result;
        
    }
    
    /**
    * get type fileds for selected table 
    * 
    * @param mixed $table
    * @return array
    */
    
    public function getTableFieldType($table){
        
        $sql    =  'SELECT r.RDB$FIELD_NAME AS field_name,
                    f.RDB$FIELD_LENGTH AS field_length,
                    CASE f.RDB$FIELD_TYPE
                      WHEN 261 THEN \'BLOB\'
                      WHEN 14 THEN \'CHAR\'
                      WHEN 40 THEN \'CSTRING\'
                      WHEN 11 THEN \'D_FLOAT\'
                      WHEN 27 THEN \'DOUBLE\'
                      WHEN 10 THEN \'FLOAT\'
                      WHEN 16 THEN \'INT64\'
                      WHEN 8 THEN \'INTEGER\'
                      WHEN 9 THEN \'QUAD\'
                      WHEN 7 THEN \'SMALLINT\'
                      WHEN 12 THEN \'DATE\'
                      WHEN 13 THEN \'TIME\'
                      WHEN 35 THEN \'TIMESTAMP\'
                      WHEN 37 THEN \'VARCHAR\'
                      ELSE \'UNKNOWN\'
                    END AS field_type,
                    f.RDB$FIELD_SUB_TYPE AS field_subtype,
                    r.RDB$DEFAULT_VALUE AS field_default_value,
                    r.RDB$NULL_FLAG AS field_not_null_constraint,
                    r.RDB$DESCRIPTION AS field_description,        
                    f.RDB$FIELD_PRECISION AS field_precision,
                    f.RDB$FIELD_SCALE AS field_scale,
                    coll.RDB$COLLATION_NAME AS field_collation,
                    cset.RDB$CHARACTER_SET_NAME AS field_charset
               FROM RDB$RELATION_FIELDS r
               LEFT JOIN RDB$FIELDS f ON r.RDB$FIELD_SOURCE = f.RDB$FIELD_NAME
               LEFT JOIN RDB$COLLATIONS coll ON r.RDB$COLLATION_ID = coll.RDB$COLLATION_ID
                AND f.RDB$CHARACTER_SET_ID = coll.RDB$CHARACTER_SET_ID
               LEFT JOIN RDB$CHARACTER_SETS cset ON f.RDB$CHARACTER_SET_ID = cset.RDB$CHARACTER_SET_ID
              WHERE r.RDB$RELATION_NAME = ?
            ORDER BY r.RDB$FIELD_NAME;';
        
        $result = $this->findAllAssocMod($sql, $table);
        
        return $result;
            
    }

    /**
    * get list from ORDER_TYPE table
    * 
    * @param string $outwards
    */
    public function getOrderTypeList($outwards = 'F'){
        
        $outwards   =   strtoupper($outwards);
        
        $sql = 'SELECT ORDER_TYPE,
                       DESCRIPTION
                FROM ORDER_TYPE
                WHERE OUTWARDS = ?';
        
        return $this->findList($sql, $outwards); 
   
    }
    
    /**
    * run Firebird generato
    * 
    * @param string $generatorName - generator name
    */
    public function runDbGenerator($generatorName){
    
        $sql = sprintf('SELECT GEN_ID(%s, 1) FROM RDB$DATABASE', strtoupper($generatorName)); 
  
        return $this->findValue($sql);
        
    }
    
    /**
    * populate WEB_REQUESTS table
    * 
    * @param string $messageId
    * @param string $trnType
    * @param string $trnVersion
    * @param string $trnCode
    * @param string $trnPriority
    * @param string $status
    * 
    * @return boolean
    */
    public function populateWebRequests($messageId, $trnType, $trnVersion = 'V4', $trnCode = 'S', $trnPriority = 9, $status = 'WW'){
        
        
        $date       =   date('Y-m-d H:i:s');
        $personId   =   $this->userId;
        $deviceId   =   $this->deviceId;
        
        $sql = sprintf("INSERT INTO WEB_REQUESTS(MESSAGE_ID, TRN_VERSION, TRN_TYPE, TRN_CLASS, TRN_DATE, PERSON_ID, DEVICE_ID, TRN_PRIORITY, REQUEST_STATUS) 
                                                 values(%s, '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s' )", 
                                                 $messageId, $trnVersion, $trnType, $trnCode, $date, $personId, $deviceId, $trnPriority, $status);
        
        $result = $this->execSQL($sql);
        
        return $result;
            
    }
    
    /**
    * update WEB_REQUESTS table
    * 
    * @param string $messageId
    * @param string $status
    * @param string $replyDate is the Reply date to use
    * 
    * @return boolean
    */
    public function updateWebRequests($messageId, $status, $replyDate = null){
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
/*
    public function updateWebRequests($messageId, $data){
        $sql    =   'UPDATE WEB_REQUESTS ';
        $params =   array();
        
        foreach($data as $key => $value){
            $params[]   =   $value;
            $sql       .=   'SET ' . $key . ' = ?, ';     
        }
            $params[]   =   $messageId;
            
        $sql =  substr($sql, 0, -2) . ' WHERE MESSAGE_ID = ?';
        
        $result = $this->execSQL($sql, $params);
        return $result;
*/
        $wkRequest = $this->searchdWebRequest( $messageId );
        $log->info( 'Request : ' . print_r($wkRequest, True) );
        $my_message = "";
        // write transaction
        $query = "EXECUTE PROCEDURE ADD_MESSAGE_V4('";
        $query .= $messageId . "','";
        $query .= $wkRequest['TRN_VERSION']  . "','";
        $query .= $wkRequest['TRN_TYPE']  . "','";
        $query .= $wkRequest['TRN_CLASS']  . "','";
        //$query .= $wkRequest['TRN_DATE']  . "','";
        $tran_trandate = date("Y-M-d H:i:s");
        $query .= $tran_trandate . "','";
        $query .= $wkRequest['PERSON_ID']  . "','";
        $query .= $wkRequest['DEVICE_ID']  . "','";
        $query .= $wkRequest['TRN_PRIORITY']  . "','";
        $query .= $status . "','";
        $query .= $wkRequest['ERROR_TEXT']  . "',";
    if (is_null($replyDate )) {
            $query .= "NULL)";
    } else { 
            $query .= "'" . $replyDate  . "')";
    }
        
        $log->info( 'sql : ' . print_r($query, True) );
        $this->beginTransaction();
        if (false === ($result = ibase_query($this->db, $query))) {
            $my_message = "Unable to Add Transaction!" ;
            //return $my_message;
        }
        ibase_free_result($result);
        //if ($wk_docommit == 'Y') {
            //commit
            //ibase_commit($dbTran);
            $this->commitTransaction();
        //}
        return $my_message;
            
    }
    
    /**
    * method sending transaction through ADD_TRAN_V4 procedure 
    * 
    * @param object $transaction
    * @param string $messageId
    * @param string $source
    * @param string $tran_trandate
    * @param string $instance
    */
    public function doTransactionV4Response($transaction, $messageId, $source = 'BSS', $tranDate = '', $instance = 'MASTER  ')
    {
       
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info( 'transaction : ' . print_r($transaction, True) );
        $trnVersion =   'V4';
        $trnType    =   $transaction->transCode;
        $trnClass   =   $transaction->transClass;
        
        if ($tranDate == '') {
            //$tranDate = date("d.m.Y H:i");
            $tranDate = date("Y-M-d H:i:s");
            $tranDate = 'NOW';
            $tranDateMerged = date("YmdHis");
        }
        
        
        $trnDelimiter   =   '|'; //$this->defaultControlValues['LABEL_FIELD_WRAPPER'];
        $personId       =   $this->userId;
        $deviceId       =   $this->deviceId;
        $messageId      =   $messageId;
        //$trnData        =   $trnVersion . $trnType . $trnClass . $tranDateMerged . $trnDelimiter . $personId . $trnDelimiter . $deviceId . $trnDelimiter . $transaction->reference . $trnDelimiter;
        $trnData        =   $personId . $trnDelimiter . $deviceId . $trnDelimiter . $messageId . $trnDelimiter . $transaction->reference . $trnDelimiter;
        $complete       =   'F';
        $errorText      =   '';
        $instanceId     =   $instance;
        $exported       =   0;
    // must calculate the source length
    $trnDataT = explode($trnDelimiter, $trnData);
        $inputSource    =  $source;
        $inputSource    =  str_repeat('S', sizeof($trnDataT) + 2 ) ;
        
        $this->beginTransaction();
        
        $sql = sprintf("SELECT REC_ID FROM ADD_TRAN_V4('%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s')",
                                                       $trnVersion, $trnType, $trnClass, $tranDate, $trnDelimiter, $personId, $deviceId,
                                                       $messageId, $trnData, $complete, $errorText, $instanceId, $exported, $inputSource);
        
    $result = False;
        if (false === ($result = ibase_query($this->db, $sql))) {
            $this->lastError = "Unable to Add Transaction!" ;
            echo (ibase_errmsg());      
            $log->info('ibase error:' . ibase_errmsg());
        } else {
            $row = ibase_fetch_row($result);
            $log->info('add tran v4 :' . print_r($row, True) );
            $result = $row[0];


            //return $row[0];
        }
        $this->commitTransaction();
        $log->info('end of ' .  __FUNCTION__);
        ibase_free_result($result);
        return true;
    }
    
    /**
    * delete all ISSN using DELETE_ISSN procedure
    * 
    * @param int $ssnId
    * @return boolean
    */
    public function runDeleteIssnProcedure($ssnId){
        
        if(!empty($ssnId)){
            $sql = 'EXECUTE PROCEDURE DELETE_ISSN(?)';
            
            return $this->execSQL($sql, array($ssnId));
        }
        
            return false;
    }
    
    public function getImports()
    {
        $sql = "SELECT * FROM TRANSACTIONS4;";

        $data = $this->findAll($sql);
        return $data;
        
    }
    
    
    /**
    * get report button list
    * 
    * @param string $screenName
    * @return array
    */
    public function getReportButtonList($screenName = null){
        return Minder_SysScreen_Legacy_OptionManager::getReportButtons();
    }
    
    /**
    * get user header
    * 
    * @param string $tableName
    * @param string $groupCode
    * @return array
    */
    public function getUserHeaders($code, $definedHeaders = array()){
        
        $sql = "SELECT *
                FROM OPTIONS
                WHERE GROUP_CODE = ? ";
        
        $userHeaders = $this->findAllAssocMod($sql, $code);
  
        $headers    =   array();
        $dbFields   =   array();
        $fields     =   array();
        
        foreach($userHeaders as $field){
            $position       = explode('|', $field['CODE']);
            $description    = explode('|', $field['DESCRIPTION'] );  
            
            $headers[$position[0]] = array($description[0] => $description[1]);
            $dbFields[]            = $position[1] . '.' . $description[0];      
            $fields[]              = $description[0];      
        }
        
        ksort($headers);
        
        foreach($headers as $key => $value){
            $definedHeaders =   array_merge($definedHeaders, $value);
        }
        
        $data['headers']    =   $definedHeaders;
        $data['db_fileds']  =   $dbFields;      
        $data['fileds']     =   $fields;      
        
        return $data;
    }
    
    
    /**
    * get revisions for assembly
    * 
    * @param string order_id
    * @return array
    */    
    public function getRevisions($id=null)
    {
        if ($id===null) {
            return array();
        }
        
        $sql = "SELECT pi.pick_order, pi.pick_order_qty, pir.pick_order_qty, pir.pick_qty_difference,
                        pi.pick_label_no, i1.prod_id, pp.short_desc
                FROM pick_order po
                LEFT OUTER JOIN pick_item pi ON po.pick_order = pi.pick_order
                LEFT OUTER JOIN pick_item_revised pir ON pi.pick_label_no = pir.pick_label_no
                LEFT OUTER JOIN pick_item_detail pid ON pi.pick_label_no = pid.pick_label_no
                LEFT OUTER JOIN issn i1 ON pid.ssn_id = i1.ssn_id
                LEFT OUTER JOIN prod_profile pp ON i1.prod_id = pp.prod_id
                WHERE po.pick_order = '$id'
                GROUP BY pi.pick_order, pi.pick_order_qty, pir.pick_order_qty, pir.pick_qty_difference,
                        pi.pick_label_no, i1.prod_id, pp.short_desc";
        
               
                
        $rows = $this->findAllAssocMod($sql);


        return $rows;               
    }
    
    /**
    * check if Product available
    * 
    * @param string $name
    * @param string $companyId
    * @param string $whId
    * @return resource
    * 
    * @throws Minder_Exception
    */
    public function checkAvailableProduct($name, $companyId, $whId){
        
        $sql    = "SELECT * FROM PRODUCT_COMPANY_WH_STOCK_STATUS(?, ?, ?, ?)";
        $result = $this->findOneAssoc($sql, $name, $companyId, $whId, $this->userId);
        if (empty($result))
            throw new Minder_Exception('Error checking Available Products: ' . $this->lastError);

        return $result;    
    } 

    public function updateProdProfile($prodId, $field, $value)
    {
        $sql   = 'UPDATE PROD_PROFILE SET ' . $field . ' = ? WHERE PROD_ID = ? ' ;
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $log->info($sql . ' : ' . $prodId . ',' . $field . ', ' . $value);

        $query = ibase_prepare($this->db, $sql);
        if ($query) {
            $result = ibase_execute($query, $value, $prodId);
            if (false !== $result) {
                ibase_commit();
                ibase_free_result($result);
                ibase_free_query($query);
                return true;
            } else {
                $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
                ibase_free_query($query);
                $log->info($this->lastError);
                return false;
            }
        }
        $this->lastError = ibase_errcode() . ' ' . ibase_errmsg() . '. Query text: ' . $sql;
        $log->info($this->lastError);
        return false;
    }
    
    public function getPickItemDetails($ssnId){
        
        $sql    =   'SELECT *
                     FROM PICK_ITEM_DETAIL
                     WHERE SSN_ID = ?';
        
        $pickItemDetail =   $this->findOneAssoc($sql, $ssnId);
        
        return $pickItemDetail;
    }
    
    public function purchaseLineDetailsList($lineList, $pageSelector, $showBy){
        
         
         
         $sql   =  'SELECT
                          PURCHASE_SUB_LINE.RECORD_ID,  
                          PURCHASE_SUB_LINE.PURCHASE_ORDER,  
                          PURCHASE_SUB_LINE.PO_LINE,  
                          PURCHASE_SUB_LINE.SSN_ID,  
                          PURCHASE_SUB_LINE.PSL_OTHER1,  
                          PURCHASE_SUB_LINE.PSL_OTHER2,  
                          PURCHASE_SUB_LINE.PSL_OTHER_DATE3,  
                          PURCHASE_SUB_LINE.PSL_OTHER_DATE4,  
                          PURCHASE_SUB_LINE.PSL_STATUS,  
                          PURCHASE_SUB_LINE.PSL_ORDER_QTY,  
                          PURCHASE_SUB_LINE.LAST_UPDATE_DATE,  
                          PURCHASE_SUB_LINE.LAST_UPDATE_BY,  
                          PURCHASE_SUB_LINE.DEVICE_ID,  
                          PURCHASE_SUB_LINE.USER_ID  
                          
                    
                       FROM PURCHASE_SUB_LINE
                       LEFT JOIN PURCHASE_LINE_DETAIL ON PURCHASE_SUB_LINE.PURCHASE_ORDER = PURCHASE_LINE_DETAIL.PURCHASE_ORDER 
                                                         AND PURCHASE_SUB_LINE.PO_LINE = PURCHASE_LINE_DETAIL.PO_LINE     
                       WHERE 1=1 AND ';
                    
         $where = '';
         if(!empty($lineList)){
         
             foreach($lineList as $line){
                 
                 $lineData  =   explode('_', $line);
                 $order     =   $lineData[0];
                 $line      =   $lineData[1];
                 
                 $where .= sprintf("(PURCHASE_SUB_LINE.PURCHASE_ORDER = '%s' AND PURCHASE_SUB_LINE.PO_LINE = '%s')  OR ", $order, $line); 
             }
         }
        
         $sql  .= substr($where, 0, -5);
         $sql  .= ' ORDER BY  PURCHASE_SUB_LINE.PO_LINE ASC'; 
         
         $log = Zend_Registry::get('logger');
         $log->info(__FUNCTION__);
         $this->lastError = $sql;
      
        
         list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageSelector, $showBy);
         $log->info($sqlQuery);
    
         $total  = $this->findValue($sqlCount);
         $data   = $this->findAllAssocMod($sqlQuery);
        
         $result['total'] = $total;
         $result['data']  = $data;
        
         return $result; 
            
    }
    
    /**
    * add one record to PURCHASE_ORDER_LINE table 
    * 
    * @param array $data
    * 
    * @return boolean
    */
    
    public function addPurchaseOrderLine($data){
        
        $sql = 'INSERT 
                INTO PURCHASE_ORDER_LINE(%s) values(%s)';
        
        $fields =   '';
        $params =   '';
        $values =   array();
        
        foreach($data as $key => $value){
            $fields     .=  $key;
            $params     .=  '?, ';
            $values[]    =  $value;      
        }
        
        $fields =   substr($fields, 0, -2);
        $params =   substr($params, 0, -2);
        
        $sql    =   sprintf($sql, $fields, $params);
    
        $result = $this->execSQL($sql, $values);
     
        return $result;
            
    }
    
    /**
    * add one record to PURCHASE_SUB_LINE table 
    * 
    * @param array $data
    * 
    * @return boolean
    */
    public function addPurcahseDetailLine($data){
        
        $sql = 'INSERT 
                INTO PURCHASE_SUB_LINE(%s) values(%s)';
        
        $fields =   '';
        $params =   '';
        $values =   array();
        
        foreach($data as $key => $value){
            $fields     .=  $key;
            $params     .=  '?, ';
            $values[]    =  $value;      
        }
        
        $fields =   substr($fields, 0, -2);
        $params =   substr($params, 0, -2);
        
        $sql    =   sprintf($sql, $fields, $params);
       
        $result = $this->execSQL($sql, $values);
     
        return $result;
    }
    
    /**
    * delete one record from PURCHASE_SUB_LINE table
    * 
    * @param int $lineNo - PURCHASE_SUB_LINE.RECORD_ID
    * @return boolean
    */
    public function deletePurchaseDetailLine($lineNo){
        
        
        $sql    = 'DELETE 
                   FROM PURCHASE_SUB_LINE ';
        $where  = 'WHERE RECORD_ID = ? ';
        $sql   .= $where;
        
        $params[] = $lineNo;
        
        $result   = $this->execSQL($sql, $params);

        return $result;    
    }
    
    /**
    * get data from PURCHASE_SUB_LINE by RECORD_ID  
    * 
    * @param int $lineNo - PURCHASE_SUB_LINE.RECORD_ID
    * 
    * @return assoc array 
    */
    public function getPurchaseDetailLineById($lineNo){
        
        $sql = 'SELECT *
                FROM PURCHASE_SUB_LINE
                WHERE RECORD_ID = ? ';
        
        $result =   $this->findOneAssoc($sql, $lineNo);
        
        return $result;
        
    }
    
    /**
    * update PURCHASE_SUB_LINE by RECORD_ID  
    * 
    * @param int $lineNo - PURCHASE_SUB_LINE.RECORD_ID
    * @param array $data
    * 
    * @return boolean
    */
    public function updatePurchaseDetailLine($lineNo, $data){
        
        $sql = 'UPDATE PURCHASE_SUB_LINE
                SET ';
        
        $values =   array();
        foreach($data as $key => $value){
            $sql       .= $key;
            $values[]   =   $value;
        }
        
        $sql  =   substr($sql, 0, -2);  
        $sql .= ' WHERE RECORD_ID  = ? ';
            
            $values[]   =   $lineNo;
        
        $result = $this->execSQL($sql, $values);
      
        return $result;    
    }
    
    public function generatePoId()
    {
         $sql = 'SELECT ORDER_ID FROM GET_PO_ORDER_NO(?);';

         if (false !== ($query = ibase_prepare($this->db, $sql))) {
            if (false !== ($result = ibase_execute($query, 'IP'))) {
                $row = ibase_fetch_row($result);
                ibase_free_result($result);
                ibase_free_query($query);
                return $row[0];
            }
            ibase_free_query($query);

         }

         return '';

    }
    
    /**
    * get new PURCHASE_LINE_NO
    * 
    * @param string $orderNo - PURCHASE_ORDER
    * 
    * @return string PURCHASE_LINE_NO 
    * 
    */
    public function getNewPurchaseLineNo($orderNo){

        $sql = 'SELECT PO_LINE FROM GET_PO_LINE_NO(?)';

        $query = ibase_prepare($this->db, $sql);

        if (false !== $query) {
            $result = ibase_execute($query, $orderNo);
            if (false !== $result) {
                $row = ibase_fetch_row($result);
                ibase_free_result($result);
                ibase_free_query($query);
                return $row[0];
            }

            ibase_free_query($query);
        }

        return '';
    }
    
   /**
     * Return a list of people
     *
     * @param mixed $type
     * @param string $q search value
     * @param integer $orderBy
     *
     * @return array
     */
    public function getPersonNamesList($type, $q = null, $orderBy = 0) {
        
        //$sql = "SELECT P.PERSON_ID, (SELECT * FROM NONULLP(P.FIRST_NAME)) || ' ' || (SELECT * FROM NONULLP(P.LAST_NAME)) AS CON_NAME FROM PERSON P WHERE";
        $sql = "SELECT P.PERSON_ID, COALESCE(P.FIRST_NAME,'') || ' ' || COALESCE(P.LAST_NAME,'') AS CON_NAME FROM PERSON P WHERE";
        $args = array();
        $flag = 0;
        if ($q != null) {
            $q = strtoupper($q);
            $sql = $sql . " (UPPER(PERSON_ID) LIKE ? OR UPPER(CONTACT_FIRST_NAME) LIKE ? OR UPPER(CONTACT_LAST_NAME) LIKE ?) AND";
            $args[] = $q;
            $args[] = $q;
            $args[] = $q;
            $flag = 1;
        }
        if (is_array($type)) {
            $sql = $sql . " (PERSON_TYPE = ?";
            $args[] = $type[0];
            $c = count($type);
            for ($i = 1; $i < $c; $i++) {
                $sql = $sql . " OR PERSON_TYPE = ?";
                $args[] = $type[$i];
            }
            $sql = $sql . ")";
        } else {
            $sql = $sql . " PERSON_TYPE = ?";
            $args[] = $type;
        }
        if ($this->limitCompany != 'all') {
            $sql = $sql . " AND COMPANY_ID = ?";
            $args[] = $this->limitCompany;
        }

        switch ($orderBy) {
            case 2:
                $sql = $sql . " ORDER BY PERSON_ID";
                break;
            case 1:
                $sql = $sql . " ORDER BY CON_NAME";
                break;
            case 0:
            default:
                $sql = $sql . " ORDER BY CON_NAME, PERSON_ID";
        }
        array_unshift($args, $sql);

        $d = null;
        $query = ibase_prepare($this->db, $args[0]);
        if ($query !== false) {
            // Replace the SQL statement with the query
            $args[0] = $query;

            if ($flag) {
                $info = ibase_param_info($query, 0);
                $delta = $info['length'] - strlen($args[1]);
                switch (true) {
                    case $delta == 1:
                        for ($i = 1; $i <= 3; $i++) {
                            $args[$i] = substr($args[$i], 0, $info['length']) . '%';
                        }
                        break;

                    case $delta <= 0:
                        for ($i = 1; $i <= 3; $i++) {
                            $args[$i] = substr($args[$i], 0, $info['length']);
                        }
                        break;

                    default:
                        for ($i = 1; $i <= 3; $i++) {
                            $args[$i] = '%' . substr($args[$i], 0, $info['length']) . '%';
                        }
                }
            }

            $result = call_user_func_array('ibase_execute', $args);
            if ($result !== false) {
                $d = array();
                while (false !== ($row = ibase_fetch_row($result))) {
                    $d[(string)$row[0]] = (string)$row[1];
                }
                ibase_free_result($result);

            } else {
                ibase_free_query($query);
                throw new Exception('Unable to run query');
            }
            ibase_free_query($query);
        }

        if ($d === null) {
            throw new Exception('Unable to retrieve list');
        }
        else {
            return $d;
        }
    }    

    public function getCompanyListLimited($q = null) {
        
        if ($this->isAdmin) {
            $sql = "SELECT COMPANY_ID, COMPANY_ID FROM COMPANY";
            if ($q !== null) {
                $sql = $sql . " WHERE UPPER(COMPANY_ID) LIKE ? ORDER BY COMPANY.COMPANY_ID";
                return $this->findList($sql, '%'. strtoupper($q) . '%');
            }
            $sql .= ' ORDER BY COMPANY.COMPANY_ID';
            return $this->findList($sql);
        } else {
            //$sql = "SELECT COMPANY_ID, COMPANY_ID FROM ACCESS_COMPANY WHERE USER_ID = ? ";
            $sql = "SELECT ACCESS_COMPANY.COMPANY_ID, COMPANY.COMPANY_ID FROM ACCESS_COMPANY JOIN COMPANY ON ACCESS_COMPANY.COMPANY_ID = COMPANY.COMPANY_ID WHERE ACCESS_COMPANY.USER_ID = ?";
            if ($q !== null) {
                //$sql = $sql . " AND UPPER(COMPANY_ID) LIKE ? ORDER BY COMPANY.COMPANY_ID";
                $sql = $sql . " AND UPPER(ACCESS_COMPANY.COMPANY_ID) LIKE ? ORDER BY COMPANY.COMPANY_ID";
                return $this->findList($sql, $this->userId, '%'. strtoupper($q) . '%');
            }
            $sql .= ' ORDER BY COMPANY.COMPANY_ID';
            return $this->findList($sql, $this->userId);
        }
    }

    public function buildUsersCompanyList($extraRows = array(), $prepend = true) {
        $result = array();
        /**
         * @var Minder2_Model_Company $company
         */
        foreach (Minder2_Environment::getInstance()->getCompanyList() as $company) {
            $result[$company->COMPANY_ID] = $company->COMPANY_ID;
        }

        ksort($result);

        $extraRows = is_array($extraRows) ? $extraRows : array();

        return $prepend ? array_merge($extraRows, $result) : array_merge($result, $extraRows);
    }

    public function getCompanyFilterString() {
        return implode('|', $this->getCompanyListLimited());
    }

    public function getWarehouseListLimited()
    {
        if ($this->isAdmin) {
            if ($this->userId == 'Admin') {
                    $sql = "SELECT WH_ID, DESCRIPTION FROM WAREHOUSE";
                    return $this->findList($sql);
            } else {
                    $sql = "SELECT WH_ID, DESCRIPTION FROM WAREHOUSE 
                                WHERE NOT ((WH_ID  = 'XA') OR (WH_ID >= 'XC' AND WH_ID <= 'XX'))";
                    return $this->findList($sql);
            }
        } else {
                $sql = "SELECT WAREHOUSE.WH_ID, DESCRIPTION 
                            FROM WAREHOUSE 
                            JOIN ACCESS_USER ON WAREHOUSE.WH_ID = ACCESS_USER.WH_ID AND USER_ID = ?";
                return $this->findList($sql, $this->userId);
        }
    }

    public function getWarehouseFilterString() {
        return implode('|', array_keys($this->getWarehouseListLimited()));
    }

    public function getPrinterListLimited() {

// get wh_id for the userid 

        $userid_is=$this->userId;

        $user_whId = $this->getSysEquipData($userid_is);

        if($user_whId==""){
        $user_whId=strtoupper($this->defaultControlValues['DEFAULT_WH_ID']);
        }



       // get default lp and pr printer for my device 
        $myDevice = array();
        $sqlDevice = "
            SELECT
                DEFAULT_PR_PRINTER,
                DEFAULT_LP_PRINTER
            FROM SYS_EQUIP 
            WHERE DEVICE_ID = ?";
        try {
            //$result = $this->fetchOne($sqlDevice, $this->deviceId);
            $myDevice =   $this->findOneAssoc($sqlDevice, $this->deviceId );
            
        } catch (Exception $e) {
            $myDevice['DEFAULT_LP_DEVICE'] = '';
            $myDevice['DEFAULT_PR_DEVICE'] = '';
        }

        $sqlPrinterType = "
            SELECT SYSTEM_PRINTER_DEVICE_TYPES FROM CONTROL";
        try {
            //$result = $this->fetchOne($sqlDevice, $this->deviceId);
            $printer_types =   $this->findOneAssoc($sqlPrinterType);
            
        } catch (Exception $e) {
             
        }


        $printers=$printer_types['SYSTEM_PRINTER_DEVICE_TYPES'];
        $printerDeviceTypes = explode("|",$printers);

        $sqlArgs = array();
        if ($this->isAdmin && $this->userId == 'Admin') {
/*
            $sql = "
                SELECT
                    DEVICE_ID,
                    DEVICE_ID || ' - ' || COALESCE(EQUIPMENT_DESCRIPTION_CODE, '')
                FROM SYS_EQUIP
                WHERE 
                    DEVICE_TYPE IN (" . substr(str_repeat('?, ', count($printerDeviceTypes)), 0, -2) . ")
                ORDER BY 1";
*/
                          $sql = "
                            SELECT
                                DEVICE_ID,
                                DEVICE_ID || ' - ' || COALESCE(EQUIPMENT_DESCRIPTION_CODE, '')
                            FROM SYS_EQUIP
                             ";
                          $sql .= " WHERE (SYS_EQUIP.DEVICE_TYPE IN (";
                            foreach ($printerDeviceTypes as $key => $val) {
                                    $comma='';
                                        if($key!=count($printerDeviceTypes)-1){

                                            $comma=",";
                                        }
                                    $sql .= "'" . $val . "'".$comma;
                            }

                          $sql .= ") AND (SYS_EQUIP.WH_ID = ? ";
                          $sqlArgs[] = $user_whId; 


                          $sql .= " ) )";
   
        } else {
/*
            $sql = "
                SELECT
                    DEVICE_ID,
                    DEVICE_ID || ' - ' || COALESCE(EQUIPMENT_DESCRIPTION_CODE, '')
                FROM SYS_EQUIP
                WHERE
                    DEVICE_TYPE IN (" . substr(str_repeat('?, ', count($printerDeviceTypes)), 0, -2) . ")
                    AND (
                        WH_ID = ?
                        OR WH_ID IN (SELECT WH_ID FROM ACCESS_USER WHERE USER_ID = ?)
                    )
                ORDER BY 1";
*/
                    $sql = "
                        SELECT
                            DEVICE_ID,
                            DEVICE_ID || ' - ' || COALESCE(EQUIPMENT_DESCRIPTION_CODE, '')
                        FROM SYS_EQUIP
                        WHERE ";
                    $sql .= " ( (SYS_EQUIP.DEVICE_TYPE IN (";

                                foreach ($printerDeviceTypes as $key => $val) {

                                    $comma='';
                                    if($key!=count($printerDeviceTypes)-1){

                                        $comma=",";
                                    }
                                    $sql .= "'" . $val . "'".$comma;
                                }

                    $sql.=")"; 

                    if(!empty($myDevice['DEFAULT_PR_PRINTER'])){
                        $sql .= " AND SYS_EQUIP.DEVICE_ID = ? ";
                        $sqlArgs[] = $myDevice['DEFAULT_PR_PRINTER'] ;
                    }
                        
                    $sql .= " AND SYS_EQUIP.WH_ID = ? ";
                    $sqlArgs[] = $user_whId;                

                    $sql .= " ) ) ";
            
           
        }

        array_unshift($sqlArgs, $sql);

        return call_user_func_array(array($this, 'findList'), $sqlArgs);
    }
    
    public function checkPrinterLimited() {
                        //$this->minder->limitPrinter =   $this->minder->checkPrinterLimited());
        $whPrinters = array();
        $whPrinters = $this->getPrinterListLimited();

//I don't know who wrote this, but this is awful 
//as I guess someone tries to find if currently selected printer in limited list
//and if it is not, use the fist from limited list
//so I will correct this
//        if(is_array($this->limitPrinter)) {
//          $_lmt_printer = $this->limitPrinter;
//        } else {
//          $_lmt_printer = array($this->limitPrinter);
//        }
//        $wk_result =  (array_key_exists($whPrinters , $_lmt_printer)) ? $this->limitPrinters : current($whPrinters);

        $wk_result =  (array_key_exists($this->limitPrinter, $whPrinters)) ? $this->limitPrinter : key($whPrinters);
        return $wk_result;
    }

    public function getTotalSumPOlines($order_id)
    {
        $sql = "SELECT SUM(PURCHASE_ORDER_LINE.PO_LINE_TOTAL)
                FROM PURCHASE_ORDER_LINE
                WHERE 
                   (
                      (PURCHASE_ORDER_LINE.purchase_order = ?)
                   )";
        
        $sum = $this->fetchOne($sql, $order_id);
        
        return $sum;
    }
    
    /**
    * get SUM of PSL_ORDER_QTY OF PURCHASE_SUB_LINE 
    * 
    * @param string $purchaseOrderNo
    * @param int $purchaseOrderLineNo
    * @return int
    */
    public function getDetailQtySum($purchaseOrderNo, $purchaseOrderLineNo){
        
        $sql = 'SELECT SUM(PSL_ORDER_QTY)
                FROM PURCHASE_SUB_LINE
                WHERE PURCHASE_ORDER = ? AND PO_LINE = ?';
        
        $totalQty   =   current($this->findOne($sql, $purchaseOrderNo, $purchaseOrderLineNo));
        
        return $totalQty;    
    }
    
    public function getCurrentWhid()
    {
        $sql = "SELECT DESCRIPTION 
            FROM SESSION 
            WHERE CODE = 'CURRENT_WH_ID' AND DEVICE_ID='". $this->deviceId."'";
        return $this->fetchOne($sql);
        
    }
    
    public function getCurrentCompanyid()
    {
        $sql = "SELECT FIRST 1 COMPANY_ID 
            FROM CONTROL";
        return $this->fetchOne($sql);
        
    }
    
    public function getPurchaseOrderLineId($po_id)
    {
        $sql = "SELECT * FROM GET_PO_LINE_NO('$po_id')";
        $po_line = $this->fetchOne($sql);
        return $po_line;
    }

    /**
     * Wait for DB Events
     *
     * @param string $eventName the first event to wait for
     * @param string $eventName2 the second event to wait for
     *
     * @return eventName that was found
     */
    public function getDBEvent($eventName, $eventName2)
    {
        $result = ibase_wait_event($eventName, $eventName2);
        return $result;
    }


    /**
     * Send  DB Events
     *
     * @param string $eventName the first event to send 
     *
     * @return eventName that was found
     */
    public function sendDBEvent($eventName )
    {
        $query = "EXECUTE PROCEDURE SEND_USER_EVENT('";
        $query .= $eventName . "')";
        $this->beginTransaction();
        if (false === ($result = ibase_query($this->db, $query))) {
            $my_message = "Unable to Add Transaction!" ;
            //return $my_message;
        }
        //unset($result);
        //if ($wk_docommit == 'Y') {
            //commit
            //ibase_commit($dbTran);
        $this->commitTransaction();
        ibase_free_result($result);
        //}
    }


    public function getSysUserData($userId = null){
        
        $sql = 'SELECT *
                FROM SYS_USER
                WHERE USER_ID = ?';
        
        if(empty($userId)){
            $sysUserData    =   $this->findOneAssoc($sql, $this->userId);    
        } else {
            $sysUserData    =   $this->findOneAssoc($sql, $userId);    
        }
        
        return $sysUserData;
        
    }



    public function getUserCompany($intUserId = null, $blnGetAllCompany = True){
        
        if($intUserId == null){
            $intUserId = $this->userId;
        }
        
        $strQuery = 'select * from ACCESS_COMPANY where user_id = ?';
        
        if($blnGetAllCompany == True){
            $arrUserCompany = $this->findAllAssoc($strQuery, $intUserId);
        }
        else{
            $arrUserCompany = $this->findOneAssoc($strQuery, $intUserId);
        }

        return $arrUserCompany;
    }



    public function getSysEquipData($userId = null){


        $deviceId=$this->getDeviceOfPerson($userId);

	// handle a null device
	if ($deviceId == "") {
		return False;
	}

        $sql="SELECT WH_ID FROM SYS_EQUIP WHERE CURRENT_PERSON = ? AND DEVICE_ID = ?";
        return $this->fetchOne($sql, $userId, $deviceId);
       
    }


        public function getDeviceOfPerson($userId) {
        return $this->fetchOne("SELECT DEVICE_ID FROM SYS_USER WHERE USER_ID = ?", $userId);
    }


    /**
     * get list of WebRequests object
     *
     * @param array $clause filters for WEB_REWQUESTS list where
     *                         KEY is field which should be filtered
     *                         VALUE is limit
     * @param integer $pageNo - Page No to Get
     * @param integer $resultsPerPage - Page Size
     *
     * @return array of Message_ID s
     */
    public function getWebRequests($clause = null, $pageNo = null, $resultsPerPage = null)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $result = array('total' => 0, 'data' => array());

        list($sql, $sqlOrder) =  $this->getSelectQuery( "T", "WEB_REQUESTS");

        // New code
        
        $sql .= " WHERE 1=1 AND ";
        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                    if(!empty($key)) {
                        $sql .= $key . " AND ";
                        if(!empty($val) && false != strpos($key, 'LIKE')) {
                            $values[] = $val;  
                        } elseif (!empty($val) && false != strpos($key, '?')) {
                            $values[] = $val;
                        } elseif(true == strpos($key, '?') && empty($val) ) {
                            $values[] = '';  
                        }
                    }
                }
        }
    
        $sql  = substr($sql, 0, -5);
        $sql .= $sqlOrder;
        
        $log->info('sql:' . $sql);
        $log->info('value:' . print_r($values,True));
        //list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage, False);
        //$log->info('sqlQuery:' . $sqlQuery);
      
        //if (false === ($Query = $this->prepareArgs($sqlQuery, $values))) {
        if (false === ($Query = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        //$data   = $this->findAllAssocMod($sqlQuery, $Query);
        $data   = $this->findAllAssocMod($sql, $Query);
       
        return $data;
    }


    /**
     * get searched for WebRequest object
     *
     * @param string $messageId - WEB_REQUESTS's MESSAGE_ID to Get
     * @return  SsnLine
     */
    public function searchdWebRequest( $messageId )
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);

        list($sql, $sqlOrder) =  $this->getSelectQuery( "F", "WEB_REQUESTS");
    $sql .= "
                        WHERE  WEB_REQUESTS.MESSAGE_ID = ? 
                    ";
        // New code
        
        $values = array( $messageId );
    
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $data   = $this->findAllAssocMod($sql, $values);
       
        return $data[0];
    }

    /**
     * get list of Transactions4 object
     *
     * @param array $clause filters for Transactions4 list where
     *                         KEY is field which should be filtered
     *                         VALUE is limit
     * @param integer $pageNo - Page No to Get
     * @param integer $resultsPerPage - Page Size
     *
     * @return array of Transactions4 Object s
     */
    public function getTransactions4($clause = null, $pageNo = null, $resultsPerPage = null)
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);
        $result = array();

        list($sql, $sqlOrder) =  $this->getSelectQuery( "T", "TRANSACTIONS4");

        // New code
        
        $sql .= " WHERE 1=1 AND ";
        $values = array();
        if ($clause !== null && is_array($clause)) {
            foreach ($clause as $key => $val) {
                    if(!empty($key)) {
                        $sql .= $key . " AND ";
                        if(!empty($val) && false != strpos($key, 'LIKE')) {
                            $values[] = $val;  
                        } elseif (!empty($val) && false != strpos($key, '?')) {
                            $values[] = $val;
                        } elseif(true == strpos($key, '?') && empty($val) ) {
                            $values[] = '';  
                        }
                    }
                }
        }
    
        $sql  = substr($sql, 0, -5);
        $sql .= $sqlOrder;
        
        $log->info('sql:' . $sql);
        //list($sqlCount, $sqlQuery) = $this->__addLimitToQuery($sql, $pageNo, $resultsPerPage, False);
        //$log->info('sqlQuery:' . $sqlQuery);
      
        //if (false === ($Query = $this->prepareArgs($sqlQuery, $values))) {
        if (false === ($Query = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        //$data   = $this->findAllAssocMod($sqlQuery, $Query);
        $data   = $this->findAllAssocMod($sql, $Query);
       
        if (count($data) > 0) {
            foreach ($data as $line) {
                $log->info('got transaction record id:' . $line['RECORD_ID']);
                // get the data for the record_id
                $transactions4 = $this->searchdTransactions4( $line['RECORD_ID']);
                $result[] = $transactions4;
            }
        }
        return $result;
    }


    /**
     * get searched for IssnLine object
     *
     * @param string $ssnId - ISSN's SSN_ID to Get
     * @return  IssnLine
     */
    public function searchdTransactions4( $recordId )
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);

        list($sql, $sqlOrder) =  $this->getSelectQuery( "F", "TRANSACTIONS4");
    $sql .= "
                        WHERE  TRANSACTIONS4.RECORD_ID = ? 
                    ";
        // New code
        
        $values = array( $recordId );
    
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $data   = $this->findAllAssocMod($sql, $values);
       
        return $data[0];
    }

    /**
     * update Web Requests from one status to another
     *
     * @param string $fromStatus
     * @param string $toStatus
     * @return  status
     */
    public function updateWebRequestsStatus( $fromStatus, $toStatus )
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);

        $this->getDBLog('Got Wakeup');
        $this->commitTransaction(True);
    $sql = "UPDATE WEB_REQUESTS SET REQUEST_STATUS = ?
                        WHERE  REQUEST_STATUS  = ? 
                    ";
        // New code
        
        $values = array( );
        $values[]  = $toStatus ;
        $values[]  = $fromStatus ;
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        $result = $this->execSQL($sql, $values);
      
        return $result;    
        
    }

    /**
     * get soap method and minder function to run this
     *
     * @param string $tranType - Transaction Type to Get
     * @return  array of the 2 values 
     */
    public function getSoapMethodForTransaction( $tranType )
    {
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);

        $sql = " SELECT SOAP_METHOD, SOAP_PROCEDURE FROM TRANSACTION_TYPES
                            WHERE  TRANSACTION_TYPES.TRN_TYPE = ? 
                        ";
        
        $values = array( $tranType );
    
        if (false === ($values = $this->prepareArgs($sql, $values))) {
            throw new Minder_Exception(ibase_errcode() . ': ' . ibase_errmsg() . '. Query text: ' . $sql);
        }
        
        $data   = $this->findAllAssocMod($sql, $values);
       
    $log->info('tran type soap info:' . print_r($data, True));
        return $data[0];
    }
    
    /**
    * update WEB_REQUESTS table
    * 
    * @param strinf $messageId
    * @param array $data
    * 
    * @return boolean
    */
    public function updateTransactions4($recordId, $data){
        $log = Zend_Registry::get('logger');
        $log->info(__FUNCTION__);

        
        $sql    =   'UPDATE TRANSACTIONS4 ';
        $params =   array();
        
        foreach($data as $key => $value){
            $params[]   =   $value;
            $sql       .=   'SET ' . $key . ' = ?, ';     
        }
            $params[]   =   $recordId;
            
        $sql =  substr($sql, 0, -2) . ' WHERE RECORD_ID = ?';

        $log->info($sql . ' : '  );
        $log->info( 'params : ' . print_r($params, True)  );
        
        $result = $this->execSQL($sql, $params);
        
        return $result;
            
    }
    
    public function getOptionsRecordByCode($groupCode, $code){
        
        $sql = "SELECT *
                FROM OPTIONS
                WHERE GROUP_CODE = ? AND CODE = ?";
        
        $data=  $this->findAllAssocMod($sql, array($groupCode, $code));
        
        return $data;
    }
    
    public function deleteBrandLineByClause($clause){
        
        $sql = 'DELETE
                FROM BRAND
                WHERE ';
        
        if(!empty($clause)){
            $values     =   array();
            $where      =   '';
            
            foreach($clause as $key => $value){
                if(!empty($value)){
                    $values[]   =   $value;
                    $where     .=   $key;   
                }    
            }
        }
        
        $sql .= substr($where, 0, -5);
        
        $result = $this->execSQL($sql, $values);
        
        return $result;    
    }
    
    public function deleteSsnTypeLineByClause($clause){
        
        $sql = 'DELETE
                FROM SSN_TYPE
                WHERE ';
        
        if(!empty($clause)){
            $values     =   array();
            $where      =   '';
            
            foreach($clause as $key => $value){
                if(!empty($value)){
                    $values[]   =   $value;
                    $where     .=   $key;   
                }    
            }
        }
        
        $sql .= substr($where, 0, -5);
        
        $result = $this->execSQL($sql, $values);
        
        return $result;    
    }
    
    public function deleteGenericByClause($clause){
        
        $sql = 'DELETE
                FROM GENERIC
                WHERE ';
        
        if(!empty($clause)){
            $values     =   array();
            $where      =   '';
            
            foreach($clause as $key => $value){
                if(!empty($value)){
                    $values[]   =   $value;
                    $where     .=   $key;   
                }    
            }
        }
        
        $sql .= substr($where, 0, -5);
        
        $result = $this->execSQL($sql, $values);
        
        return $result;    
    }
    
    public function deleteSsnSubTypeByClause($clause){
        
        $sql = 'DELETE
                FROM SSN_SUB_TYPE
                WHERE ';
        
        if(!empty($clause)){
            $values     =   array();
            $where      =   '';
            
            foreach($clause as $key => $value){
                if(!empty($value)){
                    $values[]   =   $value;
                    $where     .=   $key;   
                }    
            }
        }
        
        $sql .= substr($where, 0, -5);
        
        $result = $this->execSQL($sql, $values);
        
        return $result;    
    }
    
    public function deleteCostCentreLineByClause($clause){
        
        $sql = 'DELETE
                FROM COST_CENTRE
                WHERE ';
        
        if(!empty($clause)){
            $values     =   array();
            $where      =   '';
            
            foreach($clause as $key => $value){
                if(!empty($value)){
                    $values[]   =   $value;
                    $where     .=   $key;   
                }    
            }
        }
        
        $sql .= substr($where, 0, -5);
        
        $result = $this->execSQL($sql, $values);
        
        return $result;    
    }
    
    public function deleteModelLineByClause($clause){
        
        $sql = 'DELETE
                FROM MODEL
                WHERE ';
        
        if(!empty($clause)){
            $values     =   array();
            $where      =   '';
            
            foreach($clause as $key => $value){
                if(!empty($value)){
                    $values[]   =   $value;
                    $where     .=   $key;   
                }    
            }
        }
        
        $sql .= substr($where, 0, -5);
        
        $result = $this->execSQL($sql, $values);
        
        return $result;    
    }
    
    public function getProductNonProductPriceFiled(){
        
        $data   =   explode('|', Minder_SysScreen_Legacy_OptionManager::getDefPrice());
        
        if(in_array('PRODUCT=T', $data)){
            $product    =   true;
        } else {
            $product    =   false;
        }
        
        if(in_array('NON-PRODUCT=T', $data)){
            $nonProduct    =   true;
        } else {
            $nonProduct    =   false;
        }
        
        return array($product, $nonProduct);    
        
    }
    
    /**
    * transform user array to user list
    * 
    * @param array $userArray - array('T|True', 'F|False');
    * @return array $userlist - array('T' => 'True', 'F' => 'False');
    */
    public function getUserParamList(array $userArray){
        $userlist   =   array();
        
        if(count($userArray) > 0){
            foreach($userArray as $key => $value){
                list($userKey, $userValue) = explode('|', $value);
                
                $userlist[$userKey] =   $userValue;   
            }    
        }
        
        return $userlist;    
    }

    public function getDespatchLocationList4LocationGroup($whId = null, $locationGroup = null) {
        
        $sql = "SELECT WH_ID || LOCN_ID, LOCN_NAME  FROM  LOCATION WHERE STORE_AREA = 'DS'";
        if ($whId !== null) {
            if ($whId !== "all") {
                $sql = $sql . " AND WH_ID = '$whId'";
            }
        }
        if ($locationGroup !== null) {
            $sql = $sql . " AND LOCN_ID STARTING  '$locationGroup'";
        }

        return $this->findList($sql);
    }

    public function getNextMessageId() {
        
        $sql = "SELECT MESSAGE_ID  FROM  GET_NEXT_MESSAGE";

        return $this->findValue($sql);
    }

    public function getDefaultPickPrinter() {
    $sql = "SELECT SYS_EQUIP.COMPUTER_NAME  FROM CONTROL LEFT OUTER JOIN SYS_EQUIP ON CONTROL.DEFAULT_PICK_PRINTER = SYS_EQUIP.DEVICE_ID ";
        return $this->fetchOne($sql);
    }
    
    /**
    * Test given orders and lines if they can be despatched with the same connote.
    * 
    * @param array $orderIds - array or selected PICK_ORDERs IDs
    * @param array $linesIds - array or selected PICK_ITEMs IDs
    * @return true - on success | string - error message
    */
    public function checkOrdersAndLinesForDespatch($orderIds = array(), $linesIds = array()) {
        
        if (count($orderIds) > 1) {
            $shipToAddressList = $this->_getOrderShipToAddressList($orderIds);

            if (count($shipToAddressList) > 1) {
                return 'Cannot despatch Orders for different recipients or with different Carriers with the same Connote.';
            }
        }
        
        if (count($linesIds) > 0) {
            if (count($orderIds) < 1) {
                return 'No orders selected for despatch.';
            }

            if ($this->_hasPickItemsWhichDoesNotBelongToOrders($orderIds, $linesIds)) {
                return 'Not all selected Lines belong to selected Orders.';
            }

            $statusList = $this->_getLineStatusesWhichDoNotAllowToDespatchItems($linesIds);

            if (count($statusList) > 0) {
                return "Cannot Despatch Lines with Status = ('" . implode("', '", $statusList) . "')";
            }
        }
        
        return true;
    }

    public function selectPartialOrders($linesIds) {
        $sql = "
            SELECT DISTINCT
                PICK_ITEM.PICK_ORDER
            FROM
                PICK_ITEM
                LEFT JOIN PICK_ORDER ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER
            WHERE
                PICK_ITEM.PICK_LABEL_NO IN (" . substr(str_repeat('?, ', count($linesIds)), 0, -2) . ")
                AND PICK_ORDER.PARTIAL_PICK_ALLOWED <> 'T'
                AND EXISTS (
                    SELECT
                        SUB_PI.PICK_LABEL_NO
                    FROM
                        PICK_ITEM AS SUB_PI
                    WHERE
                        NOT SUB_PI.PICK_LINE_STATUS IN ('DS', 'AS', 'DC', 'DX')
                        AND SUB_PI.PICK_ORDER = PICK_ITEM.PICK_ORDER
                )
        ";

	
        $args = $linesIds;
        array_unshift($args, $sql);
	$args = array_merge($args,'|FETCH_MODE=SPLIT_ARRAY|');

        $orders = array();
        if (($queryResult = call_user_func_array(array($this, 'fetchAllAssoc'), $args)) !== false) {
            foreach ($queryResult as $resultRow) {
                $orders[] = $resultRow['PICK_ORDER'];
            }
        } else {
            throw new Exception($this->lastError);
        }

        return $orders;
    }
    
    /**
    * Holds lines wich belong to despatching order or location and have DS status, 
    * but was not selected by User for despatching with current Connote
    * 
    * @param array  $selectedLines - array or selected PICK_ITEMs IDs
    * @param string $holdBy - 'order' (default) | 'location' by what to hold lines
    * @return array - array(
    *                    $selectedOrder, 
    *                    $selectedLocation, 
    *                    $pickItemsToHold,
    *                    $issnsToHold,
    *                    'SELECTED_ORDER'    => $selectedOrder, 
    *                    'SELECTED_LOCATION' => $selectedLocation, 
    *                    'HOLDED_PICK_ITEMS' => $linesToHold,
    *                    'HOLDED_ISSNS'      => $linesToHold
    *                 );
    * 
    * @throws Minder_Exception
    */
    public function holdUnnededLines($selectedLines = array(), $holdBy = 'order') {
        $linesToHold      = array();
        $pickItemsToHold  = array();
        $issnsToHold      = array();
        $selectedLocation = '';
        $selectedOrder    = '';
        
        switch (strtolower($holdBy)) {
            case 'order' :
                $result = $this->_getPickOrderListByPickItem($selectedLines);
                
                if (count($result) > 1)
                    throw new Minder_Exception("Cannot hold lines for more then one order.");
                    
                $selectedOrder  = array_shift($result);
                $linesToHold    = $this->_getPickItemsAndIssnToHoldByPickOrder($selectedLines, $selectedOrder);
                break;
            case 'location' :
                $sql = '
                    SELECT DISTINCT
                        WH_ID || LOCN_ID AS LOCN
                    FROM 
                        PICK_ITEM_DETAIL 
                        LEFT OUTER JOIN ISSN ON PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID
                    WHERE
                        PICK_ITEM_DETAIL.PICK_LABEL_NO IN (' . substr(str_repeat('?, ', count($selectedLines)), 0, -2) . ')
                    ' . substr($this->getWarehouseAndCompanyLimit(0, false, 'ISSN.', 'ISSN.'), 0, -5);
                    
                $args = $selectedLines;
                array_unshift($args, $sql);
                $result = call_user_func_array(array($this, 'fetchAllAssoc'), $args);
                
                if (count($result) > 1)
                    throw new Minder_Exception("Cannot hold lines for more then one location.");
                    
                $selectedLocation = $result[0]['LOCN'];
                
                $sql = '
                    SELECT DISTINCT
                        PICK_ITEM_DETAIL.PICK_LABEL_NO,
                        ISSN.SSN_ID
                    FROM
                        PICK_ITEM_DETAIL 
                        LEFT OUTER JOIN ISSN ON PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID
                    WHERE
                        (ISSN.WH_ID || ISSN.LOCN_ID = ?)
                        AND PICK_ITEM_DETAIL.PICK_LABEL_NO NOT IN (' . substr(str_repeat('?, ', count($selectedLines)), 0, -2) . ')
                        AND ISSN.ISSN_STATUS = \'DS\'
                ' . substr($this->getWarehouseAndCompanyLimit(0, false, 'ISSN.', 'ISSN.'), 0, -5);
                
                $args = array_merge(array($selectedLocation), $selectedLines);
                array_unshift($args, $sql);
                
                $linesToHold = call_user_func_array(array($this, 'findList'), $args);
                break;
            default:
                throw new Minder_Exception("Cannot hold lines by '$holdBy'");
        }
        if (count($linesToHold) > 0) {
            
            $pickItemsToHold = array_keys($linesToHold);
            $issnsToHold     = array_unique($linesToHold);
            //move ISSNs to hold status
            $sql = "
                UPDATE ISSN SET 
                    ISSN.ISSN_STATUS = 'DH'
                WHERE
                    ISSN.SSN_ID IN (" . substr(str_repeat('?, ', count($issnsToHold)), 0, -2) . ")
                    AND ISSN.ISSN_STATUS = 'DS'
            ";

            if (false === $this->execSQL($sql, $issnsToHold))
                throw new Minder_Exception('Error holding ISSNs: ' . $this->lastError);
            
            //move PICK_ITEM_DETAILs to hold status
            $sql = '
                UPDATE PICK_ITEM_DETAIL SET 
                    PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = \'DH\'
                WHERE
                    PICK_ITEM_DETAIL.PICK_LABEL_NO IN (' . substr(str_repeat('?, ', count($pickItemsToHold)), 0, -2) . ')
                    AND PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = \'DS\'
            ';
            if (false === $this->execSQL($sql, $pickItemsToHold))
                throw new Minder_Exception('Error holding PICK_ITEM_DETAILs: ' . $this->lastError);
            
            //move PICK_ITEMs to hold status
            $sql = '
                UPDATE PICK_ITEM SET 
                    PICK_ITEM.PICK_LINE_STATUS = \'DH\'
                WHERE
                    PICK_ITEM.PICK_LABEL_NO IN (' . substr(str_repeat('?, ', count($pickItemsToHold)), 0, -2) . ')
                    AND PICK_ITEM.PICK_LINE_STATUS = \'DS\'
            ';
            if (false === $this->execSQL($sql, $pickItemsToHold))
                throw new Minder_Exception('Error holding PICK_ITEMs: ' . $this->lastError);
        }
                
        return array(
            $selectedOrder, 
            $selectedLocation, 
            $pickItemsToHold,
            $issnsToHold,
            'SELECTED_ORDER'    => $selectedOrder, 
            'SELECTED_LOCATION' => $selectedLocation, 
            'HOLDED_PICK_ITEMS' => $pickItemsToHold,
            'HOLDED_ISSNS'      => $issnsToHold
        );
    }
    
    /**
    * Release prevoiuslly holded lines
    * 
    * @param array $holdedPickItems - array of previouslly holded PICK_ITEMs IDs
    * @param array $holdedISSNs     - array of previouslly holded ISSNs IDs
    */
    public function releaseHoldedLines($holdedPickItems, $holdedISSNs) {
        if (count($holdedISSNs) > 0) {
            //move ISSNs to DS status
            $sql = '
                UPDATE ISSN SET 
                    ISSN.ISSN_STATUS = \'DS\'
                WHERE
                    ISSN.SSN_ID IN (' . substr(str_repeat('?, ', count($holdedISSNs)), 0, -2) . ')
                    AND ISSN.ISSN_STATUS = \'DH\'
            ';
            if (false === $this->execSQL($sql, $holdedISSNs))
                throw new Minder_Exception('Error releasing ISSNs: ' . $this->lastError);
        }
        
        if (count($holdedPickItems) > 0) {
            //move PICK_ITEM_DETAILs to DS status
            $sql = '
                UPDATE PICK_ITEM_DETAIL SET 
                    PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = \'DS\'
                WHERE
                    PICK_ITEM_DETAIL.PICK_LABEL_NO IN (' . substr(str_repeat('?, ', count($holdedPickItems)), 0, -2) . ')
                    AND PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = \'DH\'
            ';
            if (false === $this->execSQL($sql, $holdedPickItems))
                throw new Minder_Exception('Error releasing PICK_ITEM_DETAILs: ' . $this->lastError);
            
            //move PICK_ITEMs to DS status
            $sql = '
                UPDATE PICK_ITEM SET 
                    PICK_ITEM.PICK_LINE_STATUS = \'DS\'
                WHERE
                    PICK_ITEM.PICK_LABEL_NO IN (' . substr(str_repeat('?, ', count($holdedPickItems)), 0, -2) . ')
                    AND PICK_ITEM.PICK_LINE_STATUS = \'DH\'
            ';
            if (false === $this->execSQL($sql, $holdedPickItems))
                throw new Minder_Exception('Error releasing PICK_ITEMs: ' . $this->lastError);
        }
        
    }
    
    /**
    * Tests if there is lines with DS status
    * 
    * @param array $linesToCheck - array of PICK_ITEMs IDs to check
    * @return boolean true - there are still lines with DS status, false - no lines with DS status
    */
    public function undespatchedLinesLeft($linesToCheck = array()) {
        if (count($linesToCheck) < 1)
            return false;
            
        $sql = '
            SELECT
                COUNT(PICK_ITEM_DETAIL.PICK_LABEL_NO)
            FROM 
                PICK_ITEM_DETAIL
            WHERE
                PICK_ITEM_DETAIL.PICK_LABEL_NO IN (' . substr(str_repeat('?, ', count($linesToCheck)), 0, -2) . ')
                AND PICK_ITEM_DETAIL.PICK_DETAIL_STATUS = \'DS\'
        ';
        $args = $linesToCheck;
        array_unshift($args, $sql);
        
        $result = call_user_func_array(array($this, 'findValue'), $args);
        
        if ($result > 0)
            return true;
        
        return false;
    }
    
    
    public function getPKALTransClass($groupCode = '') {
        return $this->findValue('SELECT FIRST 1 CODE FROM OPTIONS WHERE GROUP_CODE = ?', $groupCode);
    }
    
    /**
    * Fetch data to print ADDRESS_LABEL
    * 
    * @param string $orderId - order ID to fetch data for printing
    * 
    * @return array Label data
    */
    public function getAddressLabelData($orderId) {
        $sql               = 'SELECT * FROM PICK_ORDER WHERE PICK_ORDER = ?';
        $pickOrderData     = $this->findOneAssocExt($sql, $orderId);
        
        $sql               = 'SELECT * FROM PURCHASE_ORDER WHERE PURCHASE_ORDER = ?';
        $purchaseOrderData = $this->findOneAssocExt($sql, $orderId);
        
        $personId          = NULL;
        
        switch (true) {
            case (!empty($pickOrderData['PICK_ORDER.S_PERSON_ID'])):
                $personId = $pickOrderData['PICK_ORDER.S_PERSON_ID'];
                break;
            case (!empty($pickOrderData['PICK_ORDER.S_PERSON_ID'])):
                $personId = $pickOrderData['PICK_ORDER.D_PERSON_ID'];
                break;
            case (!empty($pickOrderData['PICK_ORDER.S_PERSON_ID'])):
                $personId = $pickOrderData['PICK_ORDER.P_PERSON_ID'];
                break;
        }
        
        $personAddressData = array();
        
        if (!empty($personId)) {
            //TODO: find what address to print, as there could be a lot of them?
            $sql               = 'SELECT * FROM PERSON LEFT OUTER JOIN PERSON_ADDRESS ON PERSON.PERSON_ID = PERSON_ADDRESS.PERSON_ID WHERE PERSON.PERSON_ID = ?';
            $personAddressData = $this->findOneAssocExt($sql, $personId);
        }
        
        $result = array_merge($pickOrderData, $purchaseOrderData, $personAddressData);
        
        if (empty($result['PICK_ORDER.PICK_ORDER_TYPE'])) {
            $result['ADDRESS_ORDER_TYPE'] = $result['PURCHASE_ORDER.ORDER_TYPE'];
        } else {
            $result['ADDRESS_ORDER_TYPE'] = $result['PICK_ORDER.PICK_ORDER_TYPE'];
        }
        
        return $result;
    }
    /**    
    * Returns WH_ID and LOCATION_ID for specified DEVICE_ID. If no DEVICE_ID is specified uses current DEVICE_ID.    
    *      
    * @param string $deviceId    
    *     
    * @return array($whId, $locnId, 'WH_ID' => $whId, "LOCN_ID" => $locnId)    
    */    
    public function getDeviceWhAndLocation ($deviceId = null) {        
        if (empty($deviceId))            
            $deviceId = $this->deviceId;                
            
        Zend_Registry::get('logger')->debug(array('file' => __FILE__, 'line' => __LINE__, $deviceId));
        $whId    = '';        
        $locnId  = '';                    
        $sql     = 'SELECT WH_ID, LOCN_ID FROM SYS_EQUIP WHERE DEVICE_ID = ?';
        $result  = $this->findOneAssoc($sql, $deviceId);                
        $whId    = (empty($result['WH_ID']))   ? $this->whId        : $result['WH_ID'];
        $locnId  = (isset($result['LOCN_ID'])) ? $result['LOCN_ID'] : '';                
        return array($whId, $locnId, 'WH_ID' => $whId, "LOCN_ID" => $locnId);    
    }

    /**
     * @deprecated
     * Get PICK_ITEM_DETAILs to fillup PINV and PILN transactions fields
     *
     * @param array $linesPickLabelNo - array of PICK_LABEL_NO to fetch data for
     * @throws Minder_Exception
     * @return array - item details
     */
    public function getLineDetailsForInvoice($linesPickLabelNo) {
        if (!is_array($linesPickLabelNo) || count($linesPickLabelNo) < 1)
            throw new Minder_Exception('No PICK_LABEL_NO given nothing to fetch.');
            
        $sql = '
            SELECT DISTINCT
                PICK_ITEM.PICK_ORDER, 
                PICK_ITEM_DETAIL.DESPATCH_ID,

                PICK_ITEM.PICK_LABEL_NO,
                PICK_ITEM.PROD_ID,
                PICK_ITEM.SSN_ID,
                MAX(PICK_ITEM.SALE_PRICE) AS SALE_PRICE,
                MAX(PICK_ITEM.DISCOUNT) AS DISCOUNT,
                SUM(PICK_ITEM_DETAIL.QTY_PICKED) AS QTY_PICKED,
                MAX(PICK_ITEM.TAX_RATE) AS TAX_RATE,
                MAX(PROD_PROFILE.STANDARD_COST) AS STANDARD_COST,
                MAX(PROD_PROFILE.SALE_PRICE) AS PROD_PROFILE_SALE_PRICE,
                MAX(SSN.PURCHASE_PRICE) AS PURCHASE_PRICE,
                PICK_ITEM.LEGACY_LEDGER_SALE_CODE,
                MAX(PICK_ITEM.PICK_ORDER_QTY) AS PICK_ORDER_QTY,
                PICK_ITEM.WARRANTY_TERM
            FROM
                PICK_ITEM
                LEFT OUTER JOIN PICK_ITEM_DETAIL ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
                LEFT OUTER JOIN ISSN ON PICK_ITEM.SSN_ID = ISSN.SSN_ID
                LEFT OUTER JOIN SSN ON PICK_ITEM.SSN_ID = SSN.SSN_ID
                LEFT OUTER JOIN PROD_PROFILE ON PICK_ITEM.PROD_ID = PROD_PROFILE.PROD_ID
            WHERE
                PICK_ITEM.PICK_LABEL_NO IN(' . substr(str_repeat('?, ', count($linesPickLabelNo)), 0, -2) . ')
            GROUP BY
                PICK_ITEM.PICK_LABEL_NO,
                PICK_ITEM_DETAIL.DESPATCH_ID,
                PICK_ITEM.PICK_ORDER,
                PICK_ITEM.PROD_ID,
                PICK_ITEM.SSN_ID,
                PICK_ITEM.LEGACY_LEDGER_SALE_CODE,
                PICK_ITEM.WARRANTY_TERM
        ';
        
        array_unshift($linesPickLabelNo, $sql);
        return call_user_func_array(array($this, 'fetchAllAssoc'), $linesPickLabelNo);
    }

    /**
     * @deprecated
     * @param $linesPickLabelNo
     * @return array
     * @throws Minder_Exception
     */
    public function getPickOrderDetailsForInvoice($linesPickLabelNo) {
        if (!is_array($linesPickLabelNo) || count($linesPickLabelNo) < 1)
            throw new Minder_Exception('No PICK_LABEL_NO given nothing to fetch.');
            
        $sql = '
            SELECT DISTINCT
                PICK_ITEM.PICK_ORDER, 
                PICK_ITEM_DETAIL.DESPATCH_ID,
                PICK_ORDER.LEGACY_LEDGER_ADMIN_FEE_CODE,
                PICK_ORDER.LEGACY_LEDGER_FREIGHT_CODE,
                PICK_ORDER.LEGACY_LEDGER_DEPOSIT_CODE,
                PICK_ORDER.FREIGHT,
                PICK_ORDER.FREIGHT_TAX_AMOUNT,
                PICK_ORDER.TAX_RATE,
                PICK_ORDER.TAX_AMOUNT,
                PICK_ORDER.NET_TOTAL_AMOUNT,
                PICK_ORDER.SUM_TOTAL_AMOUNT,
                PICK_ORDER.ADMIN_FEE_RATE,
                PICK_ORDER.ADMIN_FEE_AMOUNT,
                PICK_ORDER.AMOUNT_PAID,
                PICK_ORDER.COMPANY_ID,
                PICK_ORDER.SHIPPING_METHOD,
                PICK_ORDER.DUE_AMOUNT,
                PICK_ORDER.SUB_TOTAL_AMOUNT,
                PICK_ORDER.SUB_TOTAL_TAX,
                PICK_ORDER.FEES_AMOUNTS,
                PICK_ORDER.FEES_AMOUNTS_TAX_AMOUNT,
                PICK_ORDER.ADMIN_FEE_PERCENT_AMOUNT,
                PICK_ORDER.ADMIN_FEE_TAX_AMOUNT,
                PICK_ORDER.WH_ID,
                PICK_ORDER.CUSTOMER_PO_WO,
                PICK_ORDER.PERSON_ID
            FROM
                PICK_ITEM
                LEFT OUTER JOIN PICK_ITEM_DETAIL ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
                LEFT OUTER JOIN PICK_ORDER ON PICK_ITEM.PICK_ORDER = PICK_ORDER.PICK_ORDER
            WHERE
                PICK_ITEM.PICK_LABEL_NO IN(' . substr(str_repeat('?, ', count($linesPickLabelNo)), 0, -2) . ')
        ';
        
        array_unshift($linesPickLabelNo, $sql);
        return call_user_func_array(array($this, 'fetchAllAssoc'), $linesPickLabelNo);
    }
    
    /**
    * Returns current uses category
    * 
    * @return string - user category
    */
    public function getUserCategory() {
        return (string)Minder2_Environment::getCurrentUser()->USER_CATEGORY;
    }
    
    /**
    * Searches for Label Type in OPTIONS table 
    * for given Address Type (DT, MT, OF)
    * If nothing found throw exception
    * 
    * @param string $addressType - selected address type (DT, MT, OF)
    * 
    * @return string - Label Type
    * 
    * @throws Minder_Exception - if no Label Lype could be found
    */
    public function getLabelTypeForAddress($addressType = '') {
        $labelType = '';
        
        //searching for general label type by Address Type
        $sql = 'SELECT CODE FROM OPTIONS WHERE GROUP_CODE = ? AND CODE STARTING ?';
        $code = $this->findValue($sql, 'ADDRESSES', $addressType);
        
        if (empty($code))
            throw new Minder_Exception('Cannot find Label Type for Address Type: "' . $addressType . '"');
            
        $labelType = explode('|', $code);
        $labelType = (isset($labelType[1])) ? $labelType[1] : '';
        
        if (empty($labelType))
            throw new Minder_Exception('Cannot find Label Type for Address Type: "' . $addressType . '"');
            
        return $labelType;
    }
    
    /**
    * Check if given location is moveable. As all movable location should have unique 
    * LOCN_ID accross all locations, so no need to check for WH_ID
    * 
    * @param string $locnId
    * @return boolean
    */
    public function isMoveableLocation($locnId = '') {
        $sql = 'SELECT LOCN_ID FROM LOCATION WHERE LOCN_ID = ? AND MOVEABLE_LOCN = ?';
        $value = $this->findValue($sql, $locnId, 'T');
        
        return $value == $locnId;
    }
    
    /**
    * Check if given location is despatch location;
    * 
    * @param string $whId
    * @param string $locnId
    * 
    * @return boolean
    */
    public function isDespatchLocation($whId = '', $locnId = '') {
        $whId   = is_null($whId)   ? '' : $whId; 
        $locnId = is_null($locnId) ? '' : $locnId; 
        
        $sql = "SELECT WH_ID || LOCN_ID FROM LOCATION WHERE (WH_ID IS NULL OR WH_ID = '' OR WH_ID = ?) AND LOCN_ID = ? AND STORE_TYPE = ?";
        $value = $this->fetchOne($sql, $whId, $locnId, 'DS');

        return $value == $whId . $locnId;
    }
    
    /**
    * Selects PICK_ORDER.PICK_STATUS and PICK_ITEM.PICK_LINE_STATUS for given conditions
    * 
    * @param array $conditions
    * @return array
    */
    public function selectPickORderAndPickItemStatuses($conditions = array()) {
        $statuses = array();
        
        $sql        = "
            SELECT DISTINCT
                PICK_ORDER.PICK_ORDER,
                PICK_ORDER.PICK_STATUS,
                PICK_ITEM.PICK_LINE_STATUS
            FROM
                PICK_ORDER
                LEFT OUTER JOIN PICK_ITEM ON PICK_ORDER.PICK_ORDER = PICK_ITEM.PICK_ORDER
        ";
        $sql       .= $this->getWarehouseAndCompanyLimit(0, true, 'PICK_ORDER.', 'PICK_ORDER.');
        $queryArgs  = array();
        if (count($conditions) > 0) {
            $sql       .= ' ' . implode(' AND ', array_keys($conditions));
            $queryArgs  = array_reduce(array_values($conditions), create_function('$res, $item', '$res = (is_array($res)) ? $res : array(); return array_merge($res, $item);'), $queryArgs);
            $queryArgs  = (empty($queryArgs)) ? array() : $queryArgs;
        } else {
            $sql        = substr($sql, 0, -5);
        }
        
        array_unshift($queryArgs, $sql);
        
        if (false !== ($result = call_user_func_array(array($this, 'fetchAllAssoc'), $queryArgs))) {
            $statuses = $result;
        }
        
        return $statuses;
    }

    /**
    * Compare two statuses using given statuses order
    * 
    * @param string $statusA
    * @param string $statusB
    * @param array $statusOrder
    * @return int 
    *           -1 - $statusA < $statusB
    *            0 - $statusA == $statusB
    *            1 - $statusA > $statusB
    */
    public function compareStatuses($statusA, $statusB, $statusOrder) {
        if ($statusA == $statusB)
            return 0;
            
        foreach ($statusOrder as $tmpSatus) {
            if ($tmpSatus == $statusA) 
                return -1;
            if ($tmpSatus == $statusB) 
                return 1;
        }
        
        return 0;
    }
    
    /**
    * Check selected orders and items for PICK_STATUS and PICK_LINE_STATUS
    * and fiils status structure
    * 
    * @param array $selectedOrders - list of selected orders
    * 
    * @return array(
    *           'mixed'                  - true if selected orders have different statuses
    *           'needs_confirm'          - true if all selected orders have PICK_STATUS < CF
    *           'needs_approve_pick'     - true if all selected orders have PICK_STATUS < DA and all selected orders lines have PICK_LINE_STATUS < OP
    *           'needs_approve_despatch' - true if all selected orders have PICK_STATUS < DA and all selected orders lines have PICK_LINE_STATUS >= OP
    * )
    */
    public function checkOrdersStatus($selectedOrders = array()) {
        $statuses = array(
            'mixed'                  => false,
            'needs_confirm'          => false,
            'needs_approve_pick'     => false,
            'needs_approve_despatch' => false
        );
        
        if (count($selectedOrders) < 1)
            return $statuses; //no orders selected, do nothing
            
        $tmpConditionStr = 'PICK_ORDER.PICK_ORDER IN (' . substr(str_repeat('?, ', count($selectedOrders)), 0, -2) . ')';
        $conditions      = array($tmpConditionStr => array_values($selectedOrders));
        
        $pickItemsStatuses = $this->selectPickORderAndPickItemStatuses($conditions);
        
        $tmpPickOrderStatusesOrder = array('UC', 'CF', 'OP', 'DA');
        $tmpPickItemStatusesOrder  = array('UC', 'CF', 'OP', 'AL', 'PG', 'PL', 'DS');
        $tmpOrdersStatuses         = array();
        
        foreach ($pickItemsStatuses as $statusesLine) {
            if (!isset($tmpOrdersStatuses[$statusesLine['PICK_ORDER']])) {
                $tmpOrdersStatuses[$statusesLine['PICK_ORDER']] = array(
                    'mixed'                  => false,
                    'needs_confirm'          => false,
                    'needs_approve_pick'     => false,
                    'needs_approve_despatch' => false,
                    'other'                  => false
                );
            }
            
            $tmpStatuses = &$tmpOrdersStatuses[$statusesLine['PICK_ORDER']];
            
            if ($this->compareStatuses($statusesLine['PICK_STATUS'], 'CF', $tmpPickOrderStatusesOrder) < 0
                || $this->compareStatuses($statusesLine['PICK_LINE_STATUS'], 'CF', $tmpPickItemStatusesOrder) < 0
            )
                $tmpStatuses['needs_confirm'] = true;
                
            if (   $this->compareStatuses($statusesLine['PICK_STATUS'], 'DA', $tmpPickOrderStatusesOrder) < 0
                && $this->compareStatuses($statusesLine['PICK_STATUS'], 'CF', $tmpPickOrderStatusesOrder) >= 0
                && $this->compareStatuses($statusesLine['PICK_LINE_STATUS'], 'OP', $tmpPickItemStatusesOrder) < 0
                )
                $tmpStatuses['needs_approve_pick'] = true;
                
            if (   $this->compareStatuses($statusesLine['PICK_STATUS'], 'DA', $tmpPickOrderStatusesOrder) < 0
                && $this->compareStatuses($statusesLine['PICK_STATUS'], 'CF', $tmpPickOrderStatusesOrder) >= 0
                && $this->compareStatuses($statusesLine['PICK_LINE_STATUS'], 'OP', $tmpPickItemStatusesOrder) >= 0
                )
                $tmpStatuses['needs_approve_despatch'] = true;
                
            $tmpStatuses['other'] = !($tmpStatuses['needs_confirm'] || $tmpStatuses['needs_approve_pick'] || $tmpStatuses['needs_approve_despatch']);
        }

        foreach ($tmpOrdersStatuses as $tmpStatuses) {
            $statuses['needs_confirm']          = $tmpStatuses['needs_confirm'] || $statuses['needs_confirm'];
            $statuses['needs_approve_pick']     = ($tmpStatuses['needs_approve_pick'] && !$tmpStatuses['needs_confirm']) || $statuses['needs_approve_pick'];
            $statuses['needs_approve_despatch'] = ($tmpStatuses['needs_approve_despatch'] && !$tmpStatuses['needs_confirm'] && !$tmpStatuses['needs_approve_pick']) || $statuses['needs_approve_despatch'];
            $statuses['other']                  = ($tmpStatuses['other'] && !$tmpStatuses['needs_approve_despatch'] && !$tmpStatuses['needs_confirm'] && !$tmpStatuses['needs_approve_pick']) || $statuses['other'];
        }
        
        $statuses['mixed'] = $statuses['needs_confirm'] && $statuses['needs_approve_pick'] 
                            || $statuses['needs_confirm'] && $statuses['needs_approve_despatch']
                            || $statuses['needs_confirm'] && $statuses['other']
                            || $statuses['needs_approve_pick'] && $statuses['needs_approve_despatch']
                            || $statuses['needs_approve_pick'] && $statuses['other']
                            || $statuses['needs_approve_despatch'] && $statuses['other'];
        
        return $statuses;
    }
    
    /**
    * Use this method when you need data to print PRODUCT LABEL
    * 
    * @param string | array $prodIds - PROD_ID to select data for
    * 
    * @return array - label data rows
    * @deprecated use selectProdLabelData
    * 
    * @todo Should move this method to Minder_SysScreen_Model_ProdProfile_Abstract when (if) all 
    *       screens will use SysScreen method. But now as AdminController don't use SysScreens 
    *       I have to put this here.
    */
    public function selectProductLabelData($prodIds = array()) {
        $labelData = array();
        
        $prodIds = (is_array($prodIds)) ? $prodIds : array($prodIds);
        
        if (empty($prodIds)) 
            return $labelData;
            
        $sql = "
            SELECT
                *
            FROM
                PROD_PROFILE
                LEFT OUTER JOIN PROD_EAN ON PROD_PROFILE.PROD_ID = PROD_EAN.PROD_ID
            WHERE 
                PROD_PROFILE.PROD_ID IN (" . substr(str_repeat('?, ', count($prodIds)), 0, -2) . ")
        ";
        
        $args = array_values($prodIds);
        array_unshift($args, $sql);

        if (false !== ($result = call_user_func_array(array($this, 'fetchAllAssocExt'), $args)))
            $labelData = $result;
        
        return $labelData;
    }

    public function selectProdLabelData($prodId, $companyId) {
        $labelData = array();

        if (empty($prodId))
            return $labelData;

        $sql = "
            SELECT FIRST 1
                *
            FROM
                PROD_PROFILE
                LEFT OUTER JOIN PROD_EAN ON PROD_PROFILE.PROD_ID = PROD_EAN.PROD_ID
            WHERE
                PROD_PROFILE.PROD_ID = ? AND PROD_PROFILE.COMPANY_ID = ?
        ";

        if (false !== ($result = $this->fetchAllAssocExt($sql, $prodId, $companyId))) {
            $labelData = current($result);
        }

        return $labelData;
    }

    /**
    * Use this method to find Email to send Invoice from for selected COMPANY_ID 
    * 
    * @param string $companyId   - COMPANY_ID to send invoice to
    * @param string $invoiceType - invoice type to search by
    * 
    * @return string - found Email
    * 
    * @throws Minder_Exception
    */
    public function findInvoiceFromEmail($companyId, $invoiceType) {
        $sql = "SELECT EMAIL FROM COMPANY WHERE COMPANY_ID = ?  AND INVOICE_TI_REPORT_ID IS NOT NULL";

        $email = $this->findValue($sql, $companyId  );
        
/*
        if (empty($email))
            throw new Minder_Exception('Cannot find Email for given COMPANY_ID ("' . $companyId . '") and INVOICE_TYPE ("' . $invoiceType . '") combination.');
*/
            
        return $email;
    }
    
    /**
    * Use this method to find Email to send Invoice Copy To for selected COMPANY_ID 
    * 
    * @param string $companyId   - COMPANY_ID to send invoice to
    * @param string $invoiceType - invoice type to search by
    * 
    * @return string - found Email
    * 
    * @throws Minder_Exception
    */
    public function findInvoiceCCEmail($companyId, $invoiceType) {
        $sql = "SELECT INVOICE_CC_EMAIL FROM COMPANY WHERE COMPANY_ID = ?  AND INVOICE_TI_REPORT_ID IS NOT NULL";

        $email = $this->findValue($sql, $companyId  );
        
/*
        if (empty($email))
            throw new Minder_Exception('Cannot find Email for given COMPANY_ID ("' . $companyId . '") and INVOICE_TYPE ("' . $invoiceType . '") combination.');
*/
            
        return $email;
    }
    
    /**
    * Use this method to find Email to sent Invoice for selected COMPANY_ID and PERSON and INVOICE_TYPE
    * 
    * @param string $companyId       - COMPANY_ID to send invoice to
    * @param string $invoice_type    - Invoice Type to search by
    * @param string $personId        - Person ID of Order to search by
    * 
    * @return string - found Email
    * 
    * @throws Minder_Exception
    */
    public function findInvoiceEmail($companyId, $invoiceType = 'TI', $personId) {
/*
        $sql = "SELECT DESCRIPTION FROM OPTIONS WHERE GROUP_CODE = ? AND CODE = ?";
        
        $email = $this->findValue($sql, 'EMLINVOICE', $companyId . '|' . $invoiceType);
*/
        $sql = " SELECT PERSON.EMAIL FROM PERSON WHERE PERSON.PERSON_ID = ?  AND PERSON.COMPANY_ID = ?  AND PERSON.EMAIL_INVOICE_%INVOICETYPE% = 'T' ";
        $sqlWType = str_replace("%INVOICETYPE%", $invoiceType, $sql);

        $email = $this->findValue($sqlWType, $personId, $companyId  );
        
/*
        if (empty($email))
            throw new Minder_Exception('Cannot find Email for given COMPANY_ID ("' . $companyId . '") and INVOICE_TYPE ("' . $invoiceType . '") combination.');
*/
            
        return $email;
    }
    
    /**
    * Used to calculate PROD_ID count, SSN_ID count and LITE_TOTAL for lines for selected orders at Sales Order screen
    * 
    * @param array $pickOrders - selected orders
    * @return array
    */
    public function getPickItemTotalsForSalesOrderScreen($pickOrders = array()) {
        $result = array(
            'PRODUCTS_DISPLAYED' => 0,
            'ISSNS_DISPLAYED'    => 0,
            'LINES_TOTAL'        => 0
        );
        
        if (!is_array($pickOrders) || empty($pickOrders))
            return $result;
            
        $sql = "
            SELECT
                SUM(CASE WHEN PROD_ID IS NULL OR PROD_ID = '' THEN 0 ELSE 1 END) AS PRODUCTS_DISPLAYED,
                SUM(CASE WHEN SSN_ID IS NULL OR SSN_ID = '' THEN 0 ELSE 1 END) AS ISSNS_DISPLAYED,
                SUM(COALESCE(SALE_PRICE, 0) * COALESCE(PICK_ORDER_QTY, 0) * (1 + COALESCE(TAX_RATE, 0) / 100) * (1 - COALESCE(discount, 0) / 100)) AS LINES_TOTAL
            FROM 
                PICK_ITEM
            WHERE
               PICK_ORDER IN (" . substr(str_repeat('?, ', count($pickOrders)), 0, -2) . ")
        ";
        
        array_unshift($pickOrders, $sql);
        
        return call_user_func_array(array($this, 'findOneAssoc'), $pickOrders);
    }
    
    public function getCarrierServiceTypes($carrierId = '') {
        $sql = "
            SELECT
                CARRIER_ID,
                SERVICE_SERVICE_CODE,
                SERVICE_SIGNATURE_REQD,
                SERVICE_MULTIPART_CONSIGNMENT,
                SERVICE_PARTIAL_DELIVERY,
                SERVICE_TYPE,
                DESCRIPTION,
                SERVICE_CASH_TO_COLLECT,
                SERVICE_PROFILE_ID,
                SERVICE_CHARGE_CODES,
                SERVICE_LOCATION_ID,
                RECORD_ID,
                SERVICE_TRANSIT_COVER_REQD,
                SERVICE_TRANSIT_COVER_AMOUNT,
                DEPOT_ID,
                SERVICE_ACCOUNT,
                MIN_WEIGHT,
                MAX_WEIGHT
            FROM 
                CARRIER_SERVICE
        ";
        
    
        if (empty($carrierId)) {
            return $this->fetchAllAssoc($sql);
        } else {
            $sql .= ' WHERE CARRIER_ID = ?';
            return $this->fetchAllAssoc($sql, $carrierId);
        }
    }
    
    public function getConnoteBarcodeDataIds() {
        $sql = "
            SELECT 
                PARAM.DATA_ID
            FROM 
                PARAM 
                RIGHT JOIN CARRIER ON PARAM.DATA_ID = CARRIER.CONNOTE_PARAM_ID
            WHERE 
                PARAM.DATA_ID IS NOT NULL 
                AND PARAM.DATA_ID <> ''
        ";

        $result = $this->fetchAllAssoc($sql);
        
        return empty($result) ? array() : $result;
    }
    
    public function getCarrirersDefaultServiceTypesList() {
        $sql = "SELECT CARRIER_ID, DEFAULT_SERVICE_TYPE FROM CARRIER";
        return $this->findList($sql);
    }

    /**
    * Get ISSNs IDs which already added to PICKORDER
    * 
    * @param string | array $pickOrder - single PICK_ORDER ID or array of PICK_ORDER IDs to search
    * @return array - list of added ISSNs
    */
    public function getPickOrderIssns($pickOrder) {
        $pickOrder = (is_array($pickOrder)) ? $pickOrder : array($pickOrder);
        
        if (empty($pickOrder))
            return array();
        
        $sql = "
            SELECT DISTINCT 
                SSN_ID 
            FROM 
                PICK_ITEM 
            WHERE 
                SSN_ID IS NOT NULL
                AND SSN_ID <> ''
                AND PICK_ORDER IN (" . substr(str_repeat('?, ', count($pickOrder)), 0, -2) . ")
        ";
        
        $args = array_values($pickOrder);
        array_unshift($args, $sql);
        
        if (false === ( $result = call_user_func_array(array($this, 'fetchAllAssoc'), $args) ))
            return array();
        
        return array_map(create_function('$item', 'return $item["SSN_ID"];'), $result);
    }

    
    public function canEditSalesOrder() {
        if (strtolower($this->userId) == 'admin')
            return true;
        
        if ($this->isAdmin)
            return true;
            
        if ($this->isSalesManagerT())
            return true;
            
        if ($this->isCreditManagerT())
            return true;
            
        if ($this->isEditable)
            return true;
            
        return false;
    }
    
    public function canCreateSalesOrder() {
        return $this->canEditSalesOrder();
    }
    
    public function canAdjustSalesOrder() {
        if (strtolower($this->userId) == 'admin')
            return true;
        
        if ($this->isAdmin)
            return true;
            
        if ($this->isAdjustPickOrder)
            return true;

        return false;
    }

    public function canEditSalesOrderLine() {
        return $this->canEditSalesOrder();
    }
    
    public function canAdjustSalesOrderLine() {
        if (strtolower($this->userId) == 'admin')
            return true;
        
        if ($this->isAdmin)
            return true;

        if ($this->isStatusAdjustPickItemT())
            return true;

        return false;
    }

    public function canApproveSODespatch() {
        if (strtolower($this->userId) == 'admin')
            return true;

        if ($this->isCreditManagerT())
            return true;

        return false;
    }
    
    /**
    * Get ISSNs IDs which already added to PICKORDER
    * 
    * @param string | array $pickOrder - single PICK_ORDER ID or array of PICK_ORDER IDs to search
    * @return array - list of added ISSNs
    */
    public function getReportTypeList($code) {
        $sql = "SELECT CODE, DESCRIPTION, RT_URL, RT_USER_ID, RT_PASS_WORD, LAST_UPDATE_DATE, LAST_UPDATE_BY, RT_NOTES, RT_STATUS  FROM REPORTS_TYPE WHERE CODE = ?  ";
        //return $this->findList($sql, $code);
        $data = $this->findAllAssoc($sql, $code);
        if (count($data) > 0) {
            $report = new ReportType($data[0]);
            $report->id = $data[0]['CODE'];
            $blob = ibase_blob_open($this->db, $report->items['RT_NOTES']);
            if (false !== $blob) {
                $blob_info = ibase_blob_info($this->db, $report->items['RT_NOTES']);
                $report->items['RT_NOTES'] = ibase_blob_get($blob, $blob_info['length']);
                ibase_blob_close($blob);
            } else {
                $report->items['RT_NOTES'] = '';
            }
            return $report;
        }
        $this->lastError = 'No Report Type exists';
        return false;
    }

    public function getDevicePerson($deviceId) {
        return $this->fetchOne("SELECT CURRENT_PERSON FROM SYS_EQUIP WHERE DEVICE_ID = ?", $deviceId);
    }

    public function getMaxReportActivity() {
        return $this->fetchOne("SELECT MAX(REPORT_ACTIVITY) FROM REPORTS");
    }

    public function getDateFormat() {
        $config = Zend_Registry::get('config');
        return $config->date->dateformat;
    }

    public function getDeviceCarrierList() {
        $result = current($this->getOptionsRecordByCode('DS_CARRIER', $this->deviceId));

        return empty($result) ? array() : explode('|', $result['DESCRIPTION']);
    }

    public function isRemoteSystem() {
        return strtoupper($this->defaultControlValues['IS_REMOTE']) == 'T';
    }

    public function getDataIdsByType($dataTypes) {
        $dataTypes = (array)$dataTypes;

        if (empty($dataTypes)) {
            return array();
        }

        $sql = 'SELECT DATA_ID, DATA_ID AS PARAM_ID FROM PARAM wHERE DATA_TYPE_ID IN (' . substr(str_repeat('?, ', count($dataTypes)), 0, -2) . ')';
        array_unshift($dataTypes, $sql);

        return call_user_func_array(array($this, 'findList'), $dataTypes);
    }

    public function getOrdersByProduct($products) {

        $result = array();
        $firstRun = true;

        $sql = "
            SELECT DISTINCT
                PICK_ITEM.PICK_ORDER
            FROM
                PICK_ITEM
                JOIN PROD_PROFILE ON PICK_ITEM.PROD_ID = PROD_PROFILE.PROD_ID
            WHERE
                PICK_ITEM.PICK_LINE_STATUS IN ('PL', 'DS')
                AND " . $this->formatCompanyLimit('PICK_ITEM') . "
                AND " . $this->formatWarehouseLimit('PICK_ITEM') . "
                AND (
                    PROD_PROFILE.PROD_ID = ?
                    OR PROD_PROFILE.ALTERNATE_ID = ?
                )
        ";

        foreach ($products as $prodId) {
            $foundOrders = $this->fetchColumn('PICK_ORDER', $sql, $prodId, $prodId);

            if ($firstRun) {
                $result = $foundOrders;
                $firstRun = false;
            } else {
                $result = array_intersect($result, $foundOrders);
            }

            if (count($result) < 0) {
                return $result;
            }
        }

        return $result;
    }

    /**
     * @param $orderIds
     * @return array
     */
    private function _getOrderShipToAddressList($orderIds)
    {
//chech if orders are for same PERSON_ID and the same SHIP_VIA and SHIP_TO_ADDRESS
        $sql = '
                SELECT DISTINCT
                    PICK_ORDER.PERSON_ID,
                    PICK_ORDER.SHIP_VIA,
                    PICK_ORDER.SHIP_SERVICE,
                    PICK_ORDER.S_ADDRESS_LINE1,
                    PICK_ORDER.S_ADDRESS_LINE2,
                    PICK_ORDER.S_ADDRESS_LINE3,
                    PICK_ORDER.S_ADDRESS_LINE4,
                    PICK_ORDER.S_ADDRESS_LINE5,
                    PICK_ORDER.S_CITY,
                    PICK_ORDER.S_COUNTRY,
                    PICK_ORDER.S_FIRST_NAME,
                    PICK_ORDER.S_LAST_NAME,
                    PICK_ORDER.S_PERSON_ID,
                    PICK_ORDER.S_PERSON_TYPE,
                    PICK_ORDER.S_PHONE,
                    PICK_ORDER.S_POST_CODE,
                    PICK_ORDER.S_STATE,
                    PICK_ORDER.S_TITLE
                FROM
                    PICK_ORDER
                WHERE PICK_ORDER.PICK_ORDER IN (' . substr(str_repeat('?, ', count($orderIds)), 0, -2) . ')
            ';

        return call_user_func_array(array($this, 'fetchAllAssoc'), array_merge(array($sql), $orderIds));
    }

    /**
     * Check if all selected lines belong to selected orders
     *
     * @param $orderIds
     * @param $linesIds
     * @return boolean
     */
    private function _hasPickItemsWhichDoesNotBelongToOrders($orderIds, $linesIds)
    {
        function _getItem($orderIds, $linesIds, Minder $minder) {
            $sql = '
                SELECT FIRST 1
                    PICK_LABEL_NO
                FROM
                    PICK_ITEM
                WHERE
                    PICK_ITEM.PICK_LABEL_NO IN (' . substr(str_repeat('?, ', count($linesIds)), 0, -2) . ')
                    AND PICK_ITEM.PICK_ORDER NOT IN (' . substr(str_repeat('?, ', count($orderIds)), 0, -2) . ')
            ';

            return call_user_func_array(array($minder, 'fetchAllAssoc'), array_merge(array($sql), $linesIds, $orderIds));
        }

        $from = 0;
        $window = 1000;

        while ($from < count($linesIds)) {
            $result = _getItem($orderIds, array_slice($linesIds, 0, $window), $this);

            if (count($result) > 0) {
                return true;
            }

            $from += $window;
        }

        return false;
    }

    /**
     * Returns all selected lines statuses which not DS or AS
     *
     * @param $linesIds
     * @return mixed
     */
    private function _getLineStatusesWhichDoNotAllowToDespatchItems($linesIds)
    {
        function _getStatuses($linesIds, Minder $minder) {
            $sql = '
                SELECT DISTINCT
                    PICK_ITEM.PICK_LINE_STATUS AS ROW_KEY,
                    PICK_ITEM.PICK_LINE_STATUS AS ROW_VAL
                FROM
                    PICK_ITEM
                WHERE
                    PICK_ITEM.PICK_LABEL_NO IN (' . substr(str_repeat('?, ', count($linesIds)), 0, -2) . ')
                    AND NOT PICK_ITEM.PICK_LINE_STATUS IN (\'DS\', \'PL\', \'AS\')
            ';

            return call_user_func_array(array($minder, 'findList'), array_merge(array($sql), $linesIds));
        }

        $from = 0;
        $window = 1000;
        $result = array();

        while ($from < count($linesIds)) {
            $result = array_merge($result, _getStatuses(array_slice($linesIds, 0, $window), $this));

            $from += $window;
        }

        return array_unique($result);
    }

    /**
     * @param $pickLabelNoList
     * @return array
     */
    private function _getPickOrderListByPickItem($pickLabelNoList)
    {
        function _getOrders($pickLabelNoList, Minder $minder) {
            $sql = '
                    SELECT DISTINCT
                        PICK_ITEM.PICK_ORDER
                    FROM
                        PICK_ITEM
                    WHERE
                        PICK_ITEM.PICK_LABEL_NO IN (' . implode(', ', array_fill(0, count($pickLabelNoList), '?')) . ')
                    ';

            $args = array_merge(array($sql), $pickLabelNoList);
            return Minder_ArrayUtils::mapField(call_user_func_array(array($minder, 'fetchAllAssoc'), $args), 'PICK_ORDER');
        }

        $from = 0;
        $window = 1000;
        $result = array();

        while ($from < count(($pickLabelNoList))) {
            $result = array_merge($result, _getOrders(array_slice($pickLabelNoList, $from, $window), $this));
            $from += $window;
        }

        return array_unique($result);
    }

    /**
     * @param $selectedPickLabelNoList
     * @param $pickOrder
     * @return array
     */
    private function _getPickItemsAndIssnToHoldByPickOrder($selectedPickLabelNoList, $pickOrder)
    {
        $sql = '
                    SELECT DISTINCT
                        PICK_ITEM_DETAIL.PICK_LABEL_NO,
                        ISSN.SSN_ID
                    FROM
                        PICK_ITEM
                        LEFT OUTER JOIN PICK_ITEM_DETAIL ON PICK_ITEM.PICK_LABEL_NO = PICK_ITEM_DETAIL.PICK_LABEL_NO
                        LEFT OUTER JOIN ISSN ON PICK_ITEM_DETAIL.SSN_ID = ISSN.SSN_ID
                    WHERE
                        PICK_ITEM.PICK_ORDER = ?
                        AND ISSN.ISSN_STATUS = \'DS\'
                ' . substr($this->getWarehouseAndCompanyLimit(0, false, 'ISSN.', 'ISSN.'), 0, -5);

        $orderLines                 = $this->findList($sql, $pickOrder);
        $selectedPickLabelNoList    = array_flip($selectedPickLabelNoList);

        return array_diff_key($orderLines, $selectedPickLabelNoList);
    }


    public function getFormatedDate($datDate, $strOutputFormat = "", $strServerTimeZone = "", $strClientTimeZone = ""){

	    /*$arrTesting = debug_backtrace();
        $testData = "{$arrTesting[0]["file"]} - {$arrTesting[0]["line"]} - $datDate\n";
        file_put_contents("/tmp/testing.txt", $testData, FILE_APPEND);*/
        $datTempDate = $datDate;

        if(trim($strOutputFormat) == ""){
            $strOutputFormat = "Y-m-d H:i:s";
        }
        if(trim($strServerTimeZone) == ""){
            $strServerTimeZone = "UTC";
        }
        if(trim($strClientTimeZone) == ""){
            $objSession = new Zend_Session_Namespace();
            $strClientTimeZone = $objSession->BrowserTimeZone;
            if($strClientTimeZone == ""){
                $arrSessionTableData = $this->getSessionTableData("CLIENT_TIME_ZONE");
                if(isset($arrSessionTableData["DESCRIPTION"])){
                    $strClientTimeZone = $arrSessionTableData["DESCRIPTION"];
                } else{
                    if (is_null($this->deviceId))
                        $strClientTimeZone = date_default_timezone_get();
                } 
            }
        }

        $objDate = new DateTime($datDate, new DateTimeZone($strServerTimeZone));
        $objDate->setTimezone(new DateTimeZone($strClientTimeZone));
        $datDate = $objDate->format($strOutputFormat);


	/*echo("<br>Server Time Zone : ".date_default_timezone_get().
            "<br> Clint Time Zone : $strClientTimeZone (".$objSession->BrowserTimeZone.")".
            "<br> Read From : $strServerTimeZone <br><br>");*/	

        $txtDateLog = date("d-m-Y H:i:s")." -> Server Time Zone : ".date_default_timezone_get()." \n".
        "                    -> Clint Time Zone  : $strClientTimeZone (".$objSession->BrowserTimeZone.") \n".
        "                    -> Read From        : $strServerTimeZone \n".
        "                    -> Date in DB       : $datTempDate \n".
        "                    -> Converted Date   : $datDate \n";
        //file_put_contents("/tmp/DateConversionLog.txt", $txtDateLog, FILE_APPEND);
        file_put_contents("/data/tmp/DateConversionLog.log", $txtDateLog, FILE_APPEND);


        return $datDate;
    }

    public function getFormatedDateToDb($datDate, $strOutputFormat = "", $blnForceTime = TRUE, $strServerTimeZone = "", $strClientTimeZone = ""){

        if(trim($strOutputFormat) == ""){
            if($blnForceTime == true){
                $strOutputFormat = "d.m.Y, H:i:s";
            }
            else{
                $strOutputFormat = "d.m.Y";
            }
        }
        if(trim($strServerTimeZone) == ""){
            $strServerTimeZone = "UTC";
        }
        if(trim($strClientTimeZone) == ""){
            $objSession = new Zend_Session_Namespace();
            $strClientTimeZone = $objSession->BrowserTimeZone;
            if($strClientTimeZone == ""){
                $arrSessionTableData = $this->getSessionTableData("CLIENT_TIME_ZONE");
                if(isset($arrSessionTableData["DESCRIPTION"])){
                    $strClientTimeZone = $arrSessionTableData["DESCRIPTION"];
                }
            }
        }
        if($blnForceTime == TRUE && strlen(trim($datDate)) <= 10){
            $datDate .= " ".$this->getFormatedDate(date("Y-m-d H:i:s"), "H:i:s", date_default_timezone_get(), $strClientTimeZone);
            $datDate = trim($datDate, "*");
        }

        $objDate = new DateTime($datDate, new DateTimeZone($strClientTimeZone));
        $objDate->setTimezone(new DateTimeZone($strServerTimeZone));
        $datDate = $objDate->format($strOutputFormat);
        return $datDate;
    }

    public function getClientDate($datDate, $strOutputFormat = "", $strServerTimeZone = "", $strClientTimeZone = ""){

        if(trim($strServerTimeZone) == ""){
            $strServerTimeZone = date_default_timezone_get();
        }

        $strClientDate = $this->getFormatedDate($datDate, $strOutputFormat, $strServerTimeZone, $strClientTimeZone);
        return trim($strClientDate, "*");
    }

    public function getSessionTableData($strCode = ""){
        if(trim($strCode) != ""){
            $sql = "SELECT * FROM SESSION 
            WHERE CODE = '$strCode' AND DEVICE_ID='". $this->deviceId."'";
            return $this->fetchAssoc($sql);
        }
        else{ 
            $sql = "SELECT * FROM SESSION 
            WHERE DEVICE_ID='". $this->deviceId."'";
            return $this->fetchAllAssoc($sql);
        }
    }

    public function isValidDate($datDate, $datFormat = "Y-m-d"){
        $datDate = str_replace("/", "-", $datDate);
        $datDate = str_replace(".", "-", $datDate);
        $datDate = str_replace("\\", "-", $datDate);

        $intFlag = 1;
        while($intFlag <= 2){
            $objDate = DateTime::createFromFormat($datFormat, $datDate);
            if($objDate && $objDate->format($datFormat) == $datDate){
                //echo $datDate."<br>";
                return true;
            }
            $datFormat .= " H:i:s";
            ++$intFlag;
        }

        return false;

        /*if(DateTime::createFromFormat($datFormat.' H:i:s', $datDate)!== FALSE  || DateTime::createFromFormat($datFormat,$datDate)!==FALSE) {
            return true;
        }
        else{
            return false;
        }*/
    }

    public function isNewDateCalculation(){
        if(Zend_Registry::get('config')->date->datecalculation){
            return True;
        }
        else{
            return false;
        }
    }
    /**
    * Get Scheduled Tasks 
    * 
    * @param string | array $status - single STATUS or array of STATUSEs to search
    * @return array - list of Tasks
    */
    public function getScheduleList($status) {
        //$sql = "SELECT RECORD_ID, REPS_WH_ID, REPS_RUN_TIME, REPS_LAST_RUN_TIME, REPS_NAME, REPS_SUBJECT, REPS_OUT_FOLDER, REPS_OUT_FILE_NAME, REPS_OUT_FILE_EXT, REPS_PARAMETER_2, REPS_PARAMETER_3, REPS_PARAMETER_4, REPS_PARAMETER_5, REPS_PARAMETER_6,REPS_LAST_UPDATED, REPS_LAST_UPDATED_BY, REPS_NOTES, REPS_STATUS, REPS_RUN_HOUR, REPS_RUN_DAY, REPS_PARAMETER_1_QUERY_FIELD, REPS_PARAMETER_2_QUERY_FIELD,  REPS_PARAMETER_2_QUERY_FIELD,  REPS_PARAMETER_4_QUERY_FIELD,  REPS_PARAMETER_5_QUERY_FIELD,  REPS_PARAMETER_6_QUERY_FIELD   FROM REPORTS_SCHEDULE WHERE REPS_STATUS = ?  ";
        //$sql = "SELECT RECORD_ID, REPS_WH_ID, REPS_EMAIL,  REPS_NAME, REPS_SUBJECT, REPS_OUT_FOLDER, REPS_OUT_FILE_NAME, REPS_OUT_FILE_EXT, REPS_PARAMETER_2, REPS_PARAMETER_3, REPS_PARAMETER_4, REPS_PARAMETER_5, REPS_PARAMETER_6, REPS_STATUS, REPS_RUN_HOUR, REPS_RUN_DAY, REPS_PARAMETER_1_QUERY_FIELD, REPS_PARAMETER_2_QUERY_FIELD,  REPS_PARAMETER_2_QUERY_FIELD,  REPS_PARAMETER_4_QUERY_FIELD,  REPS_PARAMETER_5_QUERY_FIELD,  REPS_PARAMETER_6_QUERY_FIELD   FROM REPORTS_SCHEDULE WHERE REPS_STATUS = ?  ";
        $sql = "SELECT RECORD_ID, REPS_WH_ID, REPS_EMAIL_GROUP,  REPS_NAME, REPS_SUBJECT, REPS_OUT_FOLDER, REPS_OUT_FILE_NAME, REPS_OUT_FILE_EXT, REPS_PARAMETER_2, REPS_PARAMETER_3, REPS_PARAMETER_4, REPS_PARAMETER_5, REPS_PARAMETER_6, REPS_STATUS, REPS_RUN_HOUR, REPS_RUN_DAY, REPS_PARAMETER_1_QUERY_FIELD, REPS_PARAMETER_2_QUERY_FIELD,  REPS_PARAMETER_2_QUERY_FIELD,  REPS_PARAMETER_4_QUERY_FIELD,  REPS_PARAMETER_5_QUERY_FIELD,  REPS_PARAMETER_6_QUERY_FIELD   FROM REPORTS_SCHEDULE WHERE REPS_STATUS = ?  ";

        $data = $this->findAllAssoc($sql, $status);
	$wk_result = array();
//var_dump($data);
        if (count($data) > 0) {
            for ($wk_idx = 0; $wk_idx < count($data); $wk_idx++)
            {
                //$report = new ReportSchedule($data[0]);
                $report = new ReportSchedule($data[$wk_idx]);
                $report->id = $data[$wk_idx]['RECORD_ID'];

                //return $report;
                $wk_result [] = $report;
            }
        } else {
            $this->lastError = 'No Task exists';
        }
//var_dump($wk_result);
        return $wk_result;
    }
    public function getEmailGroup($groupName) {
        $sql = "SELECT SET_GROUP_NAME, SET_EMAIL_NAME  FROM SYS_EMAIL_TO WHERE SET_GROUP_NAME = ?  ";

        $data = $this->findAllAssoc($sql, $groupName);
	$wk_result = array();
//var_dump($data);
        if (count($data) > 0) {
            for ($wk_idx = 0; $wk_idx < count($data); $wk_idx++)
            {
                $report = new ReportEmail($data[$wk_idx]);
                $report->id = $wk_idx;

                $wk_result [] = $report;
            }
        } else {
            $this->lastError = 'No Email for Group';
        }
//var_dump($wk_result);
        return $wk_result;
    }
    /**
    * Get Report ID for a Report Name 
    * 
    * @param string | array $status - single STATUS or array of STATUSEs to search
    * @return array - list of Tasks
    */
    public function getReportName($name) {
        $sql = "SELECT REPORT_ID  FROM REPORTS WHERE NAME = ?  ";

        $data = $this->findAllAssoc($sql, $name);
	$wk_report_id = "";
//var_dump($data);
        if (count($data) > 0) {
            $wk_report_id = $data[0]['REPORT_ID'];
            return $wk_report_id;
        } else {
            $this->lastError = 'No Report exists';
        }
//var_dump($wk_result);
        return False;
    }
    /**
    * Update a Session record 
    * 
    * @param string deviceId
    * @param string code
    * @param string description
    * @return Boolean whether successfull
    */
    public function setSessionRow($deviceId, $code, $description) {
       $query = "UPDATE OR INSERT INTO
                 SESSION(DEVICE_ID,
                         CODE,
                         DESCRIPTION,
                         CREATE_DATE)
                 VALUES('" . $deviceId . "',
                        '" . $code . "',
                        '" . $description . "',
                        'NOW')";
       $result = ibase_query($this->db, $query);
       if (false === $result) {
            $this->lastError = "Unable to Update session! Query: " . $query;
            return False;
       }
        return True;
    }

    // To get dynamic ssn column widget
    public function getDynamicSsnWidget($intSsnId){
        $arrResult = array();

        $viewRenderer = Zend_Controller_Action_HelperBroker::getStaticHelper('viewRenderer');
        if (null === $viewRenderer->view) {
            $viewRenderer->initView();
        }
        $objView = $viewRenderer->view;

        $strSqlSsn = "SELECT * FROM SSN WHERE SSN_ID = ?";
        $rstSsnData = ibase_query($this->db, $strSqlSsn, $intSsnId);
        $arrSsnData = ibase_fetch_assoc($rstSsnData);
        $arrResult["ssn_data"] = $arrSsnData;

        if($arrSsnData["SSN_GROUP"] == ""){
            $arrSsnData["SSN_GROUP"] = "DEFAULT";
        }

        $strSqlSsnGroup = "SELECT * FROM SSN_GROUP WHERE SSN_GROUP = ?";
        $rstSsnGroupData = ibase_query($this->db, $strSqlSsnGroup, $arrSsnData["SSN_GROUP"]);
        $arrSsnGroupData = ibase_fetch_assoc($rstSsnGroupData);
        $arrResult["ssn_group_data"] = $arrSsnGroupData;

        $strSqlSsnType = "SELECT * FROM SSN_TYPE WHERE CODE = ?";
        $rstSsnTypeData = ibase_query($this->db, $strSqlSsnType, $arrSsnData["SSN_TYPE"]);
        $arrSsnTypeData = ibase_fetch_assoc($rstSsnTypeData);
        $arrResult["ssn_type_data"] = $arrSsnTypeData;

        $arrResult["heading"] = "";
        $arrResult["widget"] = "";
        $arrResult["search"] = "";
        $arrSearchFunction = array(
                1 => "A",
                2 => "B",
                3 => "C",
                4 => "D",
                5 => "E",
            );

        //echo "<table style='width:1000px'>";  // For testing - display data in a table view - 1
        foreach($arrSsnData as $strKey => $strData){ 
            if(substr($strKey, 0, 5) == "OTHER" && substr($strKey, -3) != "_NO"){
                $strSearch = array("OTHER", "_DATE", "_QTY");
                $strReplace = array("", "", "");
                $intColumnNo = str_replace($strSearch, $strReplace, $strKey);

                if($intColumnNo >= 6 && $intColumnNo <= 10){
                    $strHeading = $arrSsnTypeData["FIELD".$arrSsnData["OTHER".$intColumnNo."_NO"]];
                }
                else{
                    //$strHeading = $arrSsnGroupData["FIELD".$arrSsnData["OTHER".$intColumnNo."_NO"]];
                    $strHeading = $arrSsnGroupData["FIELD".$intColumnNo];
                }

                if($strHeading != ""){
                    $strJsFunction = array_shift($arrSearchFunction);
                    $arrResult["heading"][$strKey] = $strHeading;
                    if($arrSsnGroupData["DD_OTHER".$intColumnNo] == "TRUE"){
                        if($intColumnNo <= 5){
                            $arrResult["search"]["OTHER".$intColumnNo] = " <input type='image' align='middle' onclick='conditions$strJsFunction(); return false;' src='/minder/icons/magnglass.png'>";
                        }
                        if($intColumnNo >= 6 && $intColumnNo <= 10){
                            $strDropDownQuery = "SELECT DESCRIPTION FROM PRODUCT_DESCRIPTION WHERE TYPE_CODE = '".$arrSsnData["SSN_TYPE"]."' AND FIELD_CODE = '".$arrSsnData["OTHER".$intColumnNo."_NO"]."'";
                        }
                        else{
                            $strDropDownQuery = "SELECT DESCRIPTION FROM GLOBAL_CONDITIONS WHERE OTHER_NO = $intColumnNo";
                        }
                        $rstDropDownData = ibase_query($this->db, $strDropDownQuery);
                        $arrResult["widget"][$strKey] = "<select force_keys_to_string='1' id='$strKey' name='$strKey'>
                                                            <option label='' value=''></option>";
                        while($arrDropDownData = ibase_fetch_assoc($rstDropDownData)){
                            $strSelected = "";
                            if($arrDropDownData["DESCRIPTION"] == $strData){
                                $strSelected = " selected = 'selected' ";
                            }
                            $arrResult["widget"][$strKey] .= "<option $strSelected label='{$arrDropDownData["DESCRIPTION"]}' value='{$arrDropDownData["DESCRIPTION"]}'>{$arrDropDownData["DESCRIPTION"]}</option>";
                        }
                        $arrResult["widget"][$strKey] .= "</select>";
                    }
                    else{
                        $arrResult["widget"][$strKey] = "<input type='text' value='$strData' id='$strKey' name='$strKey'>";
                    }
                }

                $arrResult["count"] = count($arrResult["heading"]);

                /*echo "<tr>                         // For testing - display data in a table view - 1
                        <td>$intColumnNo</td>
                        <td>$strKey</td>
                        <td>$strData</td>
                        <td>".$arrSsnData["OTHER".$intColumnNo."_NO"]."</td>
                        <td>".$arrSsnGroupData["FIELD".$intColumnNo]."</td>
                        <td>".$arrSsnTypeData["FIELD".$intColumnNo]."</td>
                        <td>".$strHeading."</td>
                      </tr>";*/
            }
        }
        //echo "</table>";        // For testing - display data in a table view - 1


        //echo "<pre>";           // For testing - display processed array - 2
        //print_r($arrResult);
        //echo "</pre>";


        return $arrResult;
    }

    // To get labels from ssn group
    public function getLabelsFromSsnGroup($arrColumn){
        $arrResult = array();
        $strColumn = implode(",", $arrColumn);
        $strQuery = "SELECT $strColumn FROM SSN_GROUP WHERE SSN_GROUP = 'DEFAULT'";
        $rstSsnGroupData = ibase_query($this->db, $strQuery);
        $arrSsnGroupData = ibase_fetch_assoc($rstSsnGroupData);
        foreach($arrSsnGroupData as $strKey => $strValue){
            if(trim($strValue) != ""){
                $arrTempKey = array_keys($arrColumn, $strKey);
                $arrResult[$arrTempKey[0]] = $strValue;
            }
        }
        return $arrResult;
    }

}

